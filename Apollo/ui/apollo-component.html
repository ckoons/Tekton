<!-- 
  Apollo Executive Coordinator Component
  This component provides a web interface for managing LLM operations, token budgeting, 
  protocol enforcement, and predictive planning in the Tekton system.
-->
<div id="apollo-component">
  <!-- Apollo Component Content -->
  <div class="apollo">
    <div class="apollo__header">
      <div class="apollo__title">
        <img src="/images/icon.jpg" alt="Apollo" class="apollo__logo">
        <h1>Apollo Executive Coordinator</h1>
      </div>
      <div class="apollo__header-content">
        <div class="apollo__stats">
          <div class="apollo__stat-item">
            <span>Active Sessions:</span>
            <span class="apollo__stat-value session-count">-</span>
          </div>
          <div class="apollo__stat-item">
            <span>Total Tokens:</span>
            <span class="apollo__stat-value token-count">-</span>
          </div>
        </div>
      </div>
      <div class="apollo__controls">
        <button class="apollo__btn apollo__btn-settings">
          <span>Settings</span>
        </button>
      </div>
    </div>

    <div class="apollo__menu-bar">
      <div class="apollo__chat-options">
        <div class="apollo__chat-option apollo__chat-option--attention">Attention Chat</div>
        <div class="apollo__chat-option apollo__chat-option--team">Team Chat</div>
      </div>
    </div>

    <div class="apollo__tabs">
      <div class="apollo__tab apollo__tab--active" data-tab="dashboard" 
           onclick="apollo_switchTab('dashboard'); return false;">Dashboard</div>
      <div class="apollo__tab" data-tab="preparation" 
           onclick="apollo_switchTab('preparation'); return false;">Preparation</div>
      <div class="apollo__tab" data-tab="confidence" 
           onclick="apollo_switchTab('confidence'); return false;">Confidence</div>
      <div class="apollo__tab" data-tab="actions" 
           onclick="apollo_switchTab('actions'); return false;">Actions</div>
      <div class="apollo__tab" data-tab="protocols" 
           onclick="apollo_switchTab('protocols'); return false;">Protocols</div>
      <div class="apollo__tab" data-tab="tokens" 
           onclick="apollo_switchTab('tokens'); return false;">Tokens</div>
    </div>

    <div class="apollo__content">
      <div id="dashboard-panel" class="apollo__panel apollo__panel--active" style="display: block;">
        <div class="apollo__dashboard-grid">
          <div class="apollo__card">
            <div class="apollo__card-header">
              <h3 class="apollo__card-title">System Status</h3>
              <div class="apollo__health-indicator apollo__health-indicator--healthy"></div>
            </div>
            <div class="apollo__card-body">
              <p>All systems operational</p>
              <p>4 LLM sessions active</p>
            </div>
            <div class="apollo__card-footer">
              Last updated: Just now
            </div>
          </div>

          <div class="apollo__card">
            <div class="apollo__card-header">
              <h3 class="apollo__card-title">Token Usage</h3>
            </div>
            <div class="apollo__card-body">
              <p>Total allocation: 100,000 tokens</p>
              <p>Used: 38,420 tokens</p>
              <div class="apollo__token-budget">
                <div class="apollo__token-budget-used" style="width: 38.4%"></div>
              </div>
            </div>
            <div class="apollo__card-footer">
              Current compression level: None
            </div>
          </div>

          <div class="apollo__card">
            <div class="apollo__card-header">
              <h3 class="apollo__card-title">Active Sessions</h3>
            </div>
            <div class="apollo__card-body">
              <ul class="apollo__session-list">
                <li class="apollo__session-item">
                  <span class="apollo__session-name">Codex</span>
                  <span class="apollo__session-status">
                    <div class="apollo__health-indicator apollo__health-indicator--healthy"></div>
                    Healthy
                  </span>
                </li>
                <li class="apollo__session-item">
                  <span class="apollo__session-name">Athena</span>
                  <span class="apollo__session-status">
                    <div class="apollo__health-indicator apollo__health-indicator--healthy"></div>
                    Healthy
                  </span>
                </li>
                <li class="apollo__session-item">
                  <span class="apollo__session-name">Rhetor</span>
                  <span class="apollo__session-status">
                    <div class="apollo__health-indicator apollo__health-indicator--warning"></div>
                    High Usage
                  </span>
                </li>
                <li class="apollo__session-item">
                  <span class="apollo__session-name">Engram</span>
                  <span class="apollo__session-status">
                    <div class="apollo__health-indicator apollo__health-indicator--healthy"></div>
                    Healthy
                  </span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Preparation Panel - Memory Catalog and Context Briefs -->
      <div id="preparation-panel" class="apollo__panel" style="display: none;">
        <div class="apollo__preparation-container">
          <div class="apollo__preparation-header">
            <h2>Context Brief Preparation</h2>
            <div class="apollo__preparation-stats">
              <span class="apollo__stat-badge">
                <span id="total-memories">0</span> Memories
              </span>
              <span class="apollo__stat-badge">
                <span id="total-landmarks">0</span> Landmarks
              </span>
              <span class="apollo__stat-badge">
                <span id="total-tokens">0</span> Tokens
              </span>
            </div>
          </div>

          <!-- Search and Filters -->
          <div class="apollo__preparation-controls">
            <div class="apollo__search-bar">
              <input type="text" 
                     id="memory-search" 
                     class="apollo__search-input" 
                     placeholder="Search memories..."
                     onkeyup="apollo_searchMemories(event)">
              <button class="apollo__btn apollo__btn-search" onclick="apollo_searchMemories()">
                Search
              </button>
            </div>
            
            <div class="apollo__filter-row">
              <select id="ci-filter" class="apollo__filter-select" onchange="apollo_filterMemories()">
                <option value="">All CIs</option>
                <option value="apollo-ci">Apollo</option>
                <option value="athena-ci">Athena</option>
                <option value="ergon-ci">Ergon</option>
                <option value="hermes-ci">Hermes</option>
                <option value="rhetor-ci">Rhetor</option>
              </select>
              
              <select id="type-filter" class="apollo__filter-select" onchange="apollo_filterMemories()">
                <option value="">All Types</option>
                <option value="decision">Decisions</option>
                <option value="insight">Insights</option>
                <option value="error">Errors</option>
                <option value="plan">Plans</option>
                <option value="context">Context</option>
              </select>
              
              <button class="apollo__btn apollo__btn-refresh" onclick="apollo_refreshMemories()">
                Refresh
              </button>
              <button class="apollo__btn apollo__btn-analyze" onclick="apollo_analyzeRelationships()">
                Analyze Relations
              </button>
            </div>
          </div>

          <!-- Memory Catalog Table -->
          <div class="apollo__memory-catalog">
            <table class="apollo__memory-table">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>CI Source</th>
                  <th>Type</th>
                  <th>Summary</th>
                  <th>Priority</th>
                  <th>Tokens</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="memory-table-body">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>

          <!-- Landmark Visualization -->
          <div class="apollo__landmark-section">
            <h3>Knowledge Graph Landmarks</h3>
            <div class="apollo__landmark-stats">
              <div class="apollo__landmark-stat">
                <span class="apollo__stat-label">Nodes:</span>
                <span id="landmark-nodes">0</span>
              </div>
              <div class="apollo__landmark-stat">
                <span class="apollo__stat-label">Relationships:</span>
                <span id="landmark-relationships">0</span>
              </div>
              <div class="apollo__landmark-stat">
                <span class="apollo__stat-label">Namespace:</span>
                <span class="apollo__namespace-badge">apollo</span>
              </div>
            </div>
            <div id="landmark-graph" class="apollo__landmark-graph">
              <!-- Graph visualization placeholder -->
              <div class="apollo__placeholder-graph">
                <p>Landmark graph visualization</p>
              </div>
            </div>
          </div>

          <!-- Context Brief Preview -->
          <div class="apollo__brief-section">
            <h3>Context Brief Preview</h3>
            <div class="apollo__brief-controls">
              <select id="brief-ci-select" class="apollo__filter-select">
                <option value="">Select CI...</option>
                <option value="ergon-ci">Ergon</option>
                <option value="apollo-ci">Apollo</option>
                <option value="athena-ci">Athena</option>
              </select>
              <input type="text" 
                     id="brief-context" 
                     class="apollo__context-input"
                     placeholder="Enter context for relevance...">
              <button class="apollo__btn apollo__btn-generate" onclick="apollo_generateBrief()">
                Generate Brief
              </button>
            </div>
            <div class="apollo__brief-preview">
              <div class="apollo__token-meter">
                <span>Token Usage:</span>
                <span id="brief-tokens">0 / 2000</span>
                <div class="apollo__token-bar">
                  <div id="brief-token-fill" class="apollo__token-fill" style="width: 0%"></div>
                </div>
              </div>
              <pre id="brief-content" class="apollo__brief-content">
Select a CI and enter context to generate a Context Brief...
              </pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Confidence Panel -->
      <div id="confidence-panel" class="apollo__panel" style="display: none;">
        <div class="apollo__placeholder-content">
          <h2>Decision Confidence</h2>
          <p>Confidence metrics and decision analysis will be implemented in the next update.</p>
        </div>
      </div>

      <div id="sessions-panel" class="apollo__panel" style="display: none;">
        <div class="apollo__placeholder-content">
          <h2>LLM Sessions</h2>
          <p>Detailed session information and metrics will be implemented in the next update.</p>
        </div>
      </div>

      <div id="tokens-panel" class="apollo__panel" style="display: none;">
        <div class="apollo__placeholder-content">
          <h2>Token Budget Management</h2>
          <p>Token budget allocation and management tools will be implemented in the next update.</p>
        </div>
      </div>

      <div id="protocols-panel" class="apollo__panel" style="display: none;">
        <div class="apollo__placeholder-content">
          <h2>Protocol Management</h2>
          <p>Protocol configuration and enforcement settings will be implemented in the next update.</p>
        </div>
      </div>

      <div id="forecasting-panel" class="apollo__panel" style="display: none;">
        <div class="apollo__placeholder-content">
          <h2>Predictive Forecasting</h2>
          <p>LLM behavior forecasting visualizations will be implemented in the next update.</p>
        </div>
      </div>

      <div id="actions-panel" class="apollo__panel" style="display: none;">
        <div class="apollo__placeholder-content">
          <h2>LLM Actions</h2>
          <p>Action execution interface will be implemented in the next update.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Include the component styles -->
  <link rel="stylesheet" href="styles/apollo.css">

  <script>
    // COMPONENT SCRIPT - FULLY SELF-CONTAINED
    // This prevents interference with other components

    // IMMEDIATELY SET UP UI MANAGER PROTECTION
    // Tell UI Manager to ignore this component - must be done IMMEDIATELY
    if (window.uiManager) {
      window.uiManager._ignoreComponent = 'apollo';
      console.log('[APOLLO] Set UI Manager to ignore apollo component');
    }

    // DEFINE TAB SWITCHING FUNCTION
    // CRITICAL: This uses no shared code/utilities to avoid conflicts
    window.apollo_switchTab = function(tabId) {
      console.log('[APOLLO] Switching to tab:', tabId);
      
      // Force HTML panel visibility
      const htmlPanelElements = document.querySelectorAll('#html-panel');
      htmlPanelElements.forEach(panel => {
        if (panel) panel.style.display = 'block';
      });
      
      try {
        // Only select elements within this component to avoid conflicts
        const componentContainer = document.querySelector('#apollo-component');
        if (!componentContainer) {
          console.error('[APOLLO] Tab Switch: Cannot find apollo container');
          return false;
        }
        
        // Update tab active state - ONLY WITHIN THIS COMPONENT'S CONTAINER
        const tabs = componentContainer.querySelectorAll('.apollo__tab');
        tabs.forEach(tab => {
          if (tab.getAttribute('data-tab') === tabId) {
            tab.classList.add('apollo__tab--active');
          } else {
            tab.classList.remove('apollo__tab--active');
          }
        });
        
        // Update panel visibility - ONLY WITHIN THIS COMPONENT'S CONTAINER
        const panels = componentContainer.querySelectorAll('.apollo__panel');
        panels.forEach(panel => {
          const panelId = panel.id;
          if (panelId === tabId + '-panel') {
            panel.style.display = 'block';
            panel.classList.add('apollo__panel--active');
          } else {
            panel.style.display = 'none';
            panel.classList.remove('apollo__panel--active');
          }
        });
        
        // Update component state
        if (window.apolloComponent) {
          window.apolloComponent.state = window.apolloComponent.state || {};
          window.apolloComponent.state.activeTab = tabId;
          
          // Call component-specific methods if available
          if (typeof window.apolloComponent.saveComponentState === 'function') {
            window.apolloComponent.saveComponentState();
          }
        }
      } catch (err) {
        console.error('[APOLLO] Error in tab switching:', err);
      }
      
      return false; // Stop event propagation
    };

    // HTML PANEL PROTECTION
    // Setup explicit protection for the HTML panel to prevent it being hidden
    function apollo_protectHtmlPanel() {
      const htmlPanel = document.getElementById('html-panel');
      if (!htmlPanel) {
        console.error('[APOLLO] Cannot find HTML panel to protect');
        return;
      }
      
      console.log('[APOLLO] Protecting HTML panel from being hidden');
      htmlPanel.style.display = 'block'; // Force it to be visible
      
      // Store the original display value
      if (!htmlPanel.hasOwnProperty('_apolloOriginalDisplay')) {
        Object.defineProperty(htmlPanel, '_apolloOriginalDisplay', {
          value: 'block',
          writable: true,
          configurable: true
        });
      }
      
      // Only define the getter/setter if it hasn't already been defined by this component
      if (!htmlPanel.style._apolloProtected) {
        // Mark the display property as protected by this component
        Object.defineProperty(htmlPanel.style, '_apolloProtected', {
          value: true,
          writable: false,
          configurable: true
        });
        
        // Protect the display property
        Object.defineProperty(htmlPanel.style, 'display', {
          get: function() { 
            return htmlPanel._apolloOriginalDisplay; 
          },
          set: function(value) {
            console.log(`[APOLLO] Intercepted attempt to set HTML panel display to: ${value}`);
            if (value === 'none') {
              console.log('[APOLLO] Blocked attempt to hide HTML panel');
              htmlPanel._apolloOriginalDisplay = 'block';
            } else {
              htmlPanel._apolloOriginalDisplay = value;
            }
          },
          configurable: true
        });
      }
    }

    // MEMORY AND PREPARATION FUNCTIONS
    // Functions for the Preparation tab functionality
    
    window.apollo_searchMemories = async function(event) {
      if (event && event.type === 'keyup' && event.key !== 'Enter') {
        return; // Only search on Enter key
      }
      
      const searchInput = document.getElementById('memory-search');
      const searchTerm = searchInput ? searchInput.value : '';
      
      console.log('[APOLLO] Searching memories:', searchTerm);
      
      try {
        const response = await fetch('/apollo/api/preparation/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: searchTerm })
        });
        
        if (response.ok) {
          const memories = await response.json();
          apollo_displayMemories(memories);
        }
      } catch (error) {
        console.error('[APOLLO] Search error:', error);
      }
    };
    
    window.apollo_filterMemories = function() {
      const ciFilter = document.getElementById('ci-filter').value;
      const typeFilter = document.getElementById('type-filter').value;
      
      console.log('[APOLLO] Filtering memories:', { ci: ciFilter, type: typeFilter });
      
      // Apply filters to displayed memories
      const rows = document.querySelectorAll('#memory-table-body tr');
      rows.forEach(row => {
        const ciSource = row.getAttribute('data-ci');
        const memType = row.getAttribute('data-type');
        
        let show = true;
        if (ciFilter && ciSource !== ciFilter) show = false;
        if (typeFilter && memType !== typeFilter) show = false;
        
        row.style.display = show ? '' : 'none';
      });
    };
    
    window.apollo_refreshMemories = async function() {
      console.log('[APOLLO] Refreshing memory catalog');
      
      try {
        const response = await fetch('/apollo/api/preparation/memories');
        if (response.ok) {
          const data = await response.json();
          apollo_displayMemories(data.memories);
          
          // Update stats
          document.getElementById('total-memories').textContent = data.total || 0;
          document.getElementById('total-tokens').textContent = data.total_tokens || 0;
        }
      } catch (error) {
        console.error('[APOLLO] Refresh error:', error);
      }
    };
    
    window.apollo_analyzeRelationships = async function() {
      console.log('[APOLLO] Analyzing memory relationships');
      
      try {
        const response = await fetch('/apollo/api/preparation/analyze', {
          method: 'POST'
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('[APOLLO] Relationships analyzed:', result);
          
          // Update landmark stats
          if (result.landmarks) {
            document.getElementById('landmark-nodes').textContent = result.landmarks.nodes || 0;
            document.getElementById('landmark-relationships').textContent = result.landmarks.relationships || 0;
          }
          
          // Could visualize the graph here
          apollo_visualizeLandmarks(result.landmarks);
        }
      } catch (error) {
        console.error('[APOLLO] Analysis error:', error);
      }
    };
    
    window.apollo_generateBrief = async function() {
      const ciSelect = document.getElementById('brief-ci-select');
      const contextInput = document.getElementById('brief-context');
      
      const ciName = ciSelect.value;
      const context = contextInput.value;
      
      if (!ciName) {
        alert('Please select a CI');
        return;
      }
      
      console.log('[APOLLO] Generating Context Brief for', ciName);
      
      try {
        const response = await fetch('/apollo/api/preparation/brief', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ci_name: ciName,
            message: context || 'General context',
            max_tokens: 2000
          })
        });
        
        if (response.ok) {
          const brief = await response.json();
          apollo_displayBrief(brief);
        }
      } catch (error) {
        console.error('[APOLLO] Brief generation error:', error);
      }
    };
    
    // DISPLAY HELPER FUNCTIONS
    window.apollo_displayMemories = function(memories) {
      const tbody = document.getElementById('memory-table-body');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      
      memories.forEach(memory => {
        const row = document.createElement('tr');
        row.setAttribute('data-ci', memory.ci_source);
        row.setAttribute('data-type', memory.type);
        
        row.innerHTML = `
          <td>${new Date(memory.timestamp).toLocaleString()}</td>
          <td><span class="apollo__ci-badge">${memory.ci_source}</span></td>
          <td><span class="apollo__type-badge apollo__type-${memory.type}">${memory.type}</span></td>
          <td>${memory.summary}</td>
          <td><span class="apollo__priority-badge">${memory.priority}</span></td>
          <td>${memory.tokens}</td>
          <td>
            <button class="apollo__btn-small" onclick="apollo_viewMemory('${memory.id}')">View</button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Update count
      document.getElementById('total-memories').textContent = memories.length;
    };
    
    window.apollo_displayBrief = function(brief) {
      const contentElement = document.getElementById('brief-content');
      const tokensElement = document.getElementById('brief-tokens');
      const tokenFillElement = document.getElementById('brief-token-fill');
      
      if (contentElement) {
        contentElement.textContent = brief.content || 'No content available';
      }
      
      if (tokensElement && brief.tokens_used) {
        const maxTokens = 2000;
        tokensElement.textContent = `${brief.tokens_used} / ${maxTokens}`;
        
        if (tokenFillElement) {
          const percentage = (brief.tokens_used / maxTokens) * 100;
          tokenFillElement.style.width = `${Math.min(percentage, 100)}%`;
        }
      }
    };
    
    window.apollo_visualizeLandmarks = function(landmarks) {
      const graphElement = document.getElementById('landmark-graph');
      if (!graphElement) return;
      
      // For now, just show a placeholder
      // In production, this would use a graph visualization library
      graphElement.innerHTML = `
        <div class="apollo__graph-placeholder">
          <p>Landmark Graph</p>
          <p>${landmarks?.nodes || 0} nodes, ${landmarks?.relationships || 0} edges</p>
        </div>
      `;
    };
    
    window.apollo_viewMemory = function(memoryId) {
      console.log('[APOLLO] Viewing memory:', memoryId);
      // Could open a modal or expand the row to show full content
    };
    
    // INITIALIZATION
    window.apolloComponent = window.apolloComponent || {};
    window.apolloComponent.state = { activeTab: 'dashboard' };
    
    // Auto-refresh memories when Preparation tab is opened
    const originalSwitchTab = window.apollo_switchTab;
    window.apollo_switchTab = function(tabId) {
      originalSwitchTab(tabId);
      
      if (tabId === 'preparation') {
        // Load memories when tab is activated
        apollo_refreshMemories();
      }
    };
    
    // SETUP
    // Do immediate initialization on script load
    apollo_protectHtmlPanel();
    
    // Load the component module script
    const script = document.createElement('script');
    script.src = 'scripts/apollo-component.js';
    script.type = 'module';
    document.body.appendChild(script);
  </script>
</div>