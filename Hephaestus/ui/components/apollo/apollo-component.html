<!-- Apollo Component - Attention and Prediction System -->

<!-- Load chat dependencies -->
<script src="/scripts/shared/tekton-config.js"></script>
<script src="/scripts/shared/ai-chat.js"></script>
<script src="/scripts/tekton-urls.js"></script>
<script src="/scripts/shared/single-chat.js"></script>
<script src="/scripts/shared/team-chat.js"></script>

<!-- Load Confidence component -->
<link rel="stylesheet" href="/styles/apollo/confidence-component.css">
<script src="/scripts/apollo/confidence-tracker.js"></script>
<script src="/scripts/apollo/apollo-preparation.js"></script>

<!-- Hidden radio inputs for CSS-first tab functionality -->
<input type="radio" name="apollo-tab" id="apollo-tab-dashboard" checked style="display: none;">
<input type="radio" name="apollo-tab" id="apollo-tab-preparation" style="display: none;">
<input type="radio" name="apollo-tab" id="apollo-tab-confidence" style="display: none;">
<input type="radio" name="apollo-tab" id="apollo-tab-actions" style="display: none;">
<input type="radio" name="apollo-tab" id="apollo-tab-protocols" style="display: none;">
<input type="radio" name="apollo-tab" id="apollo-tab-tokens" style="display: none;">
<input type="radio" name="apollo-tab" id="apollo-tab-attention" style="display: none;">
<input type="radio" name="apollo-tab" id="apollo-tab-teamchat" style="display: none;">

<div class="apollo" id="apollo-container" 
     data-tekton-component="apollo"
     data-tekton-area="apollo"
     data-tekton-type="component-workspace"
     data-tekton-ai="apollo-assistant"
     data-tekton-ai-ready="false">
    
    <!-- Component Header with Title -->
    <div class="apollo__header" data-tekton-zone="header" data-tekton-section="header">
        <div class="apollo__title-container">
            <img src="/images/hexagon.jpg" alt="Tekton" class="apollo__icon">
            <h2 class="apollo__title">
                <span class="apollo__title-main">Apollo</span>
                <span class="apollo__title-sub">Insight</span>
            </h2>
        </div>
    </div>
    
    <!-- Apollo Menu Bar with Tab Navigation -->
    <div class="apollo__menu-bar" data-tekton-zone="menu" data-tekton-nav="component-menu">
        <div class="apollo__tabs">
            <label for="apollo-tab-dashboard" class="apollo__tab" data-tab="dashboard"
                   data-tekton-nav-item="dashboard"
                   data-tekton-nav-target="apollo-dashboard"
                   data-tekton-nav-action="switch-tab">
                <span class="apollo__tab-label">Dashboard</span>
            </label>
            <label for="apollo-tab-preparation" class="apollo__tab" data-tab="preparation"
                   data-tekton-nav-item="preparation"
                   data-tekton-nav-target="apollo-preparation"
                   data-tekton-nav-action="switch-tab">
                <span class="apollo__tab-label">Preparation</span>
            </label>
            <label for="apollo-tab-confidence" class="apollo__tab" data-tab="confidence"
                   data-tekton-nav-item="confidence"
                   data-tekton-nav-target="apollo-confidence"
                   data-tekton-nav-action="switch-tab">
                <span class="apollo__tab-label">Confidence</span>
            </label>
            <label for="apollo-tab-actions" class="apollo__tab" data-tab="actions"
                   data-tekton-nav-item="actions"
                   data-tekton-nav-target="apollo-actions"
                   data-tekton-nav-action="switch-tab">
                <span class="apollo__tab-label">Actions</span>
            </label>
            <label for="apollo-tab-protocols" class="apollo__tab" data-tab="protocols"
                   data-tekton-nav-item="protocols"
                   data-tekton-nav-target="apollo-protocols"
                   data-tekton-nav-action="switch-tab">
                <span class="apollo__tab-label">Protocols</span>
            </label>
            <label for="apollo-tab-tokens" class="apollo__tab" data-tab="tokens"
                   data-tekton-nav-item="tokens"
                   data-tekton-nav-target="apollo-tokens"
                   data-tekton-nav-action="switch-tab">
                <span class="apollo__tab-label">Tokens</span>
            </label>
            <label for="apollo-tab-attention" class="apollo__tab" data-tab="attention"
                   data-tekton-nav-item="attention-chat"
                   data-tekton-nav-target="apollo-attention-chat"
                   data-tekton-nav-action="switch-tab">
                <span class="apollo__tab-label">Attention Chat</span>
            </label>
            <label for="apollo-tab-teamchat" class="apollo__tab" data-tab="teamchat"
                   data-tekton-nav-item="team-chat"
                   data-tekton-nav-target="apollo-team-chat"
                   data-tekton-nav-action="switch-tab">
                <span class="apollo__tab-label">Team Chat</span>
            </label>
        </div>
    </div>
    
    <!-- Apollo Content Area -->
    <div class="apollo__content" data-tekton-zone="content" data-tekton-scrollable="true">
        
        <!-- Dashboard Panel -->
        <div class="apollo__panel apollo__panel--dashboard" 
             data-tab-content="dashboard"
             data-tekton-tab-content="dashboard"
             data-tekton-panel="dashboard">
            <div class="apollo__dashboard">
                <div class="apollo__control-bar" data-tekton-zone="control-bar">
                    <div class="apollo__stats-container" data-tekton-metrics="ci-overview">
                        <div class="apollo__stat-item" data-tekton-metric="active-cis">
                            <span class="apollo__stat-label">Active CIs:</span>
                            <span class="apollo__stat-value" id="active-ci-count" data-tekton-value="active-ci-count">0</span>
                        </div>
                        <div class="apollo__stat-item" data-tekton-metric="burn-rate">
                            <span class="apollo__stat-label">Total Burn Rate:</span>
                            <span class="apollo__stat-value" id="total-burn-rate" data-tekton-value="total-burn-rate">0</span>
                            <span class="apollo__stat-label">tokens/min</span>
                        </div>
                        <div class="apollo__stat-item" data-tekton-metric="critical-cis">
                            <span class="apollo__stat-label">Critical CIs:</span>
                            <span class="apollo__stat-value" id="critical-ci-count" data-tekton-value="critical-ci-count">0</span>
                        </div>
                    </div>
                    <button id="refresh-dashboard-btn" class="apollo__button apollo__button--secondary"
                            data-tekton-action="refresh-dashboard"
                            data-tekton-trigger="click">
                        Refresh
                    </button>
                </div>
                
                <div class="apollo__section-header">
                    <h3 class="apollo__section-title">CI Master Registry</h3>
                </div>
                
                <div class="apollo__ci-grid" id="ci-grid"
                     data-tekton-container="ci-cards"
                     data-tekton-data-source="apollo-contexts"
                     data-tekton-refresh-interval="5000">
                    <!-- CI cards will be dynamically inserted here -->
                    <div class="apollo__loading" data-tekton-state="loading">Loading CI data...</div>
                </div>
            </div>
        </div>
        
        <!-- Preparation Panel -->
        <div class="apollo__panel apollo__panel--preparation" 
             data-tab-content="preparation"
             data-tekton-tab-content="preparation"
             data-tekton-panel="preparation">
            <div class="apollo__preparation">
                <div class="apollo__section-header">
                    <h3 class="apollo__section-title">Context Brief Preparation</h3>
                    <div class="apollo__preparation-stats">
                        <span class="apollo__stat-badge">
                            <span id="total-memories">0</span> Memories
                        </span>
                        <span class="apollo__stat-badge">
                            <span id="total-landmarks">0</span> Landmarks
                        </span>
                        <span class="apollo__stat-badge">
                            <span id="total-tokens">0</span> Tokens
                        </span>
                    </div>
                </div>
                
                <!-- Search and Filters -->
                <div class="apollo__preparation-controls">
                    <div class="apollo__search-bar">
                        <input type="text" 
                               id="memory-search" 
                               class="apollo__search-input" 
                               placeholder="Search memories..."
                               onkeyup="apollo_searchMemories(event)">
                        <button class="apollo__btn apollo__btn-search" onclick="apollo_searchMemories()">
                            Search
                        </button>
                    </div>
                    
                    <div class="apollo__filter-row">
                        <select id="ci-filter" class="apollo__filter-select" onchange="apollo_filterMemories()">
                            <option value="">All CIs</option>
                            <option value="apollo-ci">Apollo</option>
                            <option value="athena-ci">Athena</option>
                            <option value="ergon-ci">Ergon</option>
                            <option value="hermes-ci">Hermes</option>
                            <option value="rhetor-ci">Rhetor</option>
                        </select>
                        
                        <select id="type-filter" class="apollo__filter-select" onchange="apollo_filterMemories()">
                            <option value="">All Types</option>
                            <option value="decision">Decisions</option>
                            <option value="insight">Insights</option>
                            <option value="error">Errors</option>
                            <option value="plan">Plans</option>
                            <option value="context">Context</option>
                        </select>
                        
                        <button class="apollo__btn apollo__btn-refresh" onclick="apollo_refreshMemories()">
                            Refresh
                        </button>
                        <button class="apollo__btn apollo__btn-analyze" onclick="apollo_analyzeRelationships()">
                            Analyze Relations
                        </button>
                    </div>
                </div>
                
                <!-- Memory Catalog Table -->
                <div class="apollo__memory-catalog">
                    <table class="apollo__memory-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>CI Source</th>
                                <th>Type</th>
                                <th>Summary</th>
                                <th>Priority</th>
                                <th>Tokens</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="memory-table-body">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Cognitive Guidance Section -->
                <div class="apollo__cognitive-guidance">
                    <h3>Cognitive Guidance Builder</h3>
                    
                    <!-- Task Context -->
                    <div class="apollo__task-context">
                        <h4>Task Context</h4>
                        <div class="apollo__task-inputs">
                            <input type="text" id="task-id" class="apollo__task-input" placeholder="Task ID (e.g., TASK-001)">
                            <input type="text" id="task-name" class="apollo__task-input" placeholder="Task Name">
                            <input type="text" id="task-phase" class="apollo__task-input" placeholder="Current Phase">
                            <input type="text" id="task-step" class="apollo__task-input" placeholder="Current Step">
                            <textarea id="task-focus" class="apollo__task-input apollo__task-focus" 
                                      placeholder="What should the CI focus on?"></textarea>
                        </div>
                    </div>
                    
                    <!-- Memory Workflow Rules -->
                    <div class="apollo__memory-rules">
                        <h4>Memory Workflow</h4>
                        <label class="apollo__memory-rule">
                            <input type="checkbox" id="rule-short-term" checked>
                            <span>Update short-term memory every turn</span>
                        </label>
                        <label class="apollo__memory-rule">
                            <input type="checkbox" id="rule-medium-term" checked>
                            <span>Check medium-term every</span>
                            <input type="number" id="medium-term-interval" value="3" min="1" max="10">
                            <span>turns</span>
                        </label>
                        <label class="apollo__memory-rule">
                            <input type="checkbox" id="rule-long-term" checked>
                            <span>Scan long-term at phase completion</span>
                        </label>
                        <label class="apollo__memory-rule">
                            <input type="checkbox" id="rule-latent" checked>
                            <span>Contribute to latent space at task end</span>
                        </label>
                    </div>
                    
                    <!-- Inner Voice Generator -->
                    <div class="apollo__inner-voice">
                        <h4>Inner Voice Prompts</h4>
                        <div class="apollo__prompt-templates">
                            <button class="apollo__prompt-btn" onclick="apollo_addPrompt('check_pattern')">
                                + Check Pattern
                            </button>
                            <button class="apollo__prompt-btn" onclick="apollo_addPrompt('note_learning')">
                                + Note Learning
                            </button>
                            <button class="apollo__prompt-btn" onclick="apollo_addPrompt('recall_similar')">
                                + Recall Similar
                            </button>
                            <button class="apollo__prompt-btn" onclick="apollo_addPrompt('consolidate')">
                                + Consolidate
                            </button>
                            <button class="apollo__prompt-btn" onclick="apollo_addPrompt('collaborate')">
                                + Collaborate
                            </button>
                        </div>
                        <div class="apollo__custom-prompt" style="margin-top: 15px; display: flex; gap: 10px;">
                            <input type="text" id="apollo-prompt-input" 
                                   placeholder="Enter custom prompt..." 
                                   style="flex: 1; padding: 8px; background: #1a1a1d; border: 1px solid #FF9500; border-radius: 4px; color: #f0f0f0;">
                            <button class="apollo__prompt-btn" onclick="apollo_addPrompt('custom')">
                                + Add Custom
                            </button>
                        </div>
                        <div id="apollo-prompts-list" class="apollo__inner-prompts" style="margin-top: 15px;">
                            <!-- Inner voice prompts will appear here -->
                        </div>
                    </div>
                </div>
                
                <!-- Context Brief Section (Enhanced) -->
                <div class="apollo__brief-section">
                    <h4>Context Brief Generator</h4>
                    
                    <!-- Brief Management -->
                    <div class="apollo__brief-management">
                        <div class="apollo__brief-actions">
                            <button class="apollo__btn" onclick="apollo_saveBrief()">Save Brief</button>
                            <button class="apollo__btn" onclick="apollo_loadBrief()">Load Brief</button>
                            <button class="apollo__btn" onclick="apollo_clearBrief()">Clear</button>
                            <select id="brief-template" class="apollo__filter-select" onchange="apollo_loadTemplate()">
                                <option value="">Select Template...</option>
                                <option value="new_feature">New Feature</option>
                                <option value="debugging">Debugging</option>
                                <option value="refactoring">Refactoring</option>
                                <option value="review">Code Review</option>
                                <option value="planning">Planning</option>
                            </select>
                        </div>
                        
                        <!-- Saved Briefs List -->
                        <div id="saved-briefs" class="apollo__saved-briefs">
                            <!-- Saved briefs will appear here -->
                        </div>
                    </div>
                    
                    <div class="apollo__brief-controls">
                        <select id="brief-ci-select" class="apollo__filter-select">
                            <option value="">Select CI...</option>
                            <!-- Will be populated dynamically from CI Registry -->
                        </select>
                        <input type="text" 
                               id="brief-context" 
                               class="apollo__context-input"
                               placeholder="Enter context for relevance...">
                        <button class="apollo__btn apollo__btn-generate" onclick="apollo_generateBrief()">
                            Generate Brief
                        </button>
                    </div>
                    <div class="apollo__brief-preview">
                        <div class="apollo__token-meter">
                            <span>Token Usage:</span>
                            <span id="brief-tokens">0 / 2000</span>
                            <div class="apollo__token-bar">
                                <div id="brief-token-fill" class="apollo__token-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <pre id="brief-content" class="apollo__brief-content">
Select a CI and enter context to generate a Context Brief...
                        </pre>
                    </div>
                </div>
                
                <!-- Memory Rhythm Indicator (Floating) -->
                <div class="apollo__memory-rhythm" id="memory-rhythm-indicator" style="display: none;">
                    <div class="apollo__rhythm-bar">
                        <div class="apollo__rhythm-node active" title="Short-term">S</div>
                        <div class="apollo__rhythm-node" title="Medium-term">M</div>
                        <div class="apollo__rhythm-node" title="Long-term">L</div>
                        <div class="apollo__rhythm-node" title="Latent Space">∞</div>
                    </div>
                    <div class="apollo__rhythm-hint">Maintaining working memory...</div>
                </div>
            </div>
        </div>
        
        <!-- Token Management Panel -->
        <div class="apollo__panel apollo__panel--tokens" 
             data-tab-content="tokens"
             data-tekton-tab-content="tokens"
             data-tekton-panel="tokens">
            <div class="apollo__tokens">
                <div class="apollo__section-header">
                    <h3 class="apollo__section-title">Token Management - Operational Stress Monitor</h3>
                    <div class="apollo__section-stats">
                        <div class="apollo__stat-item">
                            <span class="apollo__stat-label">System Burn Rate:</span>
                            <span class="apollo__stat-value" id="system-burn-rate">0</span>
                            <span class="apollo__stat-label">tokens/min</span>
                        </div>
                        <div class="apollo__stat-item">
                            <span class="apollo__stat-label">Next Turn Load:</span>
                            <span class="apollo__stat-value" id="next-turn-load">0</span>
                            <span class="apollo__stat-label">tokens</span>
                        </div>
                    </div>
                </div>
                
                <div class="apollo__table-container" data-tekton-container="token-table">
                    <table class="apollo__table" data-tekton-table="token-management">
                        <thead class="apollo__table-header">
                            <tr>
                                <th class="apollo__table-header-cell" data-tekton-column="ci-name">CI Name</th>
                                <th class="apollo__table-header-cell" data-tekton-column="ci-type">Type</th>
                                <th class="apollo__table-header-cell" data-tekton-column="burn-rate">Burn Rate</th>
                                <th class="apollo__table-header-cell" data-tekton-column="next-turn">Next Turn</th>
                                <th class="apollo__table-header-cell" data-tekton-column="budget-status">Budget Status</th>
                                <th class="apollo__table-header-cell" data-tekton-column="stress-level">Stress Level</th>
                                <th class="apollo__table-header-cell" data-tekton-column="time-remaining">Time Remaining</th>
                            </tr>
                        </thead>
                        <tbody id="token-management-tbody" 
                               data-tekton-container="token-rows"
                               data-tekton-data-source="apollo-token-metrics">
                            <!-- Rows will be dynamically inserted here -->
                            <tr>
                                <td colspan="7" class="apollo__table-cell" style="text-align: center; padding: 48px;">
                                    <div class="apollo__loading" data-tekton-state="loading">Loading token data...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Protocols Panel -->
        <div class="apollo__panel apollo__panel--protocols" 
             data-tab-content="protocols"
             data-tekton-tab-content="protocols"
             data-tekton-panel="protocols">
            <div class="apollo__protocols">
                <div class="apollo__section-header">
                    <h3 class="apollo__section-title">Context Management Protocols</h3>
                    <button class="apollo__button apollo__button--primary" 
                            onclick="openProtocolDialog()"
                            data-tekton-action="add-protocol"
                            data-tekton-trigger="click"
                            data-tekton-modal="protocol-dialog">Add Protocol</button>
                </div>
                
                <div class="apollo__protocols-grid" id="protocols-grid"
                     data-tekton-container="protocol-cards"
                     data-tekton-data-source="apollo-protocols">
                    <!-- Protocol cards will be dynamically inserted here -->
                    <div class="apollo__loading" data-tekton-state="loading">Loading protocols...</div>
                </div>
            </div>
        </div>
        
        <!-- Actions Panel -->
        <div class="apollo__panel apollo__panel--actions" 
             data-tab-content="actions"
             data-tekton-tab-content="actions"
             data-tekton-panel="actions">
            <div class="apollo__actions">
                <div class="apollo__section-header">
                    <h3 class="apollo__section-title">CI Action Queue Management</h3>
                    <div class="apollo__action-controls" data-tekton-zone="action-controls">
                        <button class="apollo__button apollo__button--blue"
                                data-tekton-action="prepare-sunset"
                                data-tekton-trigger="click"
                                data-tekton-target="all-cis">Prepare Sunset Contexts</button>
                        <button class="apollo__button apollo__button--green"
                                data-tekton-action="optimize-contexts"
                                data-tekton-trigger="click"
                                data-tekton-target="all-cis">Optimize Contexts</button>
                        <button class="apollo__button apollo__button--primary"
                                data-tekton-action="refresh-memories"
                                data-tekton-trigger="click"
                                data-tekton-target="all-cis">Refresh Memories</button>
                    </div>
                </div>
                
                <div class="apollo__table-container">
                    <table class="apollo__table apollo__actions-table">
                        <thead class="apollo__table-header">
                            <tr>
                                <th class="apollo__table-header-cell">CI Name</th>
                                <th class="apollo__table-header-cell">Current State</th>
                                <th class="apollo__table-header-cell">Last Action</th>
                                <th class="apollo__table-header-cell">Next Planned Action</th>
                                <th class="apollo__table-header-cell">Context Preparation</th>
                                <th class="apollo__table-header-cell">Success Prediction</th>
                            </tr>
                        </thead>
                        <tbody id="actions-tbody">
                            <!-- Rows will be dynamically inserted here -->
                            <tr>
                                <td colspan="6" class="apollo__table-cell" style="text-align: center; padding: 48px;">
                                    <div class="apollo__loading">Loading action data...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Confidence Panel -->
        <div class="apollo__panel apollo__panel--confidence" 
             data-tab-content="confidence"
             data-tekton-tab-content="confidence"
             data-tekton-panel="confidence">
            <div class="apollo__confidence" data-tekton-element="confidence-container">
                <!-- Confidence Header -->
                <div class="apollo__confidence-header">
                    <h2 class="apollo__confidence-title">Prediction Confidence Dashboard</h2>
                    <div class="apollo__confidence-controls">
                        <select id="confidence-timeframe" class="apollo__confidence-select">
                            <option value="1h">Last Hour</option>
                            <option value="24h" selected>Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                        </select>
                        <button id="refresh-confidence" class="apollo__confidence-btn">Refresh</button>
                    </div>
                </div>
                
                <!-- Overall Confidence Score -->
                <div class="apollo__confidence-score">
                    <div class="apollo__confidence-meter">
                        <div class="apollo__confidence-ring">
                            <svg viewBox="0 0 200 200" class="apollo__confidence-svg">
                                <circle cx="100" cy="100" r="90" fill="none" stroke="#e0e0e0" stroke-width="12"/>
                                <circle cx="100" cy="100" r="90" fill="none" stroke="url(#confidence-gradient)" 
                                        stroke-width="12" stroke-dasharray="565" stroke-dashoffset="113"
                                        class="apollo__confidence-circle" id="confidence-circle"/>
                                <defs>
                                    <linearGradient id="confidence-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#2196F3;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="apollo__confidence-percent">
                                <span id="confidence-value">--</span>%
                            </div>
                        </div>
                        <div class="apollo__confidence-label">Overall Confidence</div>
                        <div class="apollo__confidence-status" id="confidence-status">Calibrating...</div>
                    </div>
                </div>
                
                <!-- Confidence Breakdown -->
                <div class="apollo__confidence-breakdown">
                    <h3>Confidence by Category</h3>
                    <div class="apollo__confidence-categories">
                        <div class="apollo__confidence-category">
                            <div class="apollo__category-header">
                                <span class="apollo__category-name">Intent Recognition</span>
                                <span class="apollo__category-score" id="intent-score">--</span>
                            </div>
                            <div class="apollo__category-bar">
                                <div class="apollo__category-fill" id="intent-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="apollo__confidence-category">
                            <div class="apollo__category-header">
                                <span class="apollo__category-name">Action Prediction</span>
                                <span class="apollo__category-score" id="action-score">--</span>
                            </div>
                            <div class="apollo__category-bar">
                                <div class="apollo__category-fill" id="action-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="apollo__confidence-category">
                            <div class="apollo__category-header">
                                <span class="apollo__category-name">Timing Accuracy</span>
                                <span class="apollo__category-score" id="timing-score">--</span>
                            </div>
                            <div class="apollo__category-bar">
                                <div class="apollo__category-fill" id="timing-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="apollo__confidence-category">
                            <div class="apollo__category-header">
                                <span class="apollo__category-name">Pattern Prediction</span>
                                <span class="apollo__category-score" id="pattern-score">--</span>
                            </div>
                            <div class="apollo__category-bar">
                                <div class="apollo__category-fill" id="pattern-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Calibration Chart -->
                <div class="apollo__calibration">
                    <h3>Calibration Chart</h3>
                    <div class="apollo__calibration-info">
                        <span>Perfect calibration: predictions match actual outcomes</span>
                    </div>
                    <div class="apollo__calibration-chart" id="calibration-chart">
                        <!-- Chart will be rendered here -->
                        <canvas id="calibration-canvas" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <!-- Recent Predictions -->
                <div class="apollo__recent-predictions">
                    <h3>Recent Predictions</h3>
                    <div class="apollo__predictions-list" id="predictions-list">
                        <!-- Predictions will be populated here -->
                        <div class="apollo__prediction-item">
                            <div class="apollo__prediction-time">Loading...</div>
                            <div class="apollo__prediction-content">
                                <span class="apollo__prediction-text">Fetching recent predictions...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Confidence Trends -->
                <div class="apollo__confidence-trends">
                    <h3>Confidence Trends</h3>
                    <div class="apollo__trends-grid">
                        <div class="apollo__trend-card">
                            <div class="apollo__trend-icon">📈</div>
                            <div class="apollo__trend-label">Improving</div>
                            <div class="apollo__trend-value" id="improving-count">--</div>
                        </div>
                        <div class="apollo__trend-card">
                            <div class="apollo__trend-icon">📊</div>
                            <div class="apollo__trend-label">Stable</div>
                            <div class="apollo__trend-value" id="stable-count">--</div>
                        </div>
                        <div class="apollo__trend-card">
                            <div class="apollo__trend-icon">📉</div>
                            <div class="apollo__trend-label">Declining</div>
                            <div class="apollo__trend-value" id="declining-count">--</div>
                        </div>
                        <div class="apollo__trend-card">
                            <div class="apollo__trend-icon">⚡</div>
                            <div class="apollo__trend-label">High Variance</div>
                            <div class="apollo__trend-value" id="variance-count">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Attention Chat Panel -->
        <div class="apollo__panel apollo__panel--attention" 
             data-tab-content="attention"
             data-tekton-tab-content="attention"
             data-tekton-panel="attention">
            <div class="apollo__chat-interface"
                 data-tekton-chat="apollo-attention"
                 data-tekton-ai="apollo"
                 data-tekton-chat-type="direct">
                <div class="apollo__chat-messages" id="attention-messages"
                     data-tekton-chat-messages="true"
                     data-tekton-scrollable="true">
                    <div class="chat-message system-message" data-tekton-message-type="system">
                        <strong>Apollo Attention System</strong><br>
                        Welcome to Apollo's direct attention interface. I can help with predictions, token management, and system optimization.
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Team Chat Panel -->
        <div class="apollo__panel apollo__panel--teamchat" 
             data-tab-content="teamchat"
             data-tekton-tab-content="teamchat"
             data-tekton-panel="teamchat">
            <div class="apollo__chat-interface"
                 data-tekton-chat="team-broadcast"
                 data-tekton-ai="all-specialists"
                 data-tekton-chat-type="broadcast">
                <div class="apollo__chat-messages" id="teamchat-messages"
                     data-tekton-chat-messages="true"
                     data-tekton-scrollable="true">
                    <div class="chat-message system-message" data-tekton-message-type="system">
                        <strong>Team Chat</strong><br>
                        Messages sent here are broadcast to all active CIs in the Tekton ecosystem.
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Chat Footer (persistent across all tabs) -->
    <div class="apollo__footer" data-tekton-zone="footer">
        <div class="apollo__chat-input-container" data-tekton-zone="chat-input">
            <div class="apollo__chat-prompt">></div>
            <input type="text" 
                   id="apollo-chat-input" 
                   class="apollo__chat-input" 
                   placeholder="Type your message..."
                   data-tekton-input="chat"
                   data-tekton-chat-input="true"
                   data-tekton-action-trigger="enter">
            <button id="apollo-send-button" 
                    class="apollo__button apollo__button--primary"
                    data-tekton-action="send-message"
                    data-tekton-trigger="click"
                    data-tekton-target="active-chat">Send</button>
        </div>
    </div>
</div>


<!-- Include CSS -->
<link rel="stylesheet" href="/styles/apollo/apollo-component.css">

<!-- JavaScript for API integration and functionality -->
<script>
(function() {
    // Prevent multiple initializations
    if (!window.apolloInitialized) {
        window.apolloInitialized = true;
        
        // Wait for DOM to be ready
        setTimeout(() => {
            initializeApollo();
        }, 0);
    }
    
    // Helper function to construct Apollo API URLs
    function apolloUrl(path) {
        return window.TektonConfig ? window.TektonConfig.getApolloUrl(path) : `http://localhost:8112${path}`;
    }
    
    // Populate all CI selectors with full CI list
    function apollo_populateCISelectors() {
        const allCIs = [
            // Core Specialist CIs
            { id: 'ergon-ci', name: 'Ergon', role: 'Task Manager', type: 'specialist' },
            { id: 'rhetor-ci', name: 'Rhetor', role: 'Orchestrator', type: 'specialist' },
            { id: 'noesis-ci', name: 'Noesis', role: 'Understanding', type: 'specialist' },
            { id: 'athena-ci', name: 'Athena', role: 'Knowledge Graph', type: 'specialist' },
            { id: 'hermes-ci', name: 'Hermes', role: 'Communication', type: 'specialist' },
            { id: 'sophia-ci', name: 'Sophia', role: 'Wisdom', type: 'specialist' },
            { id: 'apollo-ci', name: 'Apollo', role: 'Preparation', type: 'specialist' },
            { id: 'hephaestus-ci', name: 'Hephaestus', role: 'UI Builder', type: 'specialist' },
            { id: 'terma-ci', name: 'Terma', role: 'Contracts', type: 'specialist' },
            { id: 'neurosyne-ci', name: 'NeuroSyne', role: 'Cognitive', type: 'specialist' },
            { id: 'penia-ci', name: 'Penia', role: 'Cost Management', type: 'specialist' },
            { id: 'harmonia-ci', name: 'Harmonia', role: 'Orchestration', type: 'specialist' },
            { id: 'synthesis-ci', name: 'Synthesis', role: 'Integration', type: 'specialist' },
            { id: 'metis-ci', name: 'Metis', role: 'Workflows', type: 'specialist' },
            { id: 'telos-ci', name: 'Telos', role: 'Requirements', type: 'specialist' },
            { id: 'prometheus-ci', name: 'Prometheus', role: 'Planning', type: 'specialist' },
            { id: 'numa-ci', name: 'Numa', role: 'Companion', type: 'specialist' },
            { id: 'tekton-ci', name: 'Tekton', role: 'Projects', type: 'specialist' },
            
            // Terminal CIs
            { id: 'terminal-ergon', name: 'Terminal Ergon', role: 'Task Terminal', type: 'terminal' },
            { id: 'terminal-rhetor', name: 'Terminal Rhetor', role: 'Orchestration Terminal', type: 'terminal' },
            { id: 'terminal-noesis', name: 'Terminal Noesis', role: 'Understanding Terminal', type: 'terminal' },
            { id: 'terminal-athena', name: 'Terminal Athena', role: 'Knowledge Terminal', type: 'terminal' },
            { id: 'terminal-hermes', name: 'Terminal Hermes', role: 'Communication Terminal', type: 'terminal' },
            { id: 'terminal-sophia', name: 'Terminal Sophia', role: 'Wisdom Terminal', type: 'terminal' },
            { id: 'terminal-apollo', name: 'Terminal Apollo', role: 'Preparation Terminal', type: 'terminal' },
            { id: 'terminal-hephaestus', name: 'Terminal Hephaestus', role: 'UI Terminal', type: 'terminal' },
            
            // Project CIs
            { id: 'project-alpha', name: 'Project Alpha', role: 'Alpha Development', type: 'project' },
            { id: 'project-beta', name: 'Project Beta', role: 'Beta Testing', type: 'project' },
            { id: 'project-gamma', name: 'Project Gamma', role: 'Gamma Research', type: 'project' },
            { id: 'project-delta', name: 'Project Delta', role: 'Delta Integration', type: 'project' }
        ];
        
        // Update CI filter dropdown
        const ciFilter = document.getElementById('ci-filter');
        if (ciFilter) {
            ciFilter.innerHTML = '<option value="">All CIs</option>';
            allCIs.forEach(ci => {
                const option = document.createElement('option');
                option.value = ci.id;
                option.textContent = ci.name;
                ciFilter.appendChild(option);
            });
        }
        
        // Update brief CI selector  
        const briefCiSelect = document.getElementById('brief-ci-select');
        if (briefCiSelect) {
            briefCiSelect.innerHTML = '<option value="">Select CI...</option>';
            allCIs.forEach(ci => {
                const option = document.createElement('option');
                option.value = ci.id;
                option.textContent = `${ci.name} - ${ci.role}`;
                briefCiSelect.appendChild(option);
            });
        }
    }
    
    // PREPARATION TAB FUNCTIONS
    window.apollo_searchMemories = async function(event) {
        if (event && event.type === 'keyup' && event.key !== 'Enter') {
            return; // Only search on Enter key
        }
        
        const searchInput = document.getElementById('memory-search');
        const searchTerm = searchInput ? searchInput.value : '';
        
        console.log('[APOLLO] Searching memories:', searchTerm);
        
        try {
            const response = await fetch(apolloUrl('/api/preparation/search'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: searchTerm })
            });
            
            if (response.ok) {
                const memories = await response.json();
                apollo_displayMemories(memories);
            }
        } catch (error) {
            console.error('[APOLLO] Search error:', error);
        }
    };
    
    window.apollo_filterMemories = function() {
        const ciFilter = document.getElementById('ci-filter').value;
        const typeFilter = document.getElementById('type-filter').value;
        
        console.log('[APOLLO] Filtering memories:', { ci: ciFilter, type: typeFilter });
        
        // Apply filters to displayed memories
        const rows = document.querySelectorAll('#memory-table-body tr');
        rows.forEach(row => {
            const ciSource = row.getAttribute('data-ci');
            const memType = row.getAttribute('data-type');
            
            let show = true;
            if (ciFilter && ciSource !== ciFilter) show = false;
            if (typeFilter && memType !== typeFilter) show = false;
            
            row.style.display = show ? '' : 'none';
        });
    };
    
    window.apollo_refreshMemories = async function() {
        console.log('[APOLLO] Refreshing memory catalog');
        
        try {
            const response = await fetch(apolloUrl('/api/preparation/memories'));
            if (response.ok) {
                const data = await response.json();
                apollo_displayMemories(data.memories);
                
                // Update stats
                document.getElementById('total-memories').textContent = data.total || 0;
                document.getElementById('total-tokens').textContent = data.total_tokens || 0;
            }
        } catch (error) {
            console.error('[APOLLO] Refresh error:', error);
        }
    };
    
    window.apollo_analyzeRelationships = async function() {
        console.log('[APOLLO] Analyzing memory relationships');
        
        try {
            const response = await fetch(apolloUrl('/api/preparation/analyze'), {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('[APOLLO] Relationships analyzed:', result);
                
                // Update landmark stats
                if (result.landmarks) {
                    document.getElementById('landmark-nodes').textContent = result.landmarks.nodes || 0;
                    document.getElementById('landmark-relationships').textContent = result.landmarks.relationships || 0;
                }
            }
        } catch (error) {
            console.error('[APOLLO] Analysis error:', error);
        }
    };
    
    window.apollo_generateBrief = async function() {
        const ciSelect = document.getElementById('brief-ci-select');
        const contextInput = document.getElementById('brief-context');
        
        const ciName = ciSelect.value;
        const context = contextInput.value;
        
        if (!ciName) {
            alert('Please select a CI');
            return;
        }
        
        console.log('[APOLLO] Generating Context Brief for', ciName);
        
        try {
            const response = await fetch(apolloUrl('/api/preparation/brief'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ci_name: ciName,
                    message: context || 'General context',
                    max_tokens: 2000
                })
            });
            
            if (response.ok) {
                const brief = await response.json();
                apollo_displayBrief(brief);
            }
        } catch (error) {
            console.error('[APOLLO] Brief generation error:', error);
        }
    };
    
    // Display helper functions
    window.apollo_displayMemories = function(memories) {
        const tbody = document.getElementById('memory-table-body');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        memories.forEach(memory => {
            const row = document.createElement('tr');
            row.setAttribute('data-ci', memory.ci_source);
            row.setAttribute('data-type', memory.type);
            
            row.innerHTML = `
                <td>${new Date(memory.timestamp).toLocaleString()}</td>
                <td><span class="apollo__ci-badge">${memory.ci_source}</span></td>
                <td><span class="apollo__type-badge apollo__type-${memory.type}">${memory.type}</span></td>
                <td>${memory.summary}</td>
                <td><span class="apollo__priority-badge">${memory.priority}</span></td>
                <td>${memory.tokens}</td>
                <td>
                    <button class="apollo__btn-small" onclick="apollo_viewMemory('${memory.id}')">View</button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
        
        // Update count
        const totalElem = document.getElementById('total-memories');
        if (totalElem) totalElem.textContent = memories.length;
    };
    
    window.apollo_displayBrief = function(brief) {
        const contentElement = document.getElementById('brief-content');
        const tokensElement = document.getElementById('brief-tokens');
        const tokenFillElement = document.getElementById('brief-token-fill');
        
        if (contentElement) {
            contentElement.textContent = brief.content || 'No content available';
        }
        
        if (tokensElement && brief.tokens_used) {
            const maxTokens = 2000;
            tokensElement.textContent = `${brief.tokens_used} / ${maxTokens}`;
            
            if (tokenFillElement) {
                const percentage = (brief.tokens_used / maxTokens) * 100;
                tokenFillElement.style.width = `${Math.min(percentage, 100)}%`;
            }
        }
    };
    
    window.apollo_viewMemory = function(memoryId) {
        console.log('[APOLLO] Viewing memory:', memoryId);
        // Could open a modal or expand the row to show full content
    };
    
    function initializeApollo() {
        console.log('Initializing Apollo component');
        
        // Populate CI selectors with all CIs
        apollo_populateCISelectors();
        
        // Elements
        const dashboardTab = document.getElementById('apollo-tab-dashboard');
        const tokensTab = document.getElementById('apollo-tab-tokens');
        const protocolsTab = document.getElementById('apollo-tab-protocols');
        const actionsTab = document.getElementById('apollo-tab-actions');
        const refreshBtn = document.getElementById('refresh-dashboard-btn');
        
        // Auto-refresh intervals
        let dashboardRefreshInterval = null;
        let tokensRefreshInterval = null;
        let actionsRefreshInterval = null;
        
        // Start refresh based on active tab
        function startAutoRefresh() {
            stopAllRefresh();
            
            if (dashboardTab.checked) {
                updateDashboard();
                dashboardRefreshInterval = setInterval(updateDashboard, 5000);
            } else if (tokensTab.checked) {
                updateTokenManagement();
                tokensRefreshInterval = setInterval(updateTokenManagement, 5000);
            } else if (protocolsTab.checked) {
                updateProtocols();
            } else if (actionsTab.checked) {
                updateActions();
                actionsRefreshInterval = setInterval(updateActions, 5000);
            }
        }
        
        function stopAllRefresh() {
            if (dashboardRefreshInterval) clearInterval(dashboardRefreshInterval);
            if (tokensRefreshInterval) clearInterval(tokensRefreshInterval);
            if (actionsRefreshInterval) clearInterval(actionsRefreshInterval);
        }
        
        // Tab change listeners
        [dashboardTab, tokensTab, protocolsTab, actionsTab].forEach(tab => {
            tab.addEventListener('change', startAutoRefresh);
        });
        
        // Refresh button
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                if (dashboardTab.checked) updateDashboard();
            });
        }
        
        // Dashboard update function
        async function updateDashboard() {
            const grid = document.getElementById('ci-grid');
            if (!grid) return;
            
            try {
                // Fetch CI data from Apollo API
                const response = await fetch(apolloUrl('/api/v1/contexts'));
                const data = await response.json();
                
                // Check if we have valid data
                const contexts = data.data || [];
                
                // Update stats
                updateDashboardStats(contexts);
                
                // Clear grid and add CI cards
                grid.innerHTML = '';
                
                // Define CI types for organization
                const ciTypes = {
                    'coder-a': { name: 'Coder-A', type: 'Coder CI', priority: 1 },
                    'coder-b': { name: 'Coder-B', type: 'Coder CI', priority: 1 },
                    'apollo': { name: 'Apollo', type: 'Project CI', priority: 2 },
                    'tekton': { name: 'Tekton', type: 'Project CI', priority: 2 },
                    'hephaestus': { name: 'Hephaestus', type: 'Project CI', priority: 2 },
                    'terminal-1': { name: 'Terminal-1', type: 'Terminal CI', priority: 3 },
                    'terminal-2': { name: 'Terminal-2', type: 'Terminal CI', priority: 3 },
                    'athena': { name: 'Athena', type: 'Greek Chorus', priority: 4 },
                    'rhetor': { name: 'Rhetor', type: 'Greek Chorus', priority: 4 },
                    'engram': { name: 'Engram', type: 'Greek Chorus', priority: 4 },
                    'hermes': { name: 'Hermes', type: 'Greek Chorus', priority: 4 }
                };
                
                // Create cards for known CIs
                Object.keys(ciTypes).forEach(ciKey => {
                    const context = contexts.find(c => c.context_id === ciKey || c.context_id === `${ciKey}-ci`) || {};
                    const card = createCICard(ciTypes[ciKey].name, ciTypes[ciKey].type, context);
                    grid.appendChild(card);
                });
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
                grid.innerHTML = '<div class="apollo__empty-state">Error loading CI data</div>';
            }
        }
        
        function createCICard(name, type, context) {
            const card = document.createElement('div');
            card.className = 'apollo__ci-card';
            
            // Map context data from API
            const state = context.health || 'idle';
            const burnRate = context.metrics?.output_token_rate || 0;
            const lastAction = context.last_action?.action_type || 'None';
            const nextAction = context.recommended_actions?.[0]?.action_type || 'Waiting';
            const contextUsage = context.metrics?.context_usage_percent || 0;
            const timeToSundown = contextUsage > 0 ? `${Math.round((100 - contextUsage) / (burnRate / 60))}m` : 'N/A';
            
            card.innerHTML = `
                <div class="apollo__ci-header">
                    <div>
                        <div class="apollo__ci-name">${name}</div>
                        <div class="apollo__ci-type">${type}</div>
                    </div>
                    <div class="apollo__ci-state apollo__ci-state--${state}">${state}</div>
                </div>
                <div class="apollo__ci-metrics">
                    <div class="apollo__ci-metric">
                        <span class="apollo__ci-metric-label">Burn Rate:</span>
                        <span class="apollo__ci-metric-value">${burnRate} tokens/min</span>
                    </div>
                    <div class="apollo__ci-metric">
                        <span class="apollo__ci-metric-label">Time to Sundown:</span>
                        <span class="apollo__ci-metric-value">${timeToSundown}</span>
                    </div>
                </div>
                <div class="apollo__ci-actions-info">
                    <div class="apollo__ci-action-item">
                        <span class="apollo__ci-action-label">Last Action:</span>
                        <span class="apollo__ci-action-value">${lastAction}</span>
                    </div>
                    <div class="apollo__ci-action-item">
                        <span class="apollo__ci-action-label">Next Predicted:</span>
                        <span class="apollo__ci-action-value">${nextAction}</span>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function updateDashboardStats(contexts) {
            const activeCount = contexts.filter(c => c.state !== 'idle').length;
            const totalBurnRate = contexts.reduce((sum, c) => sum + (c.burn_rate || 0), 0);
            const criticalCount = contexts.filter(c => c.state === 'critical' || c.state === 'degrading').length;
            
            document.getElementById('active-ci-count').textContent = activeCount;
            document.getElementById('total-burn-rate').textContent = totalBurnRate;
            document.getElementById('critical-ci-count').textContent = criticalCount;
        }
        
        // Token Management update function
        async function updateTokenManagement() {
            const tbody = document.getElementById('token-management-tbody');
            if (!tbody) return;
            
            try {
                // Fetch contexts and predictions
                const [contextsResponse, predictionsResponse] = await Promise.all([
                    fetch(apolloUrl('/api/v1/contexts')),
                    fetch(apolloUrl('/api/v1/predictions'))
                ]);
                
                const contextsData = await contextsResponse.json();
                const predictionsData = await predictionsResponse.json();
                
                const contexts = contextsData.data || [];
                const predictions = predictionsData.data || [];
                
                tbody.innerHTML = '';
                
                // Define CI info
                const ciInfo = {
                    'coder-a': { name: 'Coder-A', type: 'Coder CI' },
                    'coder-b': { name: 'Coder-B', type: 'Coder CI' },
                    'apollo': { name: 'Apollo', type: 'Project CI' },
                    'tekton': { name: 'Tekton', type: 'Project CI' },
                    'hephaestus': { name: 'Hephaestus', type: 'Project CI' },
                    'terminal-1': { name: 'Terminal-1', type: 'Terminal CI' },
                    'terminal-2': { name: 'Terminal-2', type: 'Terminal CI' },
                    'athena': { name: 'Athena', type: 'Greek Chorus' },
                    'rhetor': { name: 'Rhetor', type: 'Greek Chorus' },
                    'engram': { name: 'Engram', type: 'Greek Chorus' },
                    'hermes': { name: 'Hermes', type: 'Greek Chorus' }
                };
                
                // Create rows for each CI
                Object.keys(ciInfo).forEach(ciKey => {
                    const context = contexts.find(c => c.context_id === ciKey || c.context_id === `${ciKey}-ci`) || {};
                    const prediction = predictions.find(p => p.context_id === ciKey || p.context_id === `${ciKey}-ci`) || {};
                    
                    const row = document.createElement('tr');
                    row.className = 'apollo__table-row';
                    
                    const burnRate = context.metrics?.output_token_rate || 0;
                    const contextUsage = context.metrics?.context_usage_percent || 0;
                    const nextTurn = prediction.predicted_metrics?.output_token_rate || 0;
                    const confidence = Math.round((prediction.confidence || 0.5) * 100);
                    const stressLevel = getStressLevelFromHealth(context.health);
                    const stressClass = getStressClass(stressLevel);
                    const trend = prediction.trend || 'stable';
                    const trendArrow = trend === 'improving' ? '↓' : trend === 'declining' ? '↑' : '→';
                    const timeRemaining = contextUsage > 0 && burnRate > 0 ? 
                        `${Math.round((100 - contextUsage) / (burnRate / 60))}m` : 'N/A';
                    
                    row.innerHTML = `
                        <td class="apollo__table-cell">${ciInfo[ciKey].name}</td>
                        <td class="apollo__table-cell">${ciInfo[ciKey].type}</td>
                        <td class="apollo__table-cell">${burnRate} ${trendArrow}</td>
                        <td class="apollo__table-cell">${nextTurn} (${confidence}%)</td>
                        <td class="apollo__table-cell">
                            <div class="apollo__progress">
                                <div class="apollo__progress-bar" style="width: ${contextUsage}%"></div>
                            </div>
                            <span>${contextUsage}%</span>
                        </td>
                        <td class="apollo__table-cell">
                            <span class="apollo__ci-state apollo__ci-state--${stressClass}">${stressLevel}</span>
                        </td>
                        <td class="apollo__table-cell">${timeRemaining}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                // Update system stats
                updateTokenStats(contexts);
                
            } catch (error) {
                console.error('Error updating token management:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="apollo__table-cell" style="text-align: center;">Error loading token data</td></tr>';
            }
        }
        
        function updateTokenStats(contexts) {
            const systemBurnRate = contexts.reduce((sum, context) => {
                return sum + (context.metrics?.output_token_rate || 0);
            }, 0);
            const nextTurnLoad = contexts.reduce((sum, context) => {
                return sum + (context.metrics?.input_token_rate || 0);
            }, 0);
            
            document.getElementById('system-burn-rate').textContent = systemBurnRate;
            document.getElementById('next-turn-load').textContent = nextTurnLoad;
        }
        
        function getStressLevelFromHealth(health) {
            if (!health) return 'Low';
            switch (health) {
                case 'excellent': return 'Low';
                case 'good': return 'Low';
                case 'fair': return 'Medium';
                case 'poor': return 'High';
                case 'critical': return 'Critical';
                default: return 'Low';
            }
        }
        
        function getStressClass(stressLevel) {
            const level = stressLevel.toLowerCase();
            if (level === 'low') return 'idle';
            if (level === 'medium') return 'stressed';
            if (level === 'high') return 'degrading';
            if (level === 'critical') return 'critical';
            return 'active';
        }
        
        // Protocols update function
        async function updateProtocols() {
            const grid = document.getElementById('protocols-grid');
            if (!grid) return;
            
            try {
                const response = await fetch(apolloUrl('/api/v1/protocols'));
                const data = await response.json();
                const protocols = data.data || [];
                
                grid.innerHTML = '';
                
                if (protocols.length > 0) {
                    protocols.forEach(protocol => {
                        const card = createProtocolCard(protocol);
                        grid.appendChild(card);
                    });
                } else {
                    // Create default protocols if none exist
                    const defaultProtocols = [
                        {
                            name: 'Memory Management',
                            type: 'optimization',
                            description: 'Prefetch and compress memory for optimal context usage',
                            effectiveness: 85,
                            last_triggered: 'Active'
                        },
                        {
                            name: 'Context Optimization',
                            type: 'optimization',
                            description: 'Dynamic context window management and prioritization',
                            effectiveness: 92,
                            last_triggered: 'Active'
                        },
                        {
                            name: 'Quality Assurance',
                            type: 'validation',
                            description: 'Ensure response quality and accuracy standards',
                            effectiveness: 88,
                            last_triggered: 'Active'
                        },
                        {
                            name: 'Sundown/Sunrise',
                            type: 'lifecycle',
                            description: 'Manage CI lifecycle when context capacity exceeds 50%',
                            effectiveness: 95,
                            last_triggered: 'Standby'
                        },
                        {
                            name: 'Task Completion',
                            type: 'validation',
                            description: 'Verify task completion criteria before marking done',
                            effectiveness: 90,
                            last_triggered: 'Active'
                        }
                    ];
                    
                    defaultProtocols.forEach(protocol => {
                        const card = createProtocolCard(protocol);
                        grid.appendChild(card);
                    });
                }
                
            } catch (error) {
                console.error('Error updating protocols:', error);
                grid.innerHTML = '<div class="apollo__empty-state">Error loading protocols</div>';
            }
        }
        
        function createProtocolCard(protocol) {
            const card = document.createElement('div');
            card.className = 'apollo__protocol-card';
            
            card.innerHTML = `
                <div class="apollo__protocol-header">
                    <div>
                        <div class="apollo__protocol-name">${protocol.name}</div>
                        <div class="apollo__protocol-type">${protocol.type}</div>
                    </div>
                    <div class="apollo__protocol-effectiveness">
                        <span class="apollo__effectiveness-label">Effectiveness:</span>
                        <span class="apollo__effectiveness-value">${protocol.effectiveness}%</span>
                    </div>
                </div>
                <div class="apollo__protocol-description">${protocol.description}</div>
                <div class="apollo__protocol-metadata">
                    <div>Last triggered: ${protocol.last_triggered || 'Never'}</div>
                    <button class="apollo__button apollo__button--primary" onclick="configureProtocol('${protocol.name}')">Configure</button>
                </div>
            `;
            
            return card;
        }
        
        // Actions update function
        async function updateActions() {
            const tbody = document.getElementById('actions-tbody');
            if (!tbody) return;
            
            try {
                // Fetch contexts with their actions
                const response = await fetch(apolloUrl('/api/v1/contexts'));
                const data = await response.json();
                const contexts = data.data || [];
                
                tbody.innerHTML = '';
                
                // Define CI info
                const ciInfo = {
                    'coder-a': { name: 'Coder-A', priority: 1 },
                    'coder-b': { name: 'Coder-B', priority: 1 },
                    'apollo': { name: 'Apollo', priority: 2 },
                    'tekton': { name: 'Tekton', priority: 2 },
                    'hephaestus': { name: 'Hephaestus', priority: 2 },
                    'terminal-1': { name: 'Terminal-1', priority: 3 },
                    'terminal-2': { name: 'Terminal-2', priority: 3 },
                    'athena': { name: 'Athena', priority: 4 },
                    'rhetor': { name: 'Rhetor', priority: 4 },
                    'engram': { name: 'Engram', priority: 4 },
                    'hermes': { name: 'Hermes', priority: 4 }
                };
                
                // Create action rows for each CI
                Object.keys(ciInfo).forEach(ciKey => {
                    const context = contexts.find(c => c.context_id === ciKey || c.context_id === `${ciKey}-ci`) || {};
                    
                    const actionData = {
                        ci_name: ciInfo[ciKey].name,
                        state: context.health || 'idle',
                        last_action: context.last_action?.action_type || 'None',
                        last_action_time: context.last_action?.timestamp ? 
                            new Date(context.last_action.timestamp).toLocaleTimeString() : 'N/A',
                        next_action: context.recommended_actions?.[0]?.action_type || 'Monitor',
                        priority: context.recommended_actions?.[0]?.priority || 'low',
                        success_prediction: Math.round((context.prediction?.confidence || 0.8) * 100),
                        context_usage: context.metrics?.context_usage_percent || 0,
                        context_components: {
                            role: true,
                            task: context.current_task ? true : false,
                            criteria: true,
                            tools: true,
                            memories: context.memory_count > 0,
                            query: false,
                            data: context.metrics ? true : false
                        }
                    };
                    
                    const row = createActionRow(actionData);
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error updating actions:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="apollo__table-cell" style="text-align: center;">Error loading actions</td></tr>';
            }
        }
        
        function createActionRow(action) {
            const row = document.createElement('tr');
            row.className = 'apollo__table-row';
            
            const contextChecklist = createContextChecklist(action.context_components, action.context_usage);
            
            row.innerHTML = `
                <td class="apollo__table-cell">${action.ci_name}</td>
                <td class="apollo__table-cell">
                    <span class="apollo__ci-state apollo__ci-state--${action.state}">${action.state}</span>
                </td>
                <td class="apollo__table-cell">
                    <div>${action.last_action}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${action.last_action_time}</div>
                </td>
                <td class="apollo__table-cell">
                    <div>${action.next_action}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Priority: ${action.priority}</div>
                </td>
                <td class="apollo__table-cell">${contextChecklist}</td>
                <td class="apollo__table-cell">${action.success_prediction}%</td>
            `;
            
            return row;
        }
        
        function createContextChecklist(components, contextUsage) {
            const items = [
                { name: 'Role', ready: components.role },
                { name: 'Task', ready: components.task },
                { name: 'Criteria', ready: components.criteria },
                { name: 'Tools', ready: components.tools },
                { name: 'Memories', ready: components.memories },
                { name: 'Query', ready: components.query },
                { name: 'Data', ready: components.data }
            ];
            
            const checklist = items.map(item => {
                const icon = item.ready ? '✓' : '⏳';
                const className = item.ready ? 'apollo__checklist-icon--complete' : 'apollo__checklist-icon--pending';
                return `<span class="apollo__checklist-item"><span class="${className}">${icon}</span> ${item.name}</span>`;
            }).join('');
            
            // Add sunset indicator if context usage is high
            const sunsetIndicator = contextUsage > 50 ? 
                '<span class="apollo__sunset-indicator" title="Context approaching sunset">🌅</span>' : '';
            
            return `<div class="apollo__context-checklist">${checklist}${sunsetIndicator}</div>`;
        }
        
        // Initialize on first load
        startAutoRefresh();
        
        // Protocol Dialog Functions - Dynamic creation like Telos
        window.openProtocolDialog = function() {
            const modal = createProtocolModal('Add New Protocol');
            document.body.appendChild(modal);
        };
        
        window.configureProtocol = function(protocolName) {
            const modal = createProtocolModal('Configure Protocol', protocolName);
            document.body.appendChild(modal);
        };
        
        window.closeProtocolDialog = function() {
            const modal = document.querySelector('.apollo__modal-overlay');
            if (modal) {
                modal.remove();
            }
        };
        
        function createProtocolModal(title, protocolName = null) {
            const modal = document.createElement('div');
            modal.className = 'apollo__modal-overlay';
            
            modal.innerHTML = `
                <div class="apollo__modal-content">
                    <div class="apollo__modal-header">
                        <h3 class="apollo__modal-title">${title}</h3>
                        <button class="apollo__modal-close" onclick="closeProtocolDialog()">×</button>
                    </div>
                    
                    <div class="apollo__modal-body">
                        <div class="apollo__protocol-form">
                            <div class="apollo__form-group">
                                <label for="protocol-name">Protocol Name:</label>
                                <input type="text" id="protocol-name" class="apollo__input" 
                                       placeholder="e.g., Response Quality Check" 
                                       value="${protocolName || ''}">
                            </div>
                            
                            <div class="apollo__form-group">
                                <label for="protocol-type">Protocol Type:</label>
                                <select id="protocol-type" class="apollo__select">
                                    <option value="optimization">Optimization</option>
                                    <option value="validation">Validation</option>
                                    <option value="lifecycle">Lifecycle</option>
                                    <option value="monitoring">Monitoring</option>
                                    <option value="safety">Safety</option>
                                </select>
                            </div>
                            
                            <div class="apollo__form-group">
                                <label for="protocol-description">Description:</label>
                                <textarea id="protocol-description" class="apollo__textarea" rows="3" 
                                          placeholder="Describe what this protocol does..."></textarea>
                            </div>
                            
                            <div class="apollo__form-group">
                                <label for="protocol-template">Protocol Definition:</label>
                                <div class="apollo__template-hint">Use the template below as a guide</div>
                                <textarea id="protocol-template" class="apollo__textarea apollo__code-editor" 
                                          rows="15">${getProtocolTemplate(protocolName)}</textarea>
                            </div>
                            
                            <div class="apollo__form-group">
                                <label for="protocol-effectiveness">Initial Effectiveness (%):</label>
                                <div class="apollo__range-group">
                                    <input type="range" id="protocol-effectiveness" min="0" max="100" value="80" 
                                           class="apollo__range" onchange="updateEffectivenessValue(this.value)">
                                    <span class="apollo__range-value" id="effectiveness-value">80%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="apollo__modal-footer">
                        <button class="apollo__modal-button apollo__modal-button--blue" onclick="clearProtocolForm()">Clear</button>
                        <button class="apollo__modal-button apollo__modal-button--purple" onclick="saveProtocol()">Save</button>
                    </div>
                </div>
            `;
            
            return modal;
        }
        
        window.updateEffectivenessValue = function(value) {
            const valueSpan = document.getElementById('effectiveness-value');
            if (valueSpan) {
                valueSpan.textContent = value + '%';
            }
        };
        
        window.clearProtocolForm = function() {
            document.getElementById('protocol-name').value = '';
            document.getElementById('protocol-type').value = 'optimization';
            document.getElementById('protocol-description').value = '';
            document.getElementById('protocol-template').value = getProtocolTemplate();
            document.getElementById('protocol-effectiveness').value = 80;
            updateEffectivenessValue(80);
        };
        
        window.saveProtocol = async function() {
            const name = document.getElementById('protocol-name').value;
            const type = document.getElementById('protocol-type').value;
            const description = document.getElementById('protocol-description').value;
            const template = document.getElementById('protocol-template').value;
            const effectiveness = document.getElementById('protocol-effectiveness').value;
            
            if (!name || !description) {
                TektonModal.warning('Please fill in all required fields');
                return;
            }
            
            try {
                // Create protocol via API
                const response = await fetch(apolloUrl('/api/v1/protocols'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        type,
                        description,
                        definition: template,
                        effectiveness: parseInt(effectiveness)
                    })
                });
                
                if (response.ok) {
                    closeProtocolDialog();
                    updateProtocols(); // Refresh the protocols list
                } else {
                    TektonModal.error('Failed to save protocol');
                }
            } catch (error) {
                console.error('Error saving protocol:', error);
                TektonModal.error('Error saving protocol');
            }
        };
        
        function getProtocolTemplate(name) {
            const template = `{
    "name": "${name || 'Protocol Name'}",
    "type": "optimization|validation|lifecycle|monitoring|safety",
    "description": "Clear description of what this protocol does",
    "scope": "context|session|global",
    "triggers": {
        "conditions": [
            {
                "metric": "context_usage_percent",
                "operator": ">",
                "value": 80
            }
        ],
        "frequency": "on_change|periodic|manual"
    },
    "actions": [
        {
            "type": "compress_context|reset_session|adjust_parameters",
            "parameters": {
                "compression_level": "light|medium|aggressive",
                "preserve_critical": true
            }
        }
    ],
    "monitoring": {
        "metrics": ["token_usage", "response_quality", "context_coherence"],
        "alert_thresholds": {
            "critical": 90,
            "warning": 70
        }
    },
    "effectiveness_tracking": {
        "success_criteria": "Metric improvement > 20%",
        "evaluation_window": "5 minutes"
    }
}`;
            return template;
        }
        
        // Update effectiveness display
        const effectivenessSlider = document.getElementById('protocol-effectiveness');
        const effectivenessValue = document.getElementById('effectiveness-value');
        if (effectivenessSlider) {
            effectivenessSlider.addEventListener('input', function() {
                effectivenessValue.textContent = this.value + '%';
            });
        }
    }
    
    // CHAT FUNCTIONALITY - Following Terma's pattern - moved outside initializeApollo for global access
    // Initialize unified chat components
    function apollo_initChats() {
        console.log('[Apollo] Initializing unified chat components');
        
        // Check if modules are loaded, if not, wait and retry
        if (!window.SingleChat || !window.TeamChat) {
            console.log('[Apollo] Chat modules not loaded yet, waiting...');
            setTimeout(function() {
                apollo_initChats(); // Retry
            }, 100);
            return;
        }
        
        const attentionChatEl = document.getElementById('attention-messages');
        const teamChatEl = document.getElementById('teamchat-messages');
        
        if (window.SingleChat && attentionChatEl) {
            window.SingleChat.init(attentionChatEl, 'apollo', 'chat-message');
            console.log('[Apollo] SingleChat initialized for attention chat');
        }
        
        if (window.TeamChat && teamChatEl) {
            window.TeamChat.init(teamChatEl, 'apollo', 'chat-message');
            console.log('[Apollo] TeamChat initialized');
        }
    }

    function apollo_sendChat() {
        const input = document.getElementById('apollo-chat-input');
        const message = input.value.trim();
        if (!message) return;
        
        const attentionRadio = document.getElementById('apollo-tab-attention');
        const teamRadio = document.getElementById('apollo-tab-teamchat');
        const attentionActive = attentionRadio ? attentionRadio.checked : false;
        const teamActive = teamRadio ? teamRadio.checked : false;
        
        // If we're not on a chat tab, switch to attention chat first
        if (!attentionActive && !teamActive) {
            if (attentionRadio) {
                attentionRadio.checked = true;
            }
            // Small delay to let the CSS transition complete
            setTimeout(() => {
                const attentionChatEl = document.getElementById('attention-messages');
                if (window.SingleChat && attentionChatEl) {
                    window.SingleChat.sendMessage(attentionChatEl, message);
                }
                input.value = '';
            }, 100);
            return;
        }
        
        // Normal chat behavior when already on a chat tab
        if (attentionActive) {
            const attentionChatEl = document.getElementById('attention-messages');
            if (window.SingleChat && attentionChatEl) {
                window.SingleChat.sendMessage(attentionChatEl, message);
            }
        } else if (teamActive) {
            const teamChatEl = document.getElementById('teamchat-messages');
            if (window.TeamChat && teamChatEl) {
                window.TeamChat.sendMessage(teamChatEl, message);
            }
        }
        
        input.value = '';
    }
    
    // Add event handlers for chat
    const sendButton = document.getElementById('apollo-send-button');
    if (sendButton) {
        sendButton.addEventListener('click', function(e) {
            e.preventDefault();
            apollo_sendChat();
        });
    }
    
    // Enter key handler for chat input
    const chatInput = document.getElementById('apollo-chat-input');
    if (chatInput) {
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                apollo_sendChat();
            }
        });
    }
    
    
    // Initialize Apollo on load
    initializeApollo();
    
    // Initialize unified chat components
    apollo_initChats();
})();
</script>
