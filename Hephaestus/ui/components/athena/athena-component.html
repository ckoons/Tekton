<!-- Athena Component - Knowledge Graph -->

<!-- Load chat dependencies -->
<script src="/scripts/shared/ai-chat.js"></script>
<script src="/scripts/tekton-urls.js"></script>
<script src="/scripts/shared/single-chat.js"></script>
<script src="/scripts/shared/team-chat.js"></script>

<!-- Hidden radio inputs for CSS-first tab functionality -->
<input type="radio" name="athena-tab" id="athena-tab-graph" checked style="display: none;">
<input type="radio" name="athena-tab" id="athena-tab-entities" style="display: none;">
<input type="radio" name="athena-tab" id="athena-tab-query" style="display: none;">
<input type="radio" name="athena-tab" id="athena-tab-chat" style="display: none;">
<input type="radio" name="athena-tab" id="athena-tab-teamchat" style="display: none;">

<div class="athena">
    <!-- Component Header with Title -->
    <div class="athena__header">
        <div class="athena__title-container">
            <img src="/images/hexagon.jpg" alt="Tekton" class="athena__icon">
            <h2 class="athena__title">
                <span class="athena__title-main">Athena</span>
                <span class="athena__title-sub">Knowledge</span>
            </h2>
        </div>
    </div>
    
    <!-- Menu Bar -->
    <div class="athena__menu-bar">
        <div class="athena__tabs">
            <label for="athena-tab-graph" class="athena__tab">
                <span class="athena__tab-label">Knowledge Graph</span>
            </label>
            <label for="athena-tab-entities" class="athena__tab">
                <span class="athena__tab-label">Entities</span>
            </label>
            <label for="athena-tab-query" class="athena__tab">
                <span class="athena__tab-label">Query Builder</span>
            </label>
            <label for="athena-tab-chat" class="athena__tab">
                <span class="athena__tab-label">Knowledge Chat</span>
            </label>
            <label for="athena-tab-teamchat" class="athena__tab">
                <span class="athena__tab-label">Team Chat</span>
            </label>
        </div>
    </div>
    
    <!-- Content Area -->
    <div class="athena__content">
        <!-- Knowledge Graph Panel -->
        <div id="graph-panel" class="athena__panel">
            <div class="athena__graph">
                <div class="athena__control-bar">
                    <div class="athena__graph-stats-inline">
                        <span class="athena__stats-title">Knowledge Graph</span>
                        <span class="athena__stats-count"><span id="total-entities">0</span> entities</span>
                        <span class="athena__stats-count"><span id="total-components">0</span> components</span>
                    </div>
                    <div class="athena__search-container">
                        <input type="text" placeholder="Search entities..." class="athena__search-input">
                        <button class="athena__search-button">Search</button>
                    </div>
                    <div class="athena__layout-selector">
                        <label for="graph-layout-select" class="athena__layout-label">Layout:</label>
                        <select id="graph-layout-select" class="athena__layout-select">
                            <option value="force">Force-Directed</option>
                            <option value="hierarchical">Hierarchical</option>
                            <option value="circular">Circular</option>
                            <option value="grouped">Grouped by Type</option>
                            <option value="spring">Spring Layout</option>
                        </select>
                    </div>
                </div>
                <div id="graph-container" class="athena__graph-container">
                    <!-- Main graph visualization -->
                    <svg id="graph-svg" class="athena__graph-svg" width="100%" height="100%" viewBox="0 0 2000 1400" preserveAspectRatio="xMidYMid meet">
                        <defs>
                            <!-- Arrowhead marker for directed edges -->
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                    refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                            </marker>
                            
                            <!-- Glow filter for hover effects -->
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        
                        <!-- Graph content will be injected here -->
                        <g id="graph-edges"></g>
                        <g id="graph-nodes"></g>
                    </svg>
                    
                    <!-- Initial placeholder -->
                    <div id="graph-placeholder" class="athena__graph-placeholder">
                        <div style="text-align: center; padding: 2rem;">
                            <h2 style="color: #999;">Knowledge Graph</h2>
                            <p style="color: #777;">Loading graph visualization...</p>
                        </div>
                    </div>
                    
                    <!-- Code/Landmark Popup (hidden by default) -->
                    <input type="radio" name="popup-view" id="popup-landmarks" checked style="display: none;">
                    <input type="radio" name="popup-view" id="popup-code" style="display: none;">
                    
                    <div id="node-popup" class="athena__node-popup" style="display: none;">
                        <div class="athena__popup-header">
                            <h4 class="athena__popup-title">Component</h4>
                            <button class="athena__popup-close" onclick="document.getElementById('node-popup').style.display='none'">√ó</button>
                        </div>
                        
                        <div class="athena__popup-toggle">
                            <label for="popup-landmarks" class="athena__popup-toggle-btn">Landmarks</label>
                            <label for="popup-code" class="athena__popup-toggle-btn">Code</label>
                        </div>
                        
                        <div class="athena__popup-content athena__popup-content--landmarks">
                            <div class="athena__popup-location">üìÅ Location: <span id="popup-location">/Component</span></div>
                            <pre id="popup-landmarks-content">Loading landmarks...</pre>
                        </div>
                        
                        <div class="athena__popup-content athena__popup-content--code">
                            <div class="athena__popup-location">üìÑ File: <span id="popup-file">/Component/__main__.py</span></div>
                            <pre id="popup-code-content">Loading code...</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Entities Panel -->
        <div id="entities-panel" class="athena__panel">
            <div class="athena__entities">
                <div class="athena__control-bar">
                    <div class="athena__search-container">
                        <input type="text" placeholder="Search entities..." class="athena__search-input">
                        <button class="athena__search-button">Search</button>
                    </div>
                </div>
                <div class="athena__entity-list-container">
                    <div id="entity-list-items" class="athena__entity-list">
                        <div class="athena__empty-state">
                            <p>No entities loaded. Connect to Athena service.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Query Builder Panel -->
        <div id="query-panel" class="athena__panel">
            <div class="athena__query-builder">
                <div class="athena__query-header">
                    <h3>Query Builder</h3>
                    <p>Build complex knowledge graph queries with visual assistance</p>
                </div>
                
                <div class="athena__query-form">
                    <div class="athena__query-section">
                        <label class="athena__query-label">Entity Type</label>
                        <select id="entity-type-select" class="athena__query-select">
                            <option value="any">Any Type</option>
                            <option value="tekton_component">Tekton Component</option>
                            <option value="integration_pattern">Integration Pattern</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="athena__query-section">
                        <label class="athena__query-label">Relationship Type</label>
                        <select id="relationship-type-select" class="athena__query-select">
                            <option value="any">Any Relationship</option>
                            <option value="uses">Uses</option>
                            <option value="provides">Provides</option>
                            <option value="connects_to">Connects To</option>
                            <option value="depends_on">Depends On</option>
                        </select>
                    </div>
                    
                    <div class="athena__query-section">
                        <label class="athena__query-label">Search Terms</label>
                        <input type="text" id="search-terms-input" class="athena__query-input" 
                               placeholder="Enter keywords to search...">
                    </div>
                    
                    <div class="athena__query-options">
                        <label class="athena__query-checkbox">
                            <input type="checkbox" id="include-archived">
                            <span>Include archived entities</span>
                        </label>
                        <label class="athena__query-checkbox">
                            <input type="checkbox" id="exact-match">
                            <span>Exact match only</span>
                        </label>
                    </div>
                    
                    <div class="athena__query-actions">
                        <button id="build-query-btn" class="athena__query-button athena__query-button--primary">
                            Build Query
                        </button>
                        <button id="clear-query-btn" class="athena__query-button athena__query-button--secondary">
                            Clear
                        </button>
                    </div>
                </div>
                
                <div id="query-result-container" class="athena__query-result" style="display: none;">
                    <div class="athena__query-result-header">
                        <h4>Generated Query</h4>
                        <div class="athena__query-result-actions">
                            <button id="copy-query-btn" class="athena__query-button athena__query-button--small">
                                Copy Query
                            </button>
                            <button id="execute-query-btn" class="athena__query-button athena__query-button--small athena__query-button--primary">
                                Execute
                            </button>
                        </div>
                    </div>
                    <div class="athena__query-code">
                        <pre id="generated-query"></pre>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Knowledge Chat Panel -->
        <div id="chat-panel" class="athena__panel athena__panel--chat">
            <div class="chat-interface">
                <div class="chat-messages" id="athena-chat-messages">
                    <div class="chat-message system-message">
                        <strong>Athena:</strong> Hello! I'm Athena, your knowledge graph CI assistant. I specialize in understanding relationships, patterns, and connections across the Tekton system. How can I help you explore our knowledge today?
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Team Chat Panel -->
        <div id="teamchat-panel" class="athena__panel athena__panel--team">
            <div class="chat-interface">
                <div class="chat-messages" id="athena-teamchat-messages">
                    <div class="chat-message system-message">
                        <strong>System:</strong> Team Chat allows Athena to coordinate with other CI specialists about knowledge graph insights.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer with Chat Input -->
    <div class="athena__footer">
        <div class="athena__chat-input-container">
            <div class="athena__chat-prompt">></div>
            <input type="text" class="athena__chat-input" id="athena-chat-input"
                   placeholder="Chat with Athena - your knowledge graph CI assistant"
                   onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); athena_sendChat(); }">
            <button class="athena__send-button" id="athena-send-button" onclick="athena_sendChat(); return false;">Send</button>
        </div>
    </div>
</div>

<style>
/* Athena Component Styles - Following Terma's BEM Pattern */

/* Container */
.athena {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
    background-color: var(--bg-primary, #1e1e2e);
    color: var(--text-primary, #f0f0f0);
    /* No absolute positioning - proper component containment */
}

/* Header */
.athena__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 16px;
    background-color: var(--bg-secondary, #252535);
    border-bottom: 1px solid var(--border-color, #444444);
}

.athena__title-container {
    display: flex;
    align-items: center;
}

.athena__icon {
    height: 30px;
    width: auto;
    margin-right: 12px;
}

.athena__title {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 500;
}

.athena__title-main {
    font-weight: 600;
}

.athena__title-sub {
    margin-left: 8px;
    opacity: 0.8;
    font-weight: normal;
}

/* Menu Bar */
.athena__menu-bar {
    display: flex;
    background-color: var(--bg-secondary, #252535);
    border-bottom: 1px solid var(--border-color, #444444);
    padding: 0 16px;
}

.athena__tabs {
    display: flex;
    gap: 8px;
}

.athena__tab {
    padding: 16px;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    color: var(--text-secondary, #aaaaaa);
    font-weight: 500;
    transition: all 0.3s ease;
}

.athena__tab:hover {
    color: var(--text-primary, #f0f0f0);
    background-color: rgba(123, 31, 162, 0.05);
}

/* Active state handled by radio button logic */

/* Content Area */
.athena__content {
    flex: 1;
    overflow: hidden;
    position: relative;
    padding-bottom: 70px; /* Account for footer height */
}

/* Panel styling - hidden by default */
.athena__panel {
    display: none;
    height: 100%;
    overflow: auto;
    padding: 0;
    position: relative;
}

/* Radio button logic for tab switching */
#athena-tab-graph:checked ~ .athena #graph-panel,
#athena-tab-entities:checked ~ .athena #entities-panel,
#athena-tab-query:checked ~ .athena #query-panel {
    display: block;
}

#athena-tab-chat:checked ~ .athena .athena__panel--chat,
#athena-tab-teamchat:checked ~ .athena .athena__panel--team {
    display: flex;
    flex-direction: column;
}

/* Active tab styling */
#athena-tab-graph:checked ~ .athena .athena__tab[for="athena-tab-graph"],
#athena-tab-entities:checked ~ .athena .athena__tab[for="athena-tab-entities"],
#athena-tab-query:checked ~ .athena .athena__tab[for="athena-tab-query"],
#athena-tab-chat:checked ~ .athena .athena__tab[for="athena-tab-chat"],
#athena-tab-teamchat:checked ~ .athena .athena__tab[for="athena-tab-teamchat"] {
    color: var(--text-primary, #f0f0f0);
    border-bottom-color: #7B1FA2;
    background-color: rgba(123, 31, 162, 0.05);
}

/* Control Bar */
.athena__control-bar {
    display: flex;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-secondary, #252535);
    border-bottom: 1px solid var(--border-color, #444444);
    align-items: center;
    margin: 0;
    position: sticky;
    top: 0;
    z-index: 10;
}

/* Graph Panel */
.athena__graph {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.athena__graph-container {
    flex: 1;
    background: #000000;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 16px;
    border-radius: 8px;
    position: relative;
    overflow: auto;
}

/* Entities Panel */
.athena__entities {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.athena__entity-list-container {
    flex: 1;
    background: #000000;
    border-radius: 8px;
    padding: 16px;
    margin: 16px;
    overflow-y: auto;
}

/* Query Builder */
.athena__query-builder {
    padding: 24px;
    margin: 16px;
    background: #000000;
    border-radius: 8px;
    text-align: center;
}

/* Control Bar */
.athena__control-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    background-color: var(--bg-secondary, #252535);
    border-bottom: 1px solid var(--border-color, #444444);
}

/* Inline Graph Stats */
.athena__graph-stats-inline {
    display: flex;
    align-items: center;
    gap: 16px;
    flex: 0 0 auto;
}

.athena__stats-title {
    font-weight: 600;
    color: #7B1FA2;
    font-size: 20px;
}

.athena__stats-count {
    color: var(--text-secondary, #aaaaaa);
    font-size: 18px;
}

.athena__stats-count span {
    color: #7B1FA2;
    font-weight: 600;
}

/* Search */
.athena__search-container {
    display: flex;
    gap: 8px;
    flex: 1;
    max-width: 400px;
}

.athena__search-input {
    flex: 1;
    padding: 4px 12px;
    background: var(--bg-tertiary, #1a1a2a);
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    color: var(--text-primary, #f0f0f0);
    height: 28px;
}

.athena__search-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 12px;
    background-color: #7B1FA2;
    border: 1px solid #8E24AA;
    border-radius: 4px;
    color: #ffffff;
    cursor: pointer;
    height: 26px;
    font-size: 13px;
}

/* Layout Selector */
.athena__layout-selector {
    display: flex;
    align-items: center;
    gap: 8px;
}

.athena__layout-label {
    color: var(--text-secondary, #aaaaaa);
    font-size: 13px;
    font-weight: 500;
}

.athena__layout-select {
    padding: 4px 8px;
    background-color: var(--bg-tertiary, #1a1a2a);
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    color: var(--text-primary, #f0f0f0);
    font-size: 13px;
    height: 28px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.athena__layout-select:hover {
    border-color: #7B1FA2;
}

.athena__layout-select:focus {
    outline: none;
    border-color: #7B1FA2;
    box-shadow: 0 0 0 2px rgba(123, 31, 162, 0.2);
}

.athena__layout-select option {
    background-color: var(--bg-tertiary, #1a1a2a);
    color: var(--text-primary, #f0f0f0);
}

/* Chat Interface */
.chat-interface {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
}

.chat-messages {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.chat-message {
    margin-bottom: 12px;
    padding: 8px 12px;
    border-radius: 4px;
    background-color: transparent;
    position: relative;
}

.chat-message strong {
    display: inline-block;
    margin-right: 8px;
    font-weight: 600;
}

/* System messages */
.chat-message.system-message {
    background-color: rgba(123, 31, 162, 0.05);
    border-left: 3px solid #7B1FA2;
    font-style: italic;
}

.chat-message.system-message strong {
    color: #7B1FA2;
}

/* User messages */
.chat-message.user-message {
    background-color: rgba(76, 175, 80, 0.05);
    border-left: 3px solid #4CAF50;
    margin-left: 0;
}

.chat-message.user-message strong {
    color: #4CAF50;
}

/* CI messages */
.chat-message.ai-message {
    background-color: rgba(123, 31, 162, 0.05);
    border-left: 3px solid #7B1FA2;
    margin-right: 0;
}

.chat-message.ai-message strong {
    color: #7B1FA2;
}

/* Footer with Chat Input */
.athena__footer {
    background-color: var(--bg-secondary, #252535);
    border-top: 1px solid var(--border-color, #444444);
    padding: 12px 16px;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 70px; /* Fixed height to match chat area */
}

.athena__chat-input-container {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
}

.athena__chat-prompt {
    font-size: 18px;
    font-weight: bold;
    color: #7B1FA2; /* Purple for Athena */
}

.athena__chat-input {
    flex: 1;
    height: 44px;
    padding: 8px 16px;
    background-color: var(--bg-tertiary, #1a1a2a);
    border: 1px solid var(--border-color, #444444);
    border-radius: 8px;
    color: var(--text-primary, #f0f0f0);
    font-size: 14px;
    transition: border-color 0.2s ease;
}

.athena__chat-input:focus {
    outline: none;
    border-color: #7B1FA2;
}

.athena__chat-input::placeholder {
    color: var(--text-secondary, #888888);
}

.athena__send-button {
    padding: 12px 24px;
    background-color: #7B1FA2;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: background-color 0.3s ease;
}

.athena__send-button:hover {
    background-color: #8E24AA;
}

/* Entity Item Styling */
.athena__entity-item {
    background-color: var(--bg-secondary, #252535);
    border: 1px solid var(--border-color, #444444);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.3s ease;
}

.athena__entity-item:hover {
    background-color: rgba(123, 31, 162, 0.1);
    border-color: #7B1FA2;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(123, 31, 162, 0.2);
}

.athena__entity-item h4 {
    margin: 0 0 8px 0;
    color: #7B1FA2;
    font-size: 1.1rem;
    font-weight: 600;
}

.athena__entity-item p {
    margin: 4px 0;
    color: var(--text-secondary, #aaaaaa);
    font-size: 0.9rem;
}

.athena__entity-item p:last-child {
    margin-bottom: 0;
}

/* Entity type badge */
.athena__entity-type {
    display: inline-block;
    background-color: rgba(123, 31, 162, 0.2);
    color: #7B1FA2;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
    margin-top: 4px;
}

/* Graph visualization styling */
.athena__graph-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #000000;
}

/* Graph container positioning */
/* Graph container is already styled above */

/* SVG Graph Styling */
.athena__graph-svg {
    display: none; /* Hidden until data loads */
    width: 100%;
    height: 100%;
}

/* Node styling */
.athena__graph-node {
    cursor: pointer;
    transition: all 0.3s ease;
}

.athena__graph-node:hover {
    filter: url(#glow);
}

.athena__graph-node-circle {
    fill: #7B1FA2;
    stroke: #8E24AA;
    stroke-width: 2;
}

.athena__graph-node-circle.pattern {
    fill: #00BFA5;
    stroke: #00E5CC;
}

.athena__graph-node-circle.other {
    fill: #666;
    stroke: #888;
}

.athena__graph-node-label {
    fill: var(--text-primary, #f0f0f0);
    font-size: 12px;
    text-anchor: middle;
    pointer-events: none;
}

/* Edge styling */
.athena__graph-edge {
    stroke: #444;
    stroke-width: 1;
    fill: none;
    opacity: 0.6;
    transition: all 0.3s ease;
}

.athena__graph-edge:hover {
    stroke: #7B1FA2;
    stroke-width: 2;
    opacity: 1;
}

/* Highlighted state for search */
.athena__graph-node.highlighted .athena__graph-node-circle {
    stroke: #FFD700;
    stroke-width: 3;
}

.athena__graph-node.dimmed {
    opacity: 0.3;
}

/* Query Builder Styling */
.athena__query-builder {
    padding: 24px;
    max-width: 800px;
    margin: 0 auto;
}

.athena__query-header {
    text-align: center;
    margin-bottom: 32px;
}

.athena__query-header h3 {
    font-size: 1.5rem;
    color: #7B1FA2;
    margin-bottom: 8px;
}

.athena__query-header p {
    color: var(--text-secondary, #aaaaaa);
}

.athena__query-form {
    background-color: var(--bg-secondary, #252535);
    border: 1px solid var(--border-color, #444444);
    border-radius: 12px;
    padding: 24px;
}

.athena__query-section {
    margin-bottom: 20px;
}

.athena__query-label {
    display: block;
    margin-bottom: 8px;
    color: var(--text-primary, #f0f0f0);
    font-weight: 500;
    font-size: 0.9rem;
}

.athena__query-select,
.athena__query-input {
    width: 100%;
    padding: 10px 12px;
    background-color: var(--bg-tertiary, #1a1a2a);
    border: 1px solid var(--border-color, #444444);
    border-radius: 6px;
    color: var(--text-primary, #f0f0f0);
    font-size: 14px;
    transition: all 0.3s ease;
}

.athena__query-select:focus,
.athena__query-input:focus {
    outline: none;
    border-color: #7B1FA2;
    box-shadow: 0 0 0 2px rgba(123, 31, 162, 0.2);
}

.athena__query-select option {
    background-color: var(--bg-tertiary, #1a1a2a);
    color: var(--text-primary, #f0f0f0);
}

.athena__query-options {
    display: flex;
    gap: 24px;
    margin: 24px 0;
}

.athena__query-checkbox {
    display: flex;
    align-items: center;
    cursor: pointer;
    color: var(--text-secondary, #aaaaaa);
    font-size: 0.9rem;
}

.athena__query-checkbox input[type="checkbox"] {
    margin-right: 8px;
    width: 16px;
    height: 16px;
    accent-color: #7B1FA2;
}

.athena__query-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 24px;
}

.athena__query-button {
    padding: 10px 24px;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    font-size: 14px;
}

.athena__query-button--primary {
    background-color: #7B1FA2;
    color: white;
}

.athena__query-button--primary:hover {
    background-color: #8E24AA;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(123, 31, 162, 0.3);
}

.athena__query-button--secondary {
    background-color: var(--bg-tertiary, #1a1a2a);
    color: var(--text-primary, #f0f0f0);
    border: 1px solid var(--border-color, #444444);
}

.athena__query-button--secondary:hover {
    background-color: var(--bg-secondary, #252535);
    border-color: #666;
}

.athena__query-button--small {
    padding: 6px 16px;
    font-size: 12px;
}

/* Query Result Styling */
.athena__query-result {
    margin-top: 32px;
    background-color: var(--bg-secondary, #252535);
    border: 1px solid var(--border-color, #444444);
    border-radius: 12px;
    padding: 24px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.athena__query-result h4 {
    color: #7B1FA2;
    margin-bottom: 16px;
    font-size: 1.1rem;
}

.athena__query-result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.athena__query-result-header h4 {
    margin: 0;
    color: #7B1FA2;
    font-size: 1.1rem;
}

.athena__query-result-actions {
    display: flex;
    gap: 8px;
}

.athena__query-code {
    background-color: #000000;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 16px;
}

.athena__query-code pre {
    margin: 0;
    color: #4CAF50;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 13px;
    line-height: 1.5;
    white-space: pre-wrap;
}

/* Node Popup Styling */
.athena__node-popup {
    position: absolute;
    background-color: rgba(37, 37, 53, 0.98);
    border: 1px solid #7B1FA2;
    border-radius: 12px;
    padding: 0;
    width: 450px;
    max-height: 500px;
    z-index: 1000;
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(123, 31, 162, 0.3);
    overflow: hidden;
}

.athena__popup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background-color: rgba(123, 31, 162, 0.1);
    border-bottom: 1px solid rgba(123, 31, 162, 0.3);
}

.athena__popup-title {
    margin: 0;
    color: #7B1FA2;
    font-size: 1.1rem;
}

.athena__popup-close {
    background: none;
    border: none;
    color: #999;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.athena__popup-close:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: #fff;
}

/* Toggle Buttons */
.athena__popup-toggle {
    display: flex;
    gap: 0;
    margin: 16px;
    background-color: var(--bg-tertiary, #1a1a2a);
    border-radius: 6px;
    overflow: hidden;
}

.athena__popup-toggle-btn {
    flex: 1;
    padding: 8px 16px;
    text-align: center;
    cursor: pointer;
    background-color: transparent;
    color: #999;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    font-weight: 500;
}

.athena__popup-toggle-btn:hover {
    background-color: rgba(123, 31, 162, 0.1);
}

/* Active toggle state */
#popup-landmarks:checked ~ .athena__node-popup .athena__popup-toggle-btn[for="popup-landmarks"],
#popup-code:checked ~ .athena__node-popup .athena__popup-toggle-btn[for="popup-code"] {
    background-color: #7B1FA2;
    color: white;
}

/* Content Areas */
.athena__popup-content {
    display: none;
    padding: 16px;
    max-height: 350px;
    overflow-y: auto;
}

/* Show content based on radio selection */
#popup-landmarks:checked ~ .athena__node-popup .athena__popup-content--landmarks,
#popup-code:checked ~ .athena__node-popup .athena__popup-content--code {
    display: block;
}

.athena__popup-location {
    margin-bottom: 12px;
    color: var(--text-secondary, #aaa);
    font-size: 0.9rem;
}

.athena__popup-content pre {
    margin: 0;
    padding: 12px;
    background-color: #000;
    border: 1px solid #333;
    border-radius: 6px;
    color: #4CAF50;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 12px;
    line-height: 1.5;
    overflow-x: auto;
}

/* Scrollbar styling for popup */
.athena__popup-content::-webkit-scrollbar {
    width: 8px;
}

.athena__popup-content::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
}

.athena__popup-content::-webkit-scrollbar-thumb {
    background: #7B1FA2;
    border-radius: 4px;
}

.athena__popup-content::-webkit-scrollbar-thumb:hover {
    background: #8E24AA;
}

/* Query Results Styling */
.athena__query-results-section {
    margin-top: 24px;
    background-color: var(--bg-secondary, #252535);
    border: 1px solid var(--border-color, #444444);
    border-radius: 12px;
    padding: 24px;
    animation: slideIn 0.3s ease-out;
}

.athena__query-results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.athena__query-results-header h4 {
    margin: 0;
    color: #7B1FA2;
    font-size: 1.1rem;
}

.athena__query-results-summary {
    padding: 12px;
    background-color: rgba(123, 31, 162, 0.1);
    border-radius: 6px;
    margin-bottom: 16px;
    color: var(--text-primary, #f0f0f0);
}

.athena__query-results-content {
    max-height: 400px;
    overflow-y: auto;
}

.athena__query-results-list h5 {
    color: #7B1FA2;
    margin: 16px 0 8px 0;
    font-size: 0.95rem;
}

.athena__query-results-entities,
.athena__query-results-relationships {
    list-style: none;
    padding: 0;
    margin: 0 0 16px 0;
}

.athena__query-results-entities li,
.athena__query-results-relationships li {
    padding: 8px 12px;
    margin-bottom: 4px;
    background-color: var(--bg-tertiary, #1a1a2a);
    border-radius: 4px;
    border-left: 3px solid #7B1FA2;
    transition: all 0.2s ease;
}

.athena__query-results-entities li:hover,
.athena__query-results-relationships li:hover {
    background-color: rgba(123, 31, 162, 0.1);
    transform: translateX(4px);
}

.athena__result-name {
    color: #7B1FA2;
    font-weight: 600;
}

.athena__result-type {
    color: var(--text-secondary, #aaa);
    font-size: 0.85rem;
}

.athena__result-source,
.athena__result-target {
    color: var(--text-primary, #f0f0f0);
    font-weight: 500;
}

.athena__result-rel {
    color: #4CAF50;
    font-style: italic;
}

.athena__result-arrow {
    color: #666;
    margin: 0 4px;
}

.athena__no-results {
    text-align: center;
    color: var(--text-secondary, #aaa);
    padding: 32px;
    font-style: italic;
}

.athena__graph-stats {
    background-color: var(--bg-secondary, #252535);
    border: 1px solid var(--border-color, #444444);
    border-radius: 12px;
    padding: 32px;
    text-align: center;
    max-width: 600px;
    margin: 0 auto;
}

.athena__graph-stats h2 {
    color: #7B1FA2;
    margin-bottom: 24px;
    font-size: 1.8rem;
}

.athena__graph-stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-top: 24px;
}

.athena__stat-card {
    background-color: rgba(123, 31, 162, 0.05);
    border: 1px solid rgba(123, 31, 162, 0.2);
    border-radius: 8px;
    padding: 16px;
    transition: all 0.3s ease;
}

.athena__stat-card:hover {
    background-color: rgba(123, 31, 162, 0.1);
    transform: scale(1.02);
}

.athena__stat-number {
    font-size: 2rem;
    font-weight: 600;
    color: #7B1FA2;
    display: block;
}

.athena__stat-label {
    font-size: 0.9rem;
    color: var(--text-secondary, #aaaaaa);
    margin-top: 4px;
}
</style>

<script>
// Initialize Athena data when component loads - minimal JS, just HTML injection
(function() {
    console.log('[ATHENA] Loading data from Athena service...');
    
    var allEntities = [];
    var graphData = null;
    
    // Simple function to load entities and update HTML
    function loadAthenaData() {
        // Check if athenaUrl is available
        if (typeof window.athenaUrl !== 'function') {
            console.log('[ATHENA] Waiting for athenaUrl function...');
            setTimeout(loadAthenaData, 500);
            return;
        }
        
        // Load graph visualization data
        fetch(window.athenaUrl('/api/v1/visualization/graph'))
            .then(response => response.json())
            .then(data => {
                console.log('[ATHENA] Loaded graph data:', data);
                graphData = data;
                
                // Update inline stats
                var totalEntities = data.entities ? data.entities.length : 0;
                var componentCount = data.entities ? data.entities.filter(e => e.entity_type === 'tekton_component').length : 0;
                
                var totalElement = document.getElementById('total-entities');
                var componentsElement = document.getElementById('total-components');
                if (totalElement) totalElement.textContent = totalEntities;
                if (componentsElement) componentsElement.textContent = componentCount;
                
                // Render the graph
                renderGraph(data);
            })
            .catch(error => {
                console.error('[ATHENA] Error loading graph data:', error);
            });
        
        // Load entities for list and search
        fetch(window.athenaUrl('/api/v1/entities/?limit=1000'))
            .then(response => response.json())
            .then(entities => {
                console.log('[ATHENA] Loaded ' + entities.length + ' entities');
                allEntities = entities;
                
                // Update entity list with styled cards
                var entityList = document.getElementById('entity-list-items');
                if (entityList && entities.length > 0) {
                    var html = '';
                    // Create a map to track unique entities by name
                    var uniqueEntities = {};
                    entities.forEach(function(entity) {
                        if (!uniqueEntities[entity.name]) {
                            uniqueEntities[entity.name] = entity;
                        }
                    });
                    
                    // Sort entities: components first, then patterns, then others
                    var sortedEntities = Object.values(uniqueEntities).sort(function(a, b) {
                        if (a.entityType === 'tekton_component' && b.entityType !== 'tekton_component') return -1;
                        if (a.entityType !== 'tekton_component' && b.entityType === 'tekton_component') return 1;
                        if (a.entityType === 'integration_pattern' && b.entityType !== 'integration_pattern') return -1;
                        if (a.entityType !== 'integration_pattern' && b.entityType === 'integration_pattern') return 1;
                        return a.name.localeCompare(b.name);
                    });
                    
                    sortedEntities.forEach(function(entity) {
                        var typeLabel = entity.entityType.replace(/_/g, ' ').replace(/\b\w/g, function(l){ return l.toUpperCase() });
                        html += '<div class="athena__entity-item">' +
                                '<h4>' + entity.name + '</h4>' +
                                '<span class="athena__entity-type">' + typeLabel + '</span>' +
                                (entity.properties && entity.properties.description ? 
                                    '<p style="margin-top: 8px;">' + entity.properties.description + '</p>' : '') +
                                (entity.properties && entity.properties.port ? 
                                    '<p><strong>Port:</strong> ' + entity.properties.port + '</p>' : '') +
                                '</div>';
                    });
                    entityList.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('[ATHENA] Error loading entities:', error);
            });
    }
    
    // Function to show node popup with landmarks and code
    function showNodePopup(node) {
        var popup = document.getElementById('node-popup');
        var title = document.querySelector('.athena__popup-title');
        var location = document.getElementById('popup-location');
        var file = document.getElementById('popup-file');
        var landmarksContent = document.getElementById('popup-landmarks-content');
        var codeContent = document.getElementById('popup-code-content');
        
        // Update popup content
        title.textContent = node.name;
        location.textContent = '/' + node.name;
        file.textContent = '/' + node.name + '/__main__.py';
        
        // Generate sample landmarks based on component type
        var landmarks = generateLandmarks(node);
        landmarksContent.textContent = landmarks;
        
        // Generate sample code snippet
        var code = generateCodeSnippet(node);
        codeContent.textContent = code;
        
        // Position popup near the center of the graph
        var container = document.getElementById('graph-container');
        var rect = container.getBoundingClientRect();
        popup.style.left = (rect.width / 2 - 225) + 'px'; // Center horizontally
        popup.style.top = '100px'; // Fixed distance from top
        
        // Show popup
        popup.style.display = 'block';
        
        // Reset to landmarks view
        document.getElementById('popup-landmarks').checked = true;
    }
    
    // Generate sample landmarks for a component
    function generateLandmarks(node) {
        var landmarks = '';
        
        if (node.type === 'tekton_component') {
            landmarks = '# Landmark: ' + node.name + ' Component - Main entry point\n';
            landmarks += '# Located at: /' + node.name + '/__main__.py:1\n\n';
            
            // Add component-specific landmarks
            switch(node.name.toLowerCase()) {
                case 'hermes':
                    landmarks += '# Landmark: MCP Server - Message bus and service registry\n';
                    landmarks += '# Located at: /Hermes/mcp_server.py:45\n\n';
                    landmarks += '# Landmark: WebSocket Handler - Real-time messaging\n';
                    landmarks += '# Located at: /Hermes/websocket_handler.py:120\n';
                    break;
                case 'athena':
                    landmarks += '# Landmark: Knowledge Graph Engine - Entity management\n';
                    landmarks += '# Located at: /Athena/engine.py:32\n\n';
                    landmarks += '# Landmark: Query Processor - Graph queries\n';
                    landmarks += '# Located at: /Athena/query_processor.py:78\n';
                    break;
                case 'rhetor':
                    landmarks += '# Landmark: LLM Router - Model selection and routing\n';
                    landmarks += '# Located at: /Rhetor/llm_router.py:25\n\n';
                    landmarks += '# Landmark: Context Manager - Prompt context\n';
                    landmarks += '# Located at: /Rhetor/context_manager.py:90\n';
                    break;
                default:
                    landmarks += '# Landmark: API Endpoints - Service interface\n';
                    landmarks += '# Located at: /' + node.name + '/api/endpoints.py:15\n\n';
                    landmarks += '# Landmark: Core Logic - Main functionality\n';
                    landmarks += '# Located at: /' + node.name + '/core.py:50\n';
            }
        } else if (node.type === 'integration_pattern') {
            landmarks = '# Landmark: ' + node.name + ' - Integration pattern\n';
            landmarks += '# Implemented across multiple components\n\n';
            landmarks += '# See: /shared/patterns/' + node.name.toLowerCase().replace(/ /g, '_') + '.py\n';
        }
        
        return landmarks || '# No landmarks found for this node';
    }
    
    // Generate sample code snippet for a component
    function generateCodeSnippet(node) {
        var code = '';
        
        if (node.type === 'tekton_component') {
            code = '# /' + node.name + '/__main__.py\n\n';
            code += 'import asyncio\n';
            code += 'from ' + node.name.toLowerCase() + '.server import ' + node.name + 'Server\n\n';
            code += 'async def main():\n';
            code += '    """Initialize ' + node.name + ' component"""\n';
            code += '    server = ' + node.name + 'Server()\n';
            code += '    \n';
            code += '    # Register with Hermes\n';
            code += '    await server.register_with_hermes()\n';
            code += '    \n';
            code += '    # Start server\n';
            code += '    await server.start()\n\n';
            code += 'if __name__ == "__main__":\n';
            code += '    asyncio.run(main())\n';
        } else {
            code = '# Pattern: ' + node.name + '\n\n';
            code += 'class ' + node.name.replace(/ /g, '') + ':\n';
            code += '    """Implementation of ' + node.name + '"""\n';
            code += '    \n';
            code += '    def apply(self, component):\n';
            code += '        # Pattern implementation\n';
            code += '        pass\n';
        }
        
        return code;
    }
    
    // Store current layout type
    var currentLayout = 'force';
    var currentNodes = [];
    var currentEdges = [];
    
    // Function to render the graph
    function renderGraph(data, layoutType) {
        if (!data.entities || data.entities.length === 0) return;
        
        var svg = document.getElementById('graph-svg');
        var placeholder = document.getElementById('graph-placeholder');
        var container = document.getElementById('graph-container');
        
        // Hide placeholder, show SVG
        placeholder.style.display = 'none';
        svg.style.display = 'block';
        
        // Use standard canvas dimensions
        var width = 2000;
        var height = 1400;
        
        // Use provided layout or current
        layoutType = layoutType || currentLayout;
        currentLayout = layoutType;
        
        // Create nodes with initial positions based on layout
        var nodes = data.entities.map(function(entity, i) {
            return {
                id: entity.entity_id,
                name: entity.name,
                type: entity.entity_type,
                x: width/2,
                y: height/2,
                index: i
            };
        });
        
        // Create edges from relationships
        var edges = [];
        if (data.relationships) {
            edges = data.relationships.map(function(rel) {
                return {
                    source: rel.source_id,
                    target: rel.target_id,
                    type: rel.relationship_type
                };
            });
        }
        
        // Store for re-layout
        currentNodes = nodes;
        currentEdges = edges;
        
        // Apply layout algorithm
        applyLayout(nodes, edges, layoutType, width, height);
        
        // Clear existing content
        document.getElementById('graph-edges').innerHTML = '';
        document.getElementById('graph-nodes').innerHTML = '';
        
        // Draw edges
        drawEdges(edges, nodes);
        
        // Draw nodes
        drawNodes(nodes);
        
        // Center the scroll view
        centerScrollView();
    }
    
    // Function to center the scroll view on the graph
    function centerScrollView() {
        // With percentage-based SVG and preserveAspectRatio, scrolling is handled automatically
        // The SVG will fit within its container and scale appropriately
    }
    
    // Function to apply different layout algorithms
    function applyLayout(nodes, edges, layoutType, width, height) {
        switch(layoutType) {
            case 'force':
                applyForceDirectedLayout(nodes, edges, width, height);
                break;
            case 'hierarchical':
                applyHierarchicalLayout(nodes, edges, width, height);
                break;
            case 'circular':
                applyCircularLayout(nodes, width, height);
                break;
            case 'grouped':
                applyGroupedLayout(nodes, width, height);
                break;
            case 'spring':
                applySpringLayout(nodes, edges, width, height);
                break;
            default:
                applyForceDirectedLayout(nodes, edges, width, height);
        }
    }
    
    // Force-directed layout
    function applyForceDirectedLayout(nodes, edges, width, height) {
        // Initialize random positions across more of the canvas
        nodes.forEach(function(node) {
            node.x = width/2 + (Math.random() - 0.5) * (width * 0.6);
            node.y = height/2 + (Math.random() - 0.5) * (height * 0.6);
        });
        
        // Run force simulation with stronger repulsion
        var iterations = 200;
        var minDistance = 80; // Minimum distance between nodes
        
        for (var i = 0; i < iterations; i++) {
            // Repulsion between all nodes
            nodes.forEach(function(node1, i) {
                nodes.forEach(function(node2, j) {
                    if (i !== j) {
                        var dx = node2.x - node1.x;
                        var dy = node2.y - node1.y;
                        var dist = Math.sqrt(dx * dx + dy * dy);
                        
                        // Strong repulsion to prevent overlap
                        if (dist < minDistance * 2) {
                            var force = dist > 0 ? (minDistance * 2 - dist) / (minDistance * 2) : 1;
                            var pushX = dist > 0 ? (dx / dist) * force * 20 : (Math.random() - 0.5) * 20;
                            var pushY = dist > 0 ? (dy / dist) * force * 20 : (Math.random() - 0.5) * 20;
                            node1.x -= pushX;
                            node1.y -= pushY;
                            node2.x += pushX;
                            node2.y += pushY;
                        }
                    }
                });
            });
            
            // Attraction along edges
            edges.forEach(function(edge) {
                var source = nodes.find(n => n.id === edge.source);
                var target = nodes.find(n => n.id === edge.target);
                if (source && target) {
                    var dx = target.x - source.x;
                    var dy = target.y - source.y;
                    var dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist > 100) {
                        var force = (dist - 100) / dist * 0.1;
                        source.x += dx * force;
                        source.y += dy * force;
                        target.x -= dx * force;
                        target.y -= dy * force;
                    }
                }
            });
            
            // Keep nodes in bounds with padding
            nodes.forEach(function(node) {
                node.x = Math.max(50, Math.min(width - 50, node.x));
                node.y = Math.max(50, Math.min(height - 50, node.y));
            });
        }
    }
    
    // Hierarchical layout
    function applyHierarchicalLayout(nodes, edges, width, height) {
        // Calculate node levels based on connections
        var levels = {};
        var maxLevel = 0;
        
        // First, identify infrastructure/shared nodes
        var infrastructureTypes = ['infrastructure', 'shared_infrastructure'];
        nodes.forEach(function(node) {
            if (infrastructureTypes.includes(node.type)) {
                levels[node.id] = 0;
            }
        });
        
        // Find nodes with no incoming edges (roots)
        nodes.forEach(function(node) {
            if (levels[node.id] === undefined) {
                var hasIncoming = edges.some(e => e.target === node.id);
                if (!hasIncoming) {
                    levels[node.id] = 1;
                }
            }
        });
        
        // Assign levels based on connections
        var maxIterations = 10;
        for (var iter = 0; iter < maxIterations; iter++) {
            var changed = false;
            edges.forEach(function(edge) {
                if (levels[edge.source] !== undefined) {
                    var newLevel = levels[edge.source] + 1;
                    if (levels[edge.target] === undefined || levels[edge.target] > newLevel) {
                        levels[edge.target] = newLevel;
                        maxLevel = Math.max(maxLevel, newLevel);
                        changed = true;
                    }
                }
            });
            if (!changed) break;
        }
        
        // Assign middle level to unconnected nodes
        var middleLevel = Math.floor(maxLevel / 2) || 1;
        nodes.forEach(function(node) {
            if (levels[node.id] === undefined) {
                levels[node.id] = middleLevel;
            }
        });
        
        // Group nodes by level and type for better distribution
        var nodesPerLevel = {};
        nodes.forEach(function(node) {
            var level = levels[node.id];
            if (!nodesPerLevel[level]) nodesPerLevel[level] = [];
            nodesPerLevel[level].push(node);
        });
        
        // Position nodes with taller levels and guaranteed spacing
        var verticalPadding = 100;
        var bottomPadding = 100;
        var levelHeight = (height - verticalPadding - bottomPadding) / (maxLevel + 1);
        var horizontalPadding = 100;
        var nodeMinSpacing = 150; // More space between nodes
        
        for (var level in nodesPerLevel) {
            var levelNodes = nodesPerLevel[level];
            var levelInt = parseInt(level);
            
            // Check if we need to split this level into multiple rows
            var usableWidth = width - (2 * horizontalPadding);
            var nodesPerRow = Math.floor(usableWidth / nodeMinSpacing);
            var numRows = Math.ceil(levelNodes.length / nodesPerRow);
            
            if (numRows > 1) {
                // Split into multiple staggered rows
                levelNodes.forEach(function(node, i) {
                    var row = i % numRows;
                    var col = Math.floor(i / numRows);
                    var nodesInThisRow = Math.ceil(levelNodes.length / numRows);
                    
                    var rowOffset = (row - (numRows - 1) / 2) * 60; // More vertical stagger
                    var xSpacing = Math.max(nodeMinSpacing, usableWidth / (nodesInThisRow + 1));
                    
                    node.x = horizontalPadding + xSpacing * (col + 1);
                    node.y = verticalPadding + levelHeight * levelInt + rowOffset;
                });
            } else {
                // Single row - distribute evenly with minimum spacing
                var xSpacing = Math.max(nodeMinSpacing, usableWidth / (levelNodes.length + 1));
                levelNodes.forEach(function(node, i) {
                    node.x = horizontalPadding + xSpacing * (i + 1);
                    node.y = verticalPadding + levelHeight * levelInt;
                });
            }
        }
    }
    
    // Circular layout
    function applyCircularLayout(nodes, width, height) {
        // Calculate radius that prevents overlap
        // Node diameter is about 40px (radius 20) + label space ~40px = 80px total
        var nodeSize = 80; // Total space needed per node including labels
        var minSpacing = nodeSize * 1.5; // 1.5x for comfortable spacing
        
        // Calculate minimum radius based on node count and spacing
        var angleStep = (2 * Math.PI) / nodes.length;
        var minRadius = minSpacing / (2 * Math.sin(angleStep / 2));
        
        // Ensure it fits in the viewBox
        var maxRadius = Math.min(width - 400, height - 400) / 2;
        var radius = Math.min(minRadius, maxRadius);
        
        // If radius is too small, we need to adjust
        if (radius < minRadius * 0.8) {
            console.warn('[ATHENA] Too many nodes for circular layout, some overlap may occur');
        }
        
        var centerX = width / 2;
        var centerY = height / 2;
        
        nodes.forEach(function(node, i) {
            var angle = i * angleStep - Math.PI / 2; // Start from top
            node.x = centerX + radius * Math.cos(angle);
            node.y = centerY + radius * Math.sin(angle);
        });
    }
    
    // Grouped layout by type
    function applyGroupedLayout(nodes, width, height) {
        // Group nodes by type
        var groups = {};
        nodes.forEach(function(node) {
            if (!groups[node.type]) groups[node.type] = [];
            groups[node.type].push(node);
        });
        
        // Sort groups by size (largest first)
        var groupKeys = Object.keys(groups).sort(function(a, b) {
            return groups[b].length - groups[a].length;
        });
        
        // Calculate optimal grid layout with padding
        var padding = 100;
        var totalGroups = groupKeys.length;
        var cols = Math.ceil(Math.sqrt(totalGroups));
        var rows = Math.ceil(totalGroups / cols);
        var cellWidth = (width - 2 * padding) / cols;
        var cellHeight = (height - 2 * padding) / rows;
        var baseCellSize = Math.min(cellWidth, cellHeight);
        
        groupKeys.forEach(function(type, groupIndex) {
            var col = groupIndex % cols;
            var row = Math.floor(groupIndex / cols);
            var groupCenterX = padding + cellWidth * col + cellWidth / 2;
            var groupCenterY = padding + cellHeight * row + cellHeight / 2;
            
            var groupNodes = groups[type];
            var nodeCount = groupNodes.length;
            
            // Adjusted scaling for better proportions
            var groupRadius;
            var minArcLength;
            
            if (nodeCount <= 3) {
                // Small groups - much smaller, tight spacing
                groupRadius = 30; // Fixed small radius
                minArcLength = 25; // Closer spacing for small groups
            } else if (nodeCount <= 10) {
                // Medium groups
                groupRadius = baseCellSize * 0.25;
                minArcLength = 40; // Medium spacing
            } else {
                // Large groups - pretend nodes are 2x bigger
                var scaleFactor = Math.sqrt(nodeCount / 5);
                groupRadius = Math.min(baseCellSize * 0.35 * scaleFactor, baseCellSize * 0.48);
                minArcLength = 60; // Large spacing (2x node size)
            }
            
            // Arrange nodes in a circle within the group
            if (nodeCount === 1) {
                groupNodes[0].x = groupCenterX;
                groupNodes[0].y = groupCenterY;
            } else {
                // Check if we need to increase radius for spacing
                var circumference = 2 * Math.PI * groupRadius;
                var arcLength = circumference / nodeCount;
                if (arcLength < minArcLength && nodeCount > 3) {
                    groupRadius = (minArcLength * nodeCount) / (2 * Math.PI);
                }
                
                var angleStep = (2 * Math.PI) / nodeCount;
                groupNodes.forEach(function(node, i) {
                    var angle = i * angleStep - Math.PI / 2;
                    node.x = groupCenterX + groupRadius * Math.cos(angle);
                    node.y = groupCenterY + groupRadius * Math.sin(angle);
                });
            }
        });
    }
    
    // Spring layout (improved force-directed)
    function applySpringLayout(nodes, edges, width, height) {
        // Initialize positions in a grid with padding
        var cols = Math.ceil(Math.sqrt(nodes.length));
        var rows = Math.ceil(nodes.length / cols);
        var topPadding = 100;
        var sidePadding = 100;
        var bottomPadding = 150;
        var cellWidth = (width - 2 * sidePadding) / cols;
        var cellHeight = (height - topPadding - bottomPadding) / rows;
        
        nodes.forEach(function(node, i) {
            var col = i % cols;
            var row = Math.floor(i / cols);
            node.x = sidePadding + cellWidth * (col + 0.5);
            node.y = topPadding + cellHeight * (row + 0.5);
        });
        
        // Spring physics simulation
        var iterations = 150;
        var springLength = 120;
        var springStrength = 0.1;
        var repulsionStrength = 1000;
        
        for (var iter = 0; iter < iterations; iter++) {
            var forces = {};
            
            // Initialize forces
            nodes.forEach(function(node) {
                forces[node.id] = { x: 0, y: 0 };
            });
            
            // Repulsion between all nodes
            nodes.forEach(function(node1, i) {
                nodes.forEach(function(node2, j) {
                    if (i < j) {
                        var dx = node2.x - node1.x;
                        var dy = node2.y - node1.y;
                        var dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist > 0) {
                            var force = repulsionStrength / (dist * dist);
                            var fx = (dx / dist) * force;
                            var fy = (dy / dist) * force;
                            forces[node1.id].x -= fx;
                            forces[node1.id].y -= fy;
                            forces[node2.id].x += fx;
                            forces[node2.id].y += fy;
                        }
                    }
                });
            });
            
            // Spring forces along edges
            edges.forEach(function(edge) {
                var source = nodes.find(n => n.id === edge.source);
                var target = nodes.find(n => n.id === edge.target);
                if (source && target) {
                    var dx = target.x - source.x;
                    var dy = target.y - source.y;
                    var dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist > 0) {
                        var force = (dist - springLength) * springStrength;
                        var fx = (dx / dist) * force;
                        var fy = (dy / dist) * force;
                        forces[source.id].x += fx;
                        forces[source.id].y += fy;
                        forces[target.id].x -= fx;
                        forces[target.id].y -= fy;
                    }
                }
            });
            
            // Apply forces with damping
            var damping = 0.8;
            nodes.forEach(function(node) {
                node.x += forces[node.id].x * damping;
                node.y += forces[node.id].y * damping;
                
                // Keep in bounds with proper padding
                node.x = Math.max(100, Math.min(width - 100, node.x));
                node.y = Math.max(100, Math.min(height - 100, node.y));
            });
        }
    }
    
    // Function to draw edges
    function drawEdges(edges, nodes) {
        var edgeGroup = document.getElementById('graph-edges');
        edges.forEach(function(edge) {
            var sourceNode = nodes.find(n => n.id === edge.source);
            var targetNode = nodes.find(n => n.id === edge.target);
            
            if (sourceNode && targetNode) {
                var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('class', 'athena__graph-edge');
                line.setAttribute('x1', sourceNode.x);
                line.setAttribute('y1', sourceNode.y);
                line.setAttribute('x2', targetNode.x);
                line.setAttribute('y2', targetNode.y);
                line.setAttribute('data-source', edge.source);
                line.setAttribute('data-target', edge.target);
                line.setAttribute('data-type', edge.type);
                edgeGroup.appendChild(line);
            }
        });
    }
    
    // Function to draw nodes
    function drawNodes(nodes) {
        var nodeGroup = document.getElementById('graph-nodes');
        nodes.forEach(function(node) {
            var g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('class', 'athena__graph-node');
            g.setAttribute('transform', 'translate(' + node.x + ',' + node.y + ')');
            g.setAttribute('data-node-id', node.id);
            g.setAttribute('data-node-name', node.name.toLowerCase());
            g.setAttribute('data-node-type', node.type);
            
            // Circle
            var circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('class', 'athena__graph-node-circle' + 
                (node.type === 'integration_pattern' ? ' pattern' : 
                 node.type === 'tekton_component' ? '' : ' other'));
            circle.setAttribute('r', '20');
            
            // Label
            var text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('class', 'athena__graph-node-label');
            text.setAttribute('y', '30');
            text.textContent = node.name;
            
            g.appendChild(circle);
            g.appendChild(text);
            
            // Click handler to show popup
            g.addEventListener('click', function(e) {
                e.stopPropagation();
                showNodePopup(node);
            });
            
            nodeGroup.appendChild(g);
        });
    }
    
    // Search functionality
    function setupSearch() {
        // Graph search
        var graphSearchInput = document.querySelector('#graph-panel .athena__search-input');
        var graphSearchButton = document.querySelector('#graph-panel .athena__search-button');
        
        if (graphSearchInput && graphSearchButton) {
            var performGraphSearch = function() {
                var searchTerm = graphSearchInput.value.toLowerCase().trim();
                var nodes = document.querySelectorAll('.athena__graph-node');
                
                if (searchTerm === '') {
                    // Clear search - show all
                    nodes.forEach(function(node) {
                        node.classList.remove('highlighted', 'dimmed');
                    });
                } else {
                    // Highlight matching nodes
                    nodes.forEach(function(node) {
                        var nodeName = node.getAttribute('data-node-name');
                        if (nodeName && nodeName.includes(searchTerm)) {
                            node.classList.add('highlighted');
                            node.classList.remove('dimmed');
                        } else {
                            node.classList.remove('highlighted');
                            node.classList.add('dimmed');
                        }
                    });
                }
            };
            
            graphSearchButton.addEventListener('click', performGraphSearch);
            graphSearchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') performGraphSearch();
            });
        }
        
        // Entity search
        var entitySearchInput = document.querySelector('#entities-panel .athena__search-input');
        var entitySearchButton = document.querySelector('#entities-panel .athena__search-button');
        
        if (entitySearchInput && entitySearchButton) {
            var performEntitySearch = function() {
                var searchTerm = entitySearchInput.value.toLowerCase().trim();
                var filtered = searchTerm === '' ? allEntities : 
                    allEntities.filter(function(entity) {
                        return entity.name.toLowerCase().includes(searchTerm) ||
                               (entity.properties && entity.properties.description && 
                                entity.properties.description.toLowerCase().includes(searchTerm));
                    });
                
                updateEntityList(filtered);
            };
            
            entitySearchButton.addEventListener('click', performEntitySearch);
            entitySearchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') performEntitySearch();
            });
        }
    }
    
    // Helper to update entity list
    function updateEntityList(entities) {
        var entityList = document.getElementById('entity-list-items');
        if (!entityList) return;
        
        var html = '';
        var uniqueEntities = {};
        entities.forEach(function(entity) {
            if (!uniqueEntities[entity.name]) {
                uniqueEntities[entity.name] = entity;
            }
        });
        
        var sortedEntities = Object.values(uniqueEntities).sort(function(a, b) {
            if (a.entityType === 'tekton_component' && b.entityType !== 'tekton_component') return -1;
            if (a.entityType !== 'tekton_component' && b.entityType === 'tekton_component') return 1;
            return a.name.localeCompare(b.name);
        });
        
        sortedEntities.forEach(function(entity) {
            var typeLabel = entity.entityType.replace(/_/g, ' ').replace(/\b\w/g, function(l){ return l.toUpperCase() });
            html += '<div class="athena__entity-item">' +
                    '<h4>' + entity.name + '</h4>' +
                    '<span class="athena__entity-type">' + typeLabel + '</span>' +
                    (entity.properties && entity.properties.description ? 
                        '<p style="margin-top: 8px;">' + entity.properties.description + '</p>' : '') +
                    (entity.properties && entity.properties.port ? 
                        '<p><strong>Port:</strong> ' + entity.properties.port + '</p>' : '') +
                    '</div>';
        });
        entityList.innerHTML = html;
    }
    
    // Setup Query Builder functionality
    function setupQueryBuilder() {
        console.log('[ATHENA] Setting up Query Builder');
        
        var buildQueryBtn = document.getElementById('build-query-btn');
        var clearQueryBtn = document.getElementById('clear-query-btn');
        var entityTypeSelect = document.getElementById('entity-type-select');
        var relationshipTypeSelect = document.getElementById('relationship-type-select');
        var searchTermsInput = document.getElementById('search-terms-input');
        var includeArchivedCheckbox = document.getElementById('include-archived');
        var exactMatchCheckbox = document.getElementById('exact-match');
        var queryResultContainer = document.getElementById('query-result-container');
        var generatedQueryElem = document.getElementById('generated-query');
        var copyQueryBtn = document.getElementById('copy-query-btn');
        var executeQueryBtn = document.getElementById('execute-query-btn');
        
        if (!buildQueryBtn || !clearQueryBtn) {
            console.error('[ATHENA] Query builder buttons not found');
            return;
        }
        
        // Build Query button handler
        buildQueryBtn.addEventListener('click', function() {
            var entityType = entityTypeSelect.value;
            var relationshipType = relationshipTypeSelect.value;
            var searchTerms = searchTermsInput.value.trim();
            var includeArchived = includeArchivedCheckbox.checked;
            var exactMatch = exactMatchCheckbox.checked;
            
            // Generate query string
            var query = 'MATCH ';
            
            if (entityType !== 'any') {
                query += '(n:' + entityType.charAt(0).toUpperCase() + entityType.slice(1) + ')';
            } else {
                query += '(n)';
            }
            
            if (relationshipType !== 'any') {
                query += '-[r:' + relationshipType.toUpperCase() + ']->(m)';
            } else {
                query += '-[r]->(m)';
            }
            
            query += '\nWHERE ';
            
            if (searchTerms) {
                if (exactMatch) {
                    query += 'n.name = "' + searchTerms + '" OR m.name = "' + searchTerms + '"';
                } else {
                    query += 'n.name CONTAINS "' + searchTerms + '" OR m.name CONTAINS "' + searchTerms + '"';
                }
            } else {
                query += 'true';
            }
            
            if (!includeArchived) {
                query += ' AND NOT n.archived AND NOT m.archived';
            }
            
            query += '\nRETURN n, r, m\nLIMIT 100;';
            
            // Show the query result container
            queryResultContainer.style.display = 'block';
            generatedQueryElem.textContent = query;
            
            // Scroll to show the generated query
            queryResultContainer.scrollIntoView({ behavior: 'smooth' });
        });
        
        // Clear Query button handler
        clearQueryBtn.addEventListener('click', function() {
            entityTypeSelect.value = 'any';
            relationshipTypeSelect.value = 'any';
            searchTermsInput.value = '';
            includeArchivedCheckbox.checked = false;
            exactMatchCheckbox.checked = false;
            queryResultContainer.style.display = 'none';
        });
        
        // Copy Query button handler
        if (copyQueryBtn) {
            copyQueryBtn.addEventListener('click', function() {
                if (generatedQueryElem) {
                    var textToCopy = generatedQueryElem.textContent;
                    
                    // Use clipboard API if available
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(textToCopy)
                            .then(function() {
                                copyQueryBtn.textContent = 'Copied!';
                                setTimeout(function() {
                                    copyQueryBtn.textContent = 'Copy Query';
                                }, 2000);
                            })
                            .catch(function(err) {
                                console.error('[ATHENA] Error copying text:', err);
                            });
                    }
                }
            });
        }
        
        // Execute Query button handler
        if (executeQueryBtn) {
            executeQueryBtn.addEventListener('click', function() {
                var queryText = generatedQueryElem.textContent;
                console.log('[ATHENA] Executing query:', queryText);
                
                // Show loading state
                executeQueryBtn.textContent = 'Executing...';
                executeQueryBtn.disabled = true;
                
                // Remove any existing result
                var existingResult = queryResultContainer.querySelector('.athena__query-results-section');
                if (existingResult) {
                    existingResult.remove();
                }
                
                // Parse the query to extract search parameters
                var searchTerm = '';
                var entityType = entityTypeSelect.value;
                var relationshipType = relationshipTypeSelect.value;
                
                // Extract search term from query
                var searchMatch = queryText.match(/CONTAINS "([^"]+)"|= "([^"]+)"/);
                if (searchMatch) {
                    searchTerm = searchMatch[1] || searchMatch[2];
                }
                
                // Execute query by filtering existing data
                executeGraphQuery(searchTerm, entityType, relationshipType, function(results) {
                    // Create results section
                    var resultsSection = document.createElement('div');
                    resultsSection.className = 'athena__query-results-section';
                    resultsSection.innerHTML = 
                        '<div class="athena__query-results-header">' +
                        '<h4>Query Results</h4>' +
                        '<button class="athena__query-button athena__query-button--small" onclick="viewQueryResultsInGraph()">View in Graph</button>' +
                        '</div>' +
                        '<div class="athena__query-results-summary">' +
                        'Found <strong>' + results.entities.length + ' entities</strong> and <strong>' + results.relationships.length + ' relationships</strong>' +
                        '</div>' +
                        '<div class="athena__query-results-content">' +
                        '<div class="athena__query-results-list" id="query-results-list"></div>' +
                        '</div>';
                    
                    queryResultContainer.appendChild(resultsSection);
                    
                    // Populate results list
                    var resultsList = document.getElementById('query-results-list');
                    
                    // Show entities
                    if (results.entities.length > 0) {
                        var entitiesHtml = '<h5>Entities:</h5><ul class="athena__query-results-entities">';
                        results.entities.forEach(function(entity) {
                            entitiesHtml += '<li><span class="athena__result-name">' + entity.name + '</span> <span class="athena__result-type">(' + entity.type + ')</span></li>';
                        });
                        entitiesHtml += '</ul>';
                        resultsList.innerHTML += entitiesHtml;
                    }
                    
                    // Show relationships
                    if (results.relationships.length > 0) {
                        var relationshipsHtml = '<h5>Relationships:</h5><ul class="athena__query-results-relationships">';
                        results.relationships.forEach(function(rel) {
                            relationshipsHtml += '<li>' + 
                                '<span class="athena__result-source">' + rel.sourceName + '</span> ' +
                                '<span class="athena__result-arrow">‚Üí</span> ' +
                                '<span class="athena__result-rel">' + rel.type + '</span> ' +
                                '<span class="athena__result-arrow">‚Üí</span> ' +
                                '<span class="athena__result-target">' + rel.targetName + '</span>' +
                                '</li>';
                        });
                        relationshipsHtml += '</ul>';
                        resultsList.innerHTML += relationshipsHtml;
                    }
                    
                    // If no results
                    if (results.entities.length === 0 && results.relationships.length === 0) {
                        resultsList.innerHTML = '<p class="athena__no-results">No results found matching your query criteria.</p>';
                    }
                    
                    // Reset button
                    executeQueryBtn.textContent = 'Execute';
                    executeQueryBtn.disabled = false;
                    
                    // Store results for "View in Graph" functionality
                    window.lastQueryResults = results;
                });
            });
        }
    }
    
    // Function to execute graph query using loaded data
    function executeGraphQuery(searchTerm, entityType, relationshipType, callback) {
        // Filter entities
        var matchingEntities = [];
        var matchingRelationships = [];
        
        if (graphData && graphData.entities) {
            // Filter entities
            graphData.entities.forEach(function(entity) {
                var matchesType = entityType === 'any' || entity.entity_type === entityType;
                var matchesSearch = !searchTerm || 
                    entity.name.toLowerCase().includes(searchTerm.toLowerCase());
                
                if (matchesType && matchesSearch) {
                    matchingEntities.push({
                        id: entity.entity_id,
                        name: entity.name,
                        type: entity.entity_type
                    });
                }
            });
            
            // Filter relationships
            if (graphData.relationships) {
                graphData.relationships.forEach(function(rel) {
                    var matchesRelType = relationshipType === 'any' || 
                        rel.relationship_type.toLowerCase() === relationshipType.toLowerCase();
                    
                    // Check if source or target matches our entities
                    var sourceEntity = graphData.entities.find(e => e.entity_id === rel.source_id);
                    var targetEntity = graphData.entities.find(e => e.entity_id === rel.target_id);
                    
                    var matchesSearch = !searchTerm || 
                        (sourceEntity && sourceEntity.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (targetEntity && targetEntity.name.toLowerCase().includes(searchTerm.toLowerCase()));
                    
                    if (matchesRelType && matchesSearch) {
                        matchingRelationships.push({
                            source: rel.source_id,
                            target: rel.target_id,
                            type: rel.relationship_type,
                            sourceName: sourceEntity ? sourceEntity.name : 'Unknown',
                            targetName: targetEntity ? targetEntity.name : 'Unknown'
                        });
                    }
                });
            }
        }
        
        // Return results
        callback({
            entities: matchingEntities,
            relationships: matchingRelationships
        });
    }
    
    // Function to view query results in graph (global for onclick)
    window.viewQueryResultsInGraph = function() {
        // Switch to Knowledge Graph tab
        document.getElementById('athena-tab-graph').checked = true;
        
        // Highlight matching nodes in the graph
        if (window.lastQueryResults) {
            var resultIds = window.lastQueryResults.entities.map(e => e.id);
            
            // Reset all nodes first
            document.querySelectorAll('.athena__graph-node').forEach(function(node) {
                node.classList.remove('highlighted', 'dimmed');
            });
            
            // Highlight matching nodes
            document.querySelectorAll('.athena__graph-node').forEach(function(node) {
                var nodeId = node.getAttribute('data-node-id');
                if (resultIds.includes(nodeId)) {
                    node.classList.add('highlighted');
                } else {
                    node.classList.add('dimmed');
                }
            });
        }
    }
    
    // Setup layout selector
    function setupLayoutSelector() {
        var layoutSelect = document.getElementById('graph-layout-select');
        if (layoutSelect) {
            layoutSelect.addEventListener('change', function() {
                var selectedLayout = layoutSelect.value;
                console.log('[ATHENA] Switching to ' + selectedLayout + ' layout');
                
                // Re-render with new layout
                if (graphData) {
                    renderGraph(graphData, selectedLayout);
                }
            });
        }
    }
    
    // Start loading after a short delay
    setTimeout(function() {
        loadAthenaData();
        setupSearch();
        setupQueryBuilder();
        setupLayoutSelector();
    }, 100);
})();

// Initialize unified chat components
function athena_initChats() {
    console.log('[Athena] Initializing unified chat components');
    
    // Check if modules are loaded, if not, wait and retry
    if (!window.SingleChat || !window.TeamChat) {
        console.log('[Athena] Chat modules not loaded yet, waiting...');
        setTimeout(function() {
            athena_initChats(); // Retry
        }, 100);
        return;
    }
    
    const knowledgeChatEl = document.getElementById('athena-chat-messages');
    const teamChatEl = document.getElementById('athena-teamchat-messages');
    
    if (window.SingleChat && knowledgeChatEl) {
        window.SingleChat.init(knowledgeChatEl, 'athena', 'chat-message');
        console.log('[Athena] SingleChat initialized for knowledge chat');
    }
    
    if (window.TeamChat && teamChatEl) {
        window.TeamChat.init(teamChatEl, 'athena', 'chat-message');
        console.log('[Athena] TeamChat initialized');
    }
}

// SIMPLE ATHENA CHAT
window.athena_sendChat = function() {
    const input = document.getElementById('athena-chat-input');
    const message = input.value.trim();
    if (!message) return;
    
    const knowledgeChatRadio = document.getElementById('athena-tab-chat');
    const teamChatRadio = document.getElementById('athena-tab-teamchat');
    const knowledgeChatActive = knowledgeChatRadio ? knowledgeChatRadio.checked : false;
    const teamChatActive = teamChatRadio ? teamChatRadio.checked : false;
    
    // If we're not on a chat tab, switch to knowledge chat first
    if (!knowledgeChatActive && !teamChatActive) {
        if (knowledgeChatRadio) {
            knowledgeChatRadio.checked = true;
        }
        // Small delay to let the CSS transition complete
        setTimeout(() => {
            const knowledgeChatEl = document.getElementById('athena-chat-messages');
            if (window.SingleChat && knowledgeChatEl) {
                window.SingleChat.sendMessage(knowledgeChatEl, message);
            }
            input.value = '';
        }, 100);
        return;
    }
    
    // Normal chat behavior when already on a chat tab
    if (knowledgeChatActive) {
        const knowledgeChatEl = document.getElementById('athena-chat-messages');
        if (window.SingleChat && knowledgeChatEl) {
            window.SingleChat.sendMessage(knowledgeChatEl, message);
        }
    } else if (teamChatActive) {
        const teamChatEl = document.getElementById('athena-teamchat-messages');
        if (window.TeamChat && teamChatEl) {
            window.TeamChat.sendMessage(teamChatEl, message);
        }
    }
    
    input.value = '';
};

// Initialize unified chat components on load
athena_initChats();
</script>