<!-- Athena Component - Knowledge Graph -->

<!-- Hidden radio inputs for CSS-first tab functionality -->
<input type="radio" name="athena-tab" id="athena-tab-graph" checked style="display: none;">
<input type="radio" name="athena-tab" id="athena-tab-entities" style="display: none;">
<input type="radio" name="athena-tab" id="athena-tab-query" style="display: none;">
<input type="radio" name="athena-tab" id="athena-tab-chat" style="display: none;">
<input type="radio" name="athena-tab" id="athena-tab-teamchat" style="display: none;">

<div class="athena">
    <!-- Component Header with Title -->
    <div class="athena__header">
        <div class="athena__title-container">
            <img src="/images/hexagon.jpg" alt="Tekton" class="athena__icon">
            <h2 class="athena__title">
                <span class="athena__title-main">Athena</span>
                <span class="athena__title-sub">Knowledge</span>
            </h2>
        </div>
    </div>
    
    <!-- Menu Bar -->
    <div class="athena__menu-bar">
        <div class="athena__tabs">
            <label for="athena-tab-graph" class="athena__tab">
                <span class="athena__tab-label">Knowledge Graph</span>
            </label>
            <label for="athena-tab-entities" class="athena__tab">
                <span class="athena__tab-label">Entities</span>
            </label>
            <label for="athena-tab-query" class="athena__tab">
                <span class="athena__tab-label">Query Builder</span>
            </label>
            <label for="athena-tab-chat" class="athena__tab">
                <span class="athena__tab-label">Knowledge Chat</span>
            </label>
            <label for="athena-tab-teamchat" class="athena__tab">
                <span class="athena__tab-label">Team Chat</span>
            </label>
        </div>
    </div>
    
    <!-- Content Area -->
    <div class="athena__content">
        <!-- Knowledge Graph Panel -->
        <div id="graph-panel" class="athena__panel">
            <div class="athena__graph">
                <div class="athena__control-bar">
                    <div class="athena__search-container">
                        <input type="text" placeholder="Search entities..." class="athena__search-input">
                        <button class="athena__search-button">Search</button>
                    </div>
                </div>
                <div id="graph-container" class="athena__graph-container">
                    <div id="graph-placeholder" class="athena__graph-placeholder">
                        <div style="text-align: center; padding: 2rem;">
                            <h2 style="color: #999;">Knowledge Graph</h2>
                            <p style="color: #777;">Connect to Athena service to view graph</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Entities Panel -->
        <div id="entities-panel" class="athena__panel">
            <div class="athena__entities">
                <div class="athena__control-bar">
                    <div class="athena__search-container">
                        <input type="text" placeholder="Search entities..." class="athena__search-input">
                        <button class="athena__search-button">Search</button>
                    </div>
                </div>
                <div class="athena__entity-list-container">
                    <div id="entity-list-items" class="athena__entity-list">
                        <div class="athena__empty-state">
                            <p>No entities loaded. Connect to Athena service.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Query Builder Panel -->
        <div id="query-panel" class="athena__panel">
            <div class="athena__query-builder">
                <h3>Query Builder</h3>
                <p>Build complex knowledge graph queries</p>
            </div>
        </div>
        
        <!-- Knowledge Chat Panel -->
        <div id="chat-panel" class="athena__panel athena__panel--chat">
            <div class="chat-interface">
                <div class="chat-messages" id="athena-chat-messages">
                    <div class="chat-message system-message">
                        <strong>Athena:</strong> Hello! I'm Athena, your knowledge graph AI assistant. I specialize in understanding relationships, patterns, and connections across the Tekton system. How can I help you explore our knowledge today?
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Team Chat Panel -->
        <div id="teamchat-panel" class="athena__panel athena__panel--team">
            <div class="chat-interface">
                <div class="chat-messages" id="athena-teamchat-messages">
                    <div class="chat-message system-message">
                        <strong>System:</strong> Team Chat allows Athena to coordinate with other AI specialists about knowledge graph insights.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer with Chat Input -->
    <div class="athena__footer">
        <div class="athena__chat-input-container">
            <div class="athena__chat-prompt">></div>
            <input type="text" class="athena__chat-input" id="athena-chat-input"
                   placeholder="Chat with Athena - your knowledge graph AI assistant"
                   onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); athena_sendChat(); }">
            <button class="athena__send-button" id="athena-send-button" onclick="athena_sendChat(); return false;">Send</button>
        </div>
    </div>
</div>

<style>
/* Athena Component Styles - Following Terma's BEM Pattern */

/* Container */
.athena {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
    background-color: var(--bg-primary, #1e1e2e);
    color: var(--text-primary, #f0f0f0);
    /* No absolute positioning - proper component containment */
}

/* Header */
.athena__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 16px;
    background-color: var(--bg-secondary, #252535);
    border-bottom: 1px solid var(--border-color, #444444);
}

.athena__title-container {
    display: flex;
    align-items: center;
}

.athena__icon {
    height: 30px;
    width: auto;
    margin-right: 12px;
}

.athena__title {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 500;
}

.athena__title-main {
    font-weight: 600;
}

.athena__title-sub {
    margin-left: 8px;
    opacity: 0.8;
    font-weight: normal;
}

/* Menu Bar */
.athena__menu-bar {
    display: flex;
    background-color: var(--bg-secondary, #252535);
    border-bottom: 1px solid var(--border-color, #444444);
    padding: 0 16px;
}

.athena__tabs {
    display: flex;
    gap: 8px;
}

.athena__tab {
    padding: 16px;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    color: var(--text-secondary, #aaaaaa);
    font-weight: 500;
    transition: all 0.3s ease;
}

.athena__tab:hover {
    color: var(--text-primary, #f0f0f0);
    background-color: rgba(123, 31, 162, 0.05);
}

/* Active state handled by radio button logic */

/* Content Area */
.athena__content {
    flex: 1;
    overflow: hidden;
    position: relative;
    padding-bottom: 70px; /* Account for footer height */
}

/* Panel styling - hidden by default */
.athena__panel {
    display: none;
    height: 100%;
    overflow: auto;
    padding: 0;
    position: relative;
}

/* Radio button logic for tab switching */
#athena-tab-graph:checked ~ .athena #graph-panel,
#athena-tab-entities:checked ~ .athena #entities-panel,
#athena-tab-query:checked ~ .athena #query-panel {
    display: block;
}

#athena-tab-chat:checked ~ .athena .athena__panel--chat,
#athena-tab-teamchat:checked ~ .athena .athena__panel--team {
    display: flex;
    flex-direction: column;
}

/* Active tab styling */
#athena-tab-graph:checked ~ .athena .athena__tab[for="athena-tab-graph"],
#athena-tab-entities:checked ~ .athena .athena__tab[for="athena-tab-entities"],
#athena-tab-query:checked ~ .athena .athena__tab[for="athena-tab-query"],
#athena-tab-chat:checked ~ .athena .athena__tab[for="athena-tab-chat"],
#athena-tab-teamchat:checked ~ .athena .athena__tab[for="athena-tab-teamchat"] {
    color: var(--text-primary, #f0f0f0);
    border-bottom-color: #7B1FA2;
    background-color: rgba(123, 31, 162, 0.05);
}

/* Control Bar */
.athena__control-bar {
    display: flex;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-secondary, #252535);
    border-bottom: 1px solid var(--border-color, #444444);
    align-items: center;
    margin: 0;
    position: sticky;
    top: 0;
    z-index: 10;
}

/* Graph Panel */
.athena__graph {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.athena__graph-container {
    flex: 1;
    background: #000000;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 16px;
    border-radius: 8px;
}

/* Entities Panel */
.athena__entities {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.athena__entity-list-container {
    flex: 1;
    background: #000000;
    border-radius: 8px;
    padding: 16px;
    margin: 16px;
    overflow-y: auto;
}

/* Query Builder */
.athena__query-builder {
    padding: 24px;
    margin: 16px;
    background: #000000;
    border-radius: 8px;
    text-align: center;
}

/* Search */
.athena__search-container {
    display: flex;
    gap: 8px;
    flex: 1;
}

.athena__search-input {
    flex: 1;
    padding: 4px 12px;
    background: var(--bg-tertiary, #1a1a2a);
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    color: var(--text-primary, #f0f0f0);
    height: 28px;
}

.athena__search-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 12px;
    background-color: #7B1FA2;
    border: 1px solid #8E24AA;
    border-radius: 4px;
    color: #ffffff;
    cursor: pointer;
    height: 26px;
    font-size: 13px;
}

/* Chat Interface */
.chat-interface {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
}

.chat-messages {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.chat-message {
    margin-bottom: 12px;
    padding: 8px 12px;
    border-radius: 4px;
    background-color: transparent;
    position: relative;
}

.chat-message strong {
    display: inline-block;
    margin-right: 8px;
    font-weight: 600;
}

/* System messages */
.chat-message.system-message {
    background-color: rgba(123, 31, 162, 0.05);
    border-left: 3px solid #7B1FA2;
    font-style: italic;
}

.chat-message.system-message strong {
    color: #7B1FA2;
}

/* User messages */
.chat-message.user-message {
    background-color: rgba(76, 175, 80, 0.05);
    border-left: 3px solid #4CAF50;
    margin-left: 0;
}

.chat-message.user-message strong {
    color: #4CAF50;
}

/* AI messages */
.chat-message.ai-message {
    background-color: rgba(123, 31, 162, 0.05);
    border-left: 3px solid #7B1FA2;
    margin-right: 0;
}

.chat-message.ai-message strong {
    color: #7B1FA2;
}

/* Footer with Chat Input */
.athena__footer {
    background-color: var(--bg-secondary, #252535);
    border-top: 1px solid var(--border-color, #444444);
    padding: 12px 16px;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 70px; /* Fixed height to match chat area */
}

.athena__chat-input-container {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
}

.athena__chat-prompt {
    font-size: 18px;
    font-weight: bold;
    color: #7B1FA2; /* Purple for Athena */
}

.athena__chat-input {
    flex: 1;
    height: 44px;
    padding: 8px 16px;
    background-color: var(--bg-tertiary, #1a1a2a);
    border: 1px solid var(--border-color, #444444);
    border-radius: 8px;
    color: var(--text-primary, #f0f0f0);
    font-size: 14px;
    transition: border-color 0.2s ease;
}

.athena__chat-input:focus {
    outline: none;
    border-color: #7B1FA2;
}

.athena__chat-input::placeholder {
    color: var(--text-secondary, #888888);
}

.athena__send-button {
    padding: 12px 24px;
    background-color: #7B1FA2;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: background-color 0.3s ease;
}

.athena__send-button:hover {
    background-color: #8E24AA;
}
</style>

<script>
// Initialize Athena data when component loads - minimal JS, just HTML injection
(function() {
    console.log('[ATHENA] Loading data from Athena service...');
    
    // Simple function to load entities and update HTML
    function loadAthenaData() {
        // Check if athenaUrl is available
        if (typeof window.athenaUrl !== 'function') {
            console.log('[ATHENA] Waiting for athenaUrl function...');
            setTimeout(loadAthenaData, 500);
            return;
        }
        
        // Load entities
        fetch(window.athenaUrl('/api/v1/entities/?limit=1000'))
            .then(response => response.json())
            .then(entities => {
                console.log('[ATHENA] Loaded ' + entities.length + ' entities');
                
                // Update graph placeholder with entity count
                var graphPlaceholder = document.getElementById('graph-placeholder');
                if (graphPlaceholder && entities.length > 0) {
                    var componentCount = entities.filter(e => e.entityType === 'tekton_component').length;
                    graphPlaceholder.innerHTML = 
                        '<div style="text-align: center; padding: 2rem;">' +
                        '<h2 style="color: #999;">Knowledge Graph</h2>' +
                        '<p style="color: #777;">' + entities.length + ' entities loaded<br>' +
                        componentCount + ' Tekton components</p>' +
                        '</div>';
                }
                
                // Update entity list
                var entityList = document.getElementById('entity-list-items');
                if (entityList && entities.length > 0) {
                    var html = '';
                    entities.forEach(function(entity) {
                        html += '<div class="athena__entity-item">' +
                                '<h4>' + entity.name + '</h4>' +
                                '<p>Type: ' + entity.entityType + '</p>' +
                                (entity.properties && entity.properties.port ? '<p>Port: ' + entity.properties.port + '</p>' : '') +
                                '</div>';
                    });
                    entityList.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('[ATHENA] Error loading entities:', error);
            });
    }
    
    // Start loading after a short delay
    setTimeout(loadAthenaData, 100);
})();

// SIMPLE ATHENA CHAT
window.athena_sendChat = function() {
    var input = document.getElementById('athena-chat-input');
    var message = input.value.trim();
    
    if (!message) return;
    
    // Determine which tab is active
    var knowledgeChatActive = document.getElementById('athena-tab-chat').checked;
    var teamChatActive = document.getElementById('athena-tab-teamchat').checked;
    
    if (knowledgeChatActive) {
        // Knowledge Chat
        var messagesContainer = document.getElementById('athena-chat-messages');
        
        // Add user message
        var userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'chat-message user-message';
        userMessageDiv.innerHTML = message;
        messagesContainer.appendChild(userMessageDiv);
        
        // Clear input
        input.value = '';
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Send to backend
        if (window.AIChat) {
            window.AIChat.sendMessage('athena', message)
                .then(function(response) {
                    var aiMessageDiv = document.createElement('div');
                    aiMessageDiv.className = 'chat-message ai-message';
                    aiMessageDiv.innerHTML = '<strong>Athena:</strong> ' + response.content;
                    messagesContainer.appendChild(aiMessageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                })
                .catch(function(err) {
                    console.error('Failed to send message:', err);
                    var errorDiv = document.createElement('div');
                    errorDiv.className = 'chat-message system-message';
                    errorDiv.innerHTML = '<strong>System:</strong> Failed to connect to Athena AI';
                    messagesContainer.appendChild(errorDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
        }
    } else if (teamChatActive) {
        // Team Chat
        var messagesContainer = document.getElementById('athena-teamchat-messages');
        
        // Add broadcast message
        var userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'chat-message user-message';
        userMessageDiv.innerHTML = message;
        messagesContainer.appendChild(userMessageDiv);
        
        // Clear input
        input.value = '';
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Team chat through Rhetor
        if (window.AIChat) {
            window.AIChat.teamChat(message, 'athena')
                .then(function(data) {
                    // Display team responses
                    if (data.responses && data.responses.length > 0) {
                        data.responses.forEach(function(resp) {
                            var aiMessageDiv = document.createElement('div');
                            aiMessageDiv.className = 'chat-message ai-message';
                            var sender = resp.socket_id.replace('-ai', '').charAt(0).toUpperCase() + 
                                         resp.socket_id.replace('-ai', '').slice(1);
                            aiMessageDiv.innerHTML = '<strong>' + sender + ':</strong> ' + resp.content;
                            messagesContainer.appendChild(aiMessageDiv);
                        });
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                })
                .catch(function(err) {
                    console.error('Failed to send team message:', err);
                    var errorDiv = document.createElement('div');
                    errorDiv.className = 'chat-message system-message';
                    errorDiv.innerHTML = '<strong>System:</strong> Failed to send team message';
                    messagesContainer.appendChild(errorDiv);
                });
        }
    }
};
</script>