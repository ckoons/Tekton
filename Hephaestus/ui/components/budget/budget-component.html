<!-- Budget Component - LLM Usage and Budget Management -->
<!-- Load Chart.js dependency -->
<script src="/scripts/chart.js"></script>

<div class="budget" data-tekton-area="budget" data-tekton-component="budget" data-tekton-type="component-workspace" data-tekton-ai="budget-assistant" data-tekton-ai-ready="false">
    <!-- Component Header with Title -->
    <div class="budget__header" data-tekton-zone="header" data-tekton-section="header">
        <div class="budget__title-container">
            <img src="/images/hexagon.jpg" alt="Tekton" class="budget__icon">
            <h2 class="budget__title">
                <span class="budget__title-main">Budget</span>
                <span class="budget__title-sub">LLM Cost Management</span>
            </h2>
        </div>
    </div>
    
    <!-- Budget Menu Bar with Tab Navigation -->
    <div class="budget__menu-bar" data-tekton-zone="menu" data-tekton-zone="menu" data-tekton-nav="component-menu">
        <div class="budget__tabs" data-tekton-zone="menu">
            <div class="budget__tab budget__tab--active" data-tab="dashboard" onclick="budget_switchTab('dashboard'); return false;" data-tekton-menu-item="Dashboard" data-tekton-menu-component="budget" data-tekton-menu-active="true" data-tekton-menu-panel="dashboard-panel" data-tekton-nav-target="dashboard-panel">
                <span class="budget__tab-label">Dashboard</span>
            </div>
            <div class="budget__tab" data-tab="details" onclick="budget_switchTab('details'); return false;" data-tekton-menu-item="Usage Details" data-tekton-menu-component="budget" data-tekton-menu-active="false" data-tekton-menu-panel="details-panel" data-tekton-nav-target="details-panel">
                <span class="budget__tab-label">Usage Details</span>
            </div>
            <div class="budget__tab" data-tab="settings" onclick="budget_switchTab('settings'); return false;" data-tekton-menu-item="Settings" data-tekton-menu-component="budget" data-tekton-menu-active="false" data-tekton-menu-panel="settings-panel" data-tekton-nav-target="settings-panel">
                <span class="budget__tab-label">Settings</span>
            </div>
            <div class="budget__tab" data-tab="alerts" onclick="budget_switchTab('alerts'); return false;" data-tekton-menu-item="Alerts" data-tekton-menu-component="budget" data-tekton-menu-active="false" data-tekton-menu-panel="alerts-panel" data-tekton-nav-target="alerts-panel">
                <span class="budget__tab-label">Alerts</span>
            </div>
            <div class="budget__tab" data-tekton-chat="tab" data-tab="budgetchat" onclick="budget_switchTab('budgetchat'); return false;" data-tekton-menu-item="Budget Chat" data-tekton-menu-component="budget" data-tekton-menu-active="false" data-tekton-menu-panel="budgetchat-panel" data-tekton-nav-target="budgetchat-panel">
                <span class="budget__tab-label">Budget Chat</span>
            </div>
            <div class="budget__tab" data-tekton-chat="tab" data-tab="teamchat" onclick="budget_switchTab('teamchat'); return false;" data-tekton-menu-item="Team Chat" data-tekton-menu-component="budget" data-tekton-menu-active="false" data-tekton-menu-panel="teamchat-panel" data-tekton-nav-target="teamchat-panel">
                <span class="budget__tab-label">Team Chat</span>
            </div>
        </div>
        <div class="budget__actions">
            <button id="clear-chat-btn" class="budget__action-button" style="display: none;" onclick="budget_clearChat(); return false;" data-tekton-action="clear-chat" data-tekton-action-type="secondary">
                <span class="budget__button-label">Clear</span>
            </button>
        </div>
    </div>
    
    <!-- Budget Content Area -->
    <div class="budget__content" data-tekton-zone="content" data-tekton-scrollable="true">
        <!-- Dashboard Tab (Default Active Tab) -->
        <div id="dashboard-panel" class="budget__panel budget__panel--active" data-tekton-panel="dashboard" data-tekton-panel-for="Dashboard" data-tekton-panel-component="budget" data-tekton-panel-active="true">
            <div class="budget__dashboard">
                <div class="budget__control-bar">
                    <div class="budget__filter-container">
                        <select id="period-select" class="budget__filter-select" data-tekton-select="option">
                            <option value="daily">Daily View</option>
                            <option value="weekly">Weekly View</option>
                            <option value="monthly" selected>Monthly View</option>
                        </select>
                    </div>
                </div>
                
                <!-- Budget Summary Cards -->
                <div class="budget__summary">
                    <div class="budget__card">
                        <div class="budget__card-header">
                            <div class="budget__card-title">Daily Spend</div>
                            <div class="budget__card-period">Today</div>
                        </div>
                        <div class="budget__card-amount-container">
                            <div class="budget__card-amount">$2.47</div>
                            <div class="budget__card-limit">/ $5.00</div>
                        </div>
                        <div class="budget__card-progress">
                            <div class="budget__card-progress-bar" style="width: 49.4%"></div>
                        </div>
                        <div class="budget__card-footer">
                            <div>49.4% of daily limit</div>
                            <div>Today</div>
                        </div>
                    </div>
                    
                    <div class="budget__card">
                        <div class="budget__card-header">
                            <div class="budget__card-title">Weekly Spend</div>
                            <div class="budget__card-period">This Week</div>
                        </div>
                        <div class="budget__card-amount-container">
                            <div class="budget__card-amount">$12.89</div>
                            <div class="budget__card-limit">/ $25.00</div>
                        </div>
                        <div class="budget__card-progress">
                            <div class="budget__card-progress-bar" style="width: 51.6%"></div>
                        </div>
                        <div class="budget__card-footer">
                            <div>51.6% of weekly limit</div>
                            <div>Apr 15 - Apr 21, 2025</div>
                        </div>
                    </div>
                    
                    <div class="budget__card">
                        <div class="budget__card-header">
                            <div class="budget__card-title">Monthly Spend</div>
                            <div class="budget__card-period">April 2025</div>
                        </div>
                        <div class="budget__card-amount-container">
                            <div class="budget__card-amount">$36.75</div>
                            <div class="budget__card-limit">/ $100.00</div>
                        </div>
                        <div class="budget__card-progress">
                            <div class="budget__card-progress-bar" style="width: 36.8%"></div>
                        </div>
                        <div class="budget__card-footer">
                            <div>36.8% of monthly limit</div>
                            <div>Apr 1 - Apr 30, 2025</div>
                        </div>
                    </div>
                    
                    <div class="budget__card">
                        <div class="budget__card-header">
                            <div class="budget__card-title">Token Usage</div>
                            <div class="budget__card-period">Last 24 Hours</div>
                        </div>
                        <div class="budget__card-amount-container">
                            <div class="budget__card-amount">1.2M</div>
                            <div class="budget__card-limit">tokens</div>
                        </div>
                        <div class="budget__card-footer">
                            <div>Input: 542K</div>
                            <div>Output: 658K</div>
                        </div>
                    </div>
                </div>
      
                <!-- Charts Section -->
                <div class="budget__charts">
                    <div class="budget__chart-card">
                        <div class="budget__chart-header">
                            <h3 class="budget__chart-title">Spend by Provider</h3>
                            <div class="budget__chart-controls">
                                <select class="budget__select">
                                    <option value="provider">By Provider</option>
                                    <option value="model">By Model</option>
                                    <option value="component">By Component</option>
                                </select>
                            </div>
                        </div>
                        <div class="budget__chart-container">
                            <canvas id="provider-pie-chart" style="max-height: 200px;"></canvas>
                        </div>
                        <div class="budget__chart-legend" id="provider-legend">
                            <!-- Legend will be populated dynamically -->
                        </div>
                    </div>
                    
                    <div class="budget__chart-card">
                        <div class="budget__chart-header">
                            <h3 class="budget__chart-title">Daily Spend Trend</h3>
                            <div class="budget__chart-controls">
                                <select class="budget__select">
                                    <option value="7days">Last 7 Days</option>
                                    <option value="30days" selected>Last 30 Days</option>
                                    <option value="90days">Last 90 Days</option>
                                </select>
                            </div>
                        </div>
                        <div class="budget__chart-container">
                            <canvas id="spend-chart" style="max-height: 200px;"></canvas>
                        </div>
                        <div class="budget__chart-legend">
                            <div class="budget__legend-item">
                                <span class="budget__legend-color" style="background-color: #3B82F6;"></span>
                                <span class="budget__legend-label">Actual Spend</span>
                            </div>
                            <div class="budget__legend-item">
                                <span class="budget__legend-color" style="background-color: #94A3B8;"></span>
                                <span class="budget__legend-label">Budget Limit</span>
                            </div>
                        </div>
                    </div>
                </div>
      
                <!-- Top Usage Section -->
                <div class="budget__detail">
                    <div class="budget__detail-header">
                        <h3 class="budget__detail-title">Top Usage</h3>
                        <div class="budget__detail-controls">
                            <select class="budget__select">
                                <option value="component">By Component</option>
                                <option value="model" selected>By Model</option>
                                <option value="task">By Task Type</option>
                            </select>
                        </div>
                    </div>
                    <div class="budget__table-container">
                        <table class="budget__table">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>Provider</th>
                                    <th>Token Count</th>
                                    <th>Cost</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody id="top-usage-body">
                                <tr>
                                    <td>Claude 3 Sonnet</td>
                                    <td><span class="budget__badge budget__badge--anthropic">Anthropic</span></td>
                                    <td>230,450</td>
                                    <td>$3.46</td>
                                    <td>34.6%</td>
                                </tr>
                                <tr>
                                    <td>Claude 3 Haiku</td>
                                    <td><span class="budget__badge budget__badge--anthropic">Anthropic</span></td>
                                    <td>543,120</td>
                                    <td>$0.68</td>
                                    <td>6.8%</td>
                                </tr>
                                <tr>
                                    <td>GPT-4</td>
                                    <td><span class="budget__badge budget__badge--openai">OpenAI</span></td>
                                    <td>104,300</td>
                                    <td>$6.26</td>
                                    <td>62.6%</td>
                                </tr>
                                <tr>
                                    <td>Llama 3</td>
                                    <td><span class="budget__badge budget__badge--ollama">Ollama</span></td>
                                    <td>1,250,680</td>
                                    <td>$0.00</td>
                                    <td>0.0%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usage Details Tab -->
        <div id="details-panel" class="budget__panel" data-tekton-panel="details" data-tekton-panel-for="Usage Details" data-tekton-panel-component="budget" data-tekton-panel-active="false">
            <div class="budget__usage-details">
                <div class="budget__control-bar">
                    <div class="budget__date-filter">
                        <div class="budget__filter-group">
                            <label class="budget__filter-label">Beginning:</label>
                            <input type="date" class="budget__input" id="start-date" value="2025-04-01">
                        </div>
                        <div class="budget__filter-group">
                            <label class="budget__filter-label">Ending:</label>
                            <input type="date" class="budget__input" id="end-date" value="2025-04-21">
                        </div>
                        <select class="budget__filter-select" id="filter-preset" onchange="budget_applyFilterPreset(); return false;">
                            <option value="custom">Custom Range</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="all">All Time</option>
                        </select>
                        <button class="budget__button budget__button--primary" id="filter-usage" onclick="budget_filterUsage(); return false;" data-tekton-action="filter-usage" data-tekton-action-type="primary">Apply Filter</button>
                    </div>
                </div>
                
                <div class="budget__table-container">
                    <table class="budget__table">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Component</th>
                                <th>Provider/Model</th>
                                <th>Task Type</th>
                                <th>Tokens</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody id="usage-table-body">
                            <tr>
                                <td>2025-04-21 15:42</td>
                                <td>Terma</td>
                                <td><span class="budget__badge budget__badge--anthropic">Claude 3 Sonnet</span></td>
                                <td>chat</td>
                                <td>4,320</td>
                                <td>$0.06</td>
                            </tr>
                            <tr>
                                <td>2025-04-21 14:15</td>
                                <td>Ergon</td>
                                <td><span class="budget__badge budget__badge--anthropic">Claude 3 Haiku</span></td>
                                <td>agent_creation</td>
                                <td>12,450</td>
                                <td>$0.02</td>
                            </tr>
                            <tr>
                                <td>2025-04-21 10:33</td>
                                <td>Athena</td>
                                <td><span class="budget__badge budget__badge--openai">GPT-4</span></td>
                                <td>knowledge_retrieval</td>
                                <td>3,280</td>
                                <td>$0.19</td>
                            </tr>
                            <tr>
                                <td>2025-04-20 18:22</td>
                                <td>Codex</td>
                                <td><span class="budget__badge budget__badge--ollama">Llama 3</span></td>
                                <td>code_completion</td>
                                <td>45,320</td>
                                <td>$0.00</td>
                            </tr>
                            <tr>
                                <td>2025-04-20 16:05</td>
                                <td>Terma</td>
                                <td><span class="budget__badge budget__badge--anthropic">Claude 3 Sonnet</span></td>
                                <td>chat</td>
                                <td>8,730</td>
                                <td>$0.13</td>
                            </tr>
                            <tr>
                                <td>2025-04-20 11:47</td>
                                <td>Ergon</td>
                                <td><span class="budget__badge budget__badge--anthropic">Claude 3 Haiku</span></td>
                                <td>workflow_planning</td>
                                <td>15,680</td>
                                <td>$0.02</td>
                            </tr>
                            <tr>
                                <td>2025-04-19 22:15</td>
                                <td>Athena</td>
                                <td><span class="budget__badge budget__badge--openai">GPT-4</span></td>
                                <td>data_analysis</td>
                                <td>7,620</td>
                                <td>$0.46</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="budget__pagination">
                    <button class="budget__button budget__button--small" data-tekton-action="previous-page" data-tekton-action-type="secondary">Previous</button>
                    <span class="budget__pagination-indicator">Page 1 of 14</span>
                    <button class="budget__button budget__button--small" data-tekton-action="next-page" data-tekton-action-type="secondary">Next</button>
                </div>
            </div>
        </div>

        <!-- Budget Settings Tab -->
        <div id="settings-panel" class="budget__panel" data-tekton-panel="settings" data-tekton-panel-for="Settings" data-tekton-panel-component="budget" data-tekton-panel-active="false">
            <div class="budget__settings">
                <div class="budget__control-bar">
                    <div class="budget__settings-header">
                        <div class="budget__settings-actions">
                            <button class="budget__button budget__button--primary" id="save-budget-settings" onclick="budget_saveSettings(); return false;" data-tekton-action="save-settings" data-tekton-action-type="primary">Save Settings</button>
                        </div>
                    </div>
                </div>
                
                <!-- Budget Limits Section -->
                <div class="budget__settings-section">
                    <div class="budget__settings-header">
                        <h3 class="budget__settings-title">Budget Limits</h3>
                    </div>
                    <div class="budget__settings-form">
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="daily-limit">Daily Budget Limit</label>
                            <div class="budget__form-input-container">
                                <span class="budget__form-input-prefix">$</span>
                                <input type="number" id="daily-limit" class="budget__input" value="5.00" min="0" step="0.01" data-tekton-input="number">
                            </div>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="weekly-limit">Weekly Budget Limit</label>
                            <div class="budget__form-input-container">
                                <span class="budget__form-input-prefix">$</span>
                                <input type="number" id="weekly-limit" class="budget__input" value="25.00" min="0" step="0.01" data-tekton-input="number">
                            </div>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="monthly-limit">Monthly Budget Limit</label>
                            <div class="budget__form-input-container">
                                <span class="budget__form-input-prefix">$</span>
                                <input type="number" id="monthly-limit" class="budget__input" value="100.00" min="0" step="0.01" data-tekton-input="number">
                            </div>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="enforce-policy">Enforcement Policy</label>
                            <select id="enforce-policy" class="budget__select" data-tekton-select="option">
                                <option value="ignore">Track Only (No Enforcement)</option>
                                <option value="warn">Show Warnings</option>
                                <option value="enforce" selected>Enforce Limits (Auto Downgrade)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Provider Budgets Section -->
                <div class="budget__settings-section">
                    <div class="budget__settings-header">
                        <h3 class="budget__settings-title">Provider Budgets</h3>
                    </div>
                    <div class="budget__settings-form">
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="anthropic-limit">Anthropic Monthly Budget</label>
                            <div class="budget__form-input-container">
                                <span class="budget__form-input-prefix">$</span>
                                <input type="number" id="anthropic-limit" class="budget__input" value="80.00" min="0" step="0.01" data-tekton-input="number">
                            </div>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="openai-limit">OpenAI Monthly Budget</label>
                            <div class="budget__form-input-container">
                                <span class="budget__form-input-prefix">$</span>
                                <input type="number" id="openai-limit" class="budget__input" value="20.00" min="0" step="0.01" data-tekton-input="number">
                            </div>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="enable-provider-limits">Enable Provider-Specific Limits</label>
                            <div class="budget__form-switch">
                                <input type="checkbox" id="enable-provider-limits" class="budget__checkbox" checked>
                                <span class="budget__form-switch-label">Enabled</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Settings Section -->
                <div class="budget__settings-section">
                    <div class="budget__settings-header">
                        <h3 class="budget__settings-title">Advanced Settings</h3>
                    </div>
                    <div class="budget__settings-form">
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="warning-threshold">Warning Threshold</label>
                            <div class="budget__form-input-container">
                                <input type="number" id="warning-threshold" class="budget__input" value="80" min="1" max="100" data-tekton-input="number">
                                <span class="budget__form-input-suffix">%</span>
                            </div>
                            <span class="budget__form-help-text">Show warnings when usage reaches this percentage of the limit</span>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="allow-free-models">Allow Free Models When Budget Depleted</label>
                            <div class="budget__form-switch">
                                <input type="checkbox" id="allow-free-models" class="budget__checkbox" checked>
                                <span class="budget__form-switch-label">Enabled</span>
                            </div>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="reset-day">Budget Reset Day (Monthly)</label>
                            <select id="reset-day" class="budget__select" data-tekton-select="option">
                                <option value="1" selected>1st of month</option>
                                <option value="15">15th of month</option>
                                <option value="last">Last day of month</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Tab -->
        <div id="alerts-panel" class="budget__panel" data-tekton-panel="alerts" data-tekton-panel-for="Alerts" data-tekton-panel-component="budget" data-tekton-panel-active="false">
            <div class="budget__alerts">
                <div class="budget__control-bar">
                    <div class="budget__alerts-actions">
                        <button class="budget__button" id="clear-alerts" onclick="budget_clearAlerts(); return false;" data-tekton-action="clear-alerts" data-tekton-action-type="secondary">Clear All</button>
                    </div>
                </div>
                
                <div class="budget__settings-section">
                    <div class="budget__settings-header">
                        <h3 class="budget__settings-title">Active Alerts</h3>
                    </div>
                    
                    <div class="budget__alert-list">
                        <div class="budget__alert">
                            <div class="budget__alert-info">
                                <div class="budget__alert-icon budget__alert-icon--warning">!</div>
                                <div class="budget__alert-details">
                                    <div class="budget__alert-title">Weekly Budget Warning</div>
                                    <div class="budget__alert-description">Weekly budget is at 82% of limit ($20.50 of $25.00)</div>
                                </div>
                            </div>
                            <div class="budget__alert-actions">
                                <button class="budget__button budget__button--small" data-tekton-action="dismiss-alert" data-tekton-action-type="secondary">Dismiss</button>
                            </div>
                        </div>
                        
                        <div class="budget__alert">
                            <div class="budget__alert-info">
                                <div class="budget__alert-icon budget__alert-icon--info">i</div>
                                <div class="budget__alert-details">
                                    <div class="budget__alert-title">OpenAI Budget Update</div>
                                    <div class="budget__alert-description">OpenAI provider reached 90% of its monthly allocation</div>
                                </div>
                            </div>
                            <div class="budget__alert-actions">
                                <button class="budget__button budget__button--small" data-tekton-action="dismiss-alert" data-tekton-action-type="secondary">Dismiss</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="budget__settings-section">
                    <div class="budget__settings-header">
                        <h3 class="budget__settings-title">Alert Settings</h3>
                    </div>
                    
                    <div class="budget__settings-form">
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="enable-email-alerts">Email Alerts</label>
                            <div class="budget__form-switch">
                                <input type="checkbox" id="enable-email-alerts" class="budget__checkbox" checked>
                                <span class="budget__form-switch-label">Enabled</span>
                            </div>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="alert-email">Alert Email Address</label>
                            <input type="email" id="alert-email" class="budget__input" value="admin@example.com" data-tekton-input="email">
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="alert-frequency">Alert Frequency</label>
                            <select id="alert-frequency" class="budget__select" data-tekton-select="option">
                                <option value="immediate">Immediate</option>
                                <option value="daily" selected>Daily Summary</option>
                                <option value="weekly">Weekly Summary</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="budget__form-actions">
                        <button class="budget__button budget__button--primary" id="save-alert-settings" onclick="budget_saveAlertSettings(); return false;" data-tekton-action="save-alert-settings" data-tekton-action-type="primary">Save Alert Settings</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget Chat Tab -->
        <div id="budgetchat-panel" class="budget__panel" data-tekton-chat="panel" data-tekton-panel="budgetchat" data-tekton-panel-for="Budget Chat" data-tekton-panel-component="budget" data-tekton-panel-active="false">
            <div id="budgetchat-messages" class="budget__chat-messages" data-tekton-chat="messages">
                <!-- Welcome message -->
                <div class="budget__message budget__message--system">
                    <div class="budget__message-content">
                        <div class="budget__message-text">
                            <h3 class="budget__message-title">Budget LLM Chat</h3>
                            <p>Chat directly with an LLM about budget optimization, cost management, and usage planning for your AI resources.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Team Chat Tab -->
        <div id="teamchat-panel" class="budget__panel" data-tekton-chat="panel" data-tekton-panel="teamchat" data-tekton-panel-for="Team Chat" data-tekton-panel-component="budget" data-tekton-panel-active="false">
            <div id="teamchat-messages" class="budget__chat-messages" data-tekton-chat="messages">
                <!-- Welcome message -->
                <div class="budget__message budget__message--system">
                    <div class="budget__message-content">
                        <div class="budget__message-text">
                            <h3 class="budget__message-title">Tekton Team Chat</h3>
                            <p>This chat is shared across all Tekton components. Use this for team communication and coordination about budget matters.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer with Chat Input -->
    <div class="budget__footer" data-tekton-zone="footer">
        <div class="budget__chat-input-container" data-tekton-chat="input">
            <div class="budget__chat-prompt" data-tekton-chat="container">></div>
            <input type="text" id="budget-chat-input" class="budget__chat-input" data-tekton-chat="input" 
                   data-tekton-input="chat-input"
                   data-tekton-input-type="chat"
                   placeholder="Ask about usage, costs, or budget settings"
                   onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); budget_sendChat(); }">
            <button id="budget-send-button" class="budget__send-button" onclick="budget_sendChat(); return false;"
                    data-tekton-action="send-message" 
                    data-tekton-action-type="primary">Send</button>
        </div>
    </div>
</div>

<!-- Add component-specific styles -->
<style>
    /* Budget component styles using BEM naming convention */
    
    /* Container */
    .budget {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        background-color: var(--bg-primary, #1e1e2e);
        color: var(--text-primary, #f0f0f0);
        /* No absolute positioning - proper component containment */
    }
    
    /* Header */
    .budget__header {
        display: flex;
        align-items: center;
        padding: 10px 16px;
        background-color: var(--bg-secondary, #252535);
        border-bottom: 1px solid var(--border-color, #444444);
        height: 46px; /* Standardized header height */
    }
    
    .budget__title-container {
        display: flex;
        align-items: center;
    }
    
    .budget__icon {
        height: 30px;
        width: auto;
        margin-right: 12px;
    }
    
    .budget__title {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 500;
    }
    
    .budget__title-sub {
        margin-left: 8px;
        opacity: 0.8;
        font-weight: normal;
    }
    
    /* Menu Bar */
    .budget__menu-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 16px;
        background-color: var(--bg-secondary, #252535);
        border-bottom: 1px solid var(--border-color, #444444);
        height: 46px; /* Standardized menu bar height */
    }
    
    .budget__tabs {
        display: flex;
        gap: 8px;
    }
    
    .budget__tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background-color: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-primary, #f0f0f0);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .budget__tab:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .budget__tab--active {
        border-bottom-color: var(--color-primary, #34A853); /* Budget green from spec */
        font-weight: 500;
    }
    
    .budget__actions {
        display: flex;
        gap: 8px;
    }
    
    .budget__action-button {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .budget__action-button:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    /* Content Area */
    .budget__content {
        flex: 1;
        overflow: hidden;
        position: relative;
    }
    
    .budget__panel {
        display: none;
        height: 100%;
        width: 100%;
        overflow: auto;
    }
    
    .budget__panel--active {
        display: block;
    }
    
    /* Specific panel layouts */
    .budget__settings,
    .budget__alerts {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .budget__settings {
        position: relative;
        padding-bottom: 120px; /* Larger gap for save button */
    }
    
    .budget__settings-actions {
        position: absolute;
        bottom: 40px;
        right: 20px;
    }
    
    .budget__alerts {
        position: relative;
        padding-bottom: 120px; /* Larger gap for clear button */
    }
    
    .budget__alerts-actions {
        position: absolute;
        bottom: 40px;
        right: 20px;
    }
    
    /* Control Bar */
    .budget__control-bar {
        display: flex;
        justify-content: space-between;
        padding: 16px;
        background-color: var(--bg-secondary, #252535);
        border-bottom: 1px solid var(--border-color, #444444);
        height: 46px; /* Standard control bar height */
    }
    
    .budget__filter-container {
        display: flex;
        gap: 8px;
    }
    
    .budget__filter-select {
        padding: 8px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
    }
    
    /* Budget Summary Cards */
    .budget__summary {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
        padding: 16px;
    }
    
    .budget__card {
        background-color: var(--bg-secondary, #252535);
        border-radius: 8px;
        border: 1px solid var(--border-color, #444444);
        padding: 16px;
        display: flex;
        flex-direction: column;
    }
    
    .budget__card-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    
    .budget__card-title {
        font-weight: 500;
        font-size: 1.1rem;
    }
    
    .budget__card-period {
        opacity: 0.7;
        font-size: 0.9rem;
    }
    
    .budget__card-amount-container {
        display: flex;
        align-items: baseline;
        margin-bottom: 12px;
    }
    
    .budget__card-amount {
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--color-primary, #34A853); /* Budget green from spec */
    }
    
    .budget__card-limit {
        margin-left: 8px;
        opacity: 0.7;
    }
    
    .budget__card-progress {
        height: 8px;
        background-color: var(--bg-tertiary, #333345);
        border-radius: 4px;
        margin-bottom: 12px;
        overflow: hidden;
    }
    
    .budget__card-progress-bar {
        height: 100%;
        background-color: var(--color-primary, #34A853); /* Budget green from spec */
        border-radius: 4px;
    }
    
    .budget__card-progress-bar--warning {
        background-color: #FFA500;
    }
    
    .budget__card-progress-bar--danger {
        background-color: #FF4444;
    }
    
    .budget__card-footer {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        opacity: 0.7;
        margin-top: auto;
    }
    
    /* Charts */
    .budget__charts {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
        padding: 0 16px;
    }
    
    .budget__chart-card {
        background-color: var(--bg-secondary, #252535);
        border-radius: 8px;
        border: 1px solid var(--border-color, #444444);
        padding: 16px;
    }
    
    .budget__chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .budget__chart-title {
        margin: 0;
        font-size: 1.2rem;
    }
    
    .budget__chart-container {
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--bg-tertiary, #333345);
        border-radius: 4px;
        margin-bottom: 16px;
    }
    
    .budget__chart-placeholder {
        text-align: center;
        opacity: 0.7;
    }
    
    .budget__chart-legend {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .budget__legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .budget__legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }
    
    /* Detail Table */
    .budget__detail {
        margin-bottom: 24px;
        padding: 0 16px 16px;
    }
    
    .budget__detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .budget__detail-title {
        margin: 0;
        font-size: 1.2rem;
    }
    
    .budget__table-container {
        overflow-x: auto;
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        margin-bottom: 16px;
    }
    
    .budget__table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .budget__table th,
    .budget__table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-color, #444444);
    }
    
    .budget__table th {
        background-color: var(--bg-secondary, #252535);
        font-weight: 500;
    }
    
    .budget__table tr:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .budget__badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    
    .budget__badge--anthropic {
        background-color: #7356BF;
        color: white;
    }
    
    .budget__badge--openai {
        background-color: #10A283;
        color: white;
    }
    
    .budget__badge--ollama {
        background-color: #FF6600;
        color: white;
    }
    
    /* Pagination */
    .budget__pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
    }
    
    .budget__pagination-indicator {
        opacity: 0.7;
    }
    
    /* Settings Form Styles */
    .budget__settings-section {
        background-color: var(--bg-secondary, #252535);
        border-radius: 8px;
        border: 1px solid var(--border-color, #444444);
        margin-bottom: 24px;
        overflow: hidden;
    }
    
    .budget__settings-header {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color, #444444);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .budget__settings-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 500;
    }
    
    .budget__settings-form {
        padding: 16px;
    }
    
    .budget__form-group {
        margin-bottom: 16px;
    }
    
    .budget__form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
    }
    
    .budget__form-input-container {
        display: flex;
        align-items: center;
    }
    
    .budget__form-input-prefix,
    .budget__form-input-suffix {
        display: flex;
        align-items: center;
        padding: 0 8px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-right: none;
        border-radius: 4px 0 0 4px;
        height: 38px;
    }
    
    .budget__form-input-suffix {
        border-left: none;
        border-right: 1px solid var(--border-color, #444444);
        border-radius: 0 4px 4px 0;
    }
    
    .budget__input {
        flex: 1;
        height: 38px;
        padding: 8px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
    }
    
    .budget__input:focus {
        outline: none;
        border-color: var(--color-primary, #34A853); /* Budget green from spec */
    }
    
    .budget__form-input-container .budget__input {
        border-radius: 0 4px 4px 0;
    }
    
    .budget__form-input-container .budget__input:not(:first-child):not(:last-child) {
        border-radius: 0;
    }
    
    .budget__select {
        width: 100%;
        height: 38px;
        padding: 8px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
    }
    
    .budget__form-switch {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .budget__checkbox {
        position: relative;
        width: 40px;
        height: 20px;
        -webkit-appearance: none;
        background-color: var(--bg-tertiary, #333345);
        border-radius: 20px;
        border: 1px solid var(--border-color, #444444);
        outline: none;
        transition: .4s;
        cursor: pointer;
    }
    
    .budget__checkbox:checked {
        background-color: var(--color-primary, #34A853); /* Budget green from spec */
    }
    
    .budget__checkbox:before {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        border-radius: 20px;
        top: 1px;
        left: 1px;
        background-color: var(--text-primary, #f0f0f0);
        transform: translateX(0);
        transition: .4s;
    }
    
    .budget__checkbox:checked:before {
        transform: translateX(20px);
    }
    
    .budget__form-help-text {
        display: block;
        margin-top: 4px;
        font-size: 0.85rem;
        opacity: 0.7;
    }
    
    .budget__form-actions {
        display: flex;
        justify-content: flex-end;
        padding: 0 16px 16px;
    }
    
    /* Buttons */
    .budget__button {
        padding: 8px 16px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
        cursor: pointer;
    }
    
    .budget__button:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .budget__button--primary {
        background-color: var(--color-primary, #34A853); /* Budget green from spec */
        border-color: var(--color-primary, #34A853); /* Budget green from spec */
        color: white;
    }
    
    .budget__button--primary:hover {
        background-color: var(--color-primary-hover, #2D9249); /* Budget green darker */
    }
    
    .budget__button--success {
        background-color: #4CAF50;
        color: white;
        border-color: #4CAF50;
    }
    
    .budget__button--success:hover {
        background-color: #388E3C;
        border-color: #388E3C;
    }
    
    .budget__button--small {
        padding: 4px 8px;
        font-size: 0.85rem;
    }
    
    .budget__button--danger {
        background-color: #E53935;
        border-color: #E53935;
        color: white;
    }
    
    .budget__button--danger:hover {
        background-color: #D32F2F;
    }
    
    /* Alert Styles */
    .budget__alert-list {
        padding: 16px;
    }
    
    .budget__alert {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-radius: 4px;
        background-color: var(--bg-tertiary, #333345);
        margin-bottom: 12px;
    }
    
    .budget__alert-info {
        display: flex;
        gap: 12px;
    }
    
    .budget__alert-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-weight: bold;
    }
    
    .budget__alert-icon--warning {
        background-color: #FFA500;
        color: black;
    }
    
    .budget__alert-icon--info {
        background-color: #3B82F6;
        color: white;
    }
    
    .budget__alert-title {
        font-weight: 500;
        margin-bottom: 4px;
    }
    
    .budget__alert-description {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    /* Date Filter */
    .budget__date-filter {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .budget__filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .budget__filter-label {
        font-size: 0.9rem;
        color: var(--text-secondary, #94A3B8);
        white-space: nowrap;
    }
    
    .budget__filter-select {
        padding: 8px 12px;
        background-color: var(--bg-tertiary, #333345);
        color: var(--text-primary, #ffffff);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        font-size: 0.9rem;
        cursor: pointer;
    }

    /* Chat Messages (for Team Chat tab) */
    .budget__chat-messages {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 70px; /* Height of the footer */
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    /* Messages - Following Numa's styling pattern */
    .budget__message {
        margin-bottom: 12px;
        padding: 8px 12px;
        border-radius: 4px;
        background-color: transparent;
        position: relative;
    }
    
    .budget__message strong {
        display: inline-block;
        margin-right: 8px;
        font-weight: 600;
    }
    
    /* System messages */
    .budget__message--system {
        background-color: rgba(52, 168, 83, 0.05);
        border-left: 3px solid #34A853;
        font-style: italic;
    }
    
    .budget__message--system strong {
        color: #34A853;
    }
    
    /* User messages */
    .budget__message--user {
        background-color: rgba(76, 175, 80, 0.05);
        border-left: 3px solid #4CAF50;
        margin-left: 32px;
        align-self: flex-end;
    }
    
    .budget__message--user strong {
        color: #4CAF50;
    }
    
    /* AI messages */
    .budget__message--ai {
        background-color: rgba(52, 168, 83, 0.05);
        border-left: 3px solid #34A853;
        margin-right: 32px;
        align-self: flex-start;
    }
    
    .budget__message--ai strong {
        color: #34A853;
    }
    
    /* Message content styling */
    .budget__message-text ul {
        list-style: none;
        padding-left: 0;
        margin: 10px 0 0 0;
    }
    
    .budget__message-text ul li {
        padding: 4px 0;
        padding-left: 20px;
        position: relative;
    }
    
    .budget__message-text ul li:before {
        content: "•";
        color: #34A853;
        font-weight: bold;
        position: absolute;
        left: 0;
    }
    
    .budget__message-title {
        margin-top: 0;
        margin-bottom: 8px;
    }
    
    /* Footer */
    .budget__footer {
        background-color: var(--bg-secondary, #252535);
        border-top: 1px solid var(--border-color, #444444);
        padding: 12px 16px;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 70px; /* Fixed height to match bottom value in chat messages */
    }
    
    .budget__chat-input-container {
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
    }
    
    .budget__chat-prompt {
        font-size: 18px;
        font-weight: bold;
        color: #34A853; /* Budget green */
    }
    
    .budget__chat-input {
        flex: 1;
        height: 44px;
        padding: 8px 16px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        color: var(--text-primary, #f0f0f0);
        font-size: 14px;
    }
    
    .budget__send-button {
        height: 44px;
        padding: 0 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #34A853; /* Budget green */
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .budget__send-button:hover {
        background-color: #2D9249; /* Darker green on hover */
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(52, 168, 83, 0.3);
    }
    
    .budget__send-button:active {
        transform: translateY(0);
        box-shadow: none;
    }
    
    /* Loading Indicator */
    .budget__loading-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
    }
    
    .budget__spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        border-top: 4px solid var(--color-primary, #34A853); /* Budget green from spec */
        animation: budget-spin 1s linear infinite;
        margin-bottom: 16px;
    }
    
    .budget__loading-text {
        color: var(--text-secondary, #aaaaaa);
    }
    
    @keyframes budget-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Typing indicator */
    .budget__typing-indicator {
        display: flex;
        gap: 4px;
        padding: 8px 0;
    }
    
    .budget__typing-indicator span {
        width: 8px;
        height: 8px;
        background-color: var(--text-secondary, #94A3B8);
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }
    
    .budget__typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .budget__typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% {
            opacity: 0.3;
            transform: translateY(0);
        }
        30% {
            opacity: 1;
            transform: translateY(-10px);
        }
    }
</style>

<!-- Load Component Scripts -->
<script src="/components/budget/scripts/budget-models.js"></script>
<script src="/components/budget/scripts/budget-api-client.js"></script>
<script src="/components/budget/scripts/budget-state-manager.js"></script>
<script src="/components/budget/scripts/budget-ws-handler.js"></script>
<script src="/components/budget/scripts/budget-chart-utils.js"></script>
<script src="/components/budget/scripts/budget-cli-handler.js"></script>
<script src="/components/budget/scripts/budget-component.js"></script>

<script type="text/javascript">
// SIMPLIFIED COMPONENT SCRIPT - FULLY SELF-CONTAINED
// This version minimizes interference with other components

// IMMEDIATELY SET UP UI MANAGER PROTECTION
// Tell UI Manager to ignore this component - must be done IMMEDIATELY to avoid races
if (window.uiManager) {
    window.uiManager._ignoreComponent = 'budget';
    console.log('[BUDGET] Set UI Manager to ignore budget component');
}

// DEFINE TAB SWITCHING FUNCTION
// CRITICAL: This uses no shared code/utilities to avoid conflicts
window.budget_switchTab = function(tabId) {
    console.log('[BUDGET] Switching to tab:', tabId);
    
    // Force HTML panel visibility
    const htmlPanelElements = document.querySelectorAll('#html-panel');
    htmlPanelElements.forEach(panel => {
        if (panel) panel.style.display = 'block';
    });
    
    try {
        // Only select elements within budget component to avoid conflicts with other components
        const budgetContainer = document.querySelector('.budget');
        if (!budgetContainer) {
            console.error('[BUDGET] Tab Switch: Cannot find budget container');
            return false;
        }
        
        // Update tab active state - ONLY WITHIN BUDGET CONTAINER
        const tabs = budgetContainer.querySelectorAll('.budget__tab');
        tabs.forEach(tab => {
            if (tab.getAttribute('data-tab') === tabId) {
                tab.classList.add('budget__tab--active');
            } else {
                tab.classList.remove('budget__tab--active');
            }
        });
        
        // Update panel visibility - ONLY WITHIN BUDGET CONTAINER
        const panels = budgetContainer.querySelectorAll('.budget__panel');
        panels.forEach(panel => {
            const panelId = panel.id;
            if (panelId === tabId + '-panel') {
                panel.style.display = 'block';
                panel.classList.add('budget__panel--active');
            } else {
                panel.style.display = 'none';
                panel.classList.remove('budget__panel--active');
            }
        });
        
        // Update clear button visibility for chat tabs
        const clearButton = budgetContainer.querySelector('#clear-chat-btn');
        if (clearButton) {
            clearButton.style.display = (tabId === 'teamchat' || tabId === 'budgetchat') ? 'block' : 'none';
        }
        
        // Update component state
        if (window.budgetComponent) {
            window.budgetComponent.state = window.budgetComponent.state || {};
            window.budgetComponent.state.activeTab = tabId;
            
            // Update chat placeholder based on active tab
            if (typeof window.budgetComponent.updateChatPlaceholder === 'function') {
                window.budgetComponent.updateChatPlaceholder(tabId);
            }
            
            // Call component-specific methods if available
            if (typeof window.budgetComponent.loadTabContent === 'function') {
                window.budgetComponent.loadTabContent(tabId);
            }
            
            if (typeof window.budgetComponent.saveComponentState === 'function') {
                window.budgetComponent.saveComponentState();
            }
        }
    } catch (err) {
        console.error('[BUDGET] Error in tab switching:', err);
    }
    
    return false; // Stop event propagation
};

// CHAT CLEARING FUNCTION
window.budget_clearChat = function() {
    console.log('[BUDGET] Clear chat clicked');
    
    try {
        // Get active tab ID within budget container
        const budgetContainer = document.querySelector('.budget');
        if (!budgetContainer) {
            console.error('[BUDGET] Clear Chat: Cannot find budget container');
            return false;
        }
        
        const activeTab = budgetContainer.querySelector('.budget__tab--active');
        const tabId = activeTab ? activeTab.getAttribute('data-tab') : '';
        
        if (tabId === 'teamchat' || tabId === 'budgetchat') {
            // Get message container within budget container only
            const panelId = `#${tabId}-messages`;
            const panel = budgetContainer.querySelector(panelId);
            if (panel) {
                // Keep welcome message
                const welcomeMsg = panel.querySelector('.budget__message--system');
                if (welcomeMsg) {
                    panel.innerHTML = '';
                    panel.appendChild(welcomeMsg);
                    console.log(`[BUDGET] Cleared ${tabId}, kept welcome message`);
                } else {
                    panel.innerHTML = '';
                    console.log(`[BUDGET] Cleared ${tabId} completely`);
                }
            }
        }
    } catch (err) {
        console.error('[BUDGET] Error clearing chat:', err);
    }
    
    return false; // Stop event propagation
};

// DATA REFRESH FUNCTION
window.budget_refreshData = function() {
    console.log('[BUDGET] Refreshing budget data');
    
    try {
        if (window.budgetComponent && typeof window.budgetComponent.refreshData === 'function') {
            window.budgetComponent.refreshData();
        } else {
            console.log('[BUDGET] Component not available for refresh, will try again');
            setTimeout(window.budget_refreshData, 1000); // Retry after 1 second
        }
    } catch (err) {
        console.error('[BUDGET] Error refreshing data:', err);
    }
    
    return false; // Stop event propagation
};

// USAGE FILTER FUNCTION
window.budget_filterUsage = function() {
    console.log('[BUDGET] Filtering usage data');
    
    try {
        if (window.budgetComponent && typeof window.budgetComponent.filterUsage === 'function') {
            window.budgetComponent.filterUsage();
        }
    } catch (err) {
        console.error('[BUDGET] Error filtering usage data:', err);
    }
    
    return false; // Stop event propagation
};

// SAVE SETTINGS FUNCTION
window.budget_saveSettings = function() {
    console.log('[BUDGET] Saving budget settings');
    
    try {
        if (window.budgetComponent && typeof window.budgetComponent.saveBudgetSettings === 'function') {
            window.budgetComponent.saveBudgetSettings();
        }
    } catch (err) {
        console.error('[BUDGET] Error saving budget settings:', err);
    }
    
    return false; // Stop event propagation
};

// SAVE ALERT SETTINGS FUNCTION
window.budget_saveAlertSettings = function() {
    console.log('[BUDGET] Saving alert settings');
    
    try {
        if (window.budgetComponent && typeof window.budgetComponent.saveAlertSettings === 'function') {
            window.budgetComponent.saveAlertSettings();
        }
    } catch (err) {
        console.error('[BUDGET] Error saving alert settings:', err);
    }
    
    return false; // Stop event propagation
};

// CLEAR ALERTS FUNCTION
window.budget_clearAlerts = function() {
    console.log('[BUDGET] Clearing all alerts');
    
    try {
        if (window.budgetComponent && typeof window.budgetComponent.clearAlerts === 'function') {
            window.budgetComponent.clearAlerts();
        }
    } catch (err) {
        console.error('[BUDGET] Error clearing alerts:', err);
    }
    
    return false; // Stop event propagation
};

// HTML PANEL PROTECTION
// Setup explicit protection for the HTML panel to prevent it being hidden
function budget_protectHtmlPanel() {
    const htmlPanel = document.getElementById('html-panel');
    if (!htmlPanel) {
        console.error('[BUDGET] Cannot find HTML panel to protect');
        return;
    }
    
    console.log('[BUDGET] Protecting HTML panel from being hidden');
    htmlPanel.style.display = 'block'; // Force it to be visible
    
    // Store the original display value
    if (!htmlPanel.hasOwnProperty('_budgetOriginalDisplay')) {
        Object.defineProperty(htmlPanel, '_budgetOriginalDisplay', {
            value: 'block',
            writable: true,
            configurable: true
        });
    }
    
    // Only define the getter/setter if it hasn't already been defined by this component
    if (!htmlPanel.style._budgetProtected) {
        // Mark the display property as protected by this component
        Object.defineProperty(htmlPanel.style, '_budgetProtected', {
            value: true,
            writable: false,
            configurable: true
        });
        
        // Protect the display property
        Object.defineProperty(htmlPanel.style, 'display', {
            get: function() { 
                return htmlPanel._budgetOriginalDisplay; 
            },
            set: function(value) {
                console.log(`[BUDGET] Intercepted attempt to set HTML panel display to: ${value}`);
                if (value === 'none') {
                    console.log('[BUDGET] Blocked attempt to hide HTML panel');
                    htmlPanel._budgetOriginalDisplay = 'block';
                } else {
                    htmlPanel._budgetOriginalDisplay = value;
                }
            },
            configurable: true
        });
    }
}

// BACKEND INTEGRATION FUNCTIONS
// Following HTML injection pattern with no DOM manipulation

async function budget_loadBudgetData() {
    console.log('[BUDGET] Loading budget data from backend');
    
    try {
        // First, try to get list of budgets
        const budgetsResponse = await fetch(budgetUrl('/api/v1/budgets'));
        if (!budgetsResponse.ok) throw new Error('Failed to fetch budgets');
        
        const budgetsList = await budgetsResponse.json();
        
        // If no budgets exist, show message
        if (!budgetsList.items || budgetsList.items.length === 0) {
            console.log('[BUDGET] No budgets found, showing default UI');
            budget_showNoBudgetsMessage();
            return;
        }
        
        // Use the first budget
        const budgetId = budgetsList.items[0].budget_id;
        
        // Get budget summary for today, this week, and this month
        const today = new Date().toISOString().split('T')[0];
        const summaryResponse = await fetch(budgetUrl(`/api/v1/budgets/${budgetId}/summary?period=daily`));
        if (!summaryResponse.ok) throw new Error('Failed to fetch budget summary');
        
        const summaries = await summaryResponse.json();
        const data = {
            daily: summaries[0] || { spent: 0, limit: 5.00 },
            weekly: { spent: 0, limit: 25.00 },
            monthly: { spent: 0, limit: 100.00 }
        };
        
        // Update daily card using innerHTML
        const dailyCard = document.querySelector('.budget__card:nth-child(1)');
        if (dailyCard && data.daily) {
            const percent = (data.daily.spent / data.daily.limit * 100).toFixed(1);
            dailyCard.innerHTML = `
                <div class="budget__card-header">
                    <div class="budget__card-title">Daily Spend</div>
                    <div class="budget__card-period">Today</div>
                </div>
                <div class="budget__card-amount-container">
                    <div class="budget__card-amount">$${data.daily.spent.toFixed(2)}</div>
                    <div class="budget__card-limit">/ $${data.daily.limit.toFixed(2)}</div>
                </div>
                <div class="budget__card-progress">
                    <div class="budget__card-progress-bar" style="width: ${percent}%"></div>
                </div>
                <div class="budget__card-footer">
                    <div>${percent}% of daily limit</div>
                    <div>Today</div>
                </div>
            `;
        }
        
        // Update weekly card
        const weeklyCard = document.querySelector('.budget__card:nth-child(2)');
        if (weeklyCard && data.weekly) {
            const percent = (data.weekly.spent / data.weekly.limit * 100).toFixed(1);
            weeklyCard.innerHTML = `
                <div class="budget__card-header">
                    <div class="budget__card-title">Weekly Spend</div>
                    <div class="budget__card-period">This Week</div>
                </div>
                <div class="budget__card-amount-container">
                    <div class="budget__card-amount">$${data.weekly.spent.toFixed(2)}</div>
                    <div class="budget__card-limit">/ $${data.weekly.limit.toFixed(2)}</div>
                </div>
                <div class="budget__card-progress">
                    <div class="budget__card-progress-bar" style="width: ${percent}%"></div>
                </div>
                <div class="budget__card-footer">
                    <div>${percent}% of weekly limit</div>
                    <div>${data.weekly.period}</div>
                </div>
            `;
        }
        
        // Update monthly card
        const monthlyCard = document.querySelector('.budget__card:nth-child(3)');
        if (monthlyCard && data.monthly) {
            const percent = (data.monthly.spent / data.monthly.limit * 100).toFixed(1);
            monthlyCard.innerHTML = `
                <div class="budget__card-header">
                    <div class="budget__card-title">Monthly Spend</div>
                    <div class="budget__card-period">This Month</div>
                </div>
                <div class="budget__card-amount-container">
                    <div class="budget__card-amount">$${data.monthly.spent.toFixed(2)}</div>
                    <div class="budget__card-limit">/ $${data.monthly.limit.toFixed(2)}</div>
                </div>
                <div class="budget__card-progress">
                    <div class="budget__card-progress-bar" style="width: ${percent}%"></div>
                </div>
                <div class="budget__card-footer">
                    <div>${percent}% of monthly limit</div>
                    <div>${data.monthly.period}</div>
                </div>
            `;
        }
        
        // Update metrics
        const metricsContainer = document.querySelector('.budget__metrics');
        if (metricsContainer && data.metrics) {
            metricsContainer.innerHTML = `
                <div class="budget__metric">
                    <div class="budget__metric-label">Total Tokens</div>
                    <div class="budget__metric-value">${(data.metrics.total_tokens / 1000000).toFixed(1)}M</div>
                </div>
                <div class="budget__metric">
                    <div class="budget__metric-label">Avg Cost/Token</div>
                    <div class="budget__metric-value">$${data.metrics.avg_cost_per_token.toFixed(4)}</div>
                </div>
                <div class="budget__metric">
                    <div class="budget__metric-label">Active Models</div>
                    <div class="budget__metric-value">${data.metrics.active_models}</div>
                </div>
                <div class="budget__metric">
                    <div class="budget__metric-label">Requests Today</div>
                    <div class="budget__metric-value">${data.metrics.requests_today}</div>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('[BUDGET] Error loading budget data:', error);
    }
}

// Show message when no budgets exist
function budget_showNoBudgetsMessage() {
    console.log('[BUDGET] No budgets configured yet');
    
    // Update summary cards to show configuration needed
    const summaryContainer = document.querySelector('.budget__summary');
    if (summaryContainer) {
        summaryContainer.innerHTML = `
            <div class="budget__empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                <h3>No Budgets Configured</h3>
                <p>Budget tracking is ready but no budgets have been set up yet.</p>
                <p>To create a budget, use the Budget API or contact your administrator.</p>
            </div>
        `;
    }
    
    // Clear charts
    const chartsContainer = document.querySelector('.budget__charts');
    if (chartsContainer) {
        chartsContainer.style.display = 'none';
    }
}

async function budget_loadUsageData() {
    console.log('[BUDGET] Loading usage data from backend');
    
    try {
        // Fetch usage records
        const response = await fetch(budgetUrl('/api/v1/usage/records?limit=20'));
        if (!response.ok) throw new Error('Failed to fetch usage data');
        
        const data = await response.json();
        
        // Update usage table
        const tbody = document.getElementById('usage-table-body');
        if (tbody) {
            if (data.items && data.items.length > 0) {
                tbody.innerHTML = data.items.map(item => `
                    <tr>
                        <td>${new Date(item.timestamp).toLocaleString()}</td>
                        <td>${item.component || 'Unknown'}</td>
                        <td>${item.provider} / ${item.model}</td>
                        <td>${item.task_type}</td>
                        <td>${item.total_tokens ? item.total_tokens.toLocaleString() : '0'}</td>
                        <td>$${item.cost ? item.cost.toFixed(4) : '0.0000'}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; opacity: 0.7;">
                            No usage records found
                        </td>
                    </tr>
                `;
            }
        }
        
        // Update top usage
        const topUsageBody = document.querySelector('#top-usage-body');
        if (topUsageBody && data.top_usage) {
            const topRows = data.top_usage.map(item => `
                <tr>
                    <td>${item.model}</td>
                    <td>${item.provider}</td>
                    <td>${item.requests.toLocaleString()}</td>
                    <td>${(item.tokens / 1000000).toFixed(2)}M</td>
                    <td>$${item.cost.toFixed(2)}</td>
                </tr>
            `).join('');
            
            topUsageBody.innerHTML = topRows;
        }
        
    } catch (error) {
        console.error('[BUDGET] Error loading usage data:', error);
    }
}

// Override the refresh function to use our integration
window.budget_refreshData = async function() {
    console.log('[BUDGET] Refreshing all budget data');
    
    try {
        // Load both budget and usage data
        await Promise.all([
            budget_loadBudgetData(),
            budget_loadUsageData()
        ]);
        
        console.log('[BUDGET] Data refresh complete');
    } catch (error) {
        console.error('[BUDGET] Error refreshing data:', error);
    }
    
    return false;
};

// LOAD COMPONENT
// Load after defining tab switching to ensure it's available
function budget_loadComponent() {
    console.log('[BUDGET] Loading component script...');
    
    const timestamp = new Date().getTime();
    const scriptPath = `/scripts/budget/budget-component.js?t=${timestamp}`;
    
    const script = document.createElement('script');
    script.src = scriptPath;
    script.async = false;
    script.onload = function() {
        console.log('[BUDGET] Component script loaded successfully');
        
        if (window.budgetComponent && typeof window.budgetComponent.init === 'function') {
            try {
                window.budgetComponent.init();
                console.log('[BUDGET] Component initialized');
                
                // Enable debug mode if available
                if (window.TektonDebug) {
                    console.log('[BUDGET] Debug mode available, enabling for Budget component');
                    window.TektonDebug.registerComponent('budgetComponent', window.budgetComponent);
                }
                
                // Load initial data
                budget_refreshData();
                
            } catch (err) {
                console.error('[BUDGET] Component initialization error:', err);
            }
        } else {
            console.warn('[BUDGET] Component init function not found');
            // Still try to load data even if component script fails
            budget_refreshData();
        }
    };
    script.onerror = function() {
        console.error('[BUDGET] Failed to load component script');
        // Still try to load data even if component script fails
        budget_refreshData();
    };
    
    document.body.appendChild(script);
}

// SETUP DONE AFTER PAGE LOAD
// This ensures the functions are available before the tab events need them
window.addEventListener('DOMContentLoaded', function() {
    console.log('[BUDGET] DOM loaded, setting up Budget component');
    budget_protectHtmlPanel();
    budget_loadComponent();
});

// IMMEDIATE PROTECTION
// In case the DOM is already loaded
if (document.readyState === 'complete' || document.readyState === 'interactive') {
    console.log('[BUDGET] Document already loaded, setting up Budget component immediately');
    budget_protectHtmlPanel();
    budget_loadComponent();
}

// Chat functionality - Following Numa's pattern
function budget_sendChat() {
    const input = document.getElementById('budget-chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Determine which tab is active
    const budgetChatActive = document.querySelector('.budget__tab[data-tab="budgetchat"]').classList.contains('budget__tab--active');
    const chatType = budgetChatActive ? 'budgetchat' : 'teamchat';
    const messagesContainer = document.getElementById(`${chatType}-messages`);
    
    // Add user message
    const userMessageDiv = document.createElement('div');
    userMessageDiv.className = 'budget__message budget__message--user';
    userMessageDiv.innerHTML = `<div class="budget__message-content"><div class="budget__message-text">${message}</div></div>`;
    messagesContainer.appendChild(userMessageDiv);
    
    // Clear input
    input.value = '';
    
    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Send to backend
    if (chatType === 'budgetchat') {
        // Send message to Penia AI via AIChat
        if (window.AIChat) {
            window.AIChat.sendMessage('budget', message)
                .then(response => {
                    const aiMessageDiv = document.createElement('div');
                    aiMessageDiv.className = 'budget__message budget__message--ai';
                    aiMessageDiv.innerHTML = `<div class="budget__message-content"><div class="budget__message-text"><strong>Penia:</strong> ${response.content}</div></div>`;
                    messagesContainer.appendChild(aiMessageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                })
                .catch(err => {
                    console.error('Failed to send message:', err);
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'budget__message budget__message--system';
                    errorDiv.innerHTML = `<div class="budget__message-content"><div class="budget__message-text"><strong>System:</strong> Failed to connect to Budget AI</div></div>`;
                    messagesContainer.appendChild(errorDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
        }
    } else {
        // Team chat
        if (window.AIChat) {
            window.AIChat.teamChat(message, 'budget')
                .then(data => {
                    // Display team responses
                    if (data.responses && data.responses.length > 0) {
                        data.responses.forEach(resp => {
                            const aiMessageDiv = document.createElement('div');
                            aiMessageDiv.className = 'budget__message budget__message--ai';
                            const sender = resp.socket_id.replace('-ai', '').charAt(0).toUpperCase() + 
                                         resp.socket_id.replace('-ai', '').slice(1);
                            aiMessageDiv.innerHTML = `<div class="budget__message-content"><div class="budget__message-text"><strong>${sender}:</strong> ${resp.content}</div></div>`;
                            messagesContainer.appendChild(aiMessageDiv);
                        });
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                })
                .catch(err => {
                    console.error('Failed to send team message:', err);
                });
        }
    }
}

// Save budget settings
async function budget_saveSettings() {
    console.log('[BUDGET] Saving budget settings');
    
    try {
        // Get form values
        const settings = {
            daily_limit: parseFloat(document.getElementById('daily-limit')?.value || 5),
            weekly_limit: parseFloat(document.getElementById('weekly-limit')?.value || 25),
            monthly_limit: parseFloat(document.getElementById('monthly-limit')?.value || 100),
            enforcement_policy: document.getElementById('enforce-policy')?.value || 'warn',
            warning_threshold: parseInt(document.getElementById('warning-threshold')?.value || 80),
            allow_free_models: document.getElementById('allow-free-models')?.checked || false
        };
        
        // For now, just log the settings (no backend endpoint for settings update yet)
        console.log('[BUDGET] Settings to save:', settings);
        alert('Settings saved successfully!');
        
    } catch (error) {
        console.error('[BUDGET] Error saving settings:', error);
        alert('Failed to save settings');
    }
}

// Save alert settings
async function budget_saveAlertSettings() {
    console.log('[BUDGET] Saving alert settings');
    
    try {
        const settings = {
            email_alerts_enabled: document.getElementById('enable-email-alerts')?.checked || false,
            alert_email: document.getElementById('alert-email')?.value || '',
            alert_frequency: document.getElementById('alert-frequency')?.value || 'daily'
        };
        
        console.log('[BUDGET] Alert settings to save:', settings);
        alert('Alert settings saved successfully!');
        
    } catch (error) {
        console.error('[BUDGET] Error saving alert settings:', error);
        alert('Failed to save alert settings');
    }
}

// Clear all alerts
function budget_clearAlerts() {
    console.log('[BUDGET] Clearing all alerts');
    const alertList = document.querySelector('.budget__alert-list');
    if (alertList) {
        alertList.innerHTML = '<div class="budget__empty-state">No alerts</div>';
    }
}

// Apply filter preset
function budget_applyFilterPreset() {
    const preset = document.getElementById('filter-preset')?.value;
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    
    if (!startDateInput || !endDateInput) return;
    
    const today = new Date();
    const formatDate = (date) => date.toISOString().split('T')[0];
    
    switch (preset) {
        case 'today':
            startDateInput.value = formatDate(today);
            endDateInput.value = formatDate(today);
            break;
        case 'week':
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            startDateInput.value = formatDate(weekStart);
            endDateInput.value = formatDate(today);
            break;
        case 'month':
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            startDateInput.value = formatDate(monthStart);
            endDateInput.value = formatDate(today);
            break;
        case 'all':
            startDateInput.value = '2025-01-01';
            endDateInput.value = formatDate(today);
            break;
    }
}

// Filter usage by date
async function budget_filterUsage() {
    console.log('[BUDGET] Filtering usage data');
    const startDate = document.getElementById('start-date')?.value;
    const endDate = document.getElementById('end-date')?.value;
    
    console.log(`[BUDGET] Filtering from ${startDate} to ${endDate}`);
    
    // Reload usage data with date filter
    await budget_loadUsageData();
}

// Send message to budget assistant API
async function budget_sendToAssistant(message, chatType, messagesContainer) {
    const assistantUrl = budgetUrl('/api/v1/assistant');
    
    try {
        // Show typing indicator
        const typingHtml = `
            <div class="budget__message budget__message--ai budget__message--typing" id="typing-indicator">
                <div class="budget__message-content">
                    <div class="budget__typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>
        `;
        messagesContainer.innerHTML += typingHtml;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Send to assistant API
        const response = await fetch(assistantUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                context: chatType === 'team' ? 'team_collaboration' : 'budget_management',
                conversation_id: `${chatType}-chat-${Date.now()}`
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to get response from assistant');
        }
        
        const data = await response.json();
        
        // Remove typing indicator
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
        
        // Add AI response
        messagesContainer.innerHTML += `
            <div class="budget__message budget__message--ai">
                <div class="budget__message-content">
                    <div class="budget__message-text">${data.response || 'I can help you with budget management and cost tracking.'}</div>
                </div>
            </div>
        `;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
    } catch (error) {
        console.error('[BUDGET] Error sending to assistant:', error);
        
        // Remove typing indicator if exists
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
        
        // Show error message
        messagesContainer.innerHTML += `
            <div class="budget__message budget__message--ai">
                <div class="budget__message-content">
                    <div class="budget__message-text">I'm currently unable to connect to the budget assistant. Please try again later.</div>
                </div>
            </div>
        `;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

// Send chat message - using innerHTML injection pattern
function budget_sendChat() {
    const input = document.getElementById('budget-chat-input');
    if (!input || !input.value.trim()) return;
    
    const message = input.value.trim();
    const activeTab = document.querySelector('.budget__tab--active')?.dataset?.tab;
    const messagesContainer = activeTab === 'teamchat' 
        ? document.getElementById('teamchat-messages')
        : document.getElementById('budgetchat-messages');
    
    if (messagesContainer) {
        // Get existing messages (preserve welcome message)
        const existingHTML = messagesContainer.innerHTML;
        
        // Add user message using innerHTML
        messagesContainer.innerHTML = existingHTML + `
            <div class="budget__message budget__message--user">
                <div class="budget__message-content">
                    <div class="budget__message-text">${message}</div>
                </div>
            </div>
        `;
        
        // Send to backend
        if (activeTab === 'budgetchat') {
            // Direct message to budget
            if (window.AIChat) {
                window.AIChat.sendMessage('penia', message)
                    .then(response => {
                        messagesContainer.innerHTML += `
                            <div class="budget__message budget__message--ai">
                                <div class="budget__message-content">
                                    <div class="budget__message-text"><strong>Penia:</strong> ${response.content}</div>
                                </div>
                            </div>
                        `;
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    })
                    .catch(err => {
                        console.error('Failed to send message:', err);
                        messagesContainer.innerHTML += `
                            <div class="budget__message budget__message--system">
                                <div class="budget__message-content">
                                    <div class="budget__message-text"><strong>System:</strong> Failed to connect to Budget AI</div>
                                </div>
                            </div>
                        `;
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    });
            }
        } else {
            // Team chat
            if (window.AIChat) {
                window.AIChat.teamChat(message, 'penia')
                    .then(data => {
                        // Display team responses
                        if (data.responses && data.responses.length > 0) {
                            data.responses.forEach(resp => {
                                const sender = resp.socket_id.replace('-ai', '').charAt(0).toUpperCase() + 
                                             resp.socket_id.replace('-ai', '').slice(1);
                                messagesContainer.innerHTML += `
                                    <div class="budget__message budget__message--ai">
                                        <div class="budget__message-content">
                                            <div class="budget__message-text"><strong>${sender}:</strong> ${resp.content}</div>
                                        </div>
                                    </div>
                                `;
                            });
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                    })
                    .catch(err => {
                        console.error('Failed to send team message:', err);
                    });
            }
        }
        
        // Clear input and scroll
        input.value = '';
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

// Clear chat functionality
function budget_clearChat() {
    const budgetChatActive = document.querySelector('.budget__tab[data-tab="budgetchat"]').classList.contains('budget__tab--active');
    const teamChatActive = document.querySelector('.budget__tab[data-tab="teamchat"]').classList.contains('budget__tab--active');
    
    if (budgetChatActive) {
        const messagesContainer = document.getElementById('budgetchat-messages');
        // Keep the welcome message, remove all others
        const messages = messagesContainer.querySelectorAll('.budget__message:not(.budget__message--system)');
        messages.forEach(msg => msg.remove());
    } else if (teamChatActive) {
        const messagesContainer = document.getElementById('teamchat-messages');
        // Keep the welcome message, remove all others
        const messages = messagesContainer.querySelectorAll('.budget__message:not(.budget__message--system)');
        messages.forEach(msg => msg.remove());
    }
}

// Chart instances
let chartInstance = null;
let providerChartInstance = null;

// Initialize provider pie chart
function budget_initializeProviderChart() {
    const chartCanvas = document.getElementById('provider-pie-chart');
    if (!chartCanvas || typeof Chart === 'undefined') return;
    
    const ctx = chartCanvas.getContext('2d');
    
    // Destroy existing chart if any
    if (window.providerChartInstance) {
        window.providerChartInstance.destroy();
    }
    
    window.providerChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Anthropic', 'OpenAI', 'Ollama'],
            datasets: [{
                data: [27.50, 9.25, 0],
                backgroundColor: ['#7356BF', '#10A283', '#FF6600'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Update legend
    const legendContainer = document.getElementById('provider-legend');
    if (legendContainer) {
        legendContainer.innerHTML = `
            <div class="budget__legend-item">
                <span class="budget__legend-color" style="background-color: #7356BF;"></span>
                <span class="budget__legend-label">Anthropic: $27.50</span>
            </div>
            <div class="budget__legend-item">
                <span class="budget__legend-color" style="background-color: #10A283;"></span>
                <span class="budget__legend-label">OpenAI: $9.25</span>
            </div>
            <div class="budget__legend-item">
                <span class="budget__legend-color" style="background-color: #FF6600;"></span>
                <span class="budget__legend-label">Ollama: $0.00</span>
            </div>
        `;
    }
}

// Initialize spend chart  
function budget_initializeChart() {
    const chartCanvas = document.getElementById('spend-chart');
    if (!chartCanvas || typeof Chart === 'undefined') return;
    
    const ctx = chartCanvas.getContext('2d');
    
    // Create initial chart with default data
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Apr 15', 'Apr 16', 'Apr 17', 'Apr 18', 'Apr 19', 'Apr 20', 'Apr 21'],
            datasets: [{
                label: 'Daily Spend',
                data: [2.34, 3.12, 2.89, 4.21, 3.76, 2.98, 2.47],
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                tension: 0.1
            }, {
                label: 'Cumulative',
                data: [2.34, 5.46, 8.35, 12.56, 16.32, 19.30, 21.77],
                borderColor: '#2196F3',
                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#ffffff'
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#ffffff'
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#ffffff',
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    }
                }
            }
        }
    });
}

// Initialize component and load data
console.log('[BUDGET] Initializing budget component');

// Initialize charts if Chart.js is available
if (typeof Chart !== 'undefined') {
    budget_initializeChart();
    budget_initializeProviderChart();
}

// Load data from backend when component initializes
budget_loadBudgetData();
budget_loadUsageData();
</script>