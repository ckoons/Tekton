<!-- Budget Component - LLM Usage and Budget Management -->
<!-- Load Chart.js dependency -->
<script src="/scripts/chart.js"></script>

<div class="budget" data-tekton-area="budget" data-tekton-component="budget" data-tekton-type="component-workspace" data-tekton-ai="budget-assistant" data-tekton-ai-ready="false">
    <!-- Component Header with Title -->
    <div class="budget__header" data-tekton-zone="header" data-tekton-section="header">
        <div class="budget__title-container">
            <img src="/images/hexagon.jpg" alt="Tekton" class="budget__icon">
            <h2 class="budget__title">
                <span class="budget__title-main">Budget</span>
                <span class="budget__title-sub">LLM Cost Management</span>
            </h2>
        </div>
    </div>
    
    <!-- Budget Menu Bar with Tab Navigation -->
    <div class="budget__menu-bar" data-tekton-zone="menu" data-tekton-zone="menu" data-tekton-nav="component-menu">
        <div class="budget__tabs" data-tekton-zone="menu">
            <div class="budget__tab budget__tab--active" data-tab="dashboard" onclick="budget_switchTab('dashboard'); return false;">
                <span class="budget__tab-label">Dashboard</span>
            </div>
            <div class="budget__tab" data-tab="details" onclick="budget_switchTab('details'); return false;">
                <span class="budget__tab-label">Usage Details</span>
            </div>
            <div class="budget__tab" data-tab="settings" onclick="budget_switchTab('settings'); return false;">
                <span class="budget__tab-label">Settings</span>
            </div>
            <div class="budget__tab" data-tab="alerts" onclick="budget_switchTab('alerts'); return false;">
                <span class="budget__tab-label">Alerts</span>
            </div>
            <div class="budget__tab" data-tab="budgetchat" onclick="budget_switchTab('budgetchat'); return false;">
                <span class="budget__tab-label">Budget Chat</span>
            </div>
            <div class="budget__tab" data-tab="teamchat" onclick="budget_switchTab('teamchat'); return false;">
                <span class="budget__tab-label">Team Chat</span>
            </div>
        </div>
        <div class="budget__actions">
            <button id="clear-chat-btn" class="budget__action-button" style="display: none;" onclick="budget_clearChat(); return false;">
                <span class="budget__button-label">Clear</span>
            </button>
            <button id="refresh-button" class="budget__action-button" onclick="budget_refreshData(); return false;">
                <span class="budget__button-label">Refresh</span>
            </button>
        </div>
    </div>
    
    <!-- Budget Content Area -->
    <div class="budget__content" data-tekton-zone="content" data-tekton-scrollable="true">
        <!-- Dashboard Tab (Default Active Tab) -->
        <div id="dashboard-panel" class="budget__panel budget__panel--active">
            <div class="budget__dashboard">
                <div class="budget__control-bar">
                    <div class="budget__filter-container">
                        <select id="period-select" class="budget__filter-select">
                            <option value="daily">Daily View</option>
                            <option value="weekly">Weekly View</option>
                            <option value="monthly" selected>Monthly View</option>
                        </select>
                    </div>
                </div>
                
                <!-- Budget Summary Cards -->
                <div class="budget__summary">
                    <div class="budget__card">
                        <div class="budget__card-header">
                            <div class="budget__card-title">Daily Spend</div>
                            <div class="budget__card-period">Today</div>
                        </div>
                        <div class="budget__card-amount-container">
                            <div class="budget__card-amount">$2.47</div>
                            <div class="budget__card-limit">/ $5.00</div>
                        </div>
                        <div class="budget__card-progress">
                            <div class="budget__card-progress-bar" style="width: 49.4%"></div>
                        </div>
                        <div class="budget__card-footer">
                            <div>49.4% of daily limit</div>
                            <div>Today</div>
                        </div>
                    </div>
                    
                    <div class="budget__card">
                        <div class="budget__card-header">
                            <div class="budget__card-title">Weekly Spend</div>
                            <div class="budget__card-period">This Week</div>
                        </div>
                        <div class="budget__card-amount-container">
                            <div class="budget__card-amount">$12.89</div>
                            <div class="budget__card-limit">/ $25.00</div>
                        </div>
                        <div class="budget__card-progress">
                            <div class="budget__card-progress-bar" style="width: 51.6%"></div>
                        </div>
                        <div class="budget__card-footer">
                            <div>51.6% of weekly limit</div>
                            <div>Apr 15 - Apr 21, 2025</div>
                        </div>
                    </div>
                    
                    <div class="budget__card">
                        <div class="budget__card-header">
                            <div class="budget__card-title">Monthly Spend</div>
                            <div class="budget__card-period">April 2025</div>
                        </div>
                        <div class="budget__card-amount-container">
                            <div class="budget__card-amount">$36.75</div>
                            <div class="budget__card-limit">/ $100.00</div>
                        </div>
                        <div class="budget__card-progress">
                            <div class="budget__card-progress-bar" style="width: 36.8%"></div>
                        </div>
                        <div class="budget__card-footer">
                            <div>36.8% of monthly limit</div>
                            <div>Apr 1 - Apr 30, 2025</div>
                        </div>
                    </div>
                    
                    <div class="budget__card">
                        <div class="budget__card-header">
                            <div class="budget__card-title">Token Usage</div>
                            <div class="budget__card-period">Last 24 Hours</div>
                        </div>
                        <div class="budget__card-amount-container">
                            <div class="budget__card-amount">1.2M</div>
                            <div class="budget__card-limit">tokens</div>
                        </div>
                        <div class="budget__card-footer">
                            <div>Input: 542K</div>
                            <div>Output: 658K</div>
                        </div>
                    </div>
                </div>
      
                <!-- Charts Section -->
                <div class="budget__charts">
                    <div class="budget__chart-card">
                        <div class="budget__chart-header">
                            <h3 class="budget__chart-title">Spend by Provider</h3>
                            <div class="budget__chart-controls">
                                <select class="budget__select">
                                    <option value="provider">By Provider</option>
                                    <option value="model">By Model</option>
                                    <option value="component">By Component</option>
                                </select>
                            </div>
                        </div>
                        <div class="budget__chart-container">
                            <div class="budget__chart-placeholder" id="provider-pie-chart">
                                <!-- Chart will be rendered here by JavaScript -->
                                <div>Provider Distribution Chart</div>
                                <div>(Placeholder)</div>
                            </div>
                        </div>
                        <div class="budget__chart-legend">
                            <div class="budget__legend-item">
                                <span class="budget__legend-color" style="background-color: #7356BF;"></span>
                                <span class="budget__legend-label">Anthropic: $27.50</span>
                            </div>
                            <div class="budget__legend-item">
                                <span class="budget__legend-color" style="background-color: #10A283;"></span>
                                <span class="budget__legend-label">OpenAI: $9.25</span>
                            </div>
                            <div class="budget__legend-item">
                                <span class="budget__legend-color" style="background-color: #FF6600;"></span>
                                <span class="budget__legend-label">Ollama: $0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="budget__chart-card">
                        <div class="budget__chart-header">
                            <h3 class="budget__chart-title">Daily Spend Trend</h3>
                            <div class="budget__chart-controls">
                                <select class="budget__select">
                                    <option value="7days">Last 7 Days</option>
                                    <option value="30days" selected>Last 30 Days</option>
                                    <option value="90days">Last 90 Days</option>
                                </select>
                            </div>
                        </div>
                        <div class="budget__chart-container">
                            <div class="budget__chart-placeholder" id="trend-chart">
                                <!-- Chart will be rendered here by JavaScript -->
                                <div>Daily Spend Trend Chart</div>
                                <div>(Placeholder)</div>
                            </div>
                        </div>
                        <div class="budget__chart-legend">
                            <div class="budget__legend-item">
                                <span class="budget__legend-color" style="background-color: #3B82F6;"></span>
                                <span class="budget__legend-label">Actual Spend</span>
                            </div>
                            <div class="budget__legend-item">
                                <span class="budget__legend-color" style="background-color: #94A3B8;"></span>
                                <span class="budget__legend-label">Budget Limit</span>
                            </div>
                        </div>
                    </div>
                </div>
      
                <!-- Top Usage Section -->
                <div class="budget__detail">
                    <div class="budget__detail-header">
                        <h3 class="budget__detail-title">Top Usage</h3>
                        <div class="budget__detail-controls">
                            <select class="budget__select">
                                <option value="component">By Component</option>
                                <option value="model" selected>By Model</option>
                                <option value="task">By Task Type</option>
                            </select>
                        </div>
                    </div>
                    <div class="budget__table-container">
                        <table class="budget__table">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>Provider</th>
                                    <th>Token Count</th>
                                    <th>Cost</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Claude 3 Sonnet</td>
                                    <td><span class="budget__badge budget__badge--anthropic">Anthropic</span></td>
                                    <td>230,450</td>
                                    <td>$3.46</td>
                                    <td>34.6%</td>
                                </tr>
                                <tr>
                                    <td>Claude 3 Haiku</td>
                                    <td><span class="budget__badge budget__badge--anthropic">Anthropic</span></td>
                                    <td>543,120</td>
                                    <td>$0.68</td>
                                    <td>6.8%</td>
                                </tr>
                                <tr>
                                    <td>GPT-4</td>
                                    <td><span class="budget__badge budget__badge--openai">OpenAI</span></td>
                                    <td>104,300</td>
                                    <td>$6.26</td>
                                    <td>62.6%</td>
                                </tr>
                                <tr>
                                    <td>Llama 3</td>
                                    <td><span class="budget__badge budget__badge--ollama">Ollama</span></td>
                                    <td>1,250,680</td>
                                    <td>$0.00</td>
                                    <td>0.0%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usage Details Tab -->
        <div id="details-panel" class="budget__panel">
            <div class="budget__usage-details">
                <div class="budget__control-bar">
                    <div class="budget__date-filter">
                        <input type="date" class="budget__input" id="start-date" value="2025-04-01">
                        <input type="date" class="budget__input" id="end-date" value="2025-04-21">
                        <button class="budget__button" id="filter-usage" onclick="budget_filterUsage(); return false;">Apply Filter</button>
                    </div>
                </div>
                
                <div class="budget__table-container">
                    <table class="budget__table">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Component</th>
                                <th>Provider/Model</th>
                                <th>Task Type</th>
                                <th>Tokens</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>2025-04-21 15:42</td>
                                <td>Terma</td>
                                <td><span class="budget__badge budget__badge--anthropic">Claude 3 Sonnet</span></td>
                                <td>chat</td>
                                <td>4,320</td>
                                <td>$0.06</td>
                            </tr>
                            <tr>
                                <td>2025-04-21 14:15</td>
                                <td>Ergon</td>
                                <td><span class="budget__badge budget__badge--anthropic">Claude 3 Haiku</span></td>
                                <td>agent_creation</td>
                                <td>12,450</td>
                                <td>$0.02</td>
                            </tr>
                            <tr>
                                <td>2025-04-21 10:33</td>
                                <td>Athena</td>
                                <td><span class="budget__badge budget__badge--openai">GPT-4</span></td>
                                <td>knowledge_retrieval</td>
                                <td>3,280</td>
                                <td>$0.19</td>
                            </tr>
                            <tr>
                                <td>2025-04-20 18:22</td>
                                <td>Codex</td>
                                <td><span class="budget__badge budget__badge--ollama">Llama 3</span></td>
                                <td>code_completion</td>
                                <td>45,320</td>
                                <td>$0.00</td>
                            </tr>
                            <tr>
                                <td>2025-04-20 16:05</td>
                                <td>Terma</td>
                                <td><span class="budget__badge budget__badge--anthropic">Claude 3 Sonnet</span></td>
                                <td>chat</td>
                                <td>8,730</td>
                                <td>$0.13</td>
                            </tr>
                            <tr>
                                <td>2025-04-20 11:47</td>
                                <td>Ergon</td>
                                <td><span class="budget__badge budget__badge--anthropic">Claude 3 Haiku</span></td>
                                <td>workflow_planning</td>
                                <td>15,680</td>
                                <td>$0.02</td>
                            </tr>
                            <tr>
                                <td>2025-04-19 22:15</td>
                                <td>Athena</td>
                                <td><span class="budget__badge budget__badge--openai">GPT-4</span></td>
                                <td>data_analysis</td>
                                <td>7,620</td>
                                <td>$0.46</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="budget__pagination">
                    <button class="budget__button budget__button--small">Previous</button>
                    <span class="budget__pagination-indicator">Page 1 of 14</span>
                    <button class="budget__button budget__button--small">Next</button>
                </div>
            </div>
        </div>

        <!-- Budget Settings Tab -->
        <div id="settings-panel" class="budget__panel">
            <div class="budget__settings">
                <div class="budget__control-bar">
                    <div class="budget__settings-header">
                        <div class="budget__settings-actions">
                            <button class="budget__button budget__button--primary" id="save-budget-settings" onclick="budget_saveSettings(); return false;">Save Settings</button>
                        </div>
                    </div>
                </div>
                
                <!-- Budget Limits Section -->
                <div class="budget__settings-section">
                    <div class="budget__settings-header">
                        <h3 class="budget__settings-title">Budget Limits</h3>
                    </div>
                    <div class="budget__settings-form">
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="daily-limit">Daily Budget Limit</label>
                            <div class="budget__form-input-container">
                                <span class="budget__form-input-prefix">$</span>
                                <input type="number" id="daily-limit" class="budget__input" value="5.00" min="0" step="0.01">
                            </div>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="weekly-limit">Weekly Budget Limit</label>
                            <div class="budget__form-input-container">
                                <span class="budget__form-input-prefix">$</span>
                                <input type="number" id="weekly-limit" class="budget__input" value="25.00" min="0" step="0.01">
                            </div>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="monthly-limit">Monthly Budget Limit</label>
                            <div class="budget__form-input-container">
                                <span class="budget__form-input-prefix">$</span>
                                <input type="number" id="monthly-limit" class="budget__input" value="100.00" min="0" step="0.01">
                            </div>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="enforce-policy">Enforcement Policy</label>
                            <select id="enforce-policy" class="budget__select">
                                <option value="ignore">Track Only (No Enforcement)</option>
                                <option value="warn">Show Warnings</option>
                                <option value="enforce" selected>Enforce Limits (Auto Downgrade)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Provider Budgets Section -->
                <div class="budget__settings-section">
                    <div class="budget__settings-header">
                        <h3 class="budget__settings-title">Provider Budgets</h3>
                    </div>
                    <div class="budget__settings-form">
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="anthropic-limit">Anthropic Monthly Budget</label>
                            <div class="budget__form-input-container">
                                <span class="budget__form-input-prefix">$</span>
                                <input type="number" id="anthropic-limit" class="budget__input" value="80.00" min="0" step="0.01">
                            </div>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="openai-limit">OpenAI Monthly Budget</label>
                            <div class="budget__form-input-container">
                                <span class="budget__form-input-prefix">$</span>
                                <input type="number" id="openai-limit" class="budget__input" value="20.00" min="0" step="0.01">
                            </div>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="enable-provider-limits">Enable Provider-Specific Limits</label>
                            <div class="budget__form-switch">
                                <input type="checkbox" id="enable-provider-limits" class="budget__checkbox" checked>
                                <span class="budget__form-switch-label">Enabled</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Settings Section -->
                <div class="budget__settings-section">
                    <div class="budget__settings-header">
                        <h3 class="budget__settings-title">Advanced Settings</h3>
                    </div>
                    <div class="budget__settings-form">
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="warning-threshold">Warning Threshold</label>
                            <div class="budget__form-input-container">
                                <input type="number" id="warning-threshold" class="budget__input" value="80" min="1" max="100">
                                <span class="budget__form-input-suffix">%</span>
                            </div>
                            <span class="budget__form-help-text">Show warnings when usage reaches this percentage of the limit</span>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="allow-free-models">Allow Free Models When Budget Depleted</label>
                            <div class="budget__form-switch">
                                <input type="checkbox" id="allow-free-models" class="budget__checkbox" checked>
                                <span class="budget__form-switch-label">Enabled</span>
                            </div>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="reset-day">Budget Reset Day (Monthly)</label>
                            <select id="reset-day" class="budget__select">
                                <option value="1" selected>1st of month</option>
                                <option value="15">15th of month</option>
                                <option value="last">Last day of month</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Tab -->
        <div id="alerts-panel" class="budget__panel">
            <div class="budget__alerts">
                <div class="budget__control-bar">
                    <div class="budget__alerts-actions">
                        <button class="budget__button" id="clear-alerts" onclick="budget_clearAlerts(); return false;">Clear All</button>
                    </div>
                </div>
                
                <div class="budget__settings-section">
                    <div class="budget__settings-header">
                        <h3 class="budget__settings-title">Active Alerts</h3>
                    </div>
                    
                    <div class="budget__alert-list">
                        <div class="budget__alert">
                            <div class="budget__alert-info">
                                <div class="budget__alert-icon budget__alert-icon--warning">!</div>
                                <div class="budget__alert-details">
                                    <div class="budget__alert-title">Weekly Budget Warning</div>
                                    <div class="budget__alert-description">Weekly budget is at 82% of limit ($20.50 of $25.00)</div>
                                </div>
                            </div>
                            <div class="budget__alert-actions">
                                <button class="budget__button budget__button--small">Dismiss</button>
                            </div>
                        </div>
                        
                        <div class="budget__alert">
                            <div class="budget__alert-info">
                                <div class="budget__alert-icon budget__alert-icon--info">i</div>
                                <div class="budget__alert-details">
                                    <div class="budget__alert-title">OpenAI Budget Update</div>
                                    <div class="budget__alert-description">OpenAI provider reached 90% of its monthly allocation</div>
                                </div>
                            </div>
                            <div class="budget__alert-actions">
                                <button class="budget__button budget__button--small">Dismiss</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="budget__settings-section">
                    <div class="budget__settings-header">
                        <h3 class="budget__settings-title">Alert Settings</h3>
                    </div>
                    
                    <div class="budget__settings-form">
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="enable-email-alerts">Email Alerts</label>
                            <div class="budget__form-switch">
                                <input type="checkbox" id="enable-email-alerts" class="budget__checkbox" checked>
                                <span class="budget__form-switch-label">Enabled</span>
                            </div>
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="alert-email">Alert Email Address</label>
                            <input type="email" id="alert-email" class="budget__input" value="admin@example.com">
                        </div>
                        
                        <div class="budget__form-group">
                            <label class="budget__form-label" for="alert-frequency">Alert Frequency</label>
                            <select id="alert-frequency" class="budget__select">
                                <option value="immediate">Immediate</option>
                                <option value="daily" selected>Daily Summary</option>
                                <option value="weekly">Weekly Summary</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="budget__form-actions">
                        <button class="budget__button budget__button--primary" id="save-alert-settings" onclick="budget_saveAlertSettings(); return false;">Save Alert Settings</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget Chat Tab -->
        <div id="budgetchat-panel" class="budget__panel">
            <div id="budgetchat-messages" class="budget__chat-messages">
                <!-- Welcome message -->
                <div class="budget__message budget__message--system">
                    <div class="budget__message-content">
                        <div class="budget__message-text">
                            <h3 class="budget__message-title">Budget LLM Chat</h3>
                            <p>Chat directly with an LLM about budget optimization, cost management, and usage planning for your AI resources.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Team Chat Tab -->
        <div id="teamchat-panel" class="budget__panel">
            <div id="teamchat-messages" class="budget__chat-messages">
                <!-- Welcome message -->
                <div class="budget__message budget__message--system">
                    <div class="budget__message-content">
                        <div class="budget__message-text">
                            <h3 class="budget__message-title">Tekton Team Chat</h3>
                            <p>This chat is shared across all Tekton components. Use this for team communication and coordination about budget matters.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer with Chat Input -->
    <div class="budget__footer" data-tekton-zone="footer">
        <div class="budget__chat-input-container">
            <div class="budget__chat-prompt">></div>
            <input type="text" id="chat-input" class="budget__chat-input" 
                   placeholder="Ask about usage, costs, or budget settings">
            <button id="send-button" class="budget__send-button">Send</button>
        </div>
    </div>
</div>

<!-- Add component-specific styles -->
<style>
    /* Budget component styles using BEM naming convention */
    
    /* Container */
    .budget {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        background-color: var(--bg-primary, #1e1e2e);
        color: var(--text-primary, #f0f0f0);
        /* No absolute positioning - proper component containment */
    }
    
    /* Header */
    .budget__header {
        display: flex;
        align-items: center;
        padding: 10px 16px;
        background-color: var(--bg-secondary, #252535);
        border-bottom: 1px solid var(--border-color, #444444);
        height: 46px; /* Standardized header height */
    }
    
    .budget__title-container {
        display: flex;
        align-items: center;
    }
    
    .budget__icon {
        height: 30px;
        width: auto;
        margin-right: 12px;
    }
    
    .budget__title {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 500;
    }
    
    .budget__title-sub {
        margin-left: 8px;
        opacity: 0.8;
        font-weight: normal;
    }
    
    /* Menu Bar */
    .budget__menu-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 16px;
        background-color: var(--bg-secondary, #252535);
        border-bottom: 1px solid var(--border-color, #444444);
        height: 46px; /* Standardized menu bar height */
    }
    
    .budget__tabs {
        display: flex;
        gap: 8px;
    }
    
    .budget__tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background-color: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-primary, #f0f0f0);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .budget__tab:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .budget__tab--active {
        border-bottom-color: var(--color-primary, #34A853); /* Budget green from spec */
        font-weight: 500;
    }
    
    .budget__actions {
        display: flex;
        gap: 8px;
    }
    
    .budget__action-button {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .budget__action-button:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    /* Content Area */
    .budget__content {
        flex: 1;
        overflow: hidden;
        position: relative;
    }
    
    .budget__panel {
        display: none;
        height: 100%;
        width: 100%;
        overflow: auto;
    }
    
    .budget__panel--active {
        display: block;
    }
    
    /* Control Bar */
    .budget__control-bar {
        display: flex;
        justify-content: space-between;
        padding: 16px;
        background-color: var(--bg-secondary, #252535);
        border-bottom: 1px solid var(--border-color, #444444);
        height: 46px; /* Standard control bar height */
    }
    
    .budget__filter-container {
        display: flex;
        gap: 8px;
    }
    
    .budget__filter-select {
        padding: 8px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
    }
    
    /* Budget Summary Cards */
    .budget__summary {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
        padding: 16px;
    }
    
    .budget__card {
        background-color: var(--bg-secondary, #252535);
        border-radius: 8px;
        border: 1px solid var(--border-color, #444444);
        padding: 16px;
        display: flex;
        flex-direction: column;
    }
    
    .budget__card-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    
    .budget__card-title {
        font-weight: 500;
        font-size: 1.1rem;
    }
    
    .budget__card-period {
        opacity: 0.7;
        font-size: 0.9rem;
    }
    
    .budget__card-amount-container {
        display: flex;
        align-items: baseline;
        margin-bottom: 12px;
    }
    
    .budget__card-amount {
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--color-primary, #34A853); /* Budget green from spec */
    }
    
    .budget__card-limit {
        margin-left: 8px;
        opacity: 0.7;
    }
    
    .budget__card-progress {
        height: 8px;
        background-color: var(--bg-tertiary, #333345);
        border-radius: 4px;
        margin-bottom: 12px;
        overflow: hidden;
    }
    
    .budget__card-progress-bar {
        height: 100%;
        background-color: var(--color-primary, #34A853); /* Budget green from spec */
        border-radius: 4px;
    }
    
    .budget__card-progress-bar--warning {
        background-color: #FFA500;
    }
    
    .budget__card-progress-bar--danger {
        background-color: #FF4444;
    }
    
    .budget__card-footer {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        opacity: 0.7;
        margin-top: auto;
    }
    
    /* Charts */
    .budget__charts {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
        padding: 0 16px;
    }
    
    .budget__chart-card {
        background-color: var(--bg-secondary, #252535);
        border-radius: 8px;
        border: 1px solid var(--border-color, #444444);
        padding: 16px;
    }
    
    .budget__chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .budget__chart-title {
        margin: 0;
        font-size: 1.2rem;
    }
    
    .budget__chart-container {
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--bg-tertiary, #333345);
        border-radius: 4px;
        margin-bottom: 16px;
    }
    
    .budget__chart-placeholder {
        text-align: center;
        opacity: 0.7;
    }
    
    .budget__chart-legend {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .budget__legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .budget__legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }
    
    /* Detail Table */
    .budget__detail {
        margin-bottom: 24px;
        padding: 0 16px 16px;
    }
    
    .budget__detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .budget__detail-title {
        margin: 0;
        font-size: 1.2rem;
    }
    
    .budget__table-container {
        overflow-x: auto;
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        margin-bottom: 16px;
    }
    
    .budget__table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .budget__table th,
    .budget__table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-color, #444444);
    }
    
    .budget__table th {
        background-color: var(--bg-secondary, #252535);
        font-weight: 500;
    }
    
    .budget__table tr:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .budget__badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    
    .budget__badge--anthropic {
        background-color: #7356BF;
        color: white;
    }
    
    .budget__badge--openai {
        background-color: #10A283;
        color: white;
    }
    
    .budget__badge--ollama {
        background-color: #FF6600;
        color: white;
    }
    
    /* Pagination */
    .budget__pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
    }
    
    .budget__pagination-indicator {
        opacity: 0.7;
    }
    
    /* Settings Form Styles */
    .budget__settings-section {
        background-color: var(--bg-secondary, #252535);
        border-radius: 8px;
        border: 1px solid var(--border-color, #444444);
        margin-bottom: 24px;
        overflow: hidden;
    }
    
    .budget__settings-header {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color, #444444);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .budget__settings-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 500;
    }
    
    .budget__settings-form {
        padding: 16px;
    }
    
    .budget__form-group {
        margin-bottom: 16px;
    }
    
    .budget__form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
    }
    
    .budget__form-input-container {
        display: flex;
        align-items: center;
    }
    
    .budget__form-input-prefix,
    .budget__form-input-suffix {
        display: flex;
        align-items: center;
        padding: 0 8px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-right: none;
        border-radius: 4px 0 0 4px;
        height: 38px;
    }
    
    .budget__form-input-suffix {
        border-left: none;
        border-right: 1px solid var(--border-color, #444444);
        border-radius: 0 4px 4px 0;
    }
    
    .budget__input {
        flex: 1;
        height: 38px;
        padding: 8px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
    }
    
    .budget__input:focus {
        outline: none;
        border-color: var(--color-primary, #34A853); /* Budget green from spec */
    }
    
    .budget__form-input-container .budget__input {
        border-radius: 0 4px 4px 0;
    }
    
    .budget__form-input-container .budget__input:not(:first-child):not(:last-child) {
        border-radius: 0;
    }
    
    .budget__select {
        width: 100%;
        height: 38px;
        padding: 8px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
    }
    
    .budget__form-switch {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .budget__checkbox {
        position: relative;
        width: 40px;
        height: 20px;
        -webkit-appearance: none;
        background-color: var(--bg-tertiary, #333345);
        border-radius: 20px;
        border: 1px solid var(--border-color, #444444);
        outline: none;
        transition: .4s;
        cursor: pointer;
    }
    
    .budget__checkbox:checked {
        background-color: var(--color-primary, #34A853); /* Budget green from spec */
    }
    
    .budget__checkbox:before {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        border-radius: 20px;
        top: 1px;
        left: 1px;
        background-color: var(--text-primary, #f0f0f0);
        transform: translateX(0);
        transition: .4s;
    }
    
    .budget__checkbox:checked:before {
        transform: translateX(20px);
    }
    
    .budget__form-help-text {
        display: block;
        margin-top: 4px;
        font-size: 0.85rem;
        opacity: 0.7;
    }
    
    .budget__form-actions {
        display: flex;
        justify-content: flex-end;
        padding: 0 16px 16px;
    }
    
    /* Buttons */
    .budget__button {
        padding: 8px 16px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
        cursor: pointer;
    }
    
    .budget__button:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .budget__button--primary {
        background-color: var(--color-primary, #34A853); /* Budget green from spec */
        border-color: var(--color-primary, #34A853); /* Budget green from spec */
        color: white;
    }
    
    .budget__button--primary:hover {
        background-color: var(--color-primary-hover, #2D9249); /* Budget green darker */
    }
    
    .budget__button--small {
        padding: 4px 8px;
        font-size: 0.85rem;
    }
    
    .budget__button--danger {
        background-color: #E53935;
        border-color: #E53935;
        color: white;
    }
    
    .budget__button--danger:hover {
        background-color: #D32F2F;
    }
    
    /* Alert Styles */
    .budget__alert-list {
        padding: 16px;
    }
    
    .budget__alert {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-radius: 4px;
        background-color: var(--bg-tertiary, #333345);
        margin-bottom: 12px;
    }
    
    .budget__alert-info {
        display: flex;
        gap: 12px;
    }
    
    .budget__alert-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-weight: bold;
    }
    
    .budget__alert-icon--warning {
        background-color: #FFA500;
        color: black;
    }
    
    .budget__alert-icon--info {
        background-color: #3B82F6;
        color: white;
    }
    
    .budget__alert-title {
        font-weight: 500;
        margin-bottom: 4px;
    }
    
    .budget__alert-description {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    /* Date Filter */
    .budget__date-filter {
        display: flex;
        gap: 8px;
    }

    /* Chat Messages (for Team Chat tab) */
    .budget__chat-messages {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 70px; /* Height of the footer */
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .budget__message {
        border-radius: 16px;
        padding: 12px 16px;
        max-width: 85%;
        word-wrap: break-word;
        line-height: 1.4;
    }
    
    .budget__message--system {
        background-color: var(--bg-tertiary, #333345);
        align-self: center;
        max-width: 90%;
        width: 600px;
        margin: 8px 0;
        border-radius: 8px;
        padding: 16px 24px;
    }
    
    .budget__message--user {
        background-color: var(--color-primary, #34A853); /* Budget green from spec */
        color: white;
        align-self: flex-end;
        border-radius: 16px 16px 0 16px;
    }
    
    .budget__message--ai {
        background-color: var(--bg-secondary, #252535);
        align-self: flex-start;
        border-radius: 16px 16px 16px 0;
    }
    
    .budget__message-title {
        margin-top: 0;
        margin-bottom: 8px;
    }
    
    /* Footer */
    .budget__footer {
        background-color: var(--bg-secondary, #252535);
        border-top: 1px solid var(--border-color, #444444);
        padding: 12px 16px;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 70px; /* Fixed height to match bottom value in chat messages */
    }
    
    .budget__chat-input-container {
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
    }
    
    .budget__chat-prompt {
        font-size: 18px;
        font-weight: bold;
        color: #4CAF50;
    }
    
    .budget__chat-input {
        flex: 1;
        height: 44px;
        padding: 8px 16px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        color: var(--text-primary, #f0f0f0);
        font-size: 14px;
    }
    
    .budget__send-button {
        height: 44px;
        padding: 0 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--color-primary, #34A853); /* Budget green from spec */
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .budget__send-button:hover {
        background-color: var(--color-primary-hover, #2D9249); /* Budget green darker */
    }
    
    /* Loading Indicator */
    .budget__loading-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
    }
    
    .budget__spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        border-top: 4px solid var(--color-primary, #34A853); /* Budget green from spec */
        animation: budget-spin 1s linear infinite;
        margin-bottom: 16px;
    }
    
    .budget__loading-text {
        color: var(--text-secondary, #aaaaaa);
    }
    
    @keyframes budget-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<!-- Load Component Scripts -->
<script src="/components/budget/scripts/budget-models.js"></script>
<script src="/components/budget/scripts/budget-api-client.js"></script>
<script src="/components/budget/scripts/budget-state-manager.js"></script>
<script src="/components/budget/scripts/budget-ws-handler.js"></script>
<script src="/components/budget/scripts/budget-chart-utils.js"></script>
<script src="/components/budget/scripts/budget-cli-handler.js"></script>
<script src="/components/budget/scripts/budget-component.js"></script>

<script type="text/javascript">
// SIMPLIFIED COMPONENT SCRIPT - FULLY SELF-CONTAINED
// This version minimizes interference with other components

// IMMEDIATELY SET UP UI MANAGER PROTECTION
// Tell UI Manager to ignore this component - must be done IMMEDIATELY to avoid races
if (window.uiManager) {
    window.uiManager._ignoreComponent = 'budget';
    console.log('[BUDGET] Set UI Manager to ignore budget component');
}

// DEFINE TAB SWITCHING FUNCTION
// CRITICAL: This uses no shared code/utilities to avoid conflicts
window.budget_switchTab = function(tabId) {
    console.log('[BUDGET] Switching to tab:', tabId);
    
    // Force HTML panel visibility
    const htmlPanelElements = document.querySelectorAll('#html-panel');
    htmlPanelElements.forEach(panel => {
        if (panel) panel.style.display = 'block';
    });
    
    try {
        // Only select elements within budget component to avoid conflicts with other components
        const budgetContainer = document.querySelector('.budget');
        if (!budgetContainer) {
            console.error('[BUDGET] Tab Switch: Cannot find budget container');
            return false;
        }
        
        // Update tab active state - ONLY WITHIN BUDGET CONTAINER
        const tabs = budgetContainer.querySelectorAll('.budget__tab');
        tabs.forEach(tab => {
            if (tab.getAttribute('data-tab') === tabId) {
                tab.classList.add('budget__tab--active');
            } else {
                tab.classList.remove('budget__tab--active');
            }
        });
        
        // Update panel visibility - ONLY WITHIN BUDGET CONTAINER
        const panels = budgetContainer.querySelectorAll('.budget__panel');
        panels.forEach(panel => {
            const panelId = panel.id;
            if (panelId === tabId + '-panel') {
                panel.style.display = 'block';
                panel.classList.add('budget__panel--active');
            } else {
                panel.style.display = 'none';
                panel.classList.remove('budget__panel--active');
            }
        });
        
        // Update clear button visibility for chat tabs
        const clearButton = budgetContainer.querySelector('#clear-chat-btn');
        if (clearButton) {
            clearButton.style.display = (tabId === 'teamchat' || tabId === 'budgetchat') ? 'block' : 'none';
        }
        
        // Update component state
        if (window.budgetComponent) {
            window.budgetComponent.state = window.budgetComponent.state || {};
            window.budgetComponent.state.activeTab = tabId;
            
            // Update chat placeholder based on active tab
            if (typeof window.budgetComponent.updateChatPlaceholder === 'function') {
                window.budgetComponent.updateChatPlaceholder(tabId);
            }
            
            // Call component-specific methods if available
            if (typeof window.budgetComponent.loadTabContent === 'function') {
                window.budgetComponent.loadTabContent(tabId);
            }
            
            if (typeof window.budgetComponent.saveComponentState === 'function') {
                window.budgetComponent.saveComponentState();
            }
        }
    } catch (err) {
        console.error('[BUDGET] Error in tab switching:', err);
    }
    
    return false; // Stop event propagation
};

// CHAT CLEARING FUNCTION
window.budget_clearChat = function() {
    console.log('[BUDGET] Clear chat clicked');
    
    try {
        // Get active tab ID within budget container
        const budgetContainer = document.querySelector('.budget');
        if (!budgetContainer) {
            console.error('[BUDGET] Clear Chat: Cannot find budget container');
            return false;
        }
        
        const activeTab = budgetContainer.querySelector('.budget__tab--active');
        const tabId = activeTab ? activeTab.getAttribute('data-tab') : '';
        
        if (tabId === 'teamchat' || tabId === 'budgetchat') {
            // Get message container within budget container only
            const panelId = `#${tabId}-messages`;
            const panel = budgetContainer.querySelector(panelId);
            if (panel) {
                // Keep welcome message
                const welcomeMsg = panel.querySelector('.budget__message--system');
                if (welcomeMsg) {
                    panel.innerHTML = '';
                    panel.appendChild(welcomeMsg);
                    console.log(`[BUDGET] Cleared ${tabId}, kept welcome message`);
                } else {
                    panel.innerHTML = '';
                    console.log(`[BUDGET] Cleared ${tabId} completely`);
                }
            }
        }
    } catch (err) {
        console.error('[BUDGET] Error clearing chat:', err);
    }
    
    return false; // Stop event propagation
};

// DATA REFRESH FUNCTION
window.budget_refreshData = function() {
    console.log('[BUDGET] Refreshing budget data');
    
    try {
        if (window.budgetComponent && typeof window.budgetComponent.refreshData === 'function') {
            window.budgetComponent.refreshData();
        } else {
            console.log('[BUDGET] Component not available for refresh, will try again');
            setTimeout(window.budget_refreshData, 1000); // Retry after 1 second
        }
    } catch (err) {
        console.error('[BUDGET] Error refreshing data:', err);
    }
    
    return false; // Stop event propagation
};

// USAGE FILTER FUNCTION
window.budget_filterUsage = function() {
    console.log('[BUDGET] Filtering usage data');
    
    try {
        if (window.budgetComponent && typeof window.budgetComponent.filterUsage === 'function') {
            window.budgetComponent.filterUsage();
        }
    } catch (err) {
        console.error('[BUDGET] Error filtering usage data:', err);
    }
    
    return false; // Stop event propagation
};

// SAVE SETTINGS FUNCTION
window.budget_saveSettings = function() {
    console.log('[BUDGET] Saving budget settings');
    
    try {
        if (window.budgetComponent && typeof window.budgetComponent.saveBudgetSettings === 'function') {
            window.budgetComponent.saveBudgetSettings();
        }
    } catch (err) {
        console.error('[BUDGET] Error saving budget settings:', err);
    }
    
    return false; // Stop event propagation
};

// SAVE ALERT SETTINGS FUNCTION
window.budget_saveAlertSettings = function() {
    console.log('[BUDGET] Saving alert settings');
    
    try {
        if (window.budgetComponent && typeof window.budgetComponent.saveAlertSettings === 'function') {
            window.budgetComponent.saveAlertSettings();
        }
    } catch (err) {
        console.error('[BUDGET] Error saving alert settings:', err);
    }
    
    return false; // Stop event propagation
};

// CLEAR ALERTS FUNCTION
window.budget_clearAlerts = function() {
    console.log('[BUDGET] Clearing all alerts');
    
    try {
        if (window.budgetComponent && typeof window.budgetComponent.clearAlerts === 'function') {
            window.budgetComponent.clearAlerts();
        }
    } catch (err) {
        console.error('[BUDGET] Error clearing alerts:', err);
    }
    
    return false; // Stop event propagation
};

// HTML PANEL PROTECTION
// Setup explicit protection for the HTML panel to prevent it being hidden
function budget_protectHtmlPanel() {
    const htmlPanel = document.getElementById('html-panel');
    if (!htmlPanel) {
        console.error('[BUDGET] Cannot find HTML panel to protect');
        return;
    }
    
    console.log('[BUDGET] Protecting HTML panel from being hidden');
    htmlPanel.style.display = 'block'; // Force it to be visible
    
    // Store the original display value
    if (!htmlPanel.hasOwnProperty('_budgetOriginalDisplay')) {
        Object.defineProperty(htmlPanel, '_budgetOriginalDisplay', {
            value: 'block',
            writable: true,
            configurable: true
        });
    }
    
    // Only define the getter/setter if it hasn't already been defined by this component
    if (!htmlPanel.style._budgetProtected) {
        // Mark the display property as protected by this component
        Object.defineProperty(htmlPanel.style, '_budgetProtected', {
            value: true,
            writable: false,
            configurable: true
        });
        
        // Protect the display property
        Object.defineProperty(htmlPanel.style, 'display', {
            get: function() { 
                return htmlPanel._budgetOriginalDisplay; 
            },
            set: function(value) {
                console.log(`[BUDGET] Intercepted attempt to set HTML panel display to: ${value}`);
                if (value === 'none') {
                    console.log('[BUDGET] Blocked attempt to hide HTML panel');
                    htmlPanel._budgetOriginalDisplay = 'block';
                } else {
                    htmlPanel._budgetOriginalDisplay = value;
                }
            },
            configurable: true
        });
    }
}

// LOAD COMPONENT
// Load after defining tab switching to ensure it's available
function budget_loadComponent() {
    console.log('[BUDGET] Loading component script...');
    
    const timestamp = new Date().getTime();
    const scriptPath = `/scripts/budget/budget-component.js?t=${timestamp}`;
    
    const script = document.createElement('script');
    script.src = scriptPath;
    script.async = false;
    script.onload = function() {
        console.log('[BUDGET] Component script loaded successfully');
        
        if (window.budgetComponent && typeof window.budgetComponent.init === 'function') {
            try {
                window.budgetComponent.init();
                console.log('[BUDGET] Component initialized');
                
                // Enable debug mode if available
                if (window.TektonDebug) {
                    console.log('[BUDGET] Debug mode available, enabling for Budget component');
                    window.TektonDebug.registerComponent('budgetComponent', window.budgetComponent);
                }
            } catch (err) {
                console.error('[BUDGET] Component initialization error:', err);
            }
        } else {
            console.warn('[BUDGET] Component init function not found');
        }
    };
    script.onerror = function() {
        console.error('[BUDGET] Failed to load component script');
    };
    
    document.body.appendChild(script);
}

// SETUP DONE AFTER PAGE LOAD
// This ensures the functions are available before the tab events need them
window.addEventListener('DOMContentLoaded', function() {
    console.log('[BUDGET] DOM loaded, setting up Budget component');
    budget_protectHtmlPanel();
    budget_loadComponent();
});

// IMMEDIATE PROTECTION
// In case the DOM is already loaded
if (document.readyState === 'complete' || document.readyState === 'interactive') {
    console.log('[BUDGET] Document already loaded, setting up Budget component immediately');
    budget_protectHtmlPanel();
    budget_loadComponent();
}
</script>