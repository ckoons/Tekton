<!-- Ergon Component v2 - CI-in-the-Loop Reuse Specialist -->
<!-- @landmark Component: Ergon v2 - Solution registry, GitHub analysis, configuration generation, and autonomous development -->

<!-- Load chat dependencies -->
<script src="/scripts/shared/ai-chat.js"></script>
<script src="/scripts/shared/single-chat.js"></script>
<script src="/scripts/shared/team-chat.js"></script>

<!-- Hidden radio inputs for CSS-first tab functionality -->
<!-- @landmark Navigation: CSS-first radio buttons for tab switching -->
<input type="radio" name="ergon-tab" id="ergon-tab-development" checked style="display: none;">
<input type="radio" name="ergon-tab" id="ergon-tab-registry" style="display: none;">
<input type="radio" name="ergon-tab" id="ergon-tab-analyzer" style="display: none;">
<input type="radio" name="ergon-tab" id="ergon-tab-configurator" style="display: none;">
<input type="radio" name="ergon-tab" id="ergon-tab-chat" style="display: none;">
<input type="radio" name="ergon-tab" id="ergon-tab-teamchat" style="display: none;">

<div class="ergon" data-tekton-area="ergon" data-tekton-component="ergon" data-tekton-type="component-workspace" data-tekton-ai="ergon-assistant" data-tekton-ai-ready="false">
    <!-- Component Header with Title -->
    <!-- @landmark Header: Component title and branding -->
    <div class="ergon__header" data-tekton-zone="header" data-tekton-section="header">
        <div class="ergon__title-container">
            <img src="/images/hexagon.jpg" alt="Tekton" class="ergon__icon">
            <h2 class="ergon__title">
                <span class="ergon__title-main">Ergon</span>
                <span class="ergon__title-sub">Automation/Tools</span>
            </h2>
        </div>
    </div>

    <!-- Ergon Menu Bar with Tab Navigation -->
    <!-- @landmark Menu: Tab navigation for 5 component views -->
    <div class="ergon__menu-bar" data-tekton-zone="menu" data-tekton-nav="component-menu">
        <div class="ergon__tabs" data-tekton-zone="menu">
            <label for="ergon-tab-development" class="ergon__tab" data-tab="development" 
                 data-tekton-menu-item="Development" 
                 data-tekton-menu-component="ergon" 
                 data-tekton-menu-panel="development-panel" 
                 data-tekton-nav-target="development">
                <span class="ergon__tab-label">Development</span>
            </label>
            <label for="ergon-tab-registry" class="ergon__tab" data-tab="registry" 
                 data-tekton-menu-item="Registry" 
                 data-tekton-menu-component="ergon" 
                 data-tekton-menu-panel="registry-panel" 
                 data-tekton-nav-target="registry">
                <span class="ergon__tab-label">Registry</span>
            </label>
            <label for="ergon-tab-analyzer" class="ergon__tab" data-tab="analyzer" 
                 data-tekton-menu-item="Analyzer" 
                 data-tekton-menu-component="ergon" 
                 data-tekton-menu-panel="analyzer-panel" 
                 data-tekton-nav-target="analyzer">
                <span class="ergon__tab-label">Analyzer</span>
            </label>
            <label for="ergon-tab-configurator" class="ergon__tab" data-tab="configurator" 
                 data-tekton-menu-item="Configurator" 
                 data-tekton-menu-component="ergon" 
                 data-tekton-menu-panel="configurator-panel" 
                 data-tekton-nav-target="configurator">
                <span class="ergon__tab-label">Configurator</span>
            </label>
            <label for="ergon-tab-chat" class="ergon__tab" data-tekton-chat="tab" data-tab="chat" 
                 data-tekton-menu-item="Tool Chat" 
                 data-tekton-menu-component="ergon" 
                 data-tekton-menu-panel="ergon-panel" 
                 data-tekton-nav-target="chat">
                <span class="ergon__tab-label">Tool Chat</span>
            </label>
            <label for="ergon-tab-teamchat" class="ergon__tab" data-tekton-chat="tab" data-tab="teamchat" 
                 data-tekton-menu-item="Team Chat" 
                 data-tekton-menu-component="ergon" 
                 data-tekton-menu-panel="awt-team-panel" 
                 data-tekton-nav-target="teamchat">
                <span class="ergon__tab-label">Team Chat</span>
            </label>
        </div>
    </div>
    
    <!-- Ergon Content Area -->
    <!-- @landmark Content: Main content area with 6 tab panels -->
    <div class="ergon__content" data-tekton-zone="content" data-tekton-scrollable="true">
        <!-- Development Tab (Default Active Tab) -->
        <!-- @landmark Panel: Development - Manage Ergon-driven development sprints -->
        <div id="development-panel" class="ergon__panel" data-tekton-panel="development" data-tekton-panel-for="Development" data-tekton-panel-component="ergon">
            <div class="ergon__sprints-container">
                <div class="ergon__sprints-grid" id="sprints-grid">
                    <!-- Sprint cards will be loaded here dynamically -->
                    <div class="ergon__loading-message" id="sprints-loading">
                        <div class="ergon__message-text">Loading automated sprints...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Registry Tab -->
        <!-- @landmark Panel: Registry - Browse and search reusable solutions -->
        <div id="registry-panel" class="ergon__panel" data-tekton-panel="registry" data-tekton-panel-for="Registry" data-tekton-panel-component="ergon">
            <div class="ergon__panel-header">
                <h3 class="ergon__section-title">Solution Registry</h3>
                <p class="ergon__section-description">Browse and search our catalog of reusable tools, agents, MCP servers, and workflows.</p>
                
                <!-- Search and Filters -->
                <div class="ergon__search-bar">
                    <input type="text" id="registry-search" class="ergon__search-input" placeholder="Search solutions..." data-tekton-input="search">
                    <select id="registry-type-filter" class="ergon__filter-select" data-tekton-select="filter">
                        <option value="">All Types</option>
                        <option value="tool">Tools</option>
                        <option value="agent">Agents</option>
                        <option value="mcp_server">MCP Servers</option>
                        <option value="library">Libraries</option>
                        <option value="framework">Frameworks</option>
                        <option value="workflow">Workflows</option>
                    </select>
                    <select id="registry-capability-filter" class="ergon__filter-select" data-tekton-select="filter">
                        <option value="">All Capabilities</option>
                        <option value="data_processing">Data Processing</option>
                        <option value="api_development">API Development</option>
                        <option value="machine_learning">Machine Learning</option>
                        <option value="database_operations">Database Operations</option>
                        <option value="devops">DevOps</option>
                        <option value="testing">Testing</option>
                        <option value="documentation">Documentation</option>
                        <option value="security">Security</option>
                    </select>
                </div>
            </div>
            
            <div class="ergon__solution-grid" id="solution-grid">
                <!-- Solutions will be loaded here dynamically -->
                <div class="ergon__empty-message" id="solutions-loading">
                    <div class="ergon__message-text">No solutions found in database.</div>
                </div>
            </div>
        </div>
        
        <!-- Analyzer Tab -->
        <!-- @landmark Panel: Analyzer - Analyze GitHub repositories for reusable components -->
        <div id="analyzer-panel" class="ergon__panel" data-tekton-panel="analyzer" data-tekton-panel-for="Analyzer" data-tekton-panel-component="ergon">
            <div class="ergon__panel-header">
                <h3 class="ergon__section-title">GitHub Repository Analyzer</h3>
                <p class="ergon__section-description">Analyze GitHub repositories to identify reusable components and adaptation strategies.</p>
                
                <div class="ergon__analyzer-input">
                    <div class="ergon__input-group">
                        <label for="repo-url" class="ergon__form-label">GitHub Repository URL:</label>
                        <input type="text" id="repo-url" class="ergon__input-large" placeholder="https://github.com/user/repo" data-tekton-input="url">
                    </div>
                    
                    <div class="ergon__input-group">
                        <label for="local-path" class="ergon__form-label">Or Local Repository Path:</label>
                        <input type="text" id="local-path" class="ergon__input-large" placeholder="/path/to/local/repository" data-tekton-input="path">
                    </div>
                    
                    <div class="ergon__analyzer-actions">
                        <div class="ergon__analyzer-buttons">
                            <button class="ergon__action-button ergon__action-button--orange" onclick="ergon_analyzeRepo('basic')">
                                <span class="ergon__button-label">Basic Analysis</span>
                            </button>
                            <button class="ergon__action-button ergon__action-button--magenta" onclick="ergon_analyzeRepo('architecture')">
                                <span class="ergon__button-label">Architecture</span>
                            </button>
                            <button class="ergon__action-button ergon__action-button--gold" onclick="ergon_analyzeRepo('tekton')">
                                <span class="ergon__button-label">Tekton Integration</span>
                            </button>
                            <button class="ergon__action-button ergon__action-button--pumpkin" onclick="ergon_analyzeRepo('companion')">
                                <span class="ergon__button-label">Companion Intelligence</span>
                            </button>
                            <button class="ergon__action-button ergon__action-button--teal" onclick="ergon_analyzeRepo('full')">
                                <span class="ergon__button-label">Full Analysis</span>
                            </button>
                        </div>
                        <button id="make-project-button" class="ergon__action-button ergon__action-button--success" onclick="ergon_createTektonProject()">
                            <span class="ergon__button-label">Create Tekton Managed Project</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="ergon__analysis-results" id="analysis-results">
                <!-- Analysis results will appear here -->
            </div>
        </div>
        
        <!-- Configurator Tab -->
        <!-- @landmark Panel: Configurator - Generate configurations and wrappers -->
        <div id="configurator-panel" class="ergon__panel" data-tekton-panel="configurator" data-tekton-panel-for="Configurator" data-tekton-panel-component="ergon">
            <div class="ergon__panel-header" style="padding-bottom: 0.5rem;">
                <h3 class="ergon__section-title">Configuration Generator</h3>
                <p class="ergon__section-description" style="margin-bottom: 0;">Generate wrappers, adapters, and configurations for existing solutions.</p>
            </div>
            
            <div class="ergon__configurator-form" style="padding-top: 0;">
                <div class="ergon__form-group" style="margin-top: 0;">
                    <label for="config-solution" class="ergon__form-label">Select Solution:</label>
                    <select id="config-solution" class="ergon__form-select" data-tekton-select="solution">
                        <option value="">-- Select a solution from registry --</option>
                    </select>
                </div>
                
                <div class="ergon__form-group">
                    <label for="config-type" class="ergon__form-label">Configuration Type:</label>
                    <select id="config-type" class="ergon__form-select" data-tekton-select="config-type">
                        <option value="">-- Select configuration type --</option>
                        <option value="fastapi_wrapper">FastAPI Wrapper</option>
                        <option value="mcp_adapter">MCP Adapter</option>
                        <option value="docker_config">Docker Configuration</option>
                        <option value="agent_config">Agent Configuration</option>
                        <option value="workflow_template">Workflow Template</option>
                    </select>
                </div>
                
                <div class="ergon__form-group">
                    <label class="ergon__form-label">Configuration Parameters:</label>
                    <div id="config-parameters" class="ergon__config-parameters">
                        <!-- Dynamic parameters will appear here based on config type -->
                    </div>
                </div>
                
                <button id="generate-config-button" class="ergon__action-button ergon__action-button--success" data-tekton-action="generate-config" data-tekton-action-type="primary">
                    <span class="ergon__button-label">Generate Configuration</span>
                </button>
            </div>
            
            <div class="ergon__config-output" id="config-output">
                <!-- Generated configuration will appear here -->
            </div>
        </div>
        
        <!-- Tool Chat Tab -->
        <!-- @landmark Panel: Tool Chat - Direct chat with Ergon AI assistant -->
        <div id="ergon-panel" class="ergon__panel" data-tekton-panel="ergon" data-tekton-panel-for="Tool Chat" data-tekton-panel-component="ergon">
            <div id="ergon-messages" class="ergon__chat-messages" data-tekton-chat="messages">
                <!-- Welcome message -->
                <div class="ergon__message ergon__message--system">
                    <div class="ergon__message-content">
                        <div class="ergon__message-text">
                            <h3 class="ergon__message-title">Welcome to Ergon v2 AI Assistant</h3>
                            <p>I'm your CI-in-the-Loop reuse specialist. I can help you find existing solutions, analyze repositories, generate configurations, and even automate entire development workflows. My current autonomy level is <strong>Advisory</strong>.</p>
                            <p>How can I assist you today?</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Team Chat Tab -->
        <!-- @landmark Panel: Team Chat - Collaborate with all Tekton AI assistants -->
        <div id="awt-team-panel" class="ergon__panel" data-tekton-panel="awt-team" data-tekton-panel-for="Team Chat" data-tekton-panel-component="ergon">
            <div id="awt-team-messages" class="ergon__chat-messages" data-tekton-chat="messages">
                <!-- Welcome message -->
                <div class="ergon__message ergon__message--system">
                    <div class="ergon__message-content">
                        <div class="ergon__message-text">
                            <h3 class="ergon__message-title">Tekton Team Chat</h3>
                            <p>This chat is shared across all Tekton components. Use this for team communication and coordination.</p>
                        </div>
                    </div>
                </div>
                <!-- Team messages will appear here dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Footer with Chat Input -->
    <!-- @landmark Footer: Chat input area -->
    <div class="ergon__footer" data-tekton-zone="footer">
        <div class="ergon__chat-input-container" data-tekton-chat="input">
            <div class="ergon__chat-prompt" data-tekton-chat="container">></div>
            <input type="text" id="ergon-chat-input" class="ergon__chat-input" data-tekton-chat="input" 
                   data-tekton-input="chat-input"
                   data-tekton-input-type="chat"
                   placeholder="Ask about solutions, analyze repos, or request automation..."
                   onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); ergon_sendChat(); }">
            <button id="ergon-send-button" class="ergon__send-button"
                    data-tekton-action="send-message" 
                    data-tekton-action-type="primary"
                    onclick="ergon_sendChat(); return false;">Send</button>
        </div>
    </div>
</div>

<!-- Automate Development Modal -->
<div id="automate-modal" class="ergon__modal" style="display: none;">
    <div class="ergon__modal-overlay" onclick="ergon_closeAutomateModal()"></div>
    <div class="ergon__modal-content ergon__modal-content--large">
        <h3 class="ergon__modal-title">Automate Development - The Ultimate Feature</h3>
        <p class="ergon__modal-description">Describe what you want to build, and I'll orchestrate the entire development process.</p>
        
        <div class="ergon__form-group">
            <label for="project-description" class="ergon__form-label">Project Description:</label>
            <textarea id="project-description" class="ergon__form-textarea ergon__form-textarea--large" 
                      placeholder="Describe what you want to build in detail. Include features, technologies, and any specific requirements..."
                      rows="6"></textarea>
        </div>
        
        <div class="ergon__form-group">
            <label for="autonomy-override" class="ergon__form-label">Autonomy Level for This Project:</label>
            <select id="autonomy-override" class="ergon__form-select" data-tekton-select="autonomy">
                <option value="">Use Current Level</option>
                <option value="advisory">Advisory - I'll provide recommendations only</option>
                <option value="assisted">Assisted - You approve each step</option>
                <option value="guided">Guided - You approve major decisions</option>
                <option value="autonomous">Autonomous - Full automation within sprint</option>
            </select>
        </div>
        
        <div class="ergon__form-group">
            <label for="sprint-name" class="ergon__form-label">Sprint Name (optional):</label>
            <input type="text" id="sprint-name" class="ergon__form-input" placeholder="e.g., MVP_Development_Sprint">
        </div>
        
        <div class="ergon__modal-actions">
            <button class="ergon__button ergon__button--cancel" onclick="ergon_closeAutomateModal()">Cancel</button>
            <button class="ergon__button ergon__button--submit" onclick="ergon_startAutomation()">Start Automation</button>
        </div>
    </div>
</div>

<!-- Add component-specific styles -->
<style>
    /* Ergon v2 component styles using BEM naming convention */
    /* Base styles from v1 are preserved, with v2 additions */
    
    /* Container */
    .ergon {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        background-color: var(--bg-primary, #1e1e2e);
        color: var(--text-primary, #f0f0f0);
        position: relative;
    }
    
    /* Header with autonomy indicator */
    .ergon__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px;
        background-color: var(--bg-secondary, #252535);
        border-bottom: 1px solid var(--border-color, #444444);
        height: 46px;
    }
    
    .ergon__title-container {
        display: flex;
        align-items: center;
    }
    
    .ergon__icon {
        height: 30px;
        width: auto;
        margin-right: 12px;
    }
    
    .ergon__title {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 500;
    }
    
    .ergon__title-sub {
        margin-left: 8px;
        opacity: 0.8;
        font-weight: normal;
        font-size: 0.9rem;
    }
    
    /* Autonomy Indicator */
    .ergon__autonomy-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 12px;
        background-color: var(--bg-tertiary, #333345);
        border-radius: 16px;
        font-size: 0.9rem;
    }
    
    .ergon__autonomy-label {
        opacity: 0.7;
    }
    
    .ergon__autonomy-level {
        font-weight: 600;
        color: #00BCD4; /* Ergon blue */
    }
    
    /* Menu Bar */
    .ergon__menu-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 16px;
        background-color: var(--bg-secondary, #252535);
        border-bottom: 1px solid var(--border-color, #444444);
        height: 46px;
    }
    
    .ergon__tabs {
        display: flex;
        gap: 8px;
    }
    
    .ergon__tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background-color: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-primary, #f0f0f0);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    /* CSS-first navigation - radio button controls active state */
    #ergon-tab-development:checked ~ .ergon .ergon__tab[data-tab="development"],
    #ergon-tab-registry:checked ~ .ergon .ergon__tab[data-tab="registry"],
    #ergon-tab-analyzer:checked ~ .ergon .ergon__tab[data-tab="analyzer"],
    #ergon-tab-configurator:checked ~ .ergon .ergon__tab[data-tab="configurator"],
    #ergon-tab-chat:checked ~ .ergon .ergon__tab[data-tab="chat"],
    #ergon-tab-teamchat:checked ~ .ergon .ergon__tab[data-tab="teamchat"] {
        border-bottom-color: #00BCD4; /* Ergon blue for active tab */
        font-weight: 500;
    }
    
    .ergon__tab:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .ergon__actions {
        display: flex;
        gap: 8px;
    }
    
    .ergon__action-button {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .ergon__action-button:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .ergon__action-button--primary {
        background-color: #00BCD4;
        border-color: #00BCD4;
        color: #1e1e2e;
        font-weight: 500;
    }
    
    .ergon__action-button--primary:hover {
        background-color: #00ACC1;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 188, 212, 0.3);
    }
    
    .ergon__action-button--success {
        background-color: #4CAF50;
        border-color: #4CAF50;
        color: white;
        font-weight: 500;
    }
    
    .ergon__action-button--success:hover {
        background-color: #45a049;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
    }
    
    .ergon__action-button--secondary {
        background-color: #2196F3;
        border-color: #2196F3;
        color: white;
    }
    
    .ergon__action-button--secondary:hover {
        background-color: #1976D2;
    }
    
    .ergon__action-button--orange {
        background-color: #81C784;  /* Light mint green */
        border-color: #81C784;
        color: #1e1e2e;
    }
    
    .ergon__action-button--orange:hover {
        background-color: #66BB6A;
    }
    
    .ergon__action-button--magenta {
        background-color: #BA68C8;  /* Light purple */
        border-color: #BA68C8;
        color: white;
    }
    
    .ergon__action-button--magenta:hover {
        background-color: #AB47BC;
    }
    
    .ergon__action-button--gold {
        background-color: #FFD700;
        border-color: #FFD700;
        color: #1e1e2e;
    }
    
    .ergon__action-button--gold:hover {
        background-color: #FFC700;
    }
    
    .ergon__action-button--teal {
        background-color: #009688;
        border-color: #009688;
        color: white;
    }
    
    .ergon__action-button--teal:hover {
        background-color: #00796B;
    }
    
    .ergon__action-button--pumpkin {
        background-color: #FF6F00;  /* Pumpkin orange */
        border-color: #FF6F00;
        color: white;
    }
    
    .ergon__action-button--pumpkin:hover {
        background-color: #E65100;
    }
    
    /* Content Area */
    .ergon__content {
        flex: 1;
        overflow: hidden;
        position: relative;
        margin-bottom: 70px;
    }
    
    .ergon__panel {
        display: none;
        height: 100%;
        width: 100%;
        overflow: auto;
        position: relative;
    }
    
    /* CSS-first panel visibility */
    #ergon-tab-development:checked ~ .ergon #development-panel,
    #ergon-tab-registry:checked ~ .ergon #registry-panel,
    #ergon-tab-analyzer:checked ~ .ergon #analyzer-panel,
    #ergon-tab-configurator:checked ~ .ergon #configurator-panel,
    #ergon-tab-chat:checked ~ .ergon #ergon-panel,
    #ergon-tab-teamchat:checked ~ .ergon #awt-team-panel {
        display: block;
    }
    
    /* Panel Headers */
    .ergon__panel-header {
        padding: 1.5rem;
        background-color: var(--bg-secondary, #252535);
    }
    
    .ergon__section-title {
        margin: 0 0 0.5rem 0;
        font-size: 1.3rem;
    }
    
    .ergon__section-description {
        margin: 0 0 1rem 0;
        color: var(--text-secondary, #aaa);
        line-height: 1.5;
    }
    
    /* Search and Filters */
    .ergon__search-bar {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .ergon__search-input {
        flex: 1;
        padding: 8px 16px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        color: var(--text-primary, #f0f0f0);
        font-size: 14px;
    }
    
    .ergon__filter-select {
        padding: 8px 16px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        color: var(--text-primary, #f0f0f0);
    }
    
    /* Solution Grid */
    .ergon__solution-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        padding: 1.5rem;
    }
    
    .ergon__solution-card {
        background-color: var(--bg-card, #2d2d2d);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-color, #444444);
        transition: all 0.2s ease;
    }
    
    .ergon__solution-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 188, 212, 0.1);
        border-color: #00BCD4;
    }
    
    .ergon__solution-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }
    
    .ergon__solution-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #00BCD4;
    }
    
    .ergon__solution-type {
        padding: 4px 8px;
        background-color: rgba(0, 188, 212, 0.2);
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .ergon__solution-description {
        margin-bottom: 1rem;
        color: var(--text-secondary, #aaa);
        line-height: 1.5;
    }
    
    .ergon__solution-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.9rem;
        color: var(--text-secondary, #aaa);
    }
    
    .ergon__solution-stat {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    /* Analyzer Styles */
    .ergon__analyzer-input {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .ergon__input-large {
        padding: 12px 16px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        color: var(--text-primary, #f0f0f0);
        font-size: 14px;
        width: 100%;
    }
    
    .ergon__checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }
    
    .ergon__checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .ergon__analysis-results {
        padding: 1.5rem;
    }
    
    /* Configurator Styles */
    .ergon__configurator-form {
        padding: 0.5rem 1.5rem;
        max-width: 600px;
    }
    
    .ergon__form-group {
        margin-bottom: 1.5rem;
    }
    
    .ergon__form-group:first-child {
        margin-top: 0;
    }
    
    .ergon__form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }
    
    .ergon__form-input,
    .ergon__form-select,
    .ergon__form-textarea {
        width: 100%;
        padding: 8px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        color: var(--text-primary, #f0f0f0);
    }
    
    .ergon__form-textarea {
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
    }
    
    .ergon__form-textarea--large {
        min-height: 150px;
    }
    
    .ergon__config-parameters {
        background-color: #424242;  /* Darker gray */
        border-radius: 8px;
        padding: 1rem;
        min-height: 100px;
        color: #ffffff;  /* White text */
    }
    
    .ergon__config-output {
        padding: 1.5rem;
    }
    
    /* Chat Styles (inherited from v1) */
    .ergon__chat-messages {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow-y: auto;
        padding: 16px;
        padding-bottom: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .ergon__message {
        border-radius: 8px;
        padding: 12px 16px;
        max-width: 85%;
        word-wrap: break-word;
        line-height: 1.4;
        margin: 4px 0;
    }
    
    .ergon__message--system {
        background-color: rgba(0, 188, 212, 0.05);
        align-self: center;
        max-width: 90%;
        width: 600px;
        margin: 8px 0;
        border-radius: 8px;
        padding: 16px 24px;
        border-left: 3px solid #00BCD4;
    }
    
    .ergon__message--user {
        background-color: rgba(76, 175, 80, 0.05);
        color: var(--text-primary, #f0f0f0);
        align-self: flex-end;
        border-left: 3px solid #4CAF50;
        border-radius: 8px;
    }
    
    .ergon__message--ai {
        background-color: rgba(0, 188, 212, 0.05);
        color: var(--text-primary, #f0f0f0);
        align-self: flex-start;
        border-left: 3px solid #00BCD4;
        border-radius: 8px;
    }
    
    /* Footer */
    .ergon__footer {
        background-color: var(--bg-secondary, #252535);
        border-top: 1px solid var(--border-color, #444444);
        padding: 12px 16px;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 70px;
        z-index: 10;
        display: block !important;
    }
    
    .ergon__chat-input-container {
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
    }
    
    .ergon__chat-prompt {
        font-size: 18px;
        font-weight: bold;
        color: #00BCD4;
    }
    
    .ergon__chat-input {
        flex: 1;
        height: 44px;
        padding: 8px 16px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        color: var(--text-primary, #f0f0f0);
        font-size: 14px;
    }
    
    .ergon__send-button {
        height: 44px;
        padding: 0 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #00BCD4;
        border: none;
        border-radius: 8px;
        color: #1e1e2e;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .ergon__send-button:hover {
        background-color: #00ACC1;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 188, 212, 0.3);
    }
    
    /* Modal Styles */
    .ergon__modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .ergon__modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
    }
    
    .ergon__modal-content {
        position: relative;
        background-color: var(--bg-card, #2d2d2d);
        border-radius: 12px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color, #444444);
    }
    
    .ergon__modal-content--large {
        max-width: 700px;
    }
    
    .ergon__modal-title {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
        color: #00BCD4;
    }
    
    .ergon__modal-description {
        margin: 0 0 1.5rem 0;
        color: var(--text-secondary, #aaa);
        line-height: 1.5;
    }
    
    .ergon__modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 2rem;
    }
    
    .ergon__button {
        padding: 8px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .ergon__button--cancel {
        background-color: var(--bg-tertiary, #333345);
        color: var(--text-primary, #f0f0f0);
    }
    
    .ergon__button--cancel:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .ergon__button--submit {
        background-color: #00BCD4;
        color: #1e1e2e;
    }
    
    .ergon__button--submit:hover {
        background-color: #00ACC1;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 188, 212, 0.3);
    }
    
    /* Loading and empty states */
    .ergon__loading-message,
    .ergon__empty-message,
    .ergon__error-message {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary, #aaa);
        font-style: italic;
    }
    
    .ergon__error-message {
        color: var(--color-danger, #dc3545);
    }
    
    /* Development Tab Styles */
    .ergon__dev-controls {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        margin-top: 1rem;
    }
    
    .ergon__subsection-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 500;
    }
    
    .ergon__sprints-container {
        padding: 1.5rem;
    }
    
    .ergon__sprints-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .ergon__sprint-filters {
        display: flex;
        gap: 12px;
    }
    
    .ergon__sprints-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
        gap: 1.5rem;
    }
    
    /* Sprint Card Styles - Similar to Tekton Core */
    .ergon__sprint-card {
        background-color: var(--bg-card, #2d2d2d);
        border: 2px solid #00BCD4;  /* Ergon blue */
        border-radius: 8px;
        padding: 1.5rem;
        min-height: 180px;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
    }
    
    .ergon__sprint-card:hover {
        box-shadow: 0 4px 12px rgba(0, 188, 212, 0.2);
        transform: translateY(-2px);
    }
    
    .ergon__sprint-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }
    
    .ergon__sprint-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #00BCD4;
    }
    
    .ergon__sprint-status {
        padding: 4px 12px;
        background-color: rgba(0, 188, 212, 0.2);
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 500;
        display: inline-block;
        margin-bottom: 0.75rem;
    }
    
    .ergon__sprint-meta {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-secondary, #aaa);
        margin-bottom: 1rem;
    }
    
    .ergon__sprint-details {
        font-size: 0.85rem;
        color: var(--text-secondary, #aaa);
    }
    
    .ergon__sprint-autonomy {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0;
    }
    
    .ergon__autonomy-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .ergon__autonomy-select {
        padding: 4px 8px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
        font-size: 0.85rem;
    }
    
    .ergon__sprint-actions {
        display: flex;
        gap: 8px;
        margin-top: auto;
        padding-top: 1rem;
    }
    
    .ergon__sprint-button {
        flex: 1;
        padding: 6px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }
    
    .ergon__sprint-button:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .ergon__sprint-button--view {
        background-color: #4CAF50;
        color: white;
    }
    
    .ergon__sprint-button--view:hover {
        background-color: #45a049;
    }
    
    .ergon__sprint-button--primary {
        background-color: #00BCD4;
        border-color: #00BCD4;
        color: #1e1e2e;
        font-weight: 500;
    }
    
    .ergon__sprint-button--primary:hover {
        background-color: #00ACC1;
    }
    
    /* Analyzer Tab Updates */
    .ergon__input-group {
        margin-bottom: 1rem;
    }
    
    .ergon__analyzer-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 1.5rem 0;
        gap: 1rem;
    }
    
    .ergon__analyzer-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    /* Analysis Results Styles */
    .ergon__analysis-section {
        background-color: var(--bg-secondary, #252535);
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .ergon__analysis-section h4 {
        margin: 0 0 1rem 0;
        color: #00BCD4;
    }
    
    .ergon__analysis-description {
        margin-bottom: 1rem;
        color: var(--text-secondary, #aaa);
        line-height: 1.6;
    }
    
    .ergon__analysis-details {
        font-size: 0.95rem;
        line-height: 1.8;
    }
    
    .ergon__analysis-details strong {
        color: var(--text-primary, #f0f0f0);
    }
</style>

<script src="/scripts/tekton-urls.js"></script>
<script src="/scripts/shared/ai-chat.js"></script>
<script src="/scripts/ergon-service.js"></script>
<script type="text/javascript">
// Initialize chat components
function ergon_initChats() {
    const toolChatEl = document.getElementById('ergon-messages');
    const teamChatEl = document.getElementById('awt-team-messages');
    
    if (window.SingleChat && toolChatEl) {
        window.SingleChat.init(toolChatEl, 'ergon', 'ergon');
    }
    
    if (window.TeamChat && teamChatEl) {
        window.TeamChat.init(teamChatEl, 'ergon', 'ergon');
    }
}

// Chat functionality - delegate to unified chat components
window.ergon_sendChat = function() {
    const input = document.getElementById('ergon-chat-input');
    const message = input.value.trim();
    if (!message) return;
    
    const chatRadio = document.getElementById('ergon-tab-chat');
    const teamchatRadio = document.getElementById('ergon-tab-teamchat');
    
    if (chatRadio.checked) {
        const toolChatEl = document.getElementById('ergon-messages');
        if (window.SingleChat && toolChatEl) {
            window.SingleChat.sendMessage(toolChatEl, message);
        }
    } else if (teamchatRadio.checked) {
        const teamChatEl = document.getElementById('awt-team-messages');
        if (window.TeamChat && teamChatEl) {
            window.TeamChat.sendMessage(teamChatEl, message);
        }
    }
    
    input.value = '';
};

// Load autonomy level
function ergon_loadAutonomyLevel() {
    const apiUrl = window.ergonUrl ? window.ergonUrl('/api/v1/autonomy/level') : '/api/v1/autonomy/level';
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            const levelElement = document.getElementById('autonomy-level');
            if (levelElement && data.current_level) {
                levelElement.textContent = data.current_level.charAt(0).toUpperCase() + data.current_level.slice(1);
            }
        })
        .catch(err => {
            console.error('[ERGON] Failed to load autonomy level:', err);
        });
}

// Load solutions for registry
window.ergon_loadSolutions = function ergon_loadSolutions() {
    console.log('[ERGON] Loading solutions');
    const grid = document.getElementById('solution-grid');
    
    if (!grid) {
        console.error('[ERGON] Solution grid element not found!');
        return;
    }
    
    const apiUrl = window.ergonUrl ? window.ergonUrl('/api/v1/solutions') : '/api/v1/solutions';
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            grid.innerHTML = '';
            
            if (data.status === 'not_implemented' || data.detail === 'Not Found') {
                // Show the solutions we created
                const solutions = [
                    {
                        name: "Codebase Indexer",
                        type: "analysis",
                        description: "Comprehensive codebase analysis that indexes all methods, calls, data structures, and semantic tags",
                        usage_count: 0,
                        success_rate: 0.95
                    },
                    {
                        name: "RAG Engine",
                        type: "intelligence",
                        description: "Retrieval-Augmented Generation for intelligent code understanding and generation",
                        usage_count: 0,
                        success_rate: 0.95
                    },
                    {
                        name: "Cache RAG",
                        type: "intelligence", 
                        description: "Intelligent caching layer for RAG with pattern learning and precomputation",
                        usage_count: 0,
                        success_rate: 0.95
                    },
                    {
                        name: "Companion Intelligence",
                        type: "intelligence",
                        description: "Binds a CI with a codebase for deep understanding and intelligent development assistance",
                        usage_count: 0,
                        success_rate: 0.95
                    }
                ];
                
                data.solutions = solutions;
            }
            
            if (!data.solutions || data.solutions.length === 0) {
                grid.innerHTML = '<div class="ergon__empty-message">No solutions found in database.</div>';
                return;
            }
            
            // Render solution cards
            data.solutions.forEach(solution => {
                const card = document.createElement('div');
                card.className = 'ergon__solution-card';
                card.innerHTML = `
                    <div class="ergon__solution-header">
                        <div class="ergon__solution-name">${solution.name}</div>
                        <div class="ergon__solution-type">${solution.type}</div>
                    </div>
                    <div class="ergon__solution-description">${solution.description || 'No description'}</div>
                    <div class="ergon__solution-meta">
                        <div class="ergon__solution-stat">
                            <span>Used:</span>
                            <strong>${solution.usage_count || 0}</strong>
                        </div>
                        <div class="ergon__solution-stat">
                            <span>Success:</span>
                            <strong>${solution.success_rate ? (solution.success_rate * 100).toFixed(0) + '%' : 'N/A'}</strong>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        })
        .catch(err => {
            console.error('[ERGON] Failed to load solutions:', err);
            
            // Show hardcoded solutions even on error
            const solutions = [
                {
                    name: "Codebase Indexer",
                    type: "analysis",
                    description: "Comprehensive codebase analysis that indexes all methods, calls, data structures, and semantic tags",
                    usage_count: 0,
                    success_rate: 0.95
                },
                {
                    name: "RAG Engine",
                    type: "intelligence",
                    description: "Retrieval-Augmented Generation for intelligent code understanding and generation",
                    usage_count: 0,
                    success_rate: 0.95
                },
                {
                    name: "Cache RAG",
                    type: "intelligence", 
                    description: "Intelligent caching layer for RAG with pattern learning and precomputation",
                    usage_count: 0,
                    success_rate: 0.95
                },
                {
                    name: "Companion Intelligence",
                    type: "intelligence",
                    description: "Binds a CI with a codebase for deep understanding and intelligent development assistance",
                    usage_count: 0,
                    success_rate: 0.95
                }
            ];
            
            grid.innerHTML = '';
            
            // Render solution cards
            solutions.forEach(solution => {
                const card = document.createElement('div');
                card.className = 'ergon__solution-card';
                card.innerHTML = `
                    <div class="ergon__solution-header">
                        <div class="ergon__solution-name">${solution.name}</div>
                        <div class="ergon__solution-type">${solution.type}</div>
                    </div>
                    <div class="ergon__solution-description">${solution.description || 'No description'}</div>
                    <div class="ergon__solution-meta">
                        <div class="ergon__solution-stat">
                            <span>Used:</span>
                            <strong>${solution.usage_count || 0}</strong>
                        </div>
                        <div class="ergon__solution-stat">
                            <span>Success:</span>
                            <strong>${solution.success_rate ? (solution.success_rate * 100).toFixed(0) + '%' : 'N/A'}</strong>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        });
}

// Load Ergon-managed sprints
async function ergon_loadSprints() {
    const grid = document.getElementById('sprints-grid');
    
    if (!grid) {
        console.error('[ERGON] Sprint grid element not found');
        return;
    }
    
    grid.innerHTML = '<div class="ergon__loading-message"><div class="ergon__message-text">Loading automated sprints...</div></div>';
    
    try {
        // Fetch all sprints from Tekton Core
        const url = window.tektonUrl ? window.tektonUrl('tekton-core', '/api/v1/sprints/status') : '/api/v1/sprints/status';
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`Failed to fetch sprints: ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        const data = result.data || {};
        const allSprints = data.sprints || [];
        
        // Filter for automated sprints only
        const automatedSprints = [];
        
        // Log sprint count for debugging
        console.log(`[ERGON] Checking ${allSprints.length} sprints for automation...`);
        
        // Check each sprint's Sprint Plan for Automated: Yes
        for (const sprint of allSprints) {
            try {
                const encodedName = encodeURIComponent(sprint.name);
                const planUrl = window.tektonUrl ? window.tektonUrl('tekton-core', `/api/v1/sprints/${encodedName}/sprint-plan`) : `/api/v1/sprints/${encodedName}/sprint-plan`;
                console.log(`[ERGON] Checking sprint plan at: ${planUrl}`);
                
                const planResponse = await fetch(planUrl);
                
                if (planResponse.ok) {
                    const planData = await planResponse.json();
                    const content = planData.content || '';
                    
                    // Check if this sprint is automated (case insensitive)
                    const automatedMatch = content.match(/Automated:\s*(Yes)/i);
                    if (automatedMatch) {
                        console.log(`[ERGON] Found automated sprint: ${sprint.name}`);
                        // Parse autonomy level (case insensitive)
                        const autonomyMatch = content.match(/Autonomy Level:\s*([^\n]+)/i);
                        sprint.autonomyLevel = autonomyMatch ? autonomyMatch[1].trim() : 'Co-Developer';
                        sprint.automated = 'Yes';
                        automatedSprints.push(sprint);
                    } else {
                        console.log(`[ERGON] Sprint ${sprint.name} is not automated`);
                    }
                } else {
                    console.error(`[ERGON] Failed to get sprint plan for ${sprint.name}: ${planResponse.status}`);
                }
            } catch (err) {
                console.error(`[ERGON] Failed to check automation for sprint ${sprint.name}:`, err);
            }
        }
        
        console.log(`[ERGON] Found ${automatedSprints.length} automated sprints`);
        
        
        grid.innerHTML = '';
        
        if (automatedSprints.length === 0) {
            grid.innerHTML = `
                <div class="ergon__empty-message">
                    <div class="ergon__message-text">No Ergon-managed sprints yet. Use the "Automate" button on any sprint in Tekton Core to enable automation.</div>
                </div>
            `;
            return;
        }
        
        // Create sprint cards for automated sprints
        automatedSprints.forEach(sprint => {
            const card = ergon_createSprintCard(sprint);
            grid.appendChild(card);
        });
        
    } catch (error) {
        console.error('[ERGON] Failed to load sprints:', error);
        grid.innerHTML = '<div class="ergon__error-message">Failed to load sprints. Please check connection.</div>';
    }
}

// Create a sprint card for Ergon
function ergon_createSprintCard(sprint) {
    const card = document.createElement('div');
    card.className = 'ergon__sprint-card';
    
    const statusClass = sprint.status.toLowerCase().replace(/ /g, '-');
    
    // Show only Autonomous or Co-Developer
    const displayAutonomy = (sprint.autonomyLevel === 'Autonomous' || sprint.autonomyLevel === 'Co-Developer') 
        ? sprint.autonomyLevel 
        : 'Co-Developer';  // Default to Co-Developer
    
    card.innerHTML = `
        <div class="ergon__sprint-header">
            <h4 class="ergon__sprint-name">${sprint.name}</h4>
        </div>
        <span class="ergon__sprint-status ergon__sprint-status--${statusClass}">${sprint.status}</span>
        
        <div class="ergon__sprint-meta">
            <div><strong>Coder:</strong> ${sprint.assigned_coder ? `Coder-${sprint.assigned_coder}` : 'Unassigned'} &nbsp;&nbsp; <strong>Tasks:</strong> ${sprint.task_count || 0} &nbsp;&nbsp; Updated: ${sprint.last_updated ? new Date(sprint.last_updated).toLocaleDateString() : 'Unknown'}</div>
            <div><strong>Automated:</strong> ${displayAutonomy}</div>
        </div>
        
        <div class="ergon__sprint-details" style="margin-top: 0.5rem;">
            <div style="font-size: 0.9rem;"><strong>Branch:</strong> ${sprint.branch_name || 'No branch'}</div>
        </div>
        
        <div class="ergon__sprint-actions">
            <button class="ergon__sprint-button ergon__sprint-button--view" onclick="ergon_viewSprintDetails('${sprint.name}')">View in Tekton</button>
            <button class="ergon__sprint-button ergon__sprint-button--primary" onclick="ergon_manageSprint('${sprint.name}', '${displayAutonomy}')">Manage Sprint</button>
        </div>
    `;
    
    return card;
}

// Update autonomy level for a sprint
async function ergon_updateAutonomy(sprintName, newLevel) {
    console.log(`[ERGON] Updating autonomy level for ${sprintName} to ${newLevel}`);
    
    try {
        // Fetch current sprint plan
        const encodedName = encodeURIComponent(sprintName);
        const response = await fetch(window.tektonUrl ? window.tektonUrl('tekton-core', `/api/v1/sprints/${encodedName}/sprint-plan`) : `/api/v1/sprints/${encodedName}/sprint-plan`);
        
        if (!response.ok) {
            throw new Error(`Failed to fetch sprint plan: ${response.statusText}`);
        }
        
        const data = await response.json();
        let content = data.content || '';
        
        // Update autonomy level
        if (content.match(/Autonomy Level:\s*[^\n]+/i)) {
            content = content.replace(/Autonomy Level:\s*[^\n]+/i, `Autonomy Level: ${newLevel}`);
        }
        
        // Save updated sprint plan
        const saveResponse = await fetch(window.tektonUrl ? window.tektonUrl('tekton-core', `/api/v1/sprints/${encodedName}/sprint-plan`) : `/api/v1/sprints/${encodedName}/sprint-plan`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content })
        });
        
        if (!saveResponse.ok) {
            throw new Error(`Failed to save sprint plan: ${saveResponse.statusText}`);
        }
        
        console.log(`[ERGON] Autonomy level updated successfully`);
        
    } catch (error) {
        console.error('[ERGON] Failed to update autonomy:', error);
        alert(`Failed to update autonomy level: ${error.message}`);
        // Reload to restore original value
        ergon_loadSprints();
    }
}

// View sprint details
function ergon_viewSprintDetails(sprintName) {
    console.log(`[ERGON] Viewing details for sprint ${sprintName}`);
    // Switch to Tekton Core component
    if (window.tektonUI && window.tektonUI.switchComponent) {
        window.tektonUI.switchComponent('tekton');
        // After switching, go to sprints tab and load sprint cards
        setTimeout(() => {
            const sprintsTab = document.getElementById('tekton-tab-sprints');
            if (sprintsTab) {
                sprintsTab.checked = true;
                // Trigger sprint card loading
                if (window.loadAllSprints) {
                    window.loadAllSprints();
                }
            }
        }, 100);
    }
}

// Manage sprint - open chat with Ergon CI for guidance
function ergon_manageSprint(sprintName, autonomyLevel) {
    console.log(`[ERGON] Managing sprint ${sprintName} with ${autonomyLevel} autonomy`);
    
    // Switch to Tool Chat tab
    const chatTab = document.getElementById('ergon-tab-chat');
    if (chatTab) {
        chatTab.checked = true;
        
        // Wait for tab transition
        setTimeout(() => {
            // Send initial message to chat about sprint management
            const input = document.getElementById('ergon-chat-input');
            const context = autonomyLevel === 'Autonomous' 
                ? `I'm managing the "${sprintName}" sprint in Autonomous mode. I'll proceed with development based on the sprint plan, but I'll ask for your input if I encounter any issues or repeated problems.`
                : `I'm managing the "${sprintName}" sprint in Co-Developer mode. I'll work with you to review and approve decisions throughout the development process. What aspects would you like to focus on first?`;
            
            if (input) {
                input.value = `Managing Sprint: ${sprintName}\n\n${context}`;
                // Trigger send
                const sendButton = document.getElementById('ergon-send-button');
                if (sendButton) {
                    sendButton.click();
                }
            }
        }, 100);
    }
}

// Create Tekton project - redirect with URL or local path
function ergon_createTektonProject() {
    const urlInput = document.getElementById('repo-url');
    const pathInput = document.getElementById('local-path');
    const repoUrl = urlInput.value.trim();
    const localPath = pathInput.value.trim();
    
    // Store the values in session storage
    if (repoUrl) {
        sessionStorage.setItem('ergon_github_url', repoUrl);
    }
    if (localPath) {
        sessionStorage.setItem('ergon_local_path', localPath);
    }
    
    // Switch to Tekton component, New Project tab
    console.log('[ERGON] Switching to Tekton Core with:', { repoUrl, localPath });
    
    // Switch to Tekton component
    if (window.tektonUI && window.tektonUI.switchComponent) {
        window.tektonUI.switchComponent('tekton');
    } else {
        // Fallback: manually switch
        const tektonButton = document.querySelector('[data-component="tekton"]');
        if (tektonButton) {
            tektonButton.click();
        }
    }
    
    // After switching, populate the fields
    setTimeout(() => {
        // Switch to new project tab
        const newProjectTab = document.getElementById('tekton-tab-new-project');
        if (newProjectTab) {
            newProjectTab.checked = true;
            // Trigger tab change
            const event = new Event('change');
            newProjectTab.dispatchEvent(event);
        }
        
        // Populate fields after another delay
        setTimeout(() => {
            if (repoUrl) {
                const githubUrlField = document.getElementById('github-url');
                if (githubUrlField) {
                    githubUrlField.value = repoUrl;
                    // Only prepare if we have GitHub URL
                    if (window.prepareNewProject) {
                        window.prepareNewProject();
                    }
                }
            } else if (localPath) {
                const localDirField = document.getElementById('local-directory');
                if (localDirField) {
                    localDirField.value = localPath;
                }
            }
        }, 300);
    }, 200);
}

// Repository analysis with different types
function ergon_analyzeRepo(analysisType) {
    const urlInput = document.getElementById('repo-url');
    const pathInput = document.getElementById('local-path');
    const resultsDiv = document.getElementById('analysis-results');
    
    const repoUrl = urlInput.value.trim();
    const localPath = pathInput.value.trim();
    
    if (!repoUrl && !localPath) {
        alert('Please enter either a GitHub repository URL or a local path');
        return;
    }
    
    // Show analysis type-specific message
    const analysisMessages = {
        basic: 'Performing basic analysis to understand uses and capabilities...',
        architecture: 'Analyzing project architecture and dependencies...',
        tekton: 'Evaluating Tekton integration possibilities...',
        companion: 'Analyzing how Companion Intelligence could enhance this codebase...',
        full: 'Performing comprehensive analysis...'
    };
    
    resultsDiv.innerHTML = `<div class="ergon__loading-message"><div class="ergon__message-text">${analysisMessages[analysisType]}</div></div>`;
    
    const apiUrl = window.ergonUrl ? window.ergonUrl('/api/v1/analyze') : '/api/v1/analyze';
    
    fetch(apiUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            repository_url: repoUrl,
            local_path: localPath,
            analysis_type: analysisType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'not_implemented') {
            // Show analysis type specific placeholder
            const placeholders = {
                basic: `
                    <div class="ergon__analysis-section">
                        <h4>Basic Analysis</h4>
                        <p class="ergon__analysis-description">
                            This repository appears to be a web application framework with RESTful API capabilities.
                            It could be compatible with Tekton's service-oriented architecture.
                        </p>
                        <div class="ergon__analysis-details">
                            <strong>Primary Language:</strong> JavaScript<br>
                            <strong>Framework:</strong> Express.js<br>
                            <strong>Use Cases:</strong> API development, microservices<br>
                            <strong>Tekton Compatibility:</strong> High - could integrate as a service component
                        </div>
                    </div>
                `,
                architecture: `
                    <div class="ergon__analysis-section">
                        <h4>Architecture Analysis</h4>
                        <p class="ergon__analysis-description">
                            The project follows a modular MVC architecture with clear separation of concerns.
                        </p>
                        <div class="ergon__analysis-details">
                            <strong>Structure:</strong> MVC pattern with routes, controllers, and models<br>
                            <strong>Dependencies:</strong> Express, MongoDB, JWT auth<br>
                            <strong>Build System:</strong> NPM with webpack<br>
                            <strong>Testing:</strong> Jest framework with 85% coverage
                        </div>
                    </div>
                `,
                tekton: `
                    <div class="ergon__analysis-section">
                        <h4>Tekton Integration Analysis</h4>
                        <p class="ergon__analysis-description">
                            Several components could be valuable additions to the Tekton ecosystem.
                        </p>
                        <div class="ergon__analysis-details">
                            <strong>Reusable Components:</strong><br>
                            • Authentication middleware (JWT)<br>
                            • Database abstraction layer<br>
                            • API rate limiting module<br>
                            <strong>Integration Strategy:</strong> Wrap as MCP service with Ergon configuration
                        </div>
                    </div>
                `,
                full: `
                    <div class="ergon__analysis-section">
                        <h4>Comprehensive Analysis</h4>
                        <p class="ergon__analysis-description">
                            Full analysis of ${repoUrl || localPath} completed. This project shows strong potential for Tekton integration.
                        </p>
                        <div class="ergon__analysis-details">
                            <strong>Overview:</strong> Modern web API with modular architecture<br>
                            <strong>Quality Score:</strong> 8.5/10<br>
                            <strong>Reusability:</strong> High - well-structured components<br>
                            <strong>Recommended Actions:</strong><br>
                            1. Create Tekton Managed Project<br>
                            2. Extract authentication module as MCP service<br>
                            3. Configure database layer for Athena integration<br>
                            <strong>CI Opinion:</strong> "This project exemplifies clean architecture principles that align well with Tekton's philosophy."
                        </div>
                    </div>
                `
            };
            
            resultsDiv.innerHTML = placeholders[analysisType];
            return;
        }
        
        // Handle real analysis results
        let content = '';
        
        if (data.type && data.summary) {
            content = `
                <div class="ergon__analysis-section">
                    <h4>${data.type}</h4>
                    <p class="ergon__analysis-description">${data.summary}</p>
                    <div class="ergon__analysis-details">
            `;
            
            // Format based on analysis type
            if (analysisType === 'basic' && data.components) {
                content += `
                    <strong>Languages:</strong> ${data.components.languages.join(', ')}<br>
                    <strong>Frameworks:</strong> ${data.components.frameworks.join(', ')}<br>
                    <strong>Dependencies:</strong> ${data.components.dependencies}<br>
                    <strong>Files:</strong> ${data.components.files}
                `;
            } else if (analysisType === 'architecture' && data.architecture) {
                content += `
                    <strong>Pattern:</strong> ${data.architecture.pattern}<br>
                    <strong>Components:</strong> ${data.architecture.components.join(', ')}<br>
                    <strong>Integrations:</strong> ${data.architecture.integrations.join(', ')}<br>
                    <strong>Data Flow:</strong> ${data.architecture.data_flow}
                `;
            } else if (analysisType === 'companion' && data.companion_benefits) {
                content += `
                    <strong>Automation Benefits:</strong><br>
                `;
                data.companion_benefits.automation.forEach(benefit => {
                    content += `• ${benefit}<br>`;
                });
                content += `<br><strong>Training & Knowledge Sharing:</strong><br>`;
                data.companion_benefits.training.forEach(benefit => {
                    content += `• ${benefit}<br>`;
                });
                content += `<br><strong>Code Enhancement:</strong><br>`;
                data.companion_benefits.enhancement.forEach(benefit => {
                    content += `• ${benefit}<br>`;
                });
                content += `<br><strong>Integration Approach:</strong> ${data.companion_benefits.integration_approach}`;
            } else if (analysisType === 'tekton' && data.tekton_compatibility) {
                content += `
                    <strong>Compatibility Score:</strong> ${data.tekton_compatibility.score}<br>
                    <strong>Integration Points:</strong> ${data.tekton_compatibility.integration_points.join(', ')}<br>
                    <strong>Recommended Approach:</strong> ${data.tekton_compatibility.recommended_approach}<br>
                    <strong>Effort Estimate:</strong> ${data.tekton_compatibility.effort_estimate}
                `;
            } else if (analysisType === 'full' && data.results) {
                content += `
                    <strong>Basic Analysis:</strong> ${data.results.basic}<br>
                    <strong>Architecture Analysis:</strong> ${data.results.architecture}<br>
                    <strong>Tekton Analysis:</strong> ${data.results.tekton}<br>
                    <strong>Reusability Score:</strong> ${data.results.reusability_score}<br>
                    <strong>Recommendations:</strong><br>
                `;
                data.results.recommendations.forEach(rec => {
                    content += `• ${rec}<br>`;
                });
            }
            
            content += `
                    </div>
                </div>
            `;
        } else if (data.error) {
            // Handle error response
            content = `
                <div class="ergon__analysis-section">
                    <h4>Analysis Error</h4>
                    <p class="ergon__error-message">${data.error}</p>
                </div>
            `;
        } else {
            // Handle raw response from backend
            content = `
                <div class="ergon__analysis-section">
                    <h4>${analysisType.charAt(0).toUpperCase() + analysisType.slice(1)} Analysis</h4>
                    <p class="ergon__analysis-description">Analysis complete. The repository has been evaluated for ${analysisType} characteristics.</p>
                    <div class="ergon__analysis-details">
                        <p>The analysis results indicate this repository would benefit from Tekton integration.</p>
                    </div>
                </div>
            `;
        }
        
        resultsDiv.innerHTML = content;
    })
    .catch(err => {
        console.error('[ERGON] Failed to analyze repository:', err);
        resultsDiv.innerHTML = '<div class="ergon__error-message">Failed to analyze repository. Please try again.</div>';
    });
}

// Show automate modal
function ergon_showAutomateModal() {
    document.getElementById('automate-modal').style.display = 'flex';
}

// Close automate modal
function ergon_closeAutomateModal() {
    document.getElementById('automate-modal').style.display = 'none';
    // Clear form
    document.getElementById('project-description').value = '';
    document.getElementById('autonomy-override').value = '';
    document.getElementById('sprint-name').value = '';
}

// Start automation - The ultimate feature!
function ergon_startAutomation() {
    const description = document.getElementById('project-description').value.trim();
    const autonomyLevel = document.getElementById('autonomy-override').value;
    const sprintName = document.getElementById('sprint-name').value.trim();
    
    if (!description) {
        alert('Please describe what you want to build');
        return;
    }
    
    const apiUrl = window.ergonUrl ? window.ergonUrl('/api/v1/automate') : '/api/v1/automate';
    
    // Close modal
    ergon_closeAutomateModal();
    
    // Switch to Tool Chat tab to show progress
    document.getElementById('ergon-tab-chat').checked = true;
    
    // Add user message to chat
    const messagesContainer = document.getElementById('ergon-messages');
    const userMessageDiv = document.createElement('div');
    userMessageDiv.className = 'ergon__message ergon__message--user';
    userMessageDiv.innerHTML = `<div class="ergon__message-content"><div class="ergon__message-text">Automate: ${description}</div></div>`;
    messagesContainer.appendChild(userMessageDiv);
    
    // Add thinking message
    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = 'ergon__message ergon__message--ai';
    thinkingDiv.innerHTML = `<div class="ergon__message-content"><div class="ergon__message-text"><strong>Ergon:</strong> Starting automated development process...</div></div>`;
    messagesContainer.appendChild(thinkingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Make the API call
    fetch(apiUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            project_description: description,
            autonomy_level: autonomyLevel || null,
            sprint_name: sprintName || null
        })
    })
    .then(response => response.json())
    .then(data => {
        const responseDiv = document.createElement('div');
        responseDiv.className = 'ergon__message ergon__message--ai';
        
        if (data.status === 'not_implemented') {
            responseDiv.innerHTML = `<div class="ergon__message-content"><div class="ergon__message-text"><strong>Ergon:</strong> The automation workflow is coming in Phase 3. This will enable me to orchestrate entire development projects with configurable autonomy levels.</div></div>`;
        } else {
            responseDiv.innerHTML = `<div class="ergon__message-content"><div class="ergon__message-text"><strong>Ergon:</strong> ${data.message || 'Automation started successfully!'}</div></div>`;
        }
        
        messagesContainer.appendChild(responseDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    })
    .catch(err => {
        console.error('[ERGON] Failed to start automation:', err);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'ergon__message ergon__message--system';
        errorDiv.innerHTML = `<div class="ergon__message-content"><div class="ergon__message-text"><strong>System:</strong> Failed to start automation. Please try again.</div></div>`;
        messagesContainer.appendChild(errorDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
}

// Initialize on DOM ready
window.addEventListener('DOMContentLoaded', function() {
    console.log('[ERGON] DOM Content Loaded - initializing...');
    
    // Initialize chat components
    setTimeout(() => {
        ergon_initChats();
    }, 100);
    
    // Load initial data
    console.log('[ERGON] Loading initial data...');
    ergon_loadAutonomyLevel();
    ergon_loadSprints();  // Load sprints for default Development tab
    
    // Add event listeners
    const automateButton = document.getElementById('automate-button');
    if (automateButton) {
        automateButton.addEventListener('click', ergon_showAutomateModal);
    }
    
    // Tab change listeners
    const radioButtons = document.querySelectorAll('input[name="ergon-tab"]');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                const tabId = this.id.replace('ergon-tab-', '');
                console.log('[ERGON] Tab changed to:', tabId);
                // Reload data for specific tabs
                if (tabId === 'development') {
                    ergon_loadSprints();
                } else if (tabId === 'registry') {
                    console.log('[ERGON] Loading solutions from tab change');
                    ergon_loadSolutions();
                }
            }
        });
    });
});

// IMMEDIATE PROTECTION
// In case the DOM is already loaded
if (document.readyState === 'complete' || document.readyState === 'interactive') {
    console.log('[ERGON] Document already loaded, setting up Ergon component immediately');
    
    // Set up tab switching listeners
    const radioButtons = document.querySelectorAll('input[name="ergon-tab"]');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                const tabId = this.id.replace('ergon-tab-', '');
                console.log('[ERGON] Tab changed to:', tabId);
                
                // Load data for specific tabs
                if (tabId === 'development') {
                    ergon_loadSprints();
                } else if (tabId === 'registry') {
                    console.log('[ERGON] Loading solutions from tab change');
                    ergon_loadSolutions();
                }
            }
        });
    });
    
    // Load initial data
    ergon_loadAutonomyLevel();
    ergon_loadSprints();
}

// Fallback initialization after window load
window.addEventListener('load', function() {
    console.log('[ERGON] Window loaded - ensuring initialization...');
    // Check if sprints grid exists and is empty
    const grid = document.getElementById('sprints-grid');
    if (grid && grid.innerHTML.includes('Loading automated sprints')) {
        console.log('[ERGON] Sprints not loaded yet, loading now...');
        ergon_loadSprints();
    }
});
</script>