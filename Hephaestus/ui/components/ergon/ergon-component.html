<!-- Ergon Component v2 - CI-in-the-Loop Reuse Specialist -->
<!-- @landmark Component: Ergon v2 - Solution registry, GitHub analysis, configuration generation, and autonomous development -->

<!-- Load chat dependencies -->
<script src="/scripts/shared/ai-chat.js"></script>
<script src="/scripts/shared/single-chat.js"></script>
<script src="/scripts/shared/team-chat.js"></script>

<!-- Load Registry integration -->
<script src="/scripts/ergon/registry-integration.js"></script>
<!-- Load Sandbox integration -->
<script src="/scripts/ergon/sandbox-integration.js"></script>
<!-- Load Construct integration -->
<script src="/scripts/ergon/construct-integration.js"></script>
<!-- Load Construct guided dialog -->
<script src="/scripts/ergon/construct-guided-dialog.js"></script>

<script>
// Define global functions early for inline handlers
window.ergon_sendChat = function() {
    console.log('[ERGON] ergon_sendChat called');
    const input = document.getElementById('ergon-chat-input');
    if (!input) {
        console.error('[ERGON] Chat input element not found!');
        return;
    }
    
    const message = input.value.trim();
    console.log('[ERGON] Message:', message);
    
    if (!message) {
        console.log('[ERGON] No message to send');
        return;
    }
    
    // Determine which tab is active
    const chatRadio = document.getElementById('ergon-tab-chat');
    const teamchatRadio = document.getElementById('ergon-tab-teamchat');
    const constructRadio = document.getElementById('ergon-tab-construct');
    const chatActive = chatRadio ? chatRadio.checked : false;
    const teamActive = teamchatRadio ? teamchatRadio.checked : false;
    const constructActive = constructRadio ? constructRadio.checked : false;
    
    // If we're on Construct tab, handle it specially
    if (constructActive) {
        console.log('[ERGON] Construct tab is active - processing for guided dialog');
        console.log('[ERGON] ConstructDialog available:', !!window.ConstructDialog);
        
        // Let the Construct guided dialog handle the input
        if (window.ConstructDialog && window.ConstructDialog.processResponse) {
            console.log('[ERGON] Calling ConstructDialog.processResponse with:', message);
            window.ConstructDialog.processResponse(message);
        } else {
            console.error('[ERGON] ConstructDialog.processResponse not available!');
            // Try to initialize if not ready
            if (window.ConstructDialog && window.ConstructDialog.init) {
                console.log('[ERGON] Attempting to initialize ConstructDialog first...');
                window.ConstructDialog.init().then(() => {
                    console.log('[ERGON] Initialized, now processing message');
                    if (window.ConstructDialog.processResponse) {
                        window.ConstructDialog.processResponse(message);
                    }
                });
            }
        }
        input.value = '';
        return;
    }
    
    // If we're not on a chat tab (or Construct), switch to tool chat first
    if (!chatActive && !teamActive) {
        if (chatRadio) {
            chatRadio.checked = true;
        }
        // Small delay to let the CSS transition complete and ensure chat is initialized
        setTimeout(() => {
            const toolChatEl = document.getElementById('ergon-messages');
            if (window.SingleChat && toolChatEl) {
                // Ensure it's initialized before sending
                window.SingleChat.init(toolChatEl, 'ergon', 'chat-message');
                window.SingleChat.sendMessage(toolChatEl, message);
            }
            input.value = '';
        }, 100);
        return;
    }
    
    // Normal chat behavior when already on a chat tab
    if (chatActive) {
        console.log('[ERGON] Chat tab is active');
        // Use SingleChat for tool AI
        const toolChatEl = document.getElementById('ergon-messages');
        if (!window.SingleChat) {
            console.error('[ERGON] SingleChat not available!');
            return;
        }
        if (!toolChatEl) {
            console.error('[ERGON] Tool chat element not found!');
            return;
        }
        
        // Ensure it's initialized (in case it wasn't already)
        if (!toolChatEl.getAttribute('data-component-name')) {
            console.log('[ERGON] Initializing SingleChat for ergon');
            window.SingleChat.init(toolChatEl, 'ergon', 'ergon');
        }
        
        console.log('[ERGON] Sending message via SingleChat');
        window.SingleChat.sendMessage(toolChatEl, message);
    } else if (teamActive) {
        console.log('[ERGON] Team chat tab is active');
        // Use TeamChat for team broadcast
        const teamChatEl = document.getElementById('awt-team-messages');
        if (!window.TeamChat) {
            console.error('[ERGON] TeamChat not available!');
            return;
        }
        if (!teamChatEl) {
            console.error('[ERGON] Team chat element not found!');
            return;
        }
        
        // Ensure it's initialized (in case it wasn't already)
        if (!teamChatEl.getAttribute('data-component-name')) {
            console.log('[ERGON] Initializing TeamChat for awt-team');
            window.TeamChat.init(teamChatEl, 'ergon', 'ergon');
        }
        
        console.log('[ERGON] Sending message via TeamChat');
        window.TeamChat.sendMessage(teamChatEl, message);
    } else {
        console.log('[ERGON] No chat tab active');
    }
    
    // Clear input
    input.value = '';
}

// Initialize Registry when tab is clicked
window.ergon_initRegistry = function() {
    if (window.RegistryIntegration) {
        const registry = new window.RegistryIntegration();
        registry.initialize();
        
        // Load initial data
        registry.loadSolutions();
        registry.updateStatistics();
    } else {
        console.warn('[ERGON] Registry integration not loaded yet');
    }
}

// Add click handler for Registry tab
document.addEventListener('DOMContentLoaded', function() {
    const registryTab = document.querySelector('label[for="ergon-tab-registry"]');
    if (registryTab) {
        registryTab.addEventListener('click', function() {
            setTimeout(ergon_initRegistry, 100); // Small delay to ensure tab is switched
        });
    }
    
    // Add click handler for Construct tab
    const constructTab = document.querySelector('label[for="ergon-tab-construct"]');
    if (constructTab) {
        constructTab.addEventListener('click', async function() {
            console.log('[ERGON] Construct tab clicked - initializing guided dialog');
            
            // Small delay to ensure tab is switched
            await new Promise(resolve => setTimeout(resolve, 100));
            
            if (window.ConstructDialog && window.ConstructDialog.init) {
                console.log('[ERGON] ConstructDialog found, initializing...');
                try {
                    await window.ConstructDialog.init();
                    console.log('[ERGON] ConstructDialog initialized successfully');
                } catch (error) {
                    console.error('[ERGON] ConstructDialog initialization failed:', error);
                    // Show fallback message
                    const questionList = document.getElementById('construct-question-list');
                    if (questionList) {
                        questionList.innerHTML = '<div class="ergon__error-message">Failed to load questions. Please check console for errors.</div>';
                    }
                }
            } else {
                console.error('[ERGON] ConstructDialog not found! Check if construct-guided-dialog.js is loaded');
                // Try loading it manually
                const script = document.createElement('script');
                script.src = '/scripts/ergon/construct-guided-dialog.js';
                script.onload = () => {
                    console.log('[ERGON] Script loaded, initializing...');
                    if (window.ConstructDialog && window.ConstructDialog.init) {
                        window.ConstructDialog.init();
                    }
                };
                document.head.appendChild(script);
            }
        });
    } else {
        console.error('[ERGON] Construct tab label not found in DOM');
    }
});
</script>

<!-- Hidden radio inputs for CSS-first tab functionality -->
<!-- @landmark Navigation: CSS-first radio buttons for tab switching -->
<input type="radio" name="ergon-tab" id="ergon-tab-development" checked style="display: none;">
<input type="radio" name="ergon-tab" id="ergon-tab-registry" style="display: none;">
<input type="radio" name="ergon-tab" id="ergon-tab-construct" style="display: none;">
<input type="radio" name="ergon-tab" id="ergon-tab-chat" style="display: none;">
<input type="radio" name="ergon-tab" id="ergon-tab-teamchat" style="display: none;">

<div class="ergon" data-tekton-area="ergon" data-tekton-component="ergon" data-tekton-type="component-workspace" data-tekton-ai="ergon-assistant" data-tekton-ai-ready="false">
    <!-- Component Header with Title -->
    <!-- @landmark Header: Component title and branding -->
    <div class="ergon__header" data-tekton-zone="header" data-tekton-section="header">
        <div class="ergon__title-container">
            <img src="/images/hexagon.jpg" alt="Tekton" class="ergon__icon">
            <h2 class="ergon__title">
                <span class="ergon__title-main">Ergon</span>
                <span class="ergon__title-sub">Automation/Tools</span>
            </h2>
        </div>
    </div>

    <!-- Ergon Menu Bar with Tab Navigation -->
    <!-- @landmark Menu: Tab navigation for 5 component views -->
    <div class="ergon__menu-bar" data-tekton-zone="menu" data-tekton-nav="component-menu">
        <div class="ergon__tabs" data-tekton-zone="menu" data-tekton-nav="tabs" data-tekton-nav-type="component-tabs">
            <label for="ergon-tab-development" class="ergon__tab" data-tab="development" 
                 data-tekton-menu-item="Development" 
                 data-tekton-menu-component="ergon" 
                 data-tekton-menu-panel="development-panel" 
                 data-tekton-nav-target="development"
                 data-tekton-nav-item="tab"
                 data-tekton-nav-action="switch-tab"
                 data-tekton-trigger="click">
                <span class="ergon__tab-label">Development</span>
            </label>
            <label for="ergon-tab-registry" class="ergon__tab" data-tab="registry" 
                 data-tekton-menu-item="Registry" 
                 data-tekton-menu-component="ergon" 
                 data-tekton-menu-panel="registry-panel" 
                 data-tekton-nav-target="registry"
                 data-tekton-nav-item="tab"
                 data-tekton-nav-action="switch-tab"
                 data-tekton-trigger="click">
                <span class="ergon__tab-label">Registry</span>
            </label>
            <label for="ergon-tab-construct" class="ergon__tab" data-tab="construct" 
                 data-tekton-menu-item="Construct" 
                 data-tekton-menu-component="ergon" 
                 data-tekton-menu-panel="construct-panel" 
                 data-tekton-nav-target="construct"
                 data-tekton-nav-item="tab"
                 data-tekton-nav-action="switch-tab"
                 data-tekton-trigger="click">
                <span class="ergon__tab-label">Construct</span>
            </label>
            <label for="ergon-tab-chat" class="ergon__tab" data-tekton-chat="tab" data-tab="chat" 
                 data-tekton-menu-item="Tool Chat" 
                 data-tekton-menu-component="ergon" 
                 data-tekton-menu-panel="ergon-panel" 
                 data-tekton-nav-target="chat"
                 data-tekton-nav-item="tab"
                 data-tekton-nav-action="switch-tab"
                 data-tekton-trigger="click"
                 data-tekton-ai="chat-tab">
                <span class="ergon__tab-label">Tool Chat</span>
            </label>
            <label for="ergon-tab-teamchat" class="ergon__tab" data-tekton-chat="tab" data-tab="teamchat" 
                 data-tekton-menu-item="Team Chat" 
                 data-tekton-menu-component="ergon" 
                 data-tekton-menu-panel="awt-team-panel" 
                 data-tekton-nav-target="teamchat"
                 data-tekton-nav-item="tab"
                 data-tekton-nav-action="switch-tab"
                 data-tekton-trigger="click"
                 data-tekton-ai="team-chat-tab">
                <span class="ergon__tab-label">Team Chat</span>
            </label>
        </div>
    </div>
    
    <!-- Ergon Content Area -->
    <!-- @landmark Content: Main content area with 6 tab panels -->
    <div class="ergon__content" data-tekton-zone="content" data-tekton-scrollable="true">
        <!-- Development Tab (Default Active Tab) -->
        <!-- @landmark Panel: Development - Manage Ergon-driven development sprints -->
        <div id="development-panel" class="ergon__panel" data-tekton-panel="development" data-tekton-panel-for="Development" data-tekton-panel-component="ergon" data-tekton-type="panel" data-tekton-zone="content-panel" data-tekton-state="active" data-tekton-visibility="visible">
            <div class="ergon__sprints-container" data-tekton-component="sprints-container" data-tekton-zone="sprints">
                <div class="ergon__sprints-grid" id="sprints-grid" data-tekton-component="sprints-grid" data-tekton-type="container" data-tekton-state="loading">
                    <!-- Sprint cards will be loaded here dynamically -->
                    <div class="ergon__loading-message" id="sprints-loading" data-tekton-type="loading-indicator" data-tekton-state="loading">
                        <div class="ergon__message-text" data-tekton-type="loading-text">Loading automated sprints...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Registry Tab -->
        <!-- @landmark Panel: Registry - Browse and search reusable solutions -->
        <div id="registry-panel" class="ergon__panel" data-tekton-panel="registry" data-tekton-panel-for="Registry" data-tekton-panel-component="ergon" data-tekton-type="panel" data-tekton-zone="content-panel" data-tekton-state="inactive" data-tekton-visibility="hidden">
            <div class="ergon__panel-header">
                <div class="ergon__panel-header-top">
                    <div class="ergon__header-left">
                        <h3 class="ergon__section-title">Solution Registry</h3>
                        <div class="ergon__header-stats">
                            <span class="ergon__stat-item">
                                <span class="ergon__stat-label">Total:</span>
                                <span id="total-solutions" class="ergon__stat-value">0</span>
                            </span>
                            <span class="ergon__stat-item">
                                <span class="ergon__stat-label">Compliant:</span>
                                <span id="compliant-solutions" class="ergon__stat-value">0</span>
                            </span>
                        </div>
                    </div>
                    <button id="check-completed-projects" class="ergon__button ergon__button--primary" 
                            data-tekton-action="check-projects" 
                            data-tekton-trigger="click"
                            data-tekton-target="import-status">
                        Check Completed Projects
                    </button>
                </div>
                <p class="ergon__section-description">Browse and search our catalog of reusable tools, agents, MCP servers, and workflows.</p>
                
                <!-- Search and Filters -->
                <div class="ergon__search-bar" data-tekton-component="search-bar" data-tekton-type="search-container">
                    <input type="text" id="registry-search" class="ergon__search-input" placeholder="Search solutions..." data-tekton-input="search" data-tekton-type="search-input" data-tekton-action="filter" data-tekton-target="solution-grid">
                    <select id="registry-type-filter" class="ergon__filter-select" data-tekton-select="filter" data-tekton-type="filter-select" data-tekton-action="filter-type" data-tekton-target="solution-grid">
                        <option value="">All Types</option>
                        <option value="tool">Tools</option>
                        <option value="agent">Agents</option>
                        <option value="mcp_server">MCP Servers</option>
                        <option value="library">Libraries</option>
                        <option value="framework">Frameworks</option>
                        <option value="workflow">Workflows</option>
                    </select>
                    <select id="registry-capability-filter" class="ergon__filter-select" data-tekton-select="filter" data-tekton-type="filter-select" data-tekton-action="filter-capability" data-tekton-target="solution-grid">
                        <option value="">All Capabilities</option>
                        <option value="data_processing">Data Processing</option>
                        <option value="api_development">API Development</option>
                        <option value="machine_learning">Machine Learning</option>
                        <option value="database_operations">Database Operations</option>
                        <option value="devops">DevOps</option>
                        <option value="testing">Testing</option>
                        <option value="documentation">Documentation</option>
                        <option value="security">Security</option>
                    </select>
                </div>
            </div>

            <!-- Solution Grid with Results -->
            <div class="ergon__solution-grid" id="solution-grid" 
                 data-tekton-component="solution-grid" 
                 data-tekton-type="container" 
                 data-tekton-zone="registry-list"
                 data-tekton-state="empty">
                
                <!-- Solutions will be loaded here dynamically -->
                <!-- Example solution card structure: -->
                <!--
                <div class="ergon__solution-card" data-tekton-element="solution-card" data-solution-id="">
                    <div class="ergon__solution-header">
                        <h4 class="ergon__solution-name"></h4>
                        <span class="ergon__solution-version"></span>
                        <span class="ergon__solution-type"></span>
                    </div>
                    <div class="ergon__solution-meta">
                        <span class="ergon__standards-badge" data-tekton-status="compliant">✓ Standards</span>
                        <span class="ergon__lineage-info">Lineage: 0</span>
                    </div>
                    <div class="ergon__solution-actions">
                        <button class="ergon__button ergon__button--test" data-tekton-action="test-solution">Test</button>
                        <button class="ergon__button ergon__button--view" data-tekton-action="view-details">Details</button>
                        <button class="ergon__button ergon__button--check" data-tekton-action="check-standards">Check</button>
                    </div>
                </div>
                -->
                
                <div class="ergon__empty-message" id="solutions-loading" 
                     data-tekton-type="empty-state" 
                     data-tekton-state="empty">
                    <div class="ergon__message-text" data-tekton-type="empty-text">
                        No solutions found. Click "Check for Completed Projects" to import from TektonCore.
                    </div>
                </div>
            </div>
        </div>
        
        
        <!-- Construct Tab -->
        <!-- @landmark Panel: Construct - Build solutions from Registry components -->
        <div id="construct-panel" class="ergon__panel" data-tekton-panel="construct" data-tekton-panel-for="Construct" data-tekton-panel-component="ergon" data-tekton-type="panel" data-tekton-zone="content-panel" data-tekton-state="inactive" data-tekton-visibility="hidden">
            <div class="ergon__panel-header">
                <h3 class="ergon__section-title">Solution Composer</h3>
                <p class="ergon__section-description">Build new solutions by combining Registry components. Answer the questions below using the chat input at the bottom of the screen.</p>
            </div>
            
            <!-- Two-column layout: Dialog on left, Workspace on right -->
            <div class="ergon__construct-layout">
                <!-- Left column: Guided Dialog -->
                <div class="ergon__construct-dialog">
                    <!-- Question list (shows all questions, grays out future ones) -->
                    <div id="construct-question-list" class="ergon__question-list">
                        <!-- Questions will be rendered here by JavaScript -->
                    </div>
                    
                    <!-- Current question highlight area -->
                    <div id="construct-current-question" class="ergon__current-question">
                        <!-- Current question will be highlighted here -->
                    </div>
                    
                    <!-- Navigation buttons -->
                    <div class="ergon__dialog-buttons">
                        <button id="construct-prev-btn" class="ergon__button ergon__button--secondary" onclick="window.ConstructDialog && window.ConstructDialog.previousQuestion()">
                            ← Prev
                        </button>
                        <button id="construct-next-btn" class="ergon__button ergon__button--secondary" onclick="window.ConstructDialog && window.ConstructDialog.nextQuestion()">
                            Next →
                        </button>
                        <button id="construct-build-btn" class="ergon__button ergon__button--primary" onclick="window.ConstructDialog && window.ConstructDialog.buildComposition()" disabled>
                            Build
                        </button>
                    </div>
                </div>
                
                <!-- Right column: Workspace JSON (real-time updates) -->
                <div class="ergon__construct-workspace">
                    <div class="ergon__workspace-header">
                        <h4>Workspace JSON</h4>
                        <span class="ergon__workspace-status">Building...</span>
                    </div>
                    <pre id="construct-workspace-json" class="ergon__json-display">{
  "components": [],
  "connections": [],
  "constraints": {}
}</pre>
                </div>
            </div>
            
            <!-- Action buttons (shown after Build) -->
            <div id="construct-actions" class="ergon__construct-actions">
                <!-- Separator line and Validate/Test/Publish/Revise buttons will appear here after composition is built -->
            </div>
            
        </div>
        
        <!-- Tool Chat Tab -->
        <!-- @landmark Panel: Tool Chat - Direct chat with Ergon AI assistant -->
        <div id="ergon-panel" class="ergon__panel" data-tekton-panel="ergon" data-tekton-panel-for="Tool Chat" data-tekton-panel-component="ergon" data-tekton-type="panel" data-tekton-zone="content-panel" data-tekton-state="inactive" data-tekton-visibility="hidden" data-tekton-chat="panel" data-tekton-ai="chat-panel" data-tekton-ai-ready="true">
            <div id="ergon-messages" class="ergon__chat-messages" data-tekton-chat="messages" data-tekton-component="chat-messages" data-tekton-type="message-container" data-tekton-ai="message-area">
                <!-- Welcome message -->
                <div class="ergon__message ergon__message--system" data-tekton-chat="message" data-tekton-message-type="system" data-tekton-type="welcome-message">
                    <div class="ergon__message-content" data-tekton-zone="message-content">
                        <div class="ergon__message-text" data-tekton-type="message-text">
                            <h3 class="ergon__message-title" data-tekton-type="message-title">Welcome to Ergon v2 AI Assistant</h3>
                            <p data-tekton-type="message-paragraph">I'm your CI-in-the-Loop reuse specialist. I can help you find existing solutions, generate configurations, and even automate entire development workflows. My current autonomy level is <strong data-tekton-ai="autonomy-indicator">Advisory</strong>.</p>
                            <p data-tekton-type="message-paragraph">How can I assist you today?</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Team Chat Tab -->
        <!-- @landmark Panel: Team Chat - Collaborate with all Tekton AI assistants -->
        <div id="awt-team-panel" class="ergon__panel" data-tekton-panel="awt-team" data-tekton-panel-for="Team Chat" data-tekton-panel-component="ergon" data-tekton-type="panel" data-tekton-zone="content-panel" data-tekton-state="inactive" data-tekton-visibility="hidden" data-tekton-chat="panel" data-tekton-ai="team-chat-panel" data-tekton-ai-ready="true">
            <div id="awt-team-messages" class="ergon__chat-messages" data-tekton-chat="messages" data-tekton-component="team-messages" data-tekton-type="message-container" data-tekton-ai="team-message-area">
                <!-- Welcome message -->
                <div class="ergon__message ergon__message--system" data-tekton-chat="message" data-tekton-message-type="system" data-tekton-type="welcome-message" data-tekton-ai="team-welcome">
                    <div class="ergon__message-content" data-tekton-zone="message-content">
                        <div class="ergon__message-text" data-tekton-type="message-text">
                            <h3 class="ergon__message-title" data-tekton-type="message-title">Tekton Team Chat</h3>
                            <p data-tekton-type="message-paragraph">This chat is shared across all Tekton components. Use this for team communication and coordination.</p>
                        </div>
                    </div>
                </div>
                <!-- Team messages will appear here dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Footer with Chat Input -->
    <!-- @landmark Footer: Chat input area -->
    <div class="ergon__footer" data-tekton-zone="footer" data-tekton-component="chat-footer" data-tekton-type="input-area">
        <div class="ergon__chat-input-container" data-tekton-chat="input" data-tekton-component="input-container" data-tekton-type="chat-input-group">
            <div class="ergon__chat-prompt" data-tekton-chat="container">></div>
            <input type="text" id="ergon-chat-input" class="ergon__chat-input" data-tekton-chat="input" 
                   data-tekton-input="chat-input"
                   data-tekton-input-type="chat"
                   placeholder="Ask about solutions or request automation..."
                   onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); ergon_sendChat(); }">
            <button id="ergon-send-button" class="ergon__send-button"
                    data-tekton-action="send-message" 
                    data-tekton-action-type="primary"
                    data-tekton-trigger="click"
                    data-tekton-target="chat-messages"
                    data-tekton-status="enabled"
                    onclick="ergon_sendChat(); return false;">Send</button>
        </div>
    </div>
</div>

<!-- Automate Development Modal -->
<div id="automate-modal" class="ergon__modal" style="display: none;" data-tekton-component="automate-modal" data-tekton-type="modal" data-tekton-state="hidden" data-tekton-visibility="hidden" data-tekton-ai="automation-modal">
    <div class="ergon__modal-overlay" onclick="ergon_closeAutomateModal()" data-tekton-type="overlay" data-tekton-action="close-modal" data-tekton-trigger="click"></div>
    <div class="ergon__modal-content ergon__modal-content--large" data-tekton-type="modal-content" data-tekton-zone="modal-body">
        <h3 class="ergon__modal-title">Automate Development - The Ultimate Feature</h3>
        <p class="ergon__modal-description">Describe what you want to build, and I'll orchestrate the entire development process.</p>
        
        <div class="ergon__form-group">
            <label for="project-description" class="ergon__form-label">Project Description:</label>
            <textarea id="project-description" class="ergon__form-textarea ergon__form-textarea--large" 
                      placeholder="Describe what you want to build in detail. Include features, technologies, and any specific requirements..."
                      rows="6"
                      data-tekton-input="project-description"
                      data-tekton-type="textarea"
                      data-tekton-ai="project-input"
                      data-tekton-state="empty"></textarea>
        </div>
        
        <div class="ergon__form-group">
            <label for="autonomy-override" class="ergon__form-label">Autonomy Level for This Project:</label>
            <select id="autonomy-override" class="ergon__form-select" data-tekton-select="autonomy" data-tekton-type="autonomy-select" data-tekton-ai="autonomy-level" data-tekton-state="default">
                <option value="">Use Current Level</option>
                <option value="advisory">Advisory - I'll provide recommendations only</option>
                <option value="assisted">Assisted - You approve each step</option>
                <option value="guided">Guided - You approve major decisions</option>
                <option value="autonomous">Autonomous - Full automation within sprint</option>
            </select>
        </div>
        
        <div class="ergon__form-group">
            <label for="sprint-name" class="ergon__form-label">Sprint Name (optional):</label>
            <input type="text" id="sprint-name" class="ergon__form-input" placeholder="e.g., MVP_Development_Sprint" data-tekton-input="sprint-name" data-tekton-type="text-input" data-tekton-state="empty">
        </div>
        
        <div class="ergon__modal-actions" data-tekton-type="action-container" data-tekton-zone="modal-footer">
            <button class="ergon__button ergon__button--cancel" onclick="ergon_closeAutomateModal()" data-tekton-action="cancel" data-tekton-action-type="secondary" data-tekton-trigger="click">Cancel</button>
            <button class="ergon__button ergon__button--submit" onclick="ergon_startAutomation()" data-tekton-action="start-automation" data-tekton-action-type="primary" data-tekton-trigger="click" data-tekton-ai="start-automation" data-tekton-status="enabled">Start Automation</button>
        </div>
    </div>
</div>

<!-- Add component-specific styles -->
<style>
    /* Ergon v2 component styles using BEM naming convention */
    /* Base styles from v1 are preserved, with v2 additions */
    
    /* Container */
    .ergon {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        background-color: var(--bg-primary, #1e1e2e);
        color: var(--text-primary, #f0f0f0);
        position: relative;
    }
    
    /* Header with autonomy indicator */
    .ergon__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px;
        background-color: var(--bg-secondary, #252535);
        border-bottom: 1px solid var(--border-color, #444444);
        height: 46px;
    }
    
    .ergon__title-container {
        display: flex;
        align-items: center;
    }
    
    .ergon__icon {
        height: 30px;
        width: auto;
        margin-right: 12px;
    }
    
    .ergon__title {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 500;
    }
    
    .ergon__title-sub {
        margin-left: 8px;
        opacity: 0.8;
        font-weight: normal;
        font-size: 0.9rem;
    }
    
    /* Autonomy Indicator */
    .ergon__autonomy-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 12px;
        background-color: var(--bg-tertiary, #333345);
        border-radius: 16px;
        font-size: 0.9rem;
    }
    
    .ergon__autonomy-label {
        opacity: 0.7;
    }
    
    .ergon__autonomy-level {
        font-weight: 600;
        color: #00BCD4; /* Ergon blue */
    }
    
    /* Menu Bar */
    .ergon__menu-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 16px;
        background-color: var(--bg-secondary, #252535);
        border-bottom: 1px solid var(--border-color, #444444);
        height: 46px;
    }
    
    .ergon__tabs {
        display: flex;
        gap: 8px;
    }
    
    .ergon__tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background-color: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-primary, #f0f0f0);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    /* CSS-first navigation - radio button controls active state */
    #ergon-tab-development:checked ~ .ergon .ergon__tab[data-tab="development"],
    #ergon-tab-registry:checked ~ .ergon .ergon__tab[data-tab="registry"],
    #ergon-tab-construct:checked ~ .ergon .ergon__tab[data-tab="construct"],
    #ergon-tab-chat:checked ~ .ergon .ergon__tab[data-tab="chat"],
    #ergon-tab-teamchat:checked ~ .ergon .ergon__tab[data-tab="teamchat"] {
        border-bottom-color: #00BCD4; /* Ergon blue for active tab */
        font-weight: 500;
    }
    
    .ergon__tab:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .ergon__actions {
        display: flex;
        gap: 8px;
    }
    
    .ergon__action-button {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .ergon__action-button:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .ergon__action-button--primary {
        background-color: #00BCD4;
        border-color: #00BCD4;
        color: #1e1e2e;
        font-weight: 500;
    }
    
    .ergon__action-button--primary:hover {
        background-color: #00ACC1;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 188, 212, 0.3);
    }
    
    .ergon__action-button--success {
        background-color: #4CAF50;
        border-color: #4CAF50;
        color: white;
        font-weight: 500;
    }
    
    .ergon__action-button--success:hover {
        background-color: #45a049;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
    }
    
    .ergon__action-button--secondary {
        background-color: #2196F3;
        border-color: #2196F3;
        color: white;
    }
    
    .ergon__action-button--secondary:hover {
        background-color: #1976D2;
    }
    
    .ergon__action-button--orange {
        background-color: #81C784;  /* Light mint green */
        border-color: #81C784;
        color: #1e1e2e;
    }
    
    .ergon__action-button--orange:hover {
        background-color: #66BB6A;
    }
    
    .ergon__action-button--magenta {
        background-color: #BA68C8;  /* Light purple */
        border-color: #BA68C8;
        color: white;
    }
    
    .ergon__action-button--magenta:hover {
        background-color: #AB47BC;
    }
    
    .ergon__action-button--gold {
        background-color: #FFD700;
        border-color: #FFD700;
        color: #1e1e2e;
    }
    
    .ergon__action-button--gold:hover {
        background-color: #FFC700;
    }
    
    .ergon__action-button--teal {
        background-color: #009688;
        border-color: #009688;
        color: white;
    }
    
    .ergon__action-button--teal:hover {
        background-color: #00796B;
    }
    
    .ergon__action-button--pumpkin {
        background-color: #FF6F00;  /* Pumpkin orange */
        border-color: #FF6F00;
        color: white;
    }
    
    .ergon__action-button--pumpkin:hover {
        background-color: #E65100;
    }
    
    /* Content Area */
    .ergon__content {
        flex: 1;
        overflow: hidden;
        position: relative;
        margin-bottom: 70px;
    }
    
    .ergon__panel {
        display: none;
        height: 100%;
        width: 100%;
        overflow: auto;
        position: relative;
    }
    
    /* CSS-first panel visibility */
    #ergon-tab-development:checked ~ .ergon #development-panel,
    #ergon-tab-registry:checked ~ .ergon #registry-panel,
    #ergon-tab-construct:checked ~ .ergon #construct-panel,
    #ergon-tab-chat:checked ~ .ergon #ergon-panel,
    #ergon-tab-teamchat:checked ~ .ergon #awt-team-panel {
        display: block;
    }
    
    /* Panel Headers */
    .ergon__panel-header {
        padding: 1.5rem;
        background-color: var(--bg-secondary, #252535);
    }
    
    .ergon__section-title {
        margin: 0 0 0.5rem 0;
        font-size: 1.3rem;
    }
    
    .ergon__section-description {
        margin: 0 0 1rem 0;
        color: var(--text-secondary, #aaa);
        line-height: 1.5;
    }
    
    /* Search and Filters */
    .ergon__search-bar {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .ergon__search-input {
        flex: 1;
        padding: 8px 16px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        color: var(--text-primary, #f0f0f0);
        font-size: 14px;
    }
    
    .ergon__filter-select {
        padding: 8px 16px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        color: var(--text-primary, #f0f0f0);
    }
    
    /* Solution Grid */
    .ergon__solution-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        padding: 1.5rem;
    }
    
    .ergon__solution-card {
        background-color: var(--bg-card, #2d2d2d);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-color, #444444);
        transition: all 0.2s ease;
    }
    
    .ergon__solution-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 188, 212, 0.1);
        border-color: #00BCD4;
    }
    
    .ergon__solution-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }
    
    .ergon__solution-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #00BCD4;
    }
    
    .ergon__solution-type {
        padding: 4px 8px;
        background-color: rgba(0, 188, 212, 0.2);
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .ergon__solution-description {
        margin-bottom: 1rem;
        color: var(--text-secondary, #aaa);
        line-height: 1.5;
    }
    
    .ergon__solution-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.9rem;
        color: var(--text-secondary, #aaa);
    }
    
    .ergon__solution-stat {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    /* Registry-specific styles */
    .ergon__panel-header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .ergon__header-left {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }
    
    .ergon__header-stats {
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    
    .ergon__status-text {
        font-size: 0.9rem;
        color: var(--text-secondary, #aaa);
    }
    
    .ergon__standards-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .ergon__standards-badge[data-tekton-status="compliant"] {
        background-color: rgba(76, 175, 80, 0.2);
        color: #4CAF50;
    }
    
    .ergon__standards-badge[data-tekton-status="non-compliant"] {
        background-color: rgba(255, 152, 0, 0.2);
        color: #FF9800;
    }
    
    .ergon__lineage-info {
        font-size: 0.85rem;
        color: var(--text-secondary, #aaa);
    }
    
    .ergon__solution-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .ergon__button {
        padding: 6px 12px;
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        background-color: var(--bg-tertiary, #333345);
        color: var(--text-primary, #f0f0f0);
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s ease;
    }
    
    .ergon__button:hover {
        background-color: var(--bg-hover, #3d3d4d);
        border-color: #00BCD4;
    }
    
    .ergon__button--primary {
        background-color: #00BCD4;
        color: #1a1a2e;
        border-color: #00BCD4;
    }
    
    .ergon__button--primary:hover {
        background-color: #00ACC1;
    }
    
    .ergon__button--test {
        border-color: #4CAF50;
    }
    
    .ergon__button--test:hover {
        background-color: rgba(76, 175, 80, 0.2);
        color: #4CAF50;
    }
    
    .ergon__stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }
    
    .ergon__stat-label {
        font-size: 0.9rem;
        color: var(--text-secondary, #aaa);
    }
    
    .ergon__stat-value {
        font-size: 1rem;
        font-weight: 600;
        color: #00BCD4;
    }
    
    .ergon__solution-version {
        padding: 2px 6px;
        background-color: var(--bg-tertiary, #333345);
        border-radius: 4px;
        font-size: 0.8rem;
        color: var(--text-secondary, #aaa);
    }
    
    
    .ergon__input-large {
        padding: 12px 16px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        color: var(--text-primary, #f0f0f0);
        font-size: 14px;
        width: 100%;
    }
    
    .ergon__checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }
    
    .ergon__checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    
    /* Configurator Styles */
    .ergon__configurator-form {
        padding: 0.5rem 1.5rem;
        max-width: 600px;
    }
    
    .ergon__form-group {
        margin-bottom: 1.5rem;
    }
    
    .ergon__form-group:first-child {
        margin-top: 0;
    }
    
    .ergon__form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }
    
    .ergon__form-input,
    .ergon__form-select,
    .ergon__form-textarea {
        width: 100%;
        padding: 8px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        color: var(--text-primary, #f0f0f0);
    }
    
    .ergon__form-textarea {
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
    }
    
    .ergon__form-textarea--large {
        min-height: 150px;
    }
    
    .ergon__config-parameters {
        background-color: #424242;  /* Darker gray */
        border-radius: 8px;
        padding: 1rem;
        min-height: 100px;
        color: #ffffff;  /* White text */
    }
    
    .ergon__config-output {
        padding: 1.5rem;
    }
    
    /* Chat Styles (inherited from v1) */
    .ergon__chat-messages {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow-y: auto;
        padding: 16px;
        padding-bottom: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .ergon__message {
        border-radius: 8px;
        padding: 12px 16px;
        max-width: 85%;
        word-wrap: break-word;
        line-height: 1.4;
        margin: 4px 0;
    }
    
    .ergon__message--system {
        background-color: rgba(0, 188, 212, 0.05);
        align-self: center;
        max-width: 90%;
        width: 600px;
        margin: 8px 0;
        border-radius: 8px;
        padding: 16px 24px;
        border-left: 3px solid #00BCD4;
    }
    
    .ergon__message--user {
        background-color: rgba(76, 175, 80, 0.05);
        color: var(--text-primary, #f0f0f0);
        align-self: flex-end;
        border-left: 3px solid #4CAF50;
        border-radius: 8px;
    }
    
    .ergon__message--ai {
        background-color: rgba(0, 188, 212, 0.05);
        color: var(--text-primary, #f0f0f0);
        align-self: flex-start;
        border-left: 3px solid #00BCD4;
        border-radius: 8px;
    }
    
    /* Footer */
    .ergon__footer {
        background-color: var(--bg-secondary, #252535);
        border-top: 1px solid var(--border-color, #444444);
        padding: 12px 16px;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 70px;
        z-index: 10;
        display: block !important;
    }
    
    .ergon__chat-input-container {
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
    }
    
    .ergon__chat-prompt {
        font-size: 18px;
        font-weight: bold;
        color: #00BCD4;
    }
    
    .ergon__chat-input {
        flex: 1;
        height: 44px;
        padding: 8px 16px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        color: var(--text-primary, #f0f0f0);
        font-size: 14px;
    }
    
    .ergon__send-button {
        height: 44px;
        padding: 0 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #00BCD4;
        border: none;
        border-radius: 8px;
        color: #1e1e2e;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .ergon__send-button:hover {
        background-color: #00ACC1;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 188, 212, 0.3);
    }
    
    /* Modal Styles */
    .ergon__modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .ergon__modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
    }
    
    .ergon__modal-content {
        position: relative;
        background-color: var(--bg-card, #2d2d2d);
        border-radius: 12px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color, #444444);
    }
    
    .ergon__modal-content--large {
        max-width: 700px;
    }
    
    .ergon__modal-title {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
        color: #00BCD4;
    }
    
    .ergon__modal-description {
        margin: 0 0 1.5rem 0;
        color: var(--text-secondary, #aaa);
        line-height: 1.5;
    }
    
    .ergon__modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 2rem;
    }
    
    .ergon__button {
        padding: 8px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .ergon__button--cancel {
        background-color: var(--bg-tertiary, #333345);
        color: var(--text-primary, #f0f0f0);
    }
    
    .ergon__button--cancel:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .ergon__button--submit {
        background-color: #00BCD4;
        color: #1e1e2e;
    }
    
    .ergon__button--submit:hover {
        background-color: #00ACC1;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 188, 212, 0.3);
    }
    
    /* Loading and empty states */
    .ergon__loading-message,
    .ergon__empty-message,
    .ergon__error-message {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary, #aaa);
        font-style: italic;
    }
    
    .ergon__error-message {
        color: var(--color-danger, #dc3545);
    }
    
    /* Development Tab Styles */
    .ergon__dev-controls {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        margin-top: 1rem;
    }
    
    .ergon__subsection-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 500;
    }
    
    .ergon__sprints-container {
        padding: 1.5rem;
    }
    
    .ergon__sprints-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .ergon__sprint-filters {
        display: flex;
        gap: 12px;
    }
    
    .ergon__sprints-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
        gap: 1.5rem;
    }
    
    /* Sprint Card Styles - Similar to Tekton Core */
    .ergon__sprint-card {
        background-color: var(--bg-card, #2d2d2d);
        border: 2px solid #00BCD4;  /* Ergon blue */
        border-radius: 8px;
        padding: 1.5rem;
        min-height: 180px;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
    }
    
    .ergon__sprint-card:hover {
        box-shadow: 0 4px 12px rgba(0, 188, 212, 0.2);
        transform: translateY(-2px);
    }
    
    .ergon__sprint-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }
    
    .ergon__sprint-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #00BCD4;
    }
    
    .ergon__sprint-status {
        padding: 4px 12px;
        background-color: rgba(0, 188, 212, 0.2);
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 500;
        display: inline-block;
        margin-bottom: 0.75rem;
    }
    
    .ergon__sprint-meta {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-secondary, #aaa);
        margin-bottom: 1rem;
    }
    
    .ergon__sprint-details {
        font-size: 0.85rem;
        color: var(--text-secondary, #aaa);
    }
    
    .ergon__sprint-autonomy {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0;
    }
    
    .ergon__autonomy-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .ergon__autonomy-select {
        padding: 4px 8px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
        font-size: 0.85rem;
    }
    
    .ergon__sprint-actions {
        display: flex;
        gap: 8px;
        margin-top: auto;
        padding-top: 1rem;
    }
    
    .ergon__sprint-button {
        flex: 1;
        padding: 6px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }
    
    .ergon__sprint-button:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .ergon__sprint-button--view {
        background-color: #4CAF50;
        color: white;
    }
    
    .ergon__sprint-button--view:hover {
        background-color: #45a049;
    }
    
    .ergon__sprint-button--primary {
        background-color: #00BCD4;
        border-color: #00BCD4;
        color: #1e1e2e;
        font-weight: 500;
    }
    
    .ergon__sprint-button--primary:hover {
        background-color: #00ACC1;
    }
    
    .ergon__input-group {
        margin-bottom: 1rem;
    }
    
    /* Results Styles */
    .ergon__results-section {
        background-color: var(--bg-secondary, #252535);
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .ergon__results-section h4 {
        margin: 0 0 1rem 0;
        color: #00BCD4;
    }
    
    .ergon__results-description {
        margin-bottom: 1rem;
        color: var(--text-secondary, #aaa);
        line-height: 1.6;
    }
    
    .ergon__results-details {
        font-size: 0.95rem;
        line-height: 1.8;
    }
    
    .ergon__results-details strong {
        color: var(--text-primary, #f0f0f0);
    }
    
    /* Sandbox Styles */
    .ergon__sandbox-container {
        margin-top: 20px;
    }
    
    .ergon__sandbox-panel {
        background: var(--bg-secondary, #2a2a2a);
        border: 1px solid var(--border-color, #404040);
        border-radius: 8px;
        margin-bottom: 15px;
        overflow: hidden;
    }
    
    .ergon__sandbox-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: var(--bg-primary, #1e1e1e);
        border-bottom: 1px solid var(--border-color, #404040);
    }
    
    .ergon__sandbox-header h4 {
        margin: 0;
        color: var(--text-primary, #f0f0f0);
        font-size: 14px;
    }
    
    .ergon__sandbox-actions {
        display: flex;
        gap: 8px;
    }
    
    .ergon__sandbox-status {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 10px 15px;
        background: var(--bg-tertiary, #252525);
        border-bottom: 1px solid var(--border-color, #404040);
        font-size: 12px;
    }
    
    .ergon__status-label {
        color: var(--text-secondary, #888);
    }
    
    .ergon__status-value {
        color: var(--text-primary, #f0f0f0);
        font-weight: 500;
    }
    
    .ergon__status-running { color: #4a9eff; }
    .ergon__status-completed { color: #4caf50; }
    .ergon__status-failed { color: #f44336; }
    .ergon__status-timeout { color: #ff9800; }
    
    .ergon__sandbox-id {
        color: var(--text-secondary, #888);
        font-family: monospace;
        margin-left: auto;
    }
    
    .ergon__sandbox-output {
        background: #1a1a1a;
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 12px;
        line-height: 1.4;
    }
    
    .ergon__output-line {
        margin: 2px 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .ergon__output-stdout { color: #d4d4d4; }
    .ergon__output-stderr { color: #ffab91; }
    .ergon__output-error { color: #f44336; }
    .ergon__output-info { color: #4a9eff; font-style: italic; }
    
    .ergon__sandbox-results {
        padding: 15px;
        background: var(--bg-tertiary, #252525);
        border-top: 1px solid var(--border-color, #404040);
    }
    
    .ergon__sandbox-results h5 {
        margin: 0 0 10px 0;
        color: var(--text-primary, #f0f0f0);
        font-size: 13px;
    }
    
    .ergon__result-item {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
        font-size: 12px;
    }
    
    .ergon__result-item span:first-child {
        color: var(--text-secondary, #888);
    }
    
    .ergon__result-item span:last-child {
        color: var(--text-primary, #f0f0f0);
        font-family: monospace;
    }
    
    .ergon__result-errors ul {
        margin: 5px 0;
        padding-left: 20px;
        color: #f44336;
    }
    
    .ergon__button--stop {
        background: #f44336;
    }
    
    .ergon__button--stop:hover {
        background: #d32f2f;
    }
    
    .ergon__button--running {
        background: #4a9eff;
        animation: pulse 1.5s infinite;
    }
    
    .ergon__button--success {
        background: #4caf50;
    }
    
    .ergon__button--failed {
        background: #f44336;
    }
    
    .ergon__button--error {
        background: #ff5722;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    
    /* Notifications */
    .ergon__notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 4px;
        color: white;
        font-size: 14px;
        z-index: 10000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
    }
    
    .ergon__notification--show {
        transform: translateX(0);
    }
    
    .ergon__notification--info { background: #2196f3; }
    .ergon__notification--success { background: #4caf50; }
    .ergon__notification--error { background: #f44336; }
    
    /* Modal styles */
    .ergon__modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .ergon__modal-content {
        background: var(--bg-primary, #1e1e1e);
        border-radius: 8px;
        max-width: 800px;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .ergon__modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color, #404040);
    }
    
    .ergon__modal-close {
        background: none;
        border: none;
        color: var(--text-secondary, #888);
        font-size: 24px;
        cursor: pointer;
    }
    
    .ergon__modal-body {
        padding: 20px;
        overflow-y: auto;
    }
    
    .ergon__detail-section {
        margin-bottom: 20px;
    }
    
    .ergon__detail-section h4 {
        margin: 0 0 10px 0;
        color: var(--text-primary, #f0f0f0);
    }
    
    .ergon__detail-section dl {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 8px;
        margin: 0;
    }
    
    .ergon__detail-section dt {
        color: var(--text-secondary, #888);
    }
    
    .ergon__detail-section dd {
        color: var(--text-primary, #f0f0f0);
        margin: 0;
        font-family: monospace;
    }
    
    .ergon__code-block {
        background: #1a1a1a;
        border: 1px solid var(--border-color, #404040);
        border-radius: 4px;
        padding: 15px;
        overflow-x: auto;
        font-family: monospace;
        font-size: 12px;
        color: #d4d4d4;
    }
    
    /* Construct Panel Styles */
    .ergon__construct-layout {
        display: flex;
        gap: 20px;
        padding: 10px 20px; /* Reduced top/bottom padding */
        height: calc(100% - 150px); /* Adjusted height */
    }
    
    .ergon__construct-dialog {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .ergon__construct-workspace {
        flex: 1;
        border: 1px solid var(--border-color, #404040);
        border-radius: 8px;
        background: var(--bg-secondary, #252535);
        padding: 15px;
        overflow-y: auto;
    }
    
    .ergon__question-list {
        flex: 1;
        overflow-y: auto;
        border: 1px solid var(--border-color, #404040);
        border-radius: 8px;
        padding: 15px;
        background: var(--bg-secondary, #252535);
    }
    
    .construct-dialog__question-item {
        display: flex;
        gap: 10px;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 6px;
        transition: all 0.3s ease;
    }
    
    .construct-dialog__question-item--answered {
        background: rgba(76, 175, 80, 0.1);
        border-left: 3px solid #4caf50;
    }
    
    .construct-dialog__question-item--current {
        background: rgba(0, 188, 212, 0.2);
        border-left: 3px solid #00bcd4;
        box-shadow: 0 2px 8px rgba(0, 188, 212, 0.3);
    }
    
    .construct-dialog__question-item--pending {
        opacity: 0.5;
        background: var(--bg-primary, #1e1e1e);
    }
    
    .construct-dialog__question-number {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: var(--border-color, #404040);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        flex-shrink: 0;
    }
    
    .construct-dialog__response {
        margin-top: 5px;
        padding: 5px 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
        font-style: italic;
        font-size: 0.9em;
    }
    
    .ergon__current-question {
        padding: 20px;
        background: rgba(0, 188, 212, 0.05);
        border: 2px solid #00bcd4;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    .ergon__current-question h4 {
        margin: 0 0 10px 0;
        color: #00bcd4;
    }
    
    .construct-dialog__hint {
        color: var(--text-secondary, #888);
        font-size: 0.9em;
        font-style: italic;
    }
    
    .ergon__dialog-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        padding: 15px;
        /* Removed border-top for cleaner look */
    }
    
    .ergon__workspace-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color, #404040);
    }
    
    .ergon__workspace-header h4 {
        margin: 0;
        color: var(--text-primary, #f0f0f0);
    }
    
    .ergon__workspace-status {
        font-size: 0.9em;
        padding: 4px 10px;
        border-radius: 4px;
        background: var(--bg-primary, #1e1e1e);
        color: var(--text-secondary, #888);
    }
    
    .ergon__json-display {
        background: #1a1a1a;
        border: 1px solid var(--border-color, #404040);
        border-radius: 4px;
        padding: 15px;
        overflow: auto;
        font-family: monospace;
        font-size: 12px;
        color: #d4d4d4;
        max-height: 400px;
    }
    
    .ergon__separator {
        height: 1px;
        background: var(--border-color, #404040);
        margin: 20px 0;
    }
    
    .ergon__construct-actions {
        /* Container for the separator and buttons */
        margin-top: 10px;
    }
    
    .construct-dialog__actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        padding: 20px;
    }
    
    /* Colorful action buttons */
    .ergon__button--validate {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    
    .ergon__button--test {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border: none;
    }
    
    .ergon__button--publish {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border: none;
    }
    
    .ergon__button--revise {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
        border: none;
    }
    
    .ergon__button--validate:hover,
    .ergon__button--test:hover,
    .ergon__button--publish:hover,
    .ergon__button--revise:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .construct-dialog__build-ready {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(0, 188, 212, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(0, 188, 212, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(0, 188, 212, 0);
        }
    }
</style>

<script src="/scripts/env.js"></script>
<script src="/scripts/tekton-urls.js"></script>
<script src="/scripts/shared/ai-chat.js"></script>
<script src="/scripts/ergon-service.js"></script>
<script type="text/javascript">
// Initialize chat components
function ergon_initChats() {
    const toolChatEl = document.getElementById('ergon-messages');
    const teamChatEl = document.getElementById('awt-team-messages');
    
    if (window.SingleChat && toolChatEl) {
        window.SingleChat.init(toolChatEl, 'ergon', 'chat-message');
        console.log('[Ergon] SingleChat initialized');
    }
    
    if (window.TeamChat && teamChatEl) {
        window.TeamChat.init(teamChatEl, 'ergon', 'chat-message');
        console.log('[Ergon] TeamChat initialized');
    }
    
    // Update main component AI ready state
    const ergonComponent = document.querySelector('[data-tekton-component="ergon"]');
    if (ergonComponent) {
        ergonComponent.setAttribute('data-tekton-ai-ready', 'true');
    }
}

// Chat function already defined at top of file for inline handlers

// Load autonomy level
function ergon_loadAutonomyLevel() {
    const apiUrl = window.ergonUrl ? window.ergonUrl('/api/v1/autonomy/level') : '/api/v1/autonomy/level';
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            const levelElement = document.getElementById('autonomy-level');
            if (levelElement && data.current_level) {
                levelElement.textContent = data.current_level.charAt(0).toUpperCase() + data.current_level.slice(1);
            }
        })
        .catch(err => {
            console.error('[ERGON] Failed to load autonomy level:', err);
        });
}

// Load solutions for registry
window.ergon_loadSolutions = function ergon_loadSolutions() {
    console.log('[ERGON] Loading solutions');
    const grid = document.getElementById('solution-grid');
    
    if (!grid) {
        console.error('[ERGON] Solution grid element not found!');
        return;
    }
    
    const apiUrl = window.ergonUrl ? window.ergonUrl('/api/v1/solutions') : '/api/v1/solutions';
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            grid.innerHTML = '';
            // Update grid state
            grid.setAttribute('data-tekton-state', 'loading');
            
            if (data.status === 'not_implemented' || data.detail === 'Not Found') {
                // Show the solutions we created
                const solutions = [
                    {
                        name: "Codebase Indexer",
                        type: "analysis",
                        description: "Comprehensive codebase analysis that indexes all methods, calls, data structures, and semantic tags",
                        usage_count: 0,
                        success_rate: 0.95
                    },
                    {
                        name: "RAG Engine",
                        type: "intelligence",
                        description: "Retrieval-Augmented Generation for intelligent code understanding and generation",
                        usage_count: 0,
                        success_rate: 0.95
                    },
                    {
                        name: "Cache RAG",
                        type: "intelligence", 
                        description: "Intelligent caching layer for RAG with pattern learning and precomputation",
                        usage_count: 0,
                        success_rate: 0.95
                    },
                    {
                        name: "Companion Intelligence",
                        type: "intelligence",
                        description: "Binds a CI with a codebase for deep understanding and intelligent development assistance",
                        usage_count: 0,
                        success_rate: 0.95
                    }
                ];
                
                data.solutions = solutions;
            }
            
            if (!data.solutions || data.solutions.length === 0) {
                grid.innerHTML = '<div class="ergon__empty-message" data-tekton-type="empty-state" data-tekton-state="empty">No solutions found in database.</div>';
                grid.setAttribute('data-tekton-state', 'empty');
                return;
            }
            
            // Render solution cards
            data.solutions.forEach(solution => {
                const card = document.createElement('div');
                card.className = 'ergon__solution-card';
                card.setAttribute('data-tekton-component', 'solution-card');
                card.setAttribute('data-tekton-type', 'card');
                card.setAttribute('data-tekton-solution-type', solution.type);
                card.setAttribute('data-tekton-solution-name', solution.name);
                card.innerHTML = `
                    <div class="ergon__solution-header" data-tekton-zone="card-header">
                        <div class="ergon__solution-name" data-tekton-type="solution-name">${solution.name}</div>
                        <div class="ergon__solution-type" data-tekton-type="solution-type" data-tekton-status="${solution.type}">${solution.type}</div>
                    </div>
                    <div class="ergon__solution-description" data-tekton-type="description">${solution.description || 'No description'}</div>
                    <div class="ergon__solution-meta" data-tekton-zone="card-meta">
                        <div class="ergon__solution-stat" data-tekton-type="stat" data-tekton-stat-type="usage">
                            <span>Used:</span>
                            <strong data-tekton-value="usage-count">${solution.usage_count || 0}</strong>
                        </div>
                        <div class="ergon__solution-stat" data-tekton-type="stat" data-tekton-stat-type="success">
                            <span>Success:</span>
                            <strong data-tekton-value="success-rate">${solution.success_rate ? (solution.success_rate * 100).toFixed(0) + '%' : 'N/A'}</strong>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            // Update grid state to loaded
            grid.setAttribute('data-tekton-state', 'loaded');
        })
        .catch(err => {
            console.error('[ERGON] Failed to load solutions:', err);
            
            // Show hardcoded solutions even on error
            const solutions = [
                {
                    name: "Codebase Indexer",
                    type: "analysis",
                    description: "Comprehensive codebase analysis that indexes all methods, calls, data structures, and semantic tags",
                    usage_count: 0,
                    success_rate: 0.95
                },
                {
                    name: "RAG Engine",
                    type: "intelligence",
                    description: "Retrieval-Augmented Generation for intelligent code understanding and generation",
                    usage_count: 0,
                    success_rate: 0.95
                },
                {
                    name: "Cache RAG",
                    type: "intelligence", 
                    description: "Intelligent caching layer for RAG with pattern learning and precomputation",
                    usage_count: 0,
                    success_rate: 0.95
                },
                {
                    name: "Companion Intelligence",
                    type: "intelligence",
                    description: "Binds a CI with a codebase for deep understanding and intelligent development assistance",
                    usage_count: 0,
                    success_rate: 0.95
                }
            ];
            
            grid.innerHTML = '';
            // Update grid state
            grid.setAttribute('data-tekton-state', 'loading');
            
            // Render solution cards
            solutions.forEach(solution => {
                const card = document.createElement('div');
                card.className = 'ergon__solution-card';
                card.setAttribute('data-tekton-component', 'solution-card');
                card.setAttribute('data-tekton-type', 'card');
                card.setAttribute('data-tekton-solution-type', solution.type);
                card.setAttribute('data-tekton-solution-name', solution.name);
                card.innerHTML = `
                    <div class="ergon__solution-header" data-tekton-zone="card-header">
                        <div class="ergon__solution-name" data-tekton-type="solution-name">${solution.name}</div>
                        <div class="ergon__solution-type" data-tekton-type="solution-type" data-tekton-status="${solution.type}">${solution.type}</div>
                    </div>
                    <div class="ergon__solution-description" data-tekton-type="description">${solution.description || 'No description'}</div>
                    <div class="ergon__solution-meta" data-tekton-zone="card-meta">
                        <div class="ergon__solution-stat" data-tekton-type="stat" data-tekton-stat-type="usage">
                            <span>Used:</span>
                            <strong data-tekton-value="usage-count">${solution.usage_count || 0}</strong>
                        </div>
                        <div class="ergon__solution-stat" data-tekton-type="stat" data-tekton-stat-type="success">
                            <span>Success:</span>
                            <strong data-tekton-value="success-rate">${solution.success_rate ? (solution.success_rate * 100).toFixed(0) + '%' : 'N/A'}</strong>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            // Update grid state to loaded
            grid.setAttribute('data-tekton-state', 'loaded');
        });
}

// Load Ergon-managed sprints
async function ergon_loadSprints() {
    const grid = document.getElementById('sprints-grid');
    
    if (!grid) {
        console.error('[ERGON] Sprint grid element not found');
        return;
    }
    
    grid.innerHTML = '<div class="ergon__loading-message"><div class="ergon__message-text">Loading automated sprints...</div></div>';
    
    try {
        // Fetch all sprints from Tekton Core
        const url = window.tektonUrl ? window.tektonUrl('tekton-core', '/api/v1/sprints/status') : '/api/v1/sprints/status';
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`Failed to fetch sprints: ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        const data = result.data || {};
        const allSprints = data.sprints || [];
        
        // Filter for automated sprints only
        const automatedSprints = [];
        
        // Log sprint count for debugging
        console.log(`[ERGON] Checking ${allSprints.length} sprints for automation...`);
        
        // Check each sprint's Sprint Plan for Automated: Yes
        for (const sprint of allSprints) {
            try {
                const encodedName = encodeURIComponent(sprint.name);
                const planUrl = window.tektonUrl ? window.tektonUrl('tekton-core', `/api/v1/sprints/${encodedName}/sprint-plan`) : `/api/v1/sprints/${encodedName}/sprint-plan`;
                console.log(`[ERGON] Checking sprint plan at: ${planUrl}`);
                
                const planResponse = await fetch(planUrl);
                
                if (planResponse.ok) {
                    const planData = await planResponse.json();
                    const content = planData.content || '';
                    
                    // Check if this sprint is automated (case insensitive)
                    const automatedMatch = content.match(/Automated:\s*(Yes)/i);
                    if (automatedMatch) {
                        console.log(`[ERGON] Found automated sprint: ${sprint.name}`);
                        // Parse autonomy level (case insensitive)
                        const autonomyMatch = content.match(/Autonomy Level:\s*([^\n]+)/i);
                        sprint.autonomyLevel = autonomyMatch ? autonomyMatch[1].trim() : 'Co-Developer';
                        sprint.automated = 'Yes';
                        automatedSprints.push(sprint);
                    } else {
                        console.log(`[ERGON] Sprint ${sprint.name} is not automated`);
                    }
                } else {
                    console.error(`[ERGON] Failed to get sprint plan for ${sprint.name}: ${planResponse.status}`);
                }
            } catch (err) {
                console.error(`[ERGON] Failed to check automation for sprint ${sprint.name}:`, err);
            }
        }
        
        console.log(`[ERGON] Found ${automatedSprints.length} automated sprints`);
        
        
        grid.innerHTML = '';
        // Update grid state
        grid.setAttribute('data-tekton-state', 'loading');
        
        if (automatedSprints.length === 0) {
            grid.innerHTML = `
                <div class="ergon__empty-message" data-tekton-type="empty-state" data-tekton-state="empty">
                    <div class="ergon__message-text" data-tekton-type="empty-text">No Ergon-managed sprints yet. Use the "Automate" button on any sprint in Tekton Core to enable automation.</div>
                </div>
            `;
            grid.setAttribute('data-tekton-state', 'empty');
            return;
        }
        
        // Create sprint cards for automated sprints
        automatedSprints.forEach(sprint => {
            const card = ergon_createSprintCard(sprint);
            grid.appendChild(card);
        });
        // Update grid state to loaded
        grid.setAttribute('data-tekton-state', 'loaded');
        
    } catch (error) {
        console.error('[ERGON] Failed to load sprints:', error);
        grid.innerHTML = '<div class="ergon__error-message" data-tekton-type="error-state" data-tekton-status="error">Failed to load sprints. Please check connection.</div>';
        grid.setAttribute('data-tekton-state', 'error');
    }
}

// Create a sprint card for Ergon
function ergon_createSprintCard(sprint) {
    const card = document.createElement('div');
    card.className = 'ergon__sprint-card';
    card.setAttribute('data-tekton-component', 'sprint-card');
    card.setAttribute('data-tekton-type', 'card');
    card.setAttribute('data-tekton-sprint-name', sprint.name);
    card.setAttribute('data-tekton-sprint-status', sprint.status);
    card.setAttribute('data-tekton-ai', 'automated-sprint');
    
    const statusClass = sprint.status.toLowerCase().replace(/ /g, '-');
    
    // Show only Autonomous or Co-Developer
    const displayAutonomy = (sprint.autonomyLevel === 'Autonomous' || sprint.autonomyLevel === 'Co-Developer') 
        ? sprint.autonomyLevel 
        : 'Co-Developer';  // Default to Co-Developer
    
    card.innerHTML = `
        <div class="ergon__sprint-header" data-tekton-zone="card-header">
            <h4 class="ergon__sprint-name" data-tekton-type="sprint-name">${sprint.name}</h4>
        </div>
        <span class="ergon__sprint-status ergon__sprint-status--${statusClass}" data-tekton-status="${sprint.status}" data-tekton-type="status-badge">${sprint.status}</span>
        
        <div class="ergon__sprint-meta" data-tekton-zone="card-meta">
            <div data-tekton-type="meta-info"><strong>Coder:</strong> ${sprint.assigned_coder ? `Coder-${sprint.assigned_coder}` : 'Unassigned'} &nbsp;&nbsp; <strong>Tasks:</strong> ${sprint.task_count || 0} &nbsp;&nbsp; Updated: ${sprint.last_updated ? new Date(sprint.last_updated).toLocaleDateString() : 'Unknown'}</div>
            <div data-tekton-type="automation-info" data-tekton-ai="autonomy-level" data-tekton-ai-level="${displayAutonomy}"><strong>Automated:</strong> ${displayAutonomy}</div>
        </div>
        
        <div class="ergon__sprint-details" style="margin-top: 0.5rem;" data-tekton-zone="card-details">
            <div style="font-size: 0.9rem;" data-tekton-type="branch-info"><strong>Branch:</strong> ${sprint.branch_name || 'No branch'}</div>
        </div>
        
        <div class="ergon__sprint-actions" data-tekton-zone="card-actions" data-tekton-type="action-container">
            <button class="ergon__sprint-button ergon__sprint-button--view" onclick="ergon_viewSprintDetails('${sprint.name}')" data-tekton-action="view-details" data-tekton-action-type="secondary" data-tekton-trigger="click" data-tekton-nav-action="switch-component" data-tekton-nav-target="tekton">View in Tekton</button>
            <button class="ergon__sprint-button ergon__sprint-button--primary" onclick="ergon_manageSprint('${sprint.name}', '${displayAutonomy}')" data-tekton-action="manage-sprint" data-tekton-action-type="primary" data-tekton-trigger="click" data-tekton-ai="manage-sprint" data-tekton-target="chat">Manage Sprint</button>
        </div>
    `;
    
    return card;
}

// Update autonomy level for a sprint
async function ergon_updateAutonomy(sprintName, newLevel) {
    console.log(`[ERGON] Updating autonomy level for ${sprintName} to ${newLevel}`);
    
    try {
        // Fetch current sprint plan
        const encodedName = encodeURIComponent(sprintName);
        const response = await fetch(window.tektonUrl ? window.tektonUrl('tekton-core', `/api/v1/sprints/${encodedName}/sprint-plan`) : `/api/v1/sprints/${encodedName}/sprint-plan`);
        
        if (!response.ok) {
            throw new Error(`Failed to fetch sprint plan: ${response.statusText}`);
        }
        
        const data = await response.json();
        let content = data.content || '';
        
        // Update autonomy level
        if (content.match(/Autonomy Level:\s*[^\n]+/i)) {
            content = content.replace(/Autonomy Level:\s*[^\n]+/i, `Autonomy Level: ${newLevel}`);
        }
        
        // Save updated sprint plan
        const saveResponse = await fetch(window.tektonUrl ? window.tektonUrl('tekton-core', `/api/v1/sprints/${encodedName}/sprint-plan`) : `/api/v1/sprints/${encodedName}/sprint-plan`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content })
        });
        
        if (!saveResponse.ok) {
            throw new Error(`Failed to save sprint plan: ${saveResponse.statusText}`);
        }
        
        console.log(`[ERGON] Autonomy level updated successfully`);
        
    } catch (error) {
        console.error('[ERGON] Failed to update autonomy:', error);
        TektonModal.error(`Failed to update autonomy level: ${error.message}`);
        // Reload to restore original value
        ergon_loadSprints();
    }
}

// View sprint details
function ergon_viewSprintDetails(sprintName) {
    console.log(`[ERGON] Viewing details for sprint ${sprintName}`);
    // Switch to Tekton Core component
    if (window.tektonUI && window.tektonUI.switchComponent) {
        window.tektonUI.switchComponent('tekton');
        // After switching, go to sprints tab and load sprint cards
        setTimeout(() => {
            const sprintsTab = document.getElementById('tekton-tab-sprints');
            if (sprintsTab) {
                sprintsTab.checked = true;
                // Trigger sprint card loading
                if (window.loadAllSprints) {
                    window.loadAllSprints();
                }
            }
        }, 100);
    }
}

// Manage sprint - open chat with Ergon CI for guidance
function ergon_manageSprint(sprintName, autonomyLevel) {
    console.log(`[ERGON] Managing sprint ${sprintName} with ${autonomyLevel} autonomy`);
    
    // Switch to Tool Chat tab
    const chatTab = document.getElementById('ergon-tab-chat');
    if (chatTab) {
        chatTab.checked = true;
        
        // Wait for tab transition
        setTimeout(() => {
            // Send initial message to chat about sprint management
            const input = document.getElementById('ergon-chat-input');
            const context = autonomyLevel === 'Autonomous' 
                ? `I'm managing the "${sprintName}" sprint in Autonomous mode. I'll proceed with development based on the sprint plan, but I'll ask for your input if I encounter any issues or repeated problems.`
                : `I'm managing the "${sprintName}" sprint in Co-Developer mode. I'll work with you to review and approve decisions throughout the development process. What aspects would you like to focus on first?`;
            
            if (input) {
                input.value = `Managing Sprint: ${sprintName}\n\n${context}`;
                // Trigger send
                const sendButton = document.getElementById('ergon-send-button');
                if (sendButton) {
                    sendButton.click();
                }
            }
        }, 100);
    }
}

// Create Tekton project - redirect with URL or local path
function ergon_createTektonProject() {
    const urlInput = document.getElementById('repo-url');
    const pathInput = document.getElementById('local-path');
    const repoUrl = urlInput.value.trim();
    const localPath = pathInput.value.trim();
    
    // Store the values in session storage
    if (repoUrl) {
        sessionStorage.setItem('ergon_github_url', repoUrl);
    }
    if (localPath) {
        sessionStorage.setItem('ergon_local_path', localPath);
    }
    
    // Switch to Tekton component, New Project tab
    console.log('[ERGON] Switching to Tekton Core with:', { repoUrl, localPath });
    
    // Switch to Tekton component
    if (window.tektonUI && window.tektonUI.switchComponent) {
        window.tektonUI.switchComponent('tekton');
    } else {
        // Fallback: manually switch
        const tektonButton = document.querySelector('[data-component="tekton"]');
        if (tektonButton) {
            tektonButton.click();
        }
    }
    
    // After switching, populate the fields
    setTimeout(() => {
        // Switch to new project tab
        const newProjectTab = document.getElementById('tekton-tab-new-project');
        if (newProjectTab) {
            newProjectTab.checked = true;
            // Trigger tab change
            const event = new Event('change');
            newProjectTab.dispatchEvent(event);
        }
        
        // Populate fields after another delay
        setTimeout(() => {
            if (repoUrl) {
                const githubUrlField = document.getElementById('github-url');
                if (githubUrlField) {
                    githubUrlField.value = repoUrl;
                    // Only prepare if we have GitHub URL
                    if (window.prepareNewProject) {
                        window.prepareNewProject();
                    }
                }
            } else if (localPath) {
                const localDirField = document.getElementById('local-directory');
                if (localDirField) {
                    localDirField.value = localPath;
                }
            }
        }, 300);
    }, 200);
}


// Show automate modal
function ergon_showAutomateModal() {
    document.getElementById('automate-modal').style.display = 'flex';
}

// Close automate modal
function ergon_closeAutomateModal() {
    document.getElementById('automate-modal').style.display = 'none';
    // Clear form
    document.getElementById('project-description').value = '';
    document.getElementById('autonomy-override').value = '';
    document.getElementById('sprint-name').value = '';
}

// Start automation - The ultimate feature!
function ergon_startAutomation() {
    const description = document.getElementById('project-description').value.trim();
    const autonomyLevel = document.getElementById('autonomy-override').value;
    const sprintName = document.getElementById('sprint-name').value.trim();
    
    if (!description) {
        TektonModal.warning('Please describe what you want to build');
        return;
    }
    
    const apiUrl = window.ergonUrl ? window.ergonUrl('/api/v1/automate') : '/api/v1/automate';
    
    // Close modal
    ergon_closeAutomateModal();
    
    // Switch to Tool Chat tab to show progress
    document.getElementById('ergon-tab-chat').checked = true;
    
    // Add user message to chat
    const messagesContainer = document.getElementById('ergon-messages');
    const userMessageDiv = document.createElement('div');
    userMessageDiv.className = 'ergon__message ergon__message--user';
    userMessageDiv.setAttribute('data-tekton-chat', 'message');
    userMessageDiv.setAttribute('data-tekton-message-type', 'user');
    userMessageDiv.setAttribute('data-tekton-type', 'chat-message');
    userMessageDiv.innerHTML = `<div class="ergon__message-content" data-tekton-zone="message-content"><div class="ergon__message-text" data-tekton-type="message-text">Automate: ${description}</div></div>`;
    messagesContainer.appendChild(userMessageDiv);
    
    // Add thinking message
    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = 'ergon__message ergon__message--ai';
    thinkingDiv.setAttribute('data-tekton-chat', 'message');
    thinkingDiv.setAttribute('data-tekton-message-type', 'ai');
    thinkingDiv.setAttribute('data-tekton-type', 'chat-message');
    thinkingDiv.setAttribute('data-tekton-ai', 'thinking');
    thinkingDiv.setAttribute('data-tekton-state', 'processing');
    thinkingDiv.innerHTML = `<div class="ergon__message-content" data-tekton-zone="message-content"><div class="ergon__message-text" data-tekton-type="message-text"><strong>Ergon:</strong> Starting automated development process...</div></div>`;
    messagesContainer.appendChild(thinkingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Make the API call
    fetch(apiUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            project_description: description,
            autonomy_level: autonomyLevel || null,
            sprint_name: sprintName || null
        })
    })
    .then(response => response.json())
    .then(data => {
        const responseDiv = document.createElement('div');
        responseDiv.className = 'ergon__message ergon__message--ai';
        responseDiv.setAttribute('data-tekton-chat', 'message');
        responseDiv.setAttribute('data-tekton-message-type', 'ai');
        responseDiv.setAttribute('data-tekton-type', 'chat-message');
        responseDiv.setAttribute('data-tekton-ai', 'response');
        responseDiv.setAttribute('data-tekton-state', 'complete');
        
        if (data.status === 'not_implemented') {
            responseDiv.innerHTML = `<div class="ergon__message-content" data-tekton-zone="message-content"><div class="ergon__message-text" data-tekton-type="message-text"><strong>Ergon:</strong> The automation workflow is coming in Phase 3. This will enable me to orchestrate entire development projects with configurable autonomy levels.</div></div>`;
        } else {
            responseDiv.innerHTML = `<div class="ergon__message-content" data-tekton-zone="message-content"><div class="ergon__message-text" data-tekton-type="message-text"><strong>Ergon:</strong> ${data.message || 'Automation started successfully!'}</div></div>`;
        }
        
        messagesContainer.appendChild(responseDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    })
    .catch(err => {
        console.error('[ERGON] Failed to start automation:', err);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'ergon__message ergon__message--system';
        errorDiv.setAttribute('data-tekton-chat', 'message');
        errorDiv.setAttribute('data-tekton-message-type', 'system');
        errorDiv.setAttribute('data-tekton-type', 'chat-message');
        errorDiv.setAttribute('data-tekton-status', 'error');
        errorDiv.innerHTML = `<div class="ergon__message-content" data-tekton-zone="message-content"><div class="ergon__message-text" data-tekton-type="message-text"><strong>System:</strong> Failed to start automation. Please try again.</div></div>`;
        messagesContainer.appendChild(errorDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
}

// Initialize on DOM ready
window.addEventListener('DOMContentLoaded', function() {
    console.log('[ERGON] DOM Content Loaded - initializing...');
    
    // Initialize chat components
    setTimeout(() => {
        ergon_initChats();
    }, 100);
    
    // Load initial data
    console.log('[ERGON] Loading initial data...');
    ergon_loadAutonomyLevel();
    ergon_loadSprints();  // Load sprints for default Development tab
    
    // Add event listeners
    const automateButton = document.getElementById('automate-button');
    if (automateButton) {
        automateButton.addEventListener('click', ergon_showAutomateModal);
    }
    
    // Tab change listeners
    const radioButtons = document.querySelectorAll('input[name="ergon-tab"]');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                const tabId = this.id.replace('ergon-tab-', '');
                console.log('[ERGON] Tab changed to:', tabId);
                
                // Update panel states
                document.querySelectorAll('.ergon__panel').forEach(panel => {
                    panel.setAttribute('data-tekton-state', 'inactive');
                    panel.setAttribute('data-tekton-visibility', 'hidden');
                });
                
                // Activate the selected panel
                const activePanel = document.getElementById(tabId === 'chat' ? 'ergon-panel' : 
                                                         tabId === 'teamchat' ? 'awt-team-panel' : 
                                                         `${tabId}-panel`);
                if (activePanel) {
                    activePanel.setAttribute('data-tekton-state', 'active');
                    activePanel.setAttribute('data-tekton-visibility', 'visible');
                }
                
                // Reload data for specific tabs
                if (tabId === 'development') {
                    ergon_loadSprints();
                } else if (tabId === 'registry') {
                    console.log('[ERGON] Loading solutions from tab change');
                    ergon_loadSolutions();
                } else if (tabId === 'configurator') {
                    console.log('[ERGON] Loading configurator solutions from tab change');
                    ergon_loadConfiguratorSolutions();
                }
            }
        });
    });
});

// IMMEDIATE PROTECTION
// In case the DOM is already loaded
if (document.readyState === 'complete' || document.readyState === 'interactive') {
    console.log('[ERGON] Document already loaded, setting up Ergon component immediately');
    
    // Set up tab switching listeners
    const radioButtons = document.querySelectorAll('input[name="ergon-tab"]');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                const tabId = this.id.replace('ergon-tab-', '');
                console.log('[ERGON] Tab changed to:', tabId);
                
                // Update panel states
                document.querySelectorAll('.ergon__panel').forEach(panel => {
                    panel.setAttribute('data-tekton-state', 'inactive');
                    panel.setAttribute('data-tekton-visibility', 'hidden');
                });
                
                // Activate the selected panel
                const activePanel = document.getElementById(tabId === 'chat' ? 'ergon-panel' : 
                                                         tabId === 'teamchat' ? 'awt-team-panel' : 
                                                         `${tabId}-panel`);
                if (activePanel) {
                    activePanel.setAttribute('data-tekton-state', 'active');
                    activePanel.setAttribute('data-tekton-visibility', 'visible');
                }
                
                // Load data for specific tabs
                if (tabId === 'development') {
                    ergon_loadSprints();
                } else if (tabId === 'registry') {
                    console.log('[ERGON] Loading solutions from tab change');
                    ergon_loadSolutions();
                } else if (tabId === 'configurator') {
                    console.log('[ERGON] Loading configurator solutions from tab change');
                    ergon_loadConfiguratorSolutions();
                }
            }
        });
    });
    
    // Load initial data
    ergon_loadAutonomyLevel();
    ergon_loadSprints();
}

// Load solutions into configurator dropdown
window.ergon_loadConfiguratorSolutions = function() {
    console.log('[ERGON] Loading solutions for configurator');
    const select = document.getElementById('config-solution');
    
    if (!select) {
        console.error('[ERGON] Config solution select element not found!');
        return;
    }
    
    // Clear existing options except the first one
    while (select.options.length > 1) {
        select.remove(1);
    }
    
    const apiUrl = window.ergonUrl ? window.ergonUrl('/api/v1/solutions') : '/api/v1/solutions';
    
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Use the same hardcoded solutions as Registry
            const solutions = [
                {
                    id: "codebase-indexer",
                    name: "Codebase Indexer",
                    type: "analysis"
                },
                {
                    id: "rag-engine",
                    name: "RAG Engine",
                    type: "intelligence"
                },
                {
                    id: "cache-rag",
                    name: "Cache RAG",
                    type: "intelligence"
                },
                {
                    id: "companion-intelligence",
                    name: "Companion Intelligence",
                    type: "intelligence"
                }
            ];
            
            // Add solutions to dropdown
            solutions.forEach(solution => {
                const option = document.createElement('option');
                option.value = solution.id;
                option.textContent = solution.name;
                option.setAttribute('data-solution-type', solution.type);
                select.appendChild(option);
            });
            
            // Update select state
            select.setAttribute('data-tekton-state', 'loaded');
            
            // Also populate config type dropdown when solution is selected
            select.addEventListener('change', function() {
                const selectedSolution = this.value;
                const configTypeSelect = document.getElementById('config-type');
                
                if (selectedSolution && configTypeSelect) {
                    // Clear existing options except the first one
                    while (configTypeSelect.options.length > 1) {
                        configTypeSelect.remove(1);
                    }
                    
                    // Add config types based on solution
                    const configTypes = [
                        { value: 'wrapper', text: 'Service Wrapper' },
                        { value: 'adapter', text: 'Adapter Pattern' },
                        { value: 'mcp', text: 'MCP Service' },
                        { value: 'api', text: 'REST API' },
                        { value: 'cli', text: 'CLI Tool' }
                    ];
                    
                    configTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.value;
                        option.textContent = type.text;
                        configTypeSelect.appendChild(option);
                    });
                    
                    configTypeSelect.setAttribute('data-tekton-state', 'loaded');
                }
            });
        })
        .catch(err => {
            console.error('[ERGON] Failed to load solutions:', err);
            
            // Still populate with hardcoded solutions on error
            const solutions = [
                {
                    id: "codebase-indexer",
                    name: "Codebase Indexer",
                    type: "analysis"
                },
                {
                    id: "rag-engine",
                    name: "RAG Engine",
                    type: "intelligence"
                },
                {
                    id: "cache-rag",
                    name: "Cache RAG",
                    type: "intelligence"
                },
                {
                    id: "companion-intelligence",
                    name: "Companion Intelligence",
                    type: "intelligence"
                }
            ];
            
            solutions.forEach(solution => {
                const option = document.createElement('option');
                option.value = solution.id;
                option.textContent = solution.name;
                option.setAttribute('data-solution-type', solution.type);
                select.appendChild(option);
            });
            
            select.setAttribute('data-tekton-state', 'loaded');
        });
};

// Fallback initialization after window load
window.addEventListener('load', function() {
    console.log('[ERGON] Window loaded - ensuring initialization...');
    // Check if sprints grid exists and is empty
    const grid = document.getElementById('sprints-grid');
    if (grid && grid.innerHTML.includes('Loading automated sprints')) {
        console.log('[ERGON] Sprints not loaded yet, loading now...');
        ergon_loadSprints();
    }
});
</script>