<!-- Harmonia Component - Workflow Orchestration and CI Routing -->

<!-- Load chat dependencies -->
<script src="/scripts/shared/ai-chat.js"></script>
<script src="/scripts/tekton-urls.js"></script>
<script src="/scripts/shared/single-chat.js"></script>
<script src="/scripts/shared/team-chat.js"></script>

<script>
// Define global functions early for inline handlers
window.harmonia_sendChat = function() {
    const input = document.getElementById('harmonia-chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Determine which tab is active
    const workflowRadio = document.getElementById('harmonia-tab-workflow');
    const teamRadio = document.getElementById('harmonia-tab-team');
    const workflowActive = workflowRadio ? workflowRadio.checked : false;
    const teamActive = teamRadio ? teamRadio.checked : false;
    
    // If we're not on a chat tab, switch to workflow chat first
    if (!workflowActive && !teamActive) {
        if (workflowRadio) {
            workflowRadio.checked = true;
        }
        // Small delay to let the CSS transition complete and ensure chat is initialized
        setTimeout(() => {
            const workflowChatEl = document.getElementById('harmonia-workflow-messages');
            if (window.SingleChat && workflowChatEl) {
                // Ensure it's initialized before sending
                window.SingleChat.init(workflowChatEl, 'harmonia', 'chat-message');
                window.SingleChat.sendMessage(workflowChatEl, message);
            }
            input.value = '';
        }, 100);
        return;
    }
    
    // Normal chat behavior when already on a chat tab
    if (workflowActive) {
        // Use SingleChat for workflow AI
        const workflowChatEl = document.getElementById('harmonia-workflow-messages');
        if (window.SingleChat && workflowChatEl) {
            window.SingleChat.sendMessage(workflowChatEl, message);
        }
    } else if (teamActive) {
        // Use TeamChat for team broadcast
        const teamChatEl = document.getElementById('harmonia-team-messages');
        if (window.TeamChat && teamChatEl) {
            window.TeamChat.sendMessage(teamChatEl, message);
        }
    }
    
    // Clear input
    input.value = '';
}
</script>

<!-- Hidden radio controls for CSS-only tab functionality -->
<input type="radio" name="harmonia-tab" id="harmonia-tab-dashboard" checked style="display: none;">
<input type="radio" name="harmonia-tab" id="harmonia-tab-workflows" style="display: none;">
<input type="radio" name="harmonia-tab" id="harmonia-tab-templates" style="display: none;">
<input type="radio" name="harmonia-tab" id="harmonia-tab-executions" style="display: none;">
<input type="radio" name="harmonia-tab" id="harmonia-tab-component-tasks" style="display: none;">
<input type="radio" name="harmonia-tab" id="harmonia-tab-review" style="display: none;">
<input type="radio" name="harmonia-tab" id="harmonia-tab-workflow" style="display: none;">
<input type="radio" name="harmonia-tab" id="harmonia-tab-team" style="display: none;">

<div class="harmonia" data-tekton-area="harmonia" data-tekton-component="harmonia" data-tekton-type="component-workspace" data-tekton-ai="harmonia-assistant" data-tekton-ai-ready="false">
    <!-- Component Header with Title -->
    <div class="harmonia__header" data-tekton-zone="header" data-tekton-section="header">
        <div class="harmonia__title-container">
            <img src="/images/hexagon.jpg" alt="Tekton" class="harmonia__icon">
            <h2 class="harmonia__title">
                <span class="harmonia__title-main">Harmonia</span>
            </h2>
        </div>
    </div>
    
    <!-- Harmonia Menu Bar with Tab Navigation -->
    <div class="harmonia__menu-bar" data-tekton-zone="menu" data-tekton-nav="component-menu">
        <div class="harmonia__tabs" data-tekton-zone="menu">
            <label for="harmonia-tab-dashboard" class="harmonia__tab" data-tab="dashboard"
                   data-tekton-menu-item="Dashboard" data-tekton-menu-component="harmonia"
                   data-tekton-menu-panel="harmonia-dashboard">
                <span class="harmonia__tab-label">Dashboard</span>
            </label>
            <label for="harmonia-tab-workflows" class="harmonia__tab" data-tab="workflows"
                   data-tekton-menu-item="Workflows" data-tekton-menu-component="harmonia"
                   data-tekton-menu-panel="harmonia-workflows">
                <span class="harmonia__tab-label">Workflows</span>
            </label>
            <label for="harmonia-tab-templates" class="harmonia__tab" data-tab="templates"
                   data-tekton-menu-item="Templates" data-tekton-menu-component="harmonia"
                   data-tekton-menu-panel="harmonia-templates">
                <span class="harmonia__tab-label">Templates</span>
            </label>
            <label for="harmonia-tab-executions" class="harmonia__tab" data-tab="executions"
                   data-tekton-menu-item="Executions" data-tekton-menu-component="harmonia"
                   data-tekton-menu-panel="harmonia-executions">
                <span class="harmonia__tab-label">Executions</span>
            </label>
            <label for="harmonia-tab-component-tasks" class="harmonia__tab" data-tab="component-tasks"
                   data-tekton-menu-item="Component Tasks" data-tekton-menu-component="harmonia"
                   data-tekton-menu-panel="harmonia-component-tasks">
                <span class="harmonia__tab-label">Component Tasks</span>
            </label>
            <label for="harmonia-tab-review" class="harmonia__tab" data-tab="review"
                   data-tekton-menu-item="Review" data-tekton-menu-component="harmonia"
                   data-tekton-menu-panel="harmonia-review">
                <span class="harmonia__tab-label">Review</span>
            </label>
            <label for="harmonia-tab-workflow" class="harmonia__tab" data-tab="workflow"
                   data-tekton-menu-item="Workflow Chat" data-tekton-menu-component="harmonia"
                   data-tekton-menu-panel="harmonia-workflow">
                <span class="harmonia__tab-label">Workflow Chat</span>
            </label>
            <label for="harmonia-tab-team" class="harmonia__tab" data-tab="teamchat"
                   data-tekton-menu-item="Team Chat" data-tekton-menu-component="harmonia"
                   data-tekton-menu-panel="harmonia-team">
                <span class="harmonia__tab-label">Team Chat</span>
            </label>
        </div>
        <div class="harmonia__actions">
            <button id="workflow-create-btn" class="harmonia__action-button harmonia__button--harmonia"
                    onclick="createNewWorkflow()"
                    data-tekton-action="create-workflow" data-tekton-action-type="primary" data-tekton-trigger="click">
                <span class="harmonia__button-label">New Workflow</span>
            </button>
            <button id="clear-chat-btn" class="harmonia__action-button" style="display: none;"
                    onclick="clearHarmoniaChat()"
                    data-tekton-action="clear-chat" data-tekton-action-type="secondary">
                <span class="harmonia__button-label">Clear</span>
            </button>
        </div>
    </div>
    
    <!-- Harmonia Content Area -->
    <div class="harmonia__content" data-tekton-zone="content" data-tekton-scrollable="true">
        <!-- Dashboard Panel (Default Active Panel) -->
        <div class="harmonia__panel harmonia__panel--dashboard" data-tab-content="dashboard"
             data-tekton-tab-content="dashboard"
             data-tekton-panel="dashboard"
             data-tekton-panel-for="Dashboard"
             data-tekton-panel-component="harmonia">
            <div class="harmonia__dashboard" data-tekton-functionality="sprint-cards">
                <h3 class="harmonia__section-title">Ready for Workflow Orchestration</h3>
                <p class="harmonia__text">Sprints with status "Ready-2:Harmonia" requiring workflow design and component routing.</p>
                
                <div class="harmonia__sprint-grid" id="sprint-grid">
                    <!-- Sprint cards will be populated here -->
                    <div class="harmonia__sprint-card" data-sprint-id="example-sprint">
                        <div class="harmonia__card-header">
                            <span class="harmonia__sprint-name">Example Sprint</span>
                            <span class="harmonia__sprint-status harmonia__sprint-status--ready">Ready-2:Harmonia</span>
                        </div>
                        <div class="harmonia__card-body">
                            <p class="harmonia__sprint-description">This sprint has completed task breakdown in Metis and is ready for workflow orchestration.</p>
                            <div class="harmonia__sprint-meta">
                                <span class="harmonia__meta-item">
                                    <span class="harmonia__meta-label">Tasks:</span>
                                    <span class="harmonia__meta-value">12</span>
                                </span>
                                <span class="harmonia__meta-item">
                                    <span class="harmonia__meta-label">Total Hours:</span>
                                    <span class="harmonia__meta-value">45</span>
                                </span>
                            </div>
                        </div>
                        <div class="harmonia__card-actions">
                            <button class="harmonia__button harmonia__button--view"
                                    onclick="viewSprint('example-sprint')"
                                    data-tekton-action="view-sprint" data-tekton-trigger="click" 
                                    data-tekton-target="workflows-panel">View</button>
                            <button class="harmonia__button harmonia__button--edit"
                                    onclick="beginOrchestration('example-sprint')"
                                    data-tekton-action="orchestrate-sprint" data-tekton-trigger="click" 
                                    data-tekton-target="workflow-builder">Begin Orchestration</button>
                        </div>
                    </div>
                </div>
                
                <div class="harmonia__empty-state" id="no-sprints" style="display: none;">
                    <div class="harmonia__empty-icon">üéº</div>
                    <h4 class="harmonia__empty-title">No Sprints Ready</h4>
                    <p class="harmonia__empty-text">No sprints with status "Ready-2:Harmonia" found. Sprints will appear here when Metis completes task breakdown.</p>
                </div>
            </div>
        </div>
        
        <!-- Workflows Panel - Visual Builder -->
        <div class="harmonia__panel harmonia__panel--workflows" data-tab-content="workflows"
             data-tekton-tab-content="workflows"
             data-tekton-panel="workflows"
             data-tekton-panel-for="Workflows"
             data-tekton-panel-component="harmonia">
            <div class="harmonia__workflow-builder" data-tekton-functionality="workflow-designer">
                <h3 class="harmonia__section-title">Visual Workflow Builder</h3>
                <p class="harmonia__text">Design workflows by connecting tasks with execution logic.</p>
                
                <div class="harmonia__builder-container">
                    <!-- Left Panel: Task List from Metis -->
                    <div class="harmonia__builder-sidebar harmonia__builder-sidebar--left" data-tekton-zone="task-list">
                        <h4 class="harmonia__sidebar-title">Available Tasks</h4>
                        <div class="harmonia__task-list" id="available-tasks">
                            <!-- Tasks will be populated from sprint data -->
                            <div class="harmonia__task-draggable" draggable="true" data-task-id="task-1"
                                 data-tekton-draggable="task" data-tekton-task-type="implementation">
                                <span class="harmonia__task-icon">üìù</span>
                                <span class="harmonia__task-name">Example Task</span>
                                <span class="harmonia__task-hours">3h</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Center: Canvas Area -->
                    <div class="harmonia__builder-canvas" data-tekton-zone="workflow-canvas">
                        <div class="harmonia__canvas-toolbar">
                            <button class="harmonia__tool-button" data-tool="task"
                                    data-tekton-action="add-node" data-tekton-node-type="task">
                                <span class="harmonia__tool-icon">üìã</span>
                                <span class="harmonia__tool-label">Task</span>
                            </button>
                            <button class="harmonia__tool-button" data-tool="decision"
                                    data-tekton-action="add-node" data-tekton-node-type="decision">
                                <span class="harmonia__tool-icon">üîÄ</span>
                                <span class="harmonia__tool-label">Decision</span>
                            </button>
                            <button class="harmonia__tool-button" data-tool="parallel"
                                    data-tekton-action="add-node" data-tekton-node-type="parallel">
                                <span class="harmonia__tool-icon">‚ö°</span>
                                <span class="harmonia__tool-label">Parallel</span>
                            </button>
                            <button class="harmonia__tool-button" data-tool="join"
                                    data-tekton-action="add-node" data-tekton-node-type="join">
                                <span class="harmonia__tool-icon">üîó</span>
                                <span class="harmonia__tool-label">Join</span>
                            </button>
                            <div class="harmonia__tool-separator"></div>
                            <button class="harmonia__tool-button"
                                    onclick="autoLayoutWorkflow()"
                                    data-tekton-action="auto-layout" data-tekton-trigger="click">
                                <span class="harmonia__tool-icon">üéØ</span>
                                <span class="harmonia__tool-label">Auto Layout</span>
                            </button>
                        </div>
                        <div class="harmonia__canvas-area" id="workflow-canvas"
                             data-tekton-droppable="workflow-canvas">
                            <svg class="harmonia__canvas-svg" width="100%" height="100%">
                                <!-- Workflow connections will be drawn here -->
                            </svg>
                            <div class="harmonia__canvas-nodes">
                                <!-- Workflow nodes will be positioned here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Panel: Properties Editor -->
                    <div class="harmonia__builder-sidebar harmonia__builder-sidebar--right" data-tekton-zone="properties">
                        <h4 class="harmonia__sidebar-title">Properties</h4>
                        <div class="harmonia__properties-editor" id="properties-editor">
                            <div class="harmonia__empty-properties">
                                <p class="harmonia__text">Select a node to edit its properties</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Templates Panel -->
        <div class="harmonia__panel harmonia__panel--templates" data-tab-content="templates"
             data-tekton-tab-content="templates"
             data-tekton-panel="templates"
             data-tekton-panel-for="Templates"
             data-tekton-panel-component="harmonia">
            <div class="harmonia__templates" data-tekton-functionality="workflow-templates">
                <div class="harmonia__section-header">
                    <div>
                        <h3 class="harmonia__section-title">Workflow Templates</h3>
                        <p class="harmonia__text">Reusable workflow patterns for common development scenarios.</p>
                    </div>
                    <div class="harmonia__section-actions">
                        <button class="harmonia__button harmonia__button--edit"
                                onclick="createHarmoniaTemplate()"
                                data-tekton-action="create-template" data-tekton-trigger="click">Create Template</button>
                        <button class="harmonia__button harmonia__button--primary"
                                onclick="importHarmoniaTemplate()"
                                data-tekton-action="import-template" data-tekton-trigger="click">Import Template</button>
                    </div>
                </div>
                
                <div class="harmonia__template-grid">
                    <div class="harmonia__template-card" data-template-id="feature-dev">
                        <div class="harmonia__template-icon">üöÄ</div>
                        <h4 class="harmonia__template-name">Feature Development</h4>
                        <p class="harmonia__template-description">Standard workflow for new feature implementation with testing and review stages.</p>
                        <div class="harmonia__template-meta">
                            <span class="harmonia__meta-item">
                                <span class="harmonia__meta-label">Nodes:</span>
                                <span class="harmonia__meta-value">8</span>
                            </span>
                            <span class="harmonia__meta-item">
                                <span class="harmonia__meta-label">Components:</span>
                                <span class="harmonia__meta-value">4</span>
                            </span>
                        </div>
                        <div class="harmonia__template-actions">
                            <button class="harmonia__button harmonia__button--view"
                                    onclick="previewHarmoniaTemplate('feature-dev')"
                                    data-tekton-action="preview-template" data-tekton-trigger="click" data-template-id="feature-dev">Preview</button>
                            <button class="harmonia__button harmonia__button--primary"
                                    onclick="useHarmoniaTemplate('feature-dev')"
                                    data-tekton-action="use-template" data-tekton-trigger="click" data-template-id="feature-dev">Use Template</button>
                        </div>
                    </div>
                    
                    <div class="harmonia__template-card" data-template-id="bug-fix">
                        <div class="harmonia__template-icon">üêõ</div>
                        <h4 class="harmonia__template-name">Bug Fix</h4>
                        <p class="harmonia__template-description">Quick workflow for bug investigation, fixing, and verification.</p>
                        <div class="harmonia__template-meta">
                            <span class="harmonia__meta-item">
                                <span class="harmonia__meta-label">Nodes:</span>
                                <span class="harmonia__meta-value">5</span>
                            </span>
                            <span class="harmonia__meta-item">
                                <span class="harmonia__meta-label">Components:</span>
                                <span class="harmonia__meta-value">3</span>
                            </span>
                        </div>
                        <div class="harmonia__template-actions">
                            <button class="harmonia__button harmonia__button--view"
                                    onclick="previewHarmoniaTemplate('bug-fix')"
                                    data-tekton-action="preview-template" data-tekton-trigger="click" data-template-id="bug-fix">Preview</button>
                            <button class="harmonia__button harmonia__button--primary"
                                    onclick="useHarmoniaTemplate('bug-fix')"
                                    data-tekton-action="use-template" data-tekton-trigger="click" data-template-id="bug-fix">Use Template</button>
                        </div>
                    </div>
                    
                    <div class="harmonia__template-card" data-template-id="refactor">
                        <div class="harmonia__template-icon">‚ôªÔ∏è</div>
                        <h4 class="harmonia__template-name">Code Refactoring</h4>
                        <p class="harmonia__template-description">Systematic workflow for code refactoring with safety checks.</p>
                        <div class="harmonia__template-meta">
                            <span class="harmonia__meta-item">
                                <span class="harmonia__meta-label">Nodes:</span>
                                <span class="harmonia__meta-value">7</span>
                            </span>
                            <span class="harmonia__meta-item">
                                <span class="harmonia__meta-label">Components:</span>
                                <span class="harmonia__meta-value">5</span>
                            </span>
                        </div>
                        <div class="harmonia__template-actions">
                            <button class="harmonia__button harmonia__button--view"
                                    onclick="previewHarmoniaTemplate('refactor')"
                                    data-tekton-action="preview-template" data-tekton-trigger="click" data-template-id="refactor">Preview</button>
                            <button class="harmonia__button harmonia__button--primary"
                                    onclick="useHarmoniaTemplate('refactor')"
                                    data-tekton-action="use-template" data-tekton-trigger="click" data-template-id="refactor">Use Template</button>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- Executions Panel -->
        <div class="harmonia__panel harmonia__panel--executions" data-tab-content="executions"
             data-tekton-tab-content="executions"
             data-tekton-panel="executions"
             data-tekton-panel-for="Executions"
             data-tekton-panel-component="harmonia">
            <div class="harmonia__executions" data-tekton-functionality="execution-monitor">
                <h3 class="harmonia__section-title">Running Workflows</h3>
                <p class="harmonia__text">Monitor and control active workflow executions.</p>
                
                <div class="harmonia__execution-list">
                    <div class="harmonia__execution-item" data-execution-id="exec-1">
                        <div class="harmonia__execution-header">
                            <div class="harmonia__execution-info">
                                <h4 class="harmonia__execution-name">Feature: User Authentication</h4>
                                <span class="harmonia__execution-workflow">Using: Feature Development Template</span>
                            </div>
                            <span class="harmonia__execution-status harmonia__execution-status--running">Running</span>
                        </div>
                        <div class="harmonia__execution-progress">
                            <div class="harmonia__progress-bar">
                                <div class="harmonia__progress-fill" style="width: 45%;"></div>
                            </div>
                            <span class="harmonia__progress-text">5 of 11 tasks completed</span>
                        </div>
                        <div class="harmonia__execution-current">
                            <span class="harmonia__current-label">Current:</span>
                            <span class="harmonia__current-task">Implementing login endpoint</span>
                            <span class="harmonia__current-component">(numa)</span>
                        </div>
                        <div class="harmonia__execution-actions">
                            <button class="harmonia__button harmonia__button--view"
                                    onclick="viewExecutionDetails('exec-1')"
                                    data-tekton-action="view-execution" data-tekton-trigger="click">View Details</button>
                            <button class="harmonia__button harmonia__button--edit"
                                    onclick="pauseExecution('exec-1')"
                                    data-tekton-action="pause-execution" data-tekton-trigger="click">Pause</button>
                            <button class="harmonia__button harmonia__button--primary"
                                    onclick="cancelExecution('exec-1')"
                                    data-tekton-action="cancel-execution" data-tekton-trigger="click">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <div class="harmonia__execution-stats">
                    <div class="harmonia__stat-card">
                        <span class="harmonia__stat-label">Active</span>
                        <span class="harmonia__stat-value">3</span>
                    </div>
                    <div class="harmonia__stat-card">
                        <span class="harmonia__stat-label">Completed Today</span>
                        <span class="harmonia__stat-value">7</span>
                    </div>
                    <div class="harmonia__stat-card">
                        <span class="harmonia__stat-label">Failed</span>
                        <span class="harmonia__stat-value">1</span>
                    </div>
                    <div class="harmonia__stat-card">
                        <span class="harmonia__stat-label">Avg Duration</span>
                        <span class="harmonia__stat-value">2.5h</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Component Tasks Panel -->
        <div class="harmonia__panel harmonia__panel--component-tasks" data-tab-content="component-tasks"
             data-tekton-tab-content="component-tasks"
             data-tekton-panel="component-tasks"
             data-tekton-panel-for="Component Tasks"
             data-tekton-panel-component="harmonia">
            <div class="harmonia__component-tasks" data-tekton-functionality="component-routing">
                <h3 class="harmonia__section-title">Component Task Routing</h3>
                <p class="harmonia__text">Configure how task types are routed to Tekton components.</p>
                
                <div class="harmonia__routing-section">
                    <h4 class="harmonia__subtitle">Default Mappings</h4>
                    <div class="harmonia__routing-table">
                        <div class="harmonia__routing-row">
                            <span class="harmonia__task-type">Implementation Tasks</span>
                            <span class="harmonia__arrow">‚Üí</span>
                            <span class="harmonia__component-name">numa</span>
                            <div class="harmonia__routing-actions">
                                <button class="harmonia__button harmonia__button--small"
                                        onclick="editComponentMapping('implementation', 'numa')"
                                        data-tekton-action="edit-mapping" data-tekton-trigger="click">Edit</button>
                            </div>
                        </div>
                        <div class="harmonia__routing-row">
                            <span class="harmonia__task-type">Analysis Tasks</span>
                            <span class="harmonia__arrow">‚Üí</span>
                            <span class="harmonia__component-name">metis</span>
                            <div class="harmonia__routing-actions">
                                <button class="harmonia__button harmonia__button--small"
                                        onclick="editComponentMapping('analysis', 'metis')"
                                        data-tekton-action="edit-mapping" data-tekton-trigger="click">Edit</button>
                            </div>
                        </div>
                        <div class="harmonia__routing-row">
                            <span class="harmonia__task-type">Planning Tasks</span>
                            <span class="harmonia__arrow">‚Üí</span>
                            <span class="harmonia__component-name">prometheus</span>
                            <div class="harmonia__routing-actions">
                                <button class="harmonia__button harmonia__button--small"
                                        onclick="editComponentMapping('planning', 'prometheus')"
                                        data-tekton-action="edit-mapping" data-tekton-trigger="click">Edit</button>
                            </div>
                        </div>
                        <div class="harmonia__routing-row">
                            <span class="harmonia__task-type">Testing Tasks</span>
                            <span class="harmonia__arrow">‚Üí</span>
                            <span class="harmonia__component-name">athena</span>
                            <div class="harmonia__routing-actions">
                                <button class="harmonia__button harmonia__button--small"
                                        onclick="editComponentMapping('testing', 'athena')"
                                        data-tekton-action="edit-mapping" data-tekton-trigger="click">Edit</button>
                            </div>
                        </div>
                        <div class="harmonia__routing-row">
                            <span class="harmonia__task-type">Documentation Tasks</span>
                            <span class="harmonia__arrow">‚Üí</span>
                            <span class="harmonia__component-name">rhetor</span>
                            <div class="harmonia__routing-actions">
                                <button class="harmonia__button harmonia__button--small"
                                        onclick="editComponentMapping('documentation', 'rhetor')"
                                        data-tekton-action="edit-mapping" data-tekton-trigger="click">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="harmonia__routing-section">
                    <h4 class="harmonia__subtitle">Component Actions</h4>
                    <p class="harmonia__text">Define specific actions each component can perform.</p>
                    
                    <div class="harmonia__component-list">
                        <div class="harmonia__component-item">
                            <div class="harmonia__component-header">
                                <span class="harmonia__component-icon">üîÆ</span>
                                <span class="harmonia__component-title">numa</span>
                            </div>
                            <div class="harmonia__component-actions-list">
                                <span class="harmonia__action-tag">implement_feature</span>
                                <span class="harmonia__action-tag">fix_bug</span>
                                <span class="harmonia__action-tag">refactor_code</span>
                                <span class="harmonia__action-tag">write_tests</span>
                            </div>
                        </div>
                        <div class="harmonia__component-item">
                            <div class="harmonia__component-header">
                                <span class="harmonia__component-icon">üìä</span>
                                <span class="harmonia__component-title">metis</span>
                            </div>
                            <div class="harmonia__component-actions-list">
                                <span class="harmonia__action-tag">analyze_requirements</span>
                                <span class="harmonia__action-tag">break_down_tasks</span>
                                <span class="harmonia__action-tag">estimate_complexity</span>
                            </div>
                        </div>
                        <div class="harmonia__component-item">
                            <div class="harmonia__component-header">
                                <span class="harmonia__component-icon">üéØ</span>
                                <span class="harmonia__component-title">prometheus</span>
                            </div>
                            <div class="harmonia__component-actions-list">
                                <span class="harmonia__action-tag">create_plan</span>
                                <span class="harmonia__action-tag">define_milestones</span>
                                <span class="harmonia__action-tag">predict_risks</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="harmonia__button harmonia__button--secondary"
                            onclick="addComponentAction()"
                            data-tekton-action="add-component-action" data-tekton-trigger="click">Add Component Action</button>
                </div>
            </div>
        </div>
        
        <!-- Review Panel -->
        <div class="harmonia__panel harmonia__panel--review" data-tab-content="review"
             data-tekton-tab-content="review"
             data-tekton-panel="review"
             data-tekton-panel-for="Review"
             data-tekton-panel-component="harmonia">
            <div class="harmonia__review" data-tekton-functionality="export-synthesis">
                <h3 class="harmonia__section-title">Review & Export</h3>
                <p class="harmonia__text">Review the workflow configuration and export to Synthesis for execution.</p>
                
                <div class="harmonia__review-summary">
                    <h4 class="harmonia__subtitle">Workflow Summary</h4>
                    <div class="harmonia__summary-stats">
                        <div class="harmonia__stat">
                            <span class="harmonia__stat-label">Total Nodes:</span>
                            <span class="harmonia__stat-value" id="total-nodes">0</span>
                        </div>
                        <div class="harmonia__stat">
                            <span class="harmonia__stat-label">Components Used:</span>
                            <span class="harmonia__stat-value" id="components-used">0</span>
                        </div>
                        <div class="harmonia__stat">
                            <span class="harmonia__stat-label">Execution Paths:</span>
                            <span class="harmonia__stat-value" id="execution-paths">0</span>
                        </div>
                        <div class="harmonia__stat">
                            <span class="harmonia__stat-label">Error Handlers:</span>
                            <span class="harmonia__stat-value" id="error-handlers">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="harmonia__review-details">
                    <h4 class="harmonia__subtitle">Workflow Configuration</h4>
                    <div class="harmonia__review-content" id="workflow-review">
                        <!-- Workflow details will be populated here -->
                        <div class="harmonia__review-section">
                            <h5 class="harmonia__review-title">Component Assignments</h5>
                            <div class="harmonia__review-list">
                                <!-- Component assignments will be listed here -->
                            </div>
                        </div>
                        <div class="harmonia__review-section">
                            <h5 class="harmonia__review-title">Execution Order</h5>
                            <div class="harmonia__review-list">
                                <!-- Execution order will be listed here -->
                            </div>
                        </div>
                        <div class="harmonia__review-section">
                            <h5 class="harmonia__review-title">Error Handling</h5>
                            <div class="harmonia__review-list">
                                <!-- Error strategies will be listed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="harmonia__export-section">
                    <h4 class="harmonia__subtitle">Export to Synthesis</h4>
                    <p class="harmonia__text">Send this workflow orchestration to Synthesis for integration and execution management.</p>
                    
                    <div class="harmonia__export-options">
                        <label class="harmonia__checkbox-label">
                            <input type="checkbox" id="include-templates" checked>
                            <span>Include workflow templates</span>
                        </label>
                        <label class="harmonia__checkbox-label">
                            <input type="checkbox" id="include-error-handlers" checked>
                            <span>Include error handling strategies</span>
                        </label>
                        <label class="harmonia__checkbox-label">
                            <input type="checkbox" id="auto-start" checked>
                            <span>Auto-start workflow after export</span>
                        </label>
                    </div>
                    
                    <div class="harmonia__export-actions">
                        <button class="harmonia__button harmonia__button--export" onclick="harmonia_exportToSynthesis(); return false;"
                                data-tekton-action="export-synthesis" data-tekton-trigger="click"
                                data-tekton-target="synthesis">Export to Synthesis</button>
                        <button class="harmonia__button harmonia__button--primary"
                                onclick="previewHarmoniaExport()"
                                data-tekton-action="preview-export" data-tekton-trigger="click">Preview Export</button>
                        <button class="harmonia__button harmonia__button--edit"
                                onclick="saveHarmoniaDraft()"
                                data-tekton-action="save-draft" data-tekton-trigger="click">Save Draft</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Workflow Chat Panel -->
        <div class="harmonia__panel harmonia__panel--workflow" data-tab-content="workflow-chat"
             data-tekton-tab-content="workflow-chat"
             data-tekton-panel="workflow"
             data-tekton-panel-for="Workflow Chat"
             data-tekton-panel-component="harmonia">
            <div class="chat-interface" data-tekton-chat="workflow"
                 data-tekton-ai="harmonia-workflow"
                 data-tekton-ai-ready="false">
                <div class="chat-messages" id="harmonia-workflow-messages"
                     data-tekton-messages="workflow"
                     data-tekton-element="chat-messages">
                    <div class="chat-message system-message">
                        <strong>Harmonia:</strong> Welcome to Workflow Chat! I can help you with:
                        <ul style="margin-top: 8px; margin-bottom: 0;">
                            <li>How do I create a parallel execution path?</li>
                            <li>What components are best for [task type]?</li>
                            <li>Show me the current workflow status</li>
                            <li>Help me optimize the workflow design</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Team Chat Panel -->
        <div class="harmonia__panel harmonia__panel--team" data-tab-content="team-chat"
             data-tekton-tab-content="team-chat"
             data-tekton-panel="team"
             data-tekton-panel-for="Team Chat"
             data-tekton-panel-component="harmonia"
             data-tekton-chat="team"
             data-tekton-ai="harmonia-orchestrator"
             data-tekton-ai-ready="false">
            <div class="chat-interface" data-tekton-chat="team">
                <div class="chat-messages" id="harmonia-team-messages"
                     data-tekton-messages="team"
                     data-tekton-element="chat-messages">
                    <div class="chat-message system-message">
                        <strong>System:</strong> Team Chat allows Harmonia to coordinate with other AI specialists.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer with Chat Input -->
    <div class="harmonia__footer" data-tekton-zone="footer" data-tekton-section="footer">
        <div class="harmonia__chat-input-container"
             data-tekton-chat="harmonia-workflow"
             data-tekton-chat-component="harmonia"
             data-tekton-element="chat-input-container">
            <div class="harmonia__chat-prompt" data-tekton-element="chat-prompt">></div>
            <input type="text" class="harmonia__chat-input" id="harmonia-chat-input"
                   data-tekton-input="chat-input"
                   data-tekton-input-type="chat"
                   data-tekton-input-component="harmonia"
                   placeholder="Chat with Harmonia - your workflow orchestration and CI routing assistant"
                   onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); harmonia_sendChat(); }">
            <button class="harmonia__send-button" id="harmonia-send-button"
                    onclick="harmonia_sendChat(); return false;"
                    data-tekton-action="send-message"
                    data-tekton-action-type="primary"
                    data-tekton-action-component="harmonia">Send</button>
        </div>
    </div>
</div>

<!-- Modals - Outside of main component to ensure proper overlay -->
<!-- Template Creation Modal -->
<div id="template-modal" class="harmonia__modal" style="display: none;">
    <div class="harmonia__modal-content">
        <div class="harmonia__modal-header">
            <h2 class="harmonia__modal-title">Create Workflow Template</h2>
            <button class="harmonia__modal-close" onclick="closeTemplateModal()">&times;</button>
        </div>
        
        <div class="harmonia__modal-body">
            <div class="harmonia__template-form">
                <!-- Basic Information -->
                <div class="harmonia__template-section">
                    <h3 class="harmonia__template-section-title">Basic Information</h3>
                    
                    <div class="harmonia__template-field">
                        <label class="harmonia__template-label">Template Name</label>
                        <input type="text" id="template-name" class="harmonia__template-input" placeholder="e.g., Feature Development">
                    </div>
                    
                    <div class="harmonia__template-field">
                        <label class="harmonia__template-label">Description</label>
                        <textarea id="template-description" class="harmonia__template-textarea" rows="3" placeholder="Describe what this template is for..."></textarea>
                    </div>
                    
                    <div class="harmonia__template-row">
                        <div class="harmonia__template-field">
                            <label class="harmonia__template-label">Category</label>
                            <select id="template-category" class="harmonia__template-select">
                                <option value="development">Development</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="testing">Testing</option>
                                <option value="deployment">Deployment</option>
                                <option value="analysis">Analysis</option>
                            </select>
                        </div>
                        
                        <div class="harmonia__template-field">
                            <label class="harmonia__template-label">Difficulty</label>
                            <select id="template-difficulty" class="harmonia__template-select">
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        
                        <div class="harmonia__template-field">
                            <label class="harmonia__template-label">Est. Duration</label>
                            <input type="text" id="template-duration" class="harmonia__template-input" placeholder="e.g., 4-6 hours">
                        </div>
                    </div>
                    
                    <div class="harmonia__template-field">
                        <label class="harmonia__template-label">Tags (comma-separated)</label>
                        <input type="text" id="template-tags" class="harmonia__template-input" placeholder="e.g., feature, testing, review">
                    </div>
                    
                    <div class="harmonia__template-field">
                        <label class="harmonia__checkbox-label">
                            <input type="checkbox" id="template-public" checked>
                            <span>Make this template public</span>
                        </label>
                    </div>
                </div>
                
                <!-- Workflow Tasks -->
                <div class="harmonia__template-section">
                    <div class="harmonia__template-section-header">
                        <h3 class="harmonia__template-section-title">Workflow Tasks</h3>
                        <button class="harmonia__button harmonia__button--small harmonia__button--primary" onclick="addTemplateTask()">Add Task</button>
                    </div>
                    
                    <div id="template-tasks-list" class="harmonia__template-tasks-list">
                        <!-- Tasks will be added here dynamically -->
                        <div class="harmonia__template-task" data-task-index="0">
                            <div class="harmonia__template-task-header">
                                <input type="text" class="harmonia__template-input" placeholder="Task Name" data-field="name">
                                <button class="harmonia__button harmonia__button--small harmonia__button--secondary" onclick="removeTemplateTask(0)">Remove</button>
                            </div>
                            <div class="harmonia__template-task-fields">
                                <select class="harmonia__template-select" data-field="component">
                                    <option value="numa">Numa</option>
                                    <option value="metis">Metis</option>
                                    <option value="prometheus">Prometheus</option>
                                    <option value="athena">Athena</option>
                                    <option value="rhetor">Rhetor</option>
                                    <option value="apollo">Apollo</option>
                                    <option value="hermes">Hermes</option>
                                    <option value="engram">Engram</option>
                                </select>
                                <input type="text" class="harmonia__template-input" placeholder="Description" data-field="description">
                                <input type="number" class="harmonia__template-input harmonia__template-input--small" placeholder="Timeout (s)" data-field="timeout" value="3600">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="harmonia__modal-footer">
            <button class="harmonia__button harmonia__button--secondary" onclick="closeTemplateModal()">Cancel</button>
            <button class="harmonia__button harmonia__button--primary" onclick="saveTemplate()">Create Template</button>
        </div>
    </div>
</div>

<!-- Workflow Editor Modal -->
<div id="workflow-modal" class="harmonia__modal" style="display: none;">
    <div class="harmonia__modal-content">
        <div class="harmonia__modal-header">
            <h2 class="harmonia__modal-title">Create New Workflow</h2>
            <button class="harmonia__modal-close" onclick="closeWorkflowModal()">&times;</button>
        </div>
        
        <div class="harmonia__modal-body">
            <div class="harmonia__workflow-form">
                <!-- Basic Information -->
                <div class="harmonia__workflow-section">
                    <h3 class="harmonia__template-section-title">Workflow Information</h3>
                    
                    <div class="harmonia__workflow-field">
                        <label class="harmonia__workflow-label">Workflow Name</label>
                        <input type="text" id="workflow-name" class="harmonia__workflow-input" placeholder="e.g., User Authentication Feature">
                    </div>
                    
                    <div class="harmonia__workflow-field">
                        <label class="harmonia__workflow-label">Description</label>
                        <textarea id="workflow-description" class="harmonia__workflow-textarea" rows="3" placeholder="Describe the workflow purpose and goals..."></textarea>
                    </div>
                    
                    <div class="harmonia__workflow-row">
                        <div class="harmonia__workflow-field">
                            <label class="harmonia__workflow-label">Sprint ID (optional)</label>
                            <input type="text" id="workflow-sprint-id" class="harmonia__workflow-input" placeholder="Associated sprint ID">
                        </div>
                        
                        <div class="harmonia__workflow-field">
                            <label class="harmonia__workflow-label">Priority</label>
                            <select id="workflow-priority" class="harmonia__workflow-select">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="harmonia__workflow-field">
                        <label class="harmonia__checkbox-label">
                            <input type="checkbox" id="workflow-auto-start">
                            <span>Auto-start workflow after creation</span>
                        </label>
                    </div>
                </div>
                
                <!-- Workflow Tasks -->
                <div class="harmonia__workflow-section">
                    <div class="harmonia__template-section-header">
                        <h3 class="harmonia__template-section-title">Workflow Tasks</h3>
                        <button class="harmonia__button harmonia__button--small harmonia__button--primary" onclick="addWorkflowTask()">Add Task</button>
                    </div>
                    
                    <div id="workflow-tasks-list" class="harmonia__workflow-tasks-list">
                        <!-- Tasks will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="harmonia__modal-footer">
            <button class="harmonia__button harmonia__button--edit" onclick="clearWorkflowForm()">Clear</button>
            <button class="harmonia__button harmonia__button--primary" onclick="saveWorkflow()">Create Workflow</button>
        </div>
    </div>
</div>

<!-- Add component-specific styles -->
<style>
    /* Harmonia component styles using BEM naming convention */
    
    /* Container */
    .harmonia {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        background-color: var(--bg-primary, #1e1e2e);
        color: var(--text-primary, #f0f0f0);
        font-size: 14px;
    }
    
    /* Header */
    .harmonia__header {
        display: flex;
        align-items: center;
        padding: 10px 16px;
        background-color: var(--bg-secondary, #252535);
        border-bottom: 1px solid var(--border-color, #444444);
        height: 46px;
    }
    
    .harmonia__title-container {
        display: flex;
        align-items: center;
    }
    
    .harmonia__icon {
        height: 30px;
        width: auto;
        margin-right: 12px;
    }
    
    .harmonia__title {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 500;
    }
    
    /* Menu Bar */
    .harmonia__menu-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 16px;
        background-color: var(--bg-secondary, #252535);
        border-bottom: 1px solid var(--border-color, #444444);
        height: 46px;
    }
    
    .harmonia__tabs {
        display: flex;
        gap: 8px;
    }
    
    .harmonia__tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background-color: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--text-primary, #f0f0f0);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .harmonia__tab:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .harmonia__actions {
        display: flex;
        gap: 8px;
    }
    
    .harmonia__action-button {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
    }
    
    .harmonia__action-button:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    /* Content Area */
    .harmonia__content {
        flex: 1;
        overflow: hidden;
        position: relative;
        padding-bottom: 70px;
    }
    
    /* Panel styling - hidden by default */
    .harmonia__panel {
        display: none;
        padding: 24px;
        height: 100%;
        overflow: auto;
    }
    
    /* Radio button logic for tab switching - Following Terma's exact pattern */
    #harmonia-tab-dashboard:checked ~ .harmonia .harmonia__panel--dashboard,
    #harmonia-tab-workflows:checked ~ .harmonia .harmonia__panel--workflows,
    #harmonia-tab-templates:checked ~ .harmonia .harmonia__panel--templates,
    #harmonia-tab-executions:checked ~ .harmonia .harmonia__panel--executions,
    #harmonia-tab-component-tasks:checked ~ .harmonia .harmonia__panel--component-tasks,
    #harmonia-tab-review:checked ~ .harmonia .harmonia__panel--review,
    #harmonia-tab-workflow:checked ~ .harmonia .harmonia__panel--workflow,
    #harmonia-tab-team:checked ~ .harmonia .harmonia__panel--team {
        display: flex;
        flex-direction: column;
    }
    
    /* Active tab styling */
    #harmonia-tab-dashboard:checked ~ .harmonia .harmonia__tab[for="harmonia-tab-dashboard"],
    #harmonia-tab-workflows:checked ~ .harmonia .harmonia__tab[for="harmonia-tab-workflows"],
    #harmonia-tab-templates:checked ~ .harmonia .harmonia__tab[for="harmonia-tab-templates"],
    #harmonia-tab-executions:checked ~ .harmonia .harmonia__tab[for="harmonia-tab-executions"],
    #harmonia-tab-component-tasks:checked ~ .harmonia .harmonia__tab[for="harmonia-tab-component-tasks"],
    #harmonia-tab-review:checked ~ .harmonia .harmonia__tab[for="harmonia-tab-review"],
    #harmonia-tab-workflow:checked ~ .harmonia .harmonia__tab[for="harmonia-tab-workflow"],
    #harmonia-tab-team:checked ~ .harmonia .harmonia__tab[for="harmonia-tab-team"] {
        color: var(--text-primary, #f0f0f0);
        border-bottom-color: #7E57C2;
        background-color: rgba(126, 87, 194, 0.05);
    }
    
    /* Show/hide action buttons based on active tab - Following Terma pattern */
    #clear-chat-btn {
        display: none;
    }
    
    #harmonia-tab-workflow:checked ~ .harmonia .harmonia__actions #workflow-create-btn,
    #harmonia-tab-team:checked ~ .harmonia .harmonia__actions #workflow-create-btn {
        display: none;
    }
    
    #harmonia-tab-workflow:checked ~ .harmonia .harmonia__actions #clear-chat-btn,
    #harmonia-tab-team:checked ~ .harmonia .harmonia__actions #clear-chat-btn {
        display: flex;
    }
    
    /* Section Titles */
    .harmonia__section-title {
        margin: 0 0 8px 0;
        font-size: 1.4rem;
        font-weight: 500;
        color: var(--text-primary, #f0f0f0);
    }
    
    .harmonia__subtitle {
        margin: 24px 0 12px 0;
        font-size: 1.1rem;
        font-weight: 500;
        color: var(--text-primary, #f0f0f0);
    }
    
    .harmonia__text {
        margin: 0 0 16px 0;
        color: var(--text-secondary, #b0b0b0);
        font-size: 14px;
    }
    
    /* Dashboard Styles */
    .harmonia__sprint-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }
    
    .harmonia__sprint-card {
        background-color: var(--bg-secondary, #252535);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        padding: 16px;
        transition: all 0.2s ease;
    }
    
    .harmonia__sprint-card:hover {
        border-color: #7E57C2;
        box-shadow: 0 2px 8px rgba(126, 87, 194, 0.2);
    }
    
    .harmonia__card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .harmonia__sprint-name {
        font-weight: 500;
        font-size: 1.1rem;
    }
    
    .harmonia__sprint-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .harmonia__sprint-status--ready {
        background-color: rgba(126, 87, 194, 0.2);
        color: #7E57C2;
    }
    
    .harmonia__card-body {
        margin-bottom: 16px;
    }
    
    .harmonia__sprint-description {
        color: var(--text-secondary, #b0b0b0);
        margin-bottom: 12px;
        font-size: 14px;
    }
    
    .harmonia__sprint-meta {
        display: flex;
        gap: 16px;
        font-size: 13px;
    }
    
    .harmonia__meta-label {
        color: var(--text-secondary, #b0b0b0);
    }
    
    .harmonia__meta-value {
        color: var(--text-primary, #f0f0f0);
        margin-left: 4px;
    }
    
    .harmonia__card-actions {
        display: flex;
        gap: 8px;
    }
    
    /* Button Styles */
    .harmonia__button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .harmonia__button--primary {
        background-color: #7E57C2;
        color: white;
    }
    
    .harmonia__button--primary:hover {
        background-color: #6E47B2;
    }
    
    .harmonia__button--harmonia {
        background-color: #FF6B35;
        color: white;
    }
    
    .harmonia__button--harmonia:hover {
        background-color: #E55A2B;
    }
    
    .harmonia__button--secondary {
        background-color: var(--bg-tertiary, #333345);
        color: var(--text-primary, #f0f0f0);
        border: 1px solid var(--border-color, #444444);
    }
    
    .harmonia__button--secondary:hover {
        background-color: var(--bg-hover, #3a3a4a);
    }
    
    .harmonia__button--view {
        background-color: #FFC107;
        color: #000;
    }
    
    .harmonia__button--view:hover {
        background-color: #FFB300;
    }
    
    .harmonia__button--edit {
        background-color: #4CAF50;
        color: white;
    }
    
    .harmonia__button--edit:hover {
        background-color: #45a049;
    }
    
    .harmonia__button--export {
        background-color: #9C27B0;
        color: white;
    }
    
    .harmonia__button--export:hover {
        background-color: #8E24AA;
    }
    
    .harmonia__button--small {
        padding: 4px 8px;
        font-size: 12px;
    }
    
    /* Workflow Builder Styles */
    .harmonia__builder-container {
        display: flex;
        gap: 16px;
        height: calc(100vh - 300px);
        margin-top: 16px;
    }
    
    .harmonia__builder-sidebar {
        width: 250px;
        background-color: var(--bg-secondary, #252535);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        padding: 16px;
        overflow-y: auto;
    }
    
    .harmonia__sidebar-title {
        margin: 0 0 12px 0;
        font-size: 1rem;
        font-weight: 500;
    }
    
    .harmonia__task-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .harmonia__task-draggable {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        cursor: move;
        transition: all 0.2s ease;
    }
    
    .harmonia__task-draggable:hover {
        border-color: #7E57C2;
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .harmonia__task-icon {
        font-size: 16px;
    }
    
    .harmonia__task-name {
        flex: 1;
        font-size: 14px;
    }
    
    .harmonia__task-hours {
        font-size: 12px;
        color: var(--text-secondary, #b0b0b0);
    }
    
    .harmonia__builder-canvas {
        flex: 1;
        background-color: var(--bg-secondary, #252535);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
    }
    
    .harmonia__canvas-toolbar {
        display: flex;
        gap: 8px;
        padding: 12px;
        border-bottom: 1px solid var(--border-color, #444444);
    }
    
    .harmonia__tool-button {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 8px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 12px;
    }
    
    .harmonia__tool-button:hover {
        background-color: var(--bg-hover, #3a3a4a);
        border-color: #7E57C2;
    }
    
    .harmonia__tool-icon {
        font-size: 20px;
    }
    
    .harmonia__tool-separator {
        width: 1px;
        background-color: var(--border-color, #444444);
        margin: 0 8px;
    }
    
    .harmonia__canvas-area {
        flex: 1;
        position: relative;
        overflow: auto;
        background-image: 
            repeating-linear-gradient(0deg, transparent, transparent 19px, rgba(255, 255, 255, 0.05) 19px, rgba(255, 255, 255, 0.05) 20px),
            repeating-linear-gradient(90deg, transparent, transparent 19px, rgba(255, 255, 255, 0.05) 19px, rgba(255, 255, 255, 0.05) 20px);
    }
    
    .harmonia__canvas-svg {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
    }
    
    .harmonia__canvas-nodes {
        position: relative;
        width: 100%;
        min-height: 100%;
    }
    
    /* Properties Editor */
    .harmonia__properties-editor {
        min-height: 200px;
    }
    
    .harmonia__empty-properties {
        text-align: center;
        padding: 24px;
        color: var(--text-secondary, #b0b0b0);
    }
    
    /* Section Header with Actions */
    .harmonia__section-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
    }
    
    .harmonia__section-actions {
        display: flex;
        gap: 8px;
    }
    
    /* Templates */
    .harmonia__template-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }
    
    .harmonia__template-card {
        background-color: var(--bg-secondary, #252535);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        transition: all 0.2s ease;
    }
    
    .harmonia__template-card:hover {
        border-color: #7E57C2;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(126, 87, 194, 0.2);
    }
    
    .harmonia__template-icon {
        font-size: 48px;
        margin-bottom: 12px;
    }
    
    .harmonia__template-name {
        margin: 0 0 8px 0;
        font-size: 1.1rem;
        font-weight: 500;
    }
    
    .harmonia__template-description {
        margin: 0 0 16px 0;
        font-size: 14px;
        color: var(--text-secondary, #b0b0b0);
    }
    
    .harmonia__template-meta {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-bottom: 16px;
        font-size: 13px;
    }
    
    .harmonia__template-actions {
        display: flex;
        gap: 8px;
        justify-content: center;
    }
    
    .harmonia__template-actions-bar {
        display: flex;
        gap: 8px;
        margin-top: 24px;
    }
    
    /* Executions */
    .harmonia__execution-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: 16px;
    }
    
    .harmonia__execution-item {
        background-color: var(--bg-secondary, #252535);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        padding: 16px;
    }
    
    .harmonia__execution-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .harmonia__execution-name {
        margin: 0 0 4px 0;
        font-size: 1.1rem;
        font-weight: 500;
    }
    
    .harmonia__execution-workflow {
        font-size: 13px;
        color: var(--text-secondary, #b0b0b0);
    }
    
    .harmonia__execution-status {
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .harmonia__execution-status--running {
        background-color: rgba(33, 150, 243, 0.2);
        color: #2196F3;
    }
    
    .harmonia__execution-progress {
        margin-bottom: 12px;
    }
    
    .harmonia__progress-bar {
        height: 8px;
        background-color: var(--bg-tertiary, #333345);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 4px;
    }
    
    .harmonia__progress-fill {
        height: 100%;
        background-color: #2196F3;
        transition: width 0.3s ease;
    }
    
    .harmonia__progress-text {
        font-size: 12px;
        color: var(--text-secondary, #b0b0b0);
    }
    
    .harmonia__execution-current {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
        font-size: 14px;
    }
    
    .harmonia__current-label {
        color: var(--text-secondary, #b0b0b0);
    }
    
    .harmonia__current-component {
        color: #7E57C2;
        font-weight: 500;
    }
    
    .harmonia__execution-actions {
        display: flex;
        gap: 8px;
    }
    
    .harmonia__execution-stats {
        display: flex;
        gap: 16px;
        margin-top: 24px;
    }
    
    .harmonia__stat-card {
        flex: 1;
        padding: 16px;
        background-color: var(--bg-secondary, #252535);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        text-align: center;
    }
    
    .harmonia__stat-label {
        display: block;
        font-size: 12px;
        color: var(--text-secondary, #b0b0b0);
        margin-bottom: 8px;
    }
    
    .harmonia__stat-value {
        display: block;
        font-size: 2rem;
        font-weight: 500;
        color: #7E57C2;
    }
    
    /* Component Tasks */
    .harmonia__routing-section {
        margin-bottom: 32px;
    }
    
    .harmonia__routing-table {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 12px;
    }
    
    .harmonia__routing-row {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px 16px;
        background-color: var(--bg-secondary, #252535);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
    }
    
    .harmonia__task-type {
        flex: 1;
        font-weight: 500;
    }
    
    .harmonia__arrow {
        color: var(--text-secondary, #b0b0b0);
    }
    
    .harmonia__component-name {
        flex: 1;
        color: #7E57C2;
        font-weight: 500;
    }
    
    .harmonia__routing-actions {
        display: flex;
        gap: 8px;
    }
    
    .harmonia__component-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }
    
    .harmonia__component-item {
        background-color: var(--bg-secondary, #252535);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        padding: 16px;
    }
    
    .harmonia__component-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }
    
    .harmonia__component-icon {
        font-size: 24px;
    }
    
    .harmonia__component-title {
        font-size: 1.1rem;
        font-weight: 500;
    }
    
    .harmonia__component-actions-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .harmonia__action-tag {
        padding: 4px 8px;
        background-color: var(--bg-tertiary, #333345);
        border-radius: 4px;
        font-size: 12px;
        color: var(--text-primary, #f0f0f0);
    }
    
    /* Review */
    .harmonia__summary-stats {
        display: flex;
        gap: 32px;
        margin: 16px 0;
        padding: 16px;
        background-color: var(--bg-secondary, #252535);
        border-radius: 8px;
    }
    
    .harmonia__stat {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .harmonia__stat-label {
        font-size: 12px;
        color: var(--text-secondary, #b0b0b0);
    }
    
    .harmonia__stat-value {
        font-size: 1.5rem;
        font-weight: 500;
        color: #7E57C2;
    }
    
    .harmonia__review-content {
        margin-top: 16px;
    }
    
    .harmonia__review-section {
        margin-bottom: 24px;
        padding: 16px;
        background-color: var(--bg-secondary, #252535);
        border-radius: 8px;
    }
    
    .harmonia__review-title {
        margin: 0 0 12px 0;
        font-size: 1rem;
        font-weight: 500;
    }
    
    .harmonia__review-list {
        margin: 0;
        padding-left: 20px;
        list-style-type: disc;
    }
    
    .harmonia__export-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin: 16px 0;
    }
    
    .harmonia__checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }
    
    .harmonia__checkbox-label input[type="checkbox"] {
        cursor: pointer;
    }
    
    .harmonia__export-actions {
        display: flex;
        gap: 8px;
        margin-top: 20px;
    }
    
    /* Empty States */
    .harmonia__empty-state {
        text-align: center;
        padding: 48px 24px;
        color: var(--text-secondary, #b0b0b0);
    }
    
    .harmonia__empty-icon {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    
    .harmonia__empty-title {
        margin: 0 0 8px 0;
        font-size: 1.2rem;
        font-weight: 500;
    }
    
    .harmonia__empty-text {
        margin: 0;
        font-size: 14px;
    }
    
    /* Chat Interface - Following Terma's exact pattern */
    .chat-interface {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .chat-message {
        margin-bottom: 12px;
        padding: 8px 12px;
        border-radius: 4px;
        background-color: transparent;
        position: relative;
    }
    
    .chat-message strong {
        display: inline-block;
        margin-right: 8px;
        font-weight: 600;
    }
    
    /* System messages */
    .chat-message.system-message {
        background-color: rgba(126, 87, 194, 0.05);
        border-left: 3px solid #7E57C2;
        font-style: italic;
    }
    
    .chat-message.system-message strong {
        color: #7E57C2;
    }
    
    /* User messages */
    .chat-message.user-message {
        background-color: rgba(76, 175, 80, 0.05);
        border-left: 3px solid #4CAF50;
        margin-left: 0;
    }
    
    .chat-message.user-message strong {
        color: #4CAF50;
    }
    
    /* Footer - Following Terma's pattern */
    .harmonia__footer {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 12px 16px;
        background-color: var(--bg-secondary, #252535);
        border-top: 1px solid var(--border-color, #444444);
        height: 70px;
        box-sizing: border-box;
    }
    
    .harmonia__chat-input-container {
        display: flex;
        gap: 8px;
        align-items: center;
        height: 100%;
    }
    
    .harmonia__chat-prompt {
        color: #7E57C2;
        font-weight: bold;
        font-size: 16px;
        min-width: 20px;
    }
    
    .harmonia__chat-input {
        flex: 1;
        padding: 8px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
        font-size: 14px;
        height: 36px;
        box-sizing: border-box;
    }
    
    .harmonia__chat-input:focus {
        outline: none;
        border-color: #7E57C2;
    }
    
    .harmonia__send-button {
        padding: 8px 16px;
        background-color: #7E57C2;
        border: none;
        border-radius: 4px;
        color: white;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        height: 36px;
        min-width: 60px;
    }
    
    .harmonia__send-button:hover {
        background-color: #6E47B2;
    }
    
    /* Modal Styles - Must be here for proper overlay */
    .harmonia__modal {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.7) !important;
        align-items: center !important;
        justify-content: center !important;
        z-index: 999999 !important;
        /* display controlled by JavaScript - do not set here */
    }
    
    .harmonia__modal[style*="display: flex"] {
        display: flex !important;
    }

    .harmonia__modal-content {
        position: relative;
        background-color: var(--bg-primary, #1a1a2a);
        border: 1px solid var(--border-color, #444444);
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    .harmonia__modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid var(--border-color, #444444);
    }

    .harmonia__modal-title {
        margin: 0;
        font-size: 1.5rem;
        color: #7E57C2;
    }

    .harmonia__modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-secondary, #b0b0b0);
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .harmonia__modal-close:hover {
        background-color: var(--bg-secondary, #252535);
        color: var(--text-primary, #f0f0f0);
    }

    .harmonia__modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .harmonia__modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 20px;
        border-top: 1px solid var(--border-color, #444444);
    }

    /* Template Form Styles */
    .harmonia__template-form {
        display: flex;
        flex-direction: column;
        gap: 32px;
    }

    .harmonia__template-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .harmonia__template-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .harmonia__template-section-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 500;
        color: #7E57C2;
    }

    .harmonia__template-field {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .harmonia__template-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
    }

    .harmonia__template-label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary, #f0f0f0);
    }

    .harmonia__template-input,
    .harmonia__template-select,
    .harmonia__template-textarea {
        padding: 8px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
        font-size: 14px;
    }

    .harmonia__template-input:focus,
    .harmonia__template-select:focus,
    .harmonia__template-textarea:focus {
        outline: none;
        border-color: #7E57C2;
    }

    .harmonia__template-textarea {
        resize: vertical;
        min-height: 80px;
    }

    .harmonia__template-input--small {
        width: 120px;
    }

    /* Template Tasks */
    .harmonia__template-tasks-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .harmonia__template-task {
        background-color: var(--bg-secondary, #252535);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        padding: 16px;
    }

    .harmonia__template-task-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        gap: 12px;
    }

    .harmonia__template-task-header .harmonia__template-input {
        flex: 1;
    }

    .harmonia__template-task-fields {
        display: grid;
        grid-template-columns: 150px 1fr 120px;
        gap: 12px;
    }

    /* Workflow Editor Styles */
    .harmonia__workflow-form {
        display: flex;
        flex-direction: column;
        gap: 32px;
    }

    .harmonia__workflow-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .harmonia__workflow-field {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .harmonia__workflow-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .harmonia__workflow-label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary, #f0f0f0);
    }

    .harmonia__workflow-input,
    .harmonia__workflow-select,
    .harmonia__workflow-textarea {
        padding: 8px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
        font-size: 14px;
    }

    .harmonia__workflow-input:focus,
    .harmonia__workflow-select:focus,
    .harmonia__workflow-textarea:focus {
        outline: none;
        border-color: #7E57C2;
    }

    .harmonia__workflow-textarea {
        resize: vertical;
        min-height: 80px;
    }

    .harmonia__workflow-input--small {
        width: 80px;
    }

    /* Workflow Tasks */
    .harmonia__workflow-tasks-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
        max-height: 400px;
        overflow-y: auto;
    }

    .harmonia__workflow-task {
        background-color: var(--bg-secondary, #252535);
        border: 1px solid var(--border-color, #444444);
        border-radius: 8px;
        padding: 16px;
    }

    .harmonia__workflow-task-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        gap: 12px;
    }

    .harmonia__workflow-task-header .harmonia__workflow-input {
        flex: 1;
    }

    .harmonia__workflow-task-fields {
        display: grid;
        grid-template-columns: 200px 1fr 80px;
        gap: 12px;
        margin-bottom: 12px;
    }

    .harmonia__workflow-task-dependencies {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .harmonia__workflow-task-dependencies .harmonia__workflow-input {
        flex: 1;
    }
</style>

<!-- JavaScript (minimal, following HTML Injection pattern) -->
<script>
// No tab switching needed - handled by CSS with radio buttons

// Sprint actions
function harmonia_viewSprint(sprintId) {
    console.log('[HARMONIA] Viewing sprint:', sprintId);
    // Check the workflows radio button to switch tabs
    document.getElementById('harmonia-tab-workflows').checked = true;
    // Load sprint workflows
    loadSprintWorkflows(sprintId);
}

function harmonia_orchestrateSprint(sprintId) {
    console.log('[HARMONIA] Beginning orchestration for sprint:', sprintId);
    // Check the workflows radio button to switch tabs
    document.getElementById('harmonia-tab-workflows').checked = true;
    // Store current sprint ID
    window.currentSprintId = sprintId;
    // Load sprint tasks for workflow building
    loadSprintTasksForWorkflow(sprintId);
}

// Workflow actions
function harmonia_createWorkflow() {
    console.log('[HARMONIA] Creating new workflow');
    document.getElementById('harmonia-tab-workflows').checked = true;
    // Clear the canvas
    clearWorkflowCanvas();
}

function harmonia_autoLayout() {
    console.log('[HARMONIA] Auto-layout workflow');
    // TODO: Implement auto-layout algorithm
    TektonModal.info('Auto-layout will arrange nodes for optimal readability');
}

// Template actions
function harmonia_previewTemplate(templateId) {
    console.log('[HARMONIA] Previewing template:', templateId);
    // TODO: Show template preview
}

function harmonia_useTemplate(templateId) {
    console.log('[HARMONIA] Using template:', templateId);
    document.getElementById('harmonia-tab-workflows').checked = true;
    // Load template into workflow builder
    loadTemplateIntoBuilder(templateId);
}

// Execution actions
function harmonia_viewExecution(executionId) {
    console.log('[HARMONIA] Viewing execution:', executionId);
    // TODO: Show execution details
}

function harmonia_pauseExecution(executionId) {
    console.log('[HARMONIA] Pausing execution:', executionId);
    // TODO: Pause execution via API
}

function harmonia_cancelExecution(executionId) {
    console.log('[HARMONIA] Cancelling execution:', executionId);
    if (await TektonModal.confirm('Are you sure you want to cancel this execution?')) {
        // TODO: Cancel execution via API
    }
}

// Component routing actions
function harmonia_editMapping(taskType) {
    console.log('[HARMONIA] Editing mapping for:', taskType);
    // TODO: Show mapping editor
}

function harmonia_addComponentAction() {
    console.log('[HARMONIA] Adding component action');
    // TODO: Show action editor
}

// Export actions
function harmonia_exportToSynthesis() {
    console.log('[HARMONIA] Exporting to Synthesis');
    const options = {
        includeTemplates: document.getElementById('include-templates').checked,
        includeErrorHandlers: document.getElementById('include-error-handlers').checked,
        autoStart: document.getElementById('auto-start').checked
    };
    console.log('[HARMONIA] Export options:', options);
    // TODO: Implement export logic
    TektonModal.success('Workflow exported to Synthesis successfully!');
}

function harmonia_previewExport() {
    console.log('[HARMONIA] Previewing export');
    // TODO: Show preview dialog
}

function harmonia_saveDraft() {
    console.log('[HARMONIA] Saving draft');
    // TODO: Save workflow draft
    TektonModal.success('Workflow draft saved');
}

// Initialize chat components
function harmonia_initChats() {
    const workflowChatEl = document.getElementById('harmonia-workflow-messages');
    const teamChatEl = document.getElementById('harmonia-team-messages');
    
    if (window.SingleChat && workflowChatEl) {
        window.SingleChat.init(workflowChatEl, 'harmonia', 'chat-message');
    }
    
    if (window.TeamChat && teamChatEl) {
        window.TeamChat.init(teamChatEl, 'harmonia', 'chat-message');
    }
}

// Chat function already defined at top of file for inline handlers

function harmonia_clearChat() {
    console.log('[HARMONIA] Clearing chat');
    
    const workflowActive = document.getElementById('harmonia-tab-workflow').checked;
    const teamActive = document.getElementById('harmonia-tab-team').checked;
    
    let targetMessages = null;
    
    if (workflowActive) {
        targetMessages = document.getElementById('harmonia-workflow-messages');
    } else if (teamActive) {
        targetMessages = document.getElementById('harmonia-team-messages');
    }
    
    if (targetMessages) {
        // Keep the welcome message (first system message)
        const welcomeMessage = targetMessages.querySelector('.chat-message.system-message');
        targetMessages.innerHTML = '';
        if (welcomeMessage) {
            targetMessages.appendChild(welcomeMessage.cloneNode(true));
        }
    }
    
    return false;
}

// Workflow Builder Functions
let selectedNode = null;
let nodeCounter = 0;
let connections = [];

function addWorkflowNode(type, x, y) {
    const canvas = document.querySelector('.harmonia__canvas-nodes');
    const node = document.createElement('div');
    node.className = 'harmonia__workflow-node';
    node.dataset.nodeId = `node-${++nodeCounter}`;
    node.dataset.nodeType = type;
    node.style.position = 'absolute';
    node.style.left = `${x}px`;
    node.style.top = `${y}px`;
    
    const icons = {
        task: 'üìã',
        decision: 'üîÄ',
        parallel: '‚ö°',
        join: 'üîó'
    };
    
    node.innerHTML = `
        <div class="harmonia__node-icon">${icons[type] || 'üìã'}</div>
        <div class="harmonia__node-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
    `;
    
    node.addEventListener('click', () => selectNode(node));
    canvas.appendChild(node);
    
    return node;
}

function selectNode(node) {
    // Deselect previous
    if (selectedNode) {
        selectedNode.classList.remove('selected');
    }
    
    selectedNode = node;
    node.classList.add('selected');
    
    // Update properties panel
    updatePropertiesPanel(node);
}

function updatePropertiesPanel(node) {
    const editor = document.getElementById('properties-editor');
    const nodeType = node.dataset.nodeType;
    const nodeId = node.dataset.nodeId;
    
    editor.innerHTML = `
        <div class="harmonia__property-group">
            <label class="harmonia__property-label">Node ID</label>
            <input type="text" class="harmonia__property-input" value="${nodeId}" readonly>
        </div>
        <div class="harmonia__property-group">
            <label class="harmonia__property-label">Type</label>
            <input type="text" class="harmonia__property-input" value="${nodeType}" readonly>
        </div>
        <div class="harmonia__property-group">
            <label class="harmonia__property-label">Name</label>
            <input type="text" class="harmonia__property-input" placeholder="Enter node name">
        </div>
        <div class="harmonia__property-group">
            <label class="harmonia__property-label">Description</label>
            <textarea class="harmonia__property-textarea" rows="3" placeholder="Enter description"></textarea>
        </div>
        <button class="harmonia__button harmonia__button--secondary" onclick="deleteNode('${nodeId}')">Delete Node</button>
    `;
}

function deleteNode(nodeId) {
    const node = document.querySelector(`[data-node-id="${nodeId}"]`);
    if (node && await TektonModal.confirm('Delete this node?')) {
        node.remove();
        // Clear properties panel
        document.getElementById('properties-editor').innerHTML = `
            <div class="harmonia__empty-properties">
                <p class="harmonia__text">Select a node to edit its properties</p>
            </div>
        `;
    }
}

function clearWorkflowCanvas() {
    const canvas = document.querySelector('.harmonia__canvas-nodes');
    canvas.innerHTML = '';
    nodeCounter = 0;
    connections = [];
    selectedNode = null;
}

// API Functions
async function loadSprints(statusFilter = 'Ready-2:Harmonia') {
    console.log('[HARMONIA] Loading sprints with status:', statusFilter);
    try {
        const url = statusFilter 
            ? (window.harmoniaUrl ? window.harmoniaUrl(`/api/v1/sprints?status=${encodeURIComponent(statusFilter)}`) : `http://localhost:8007/api/v1/sprints?status=${encodeURIComponent(statusFilter)}`)
            : (window.harmoniaUrl ? window.harmoniaUrl('/api/v1/sprints') : 'http://localhost:8007/api/v1/sprints');
            
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            displaySprints(data.sprints);
        } else {
            console.error('[HARMONIA] Failed to load sprints:', data);
        }
    } catch (error) {
        console.error('[HARMONIA] Error loading sprints:', error);
        // Show example sprint if API fails
        document.getElementById('no-sprints').style.display = 'none';
    }
}

function displaySprints(sprints) {
    const grid = document.getElementById('sprint-grid');
    const emptyState = document.getElementById('no-sprints');
    
    if (!grid) return;
    
    // Clear existing content except example
    const children = Array.from(grid.children);
    children.forEach(child => {
        if (!child.getAttribute('data-sprint-id')?.includes('example')) {
            child.remove();
        }
    });
    
    if (sprints.length === 0) {
        emptyState.style.display = 'block';
        // Hide example card
        const exampleCard = grid.querySelector('[data-sprint-id="example-sprint"]');
        if (exampleCard) exampleCard.style.display = 'none';
    } else {
        emptyState.style.display = 'none';
        // Hide example card
        const exampleCard = grid.querySelector('[data-sprint-id="example-sprint"]');
        if (exampleCard) exampleCard.style.display = 'none';
        
        sprints.forEach(sprint => {
            const card = createSprintCard(sprint);
            grid.appendChild(card);
        });
    }
}

function createSprintCard(sprint) {
    const div = document.createElement('div');
    div.className = 'harmonia__sprint-card';
    div.setAttribute('data-sprint-id', sprint.id);
    
    div.innerHTML = `
        <div class="harmonia__card-header">
            <span class="harmonia__sprint-name">${sprint.name}</span>
            <span class="harmonia__sprint-status harmonia__sprint-status--ready">${sprint.status}</span>
        </div>
        <div class="harmonia__card-body">
            <p class="harmonia__sprint-description">${sprint.description}</p>
            <div class="harmonia__sprint-meta">
                <span class="harmonia__meta-item">
                    <span class="harmonia__meta-label">Tasks:</span>
                    <span class="harmonia__meta-value">${sprint.tasks?.length || 0}</span>
                </span>
                <span class="harmonia__meta-item">
                    <span class="harmonia__meta-label">Total Hours:</span>
                    <span class="harmonia__meta-value">${sprint.total_hours || 0}</span>
                </span>
            </div>
        </div>
        <div class="harmonia__card-actions">
            <button class="harmonia__button harmonia__button--view" onclick="harmonia_viewSprint('${sprint.id}'); return false;"
                    data-tekton-action="view-sprint" data-tekton-trigger="click" 
                    data-tekton-target="workflows-panel">View</button>
            <button class="harmonia__button harmonia__button--edit" onclick="harmonia_orchestrateSprint('${sprint.id}'); return false;"
                    data-tekton-action="orchestrate-sprint" data-tekton-trigger="click" 
                    data-tekton-target="workflow-builder">Begin Orchestration</button>
        </div>
    `;
    
    return div;
}

async function loadSprintTasksForWorkflow(sprintId) {
    console.log('[HARMONIA] Loading tasks for workflow builder:', sprintId);
    try {
        const response = await fetch(window.harmoniaUrl ? window.harmoniaUrl(`/api/v1/sprints/${sprintId}/tasks`) : `http://localhost:8007/api/v1/sprints/${sprintId}/tasks`);
        const data = await response.json();
        
        if (data.success) {
            displayTasksInSidebar(data.tasks);
        } else {
            console.error('[HARMONIA] Failed to load sprint tasks:', data);
        }
    } catch (error) {
        console.error('[HARMONIA] Error loading sprint tasks:', error);
    }
}

function displayTasksInSidebar(tasks) {
    const taskList = document.getElementById('available-tasks');
    if (!taskList) return;
    
    taskList.innerHTML = '';
    
    if (tasks.length === 0) {
        taskList.innerHTML = '<p class="harmonia__text">No tasks available</p>';
        return;
    }
    
    tasks.forEach(task => {
        const taskElement = createDraggableTask(task);
        taskList.appendChild(taskElement);
    });
}

function createDraggableTask(task) {
    const div = document.createElement('div');
    div.className = 'harmonia__task-draggable';
    div.draggable = true;
    div.dataset.taskId = task.id;
    div.dataset.taskType = task.type || 'implementation';
    
    const taskIcons = {
        implementation: 'üíª',
        analysis: 'üìä',
        planning: 'üìã',
        testing: 'üß™',
        documentation: 'üìù'
    };
    
    div.innerHTML = `
        <span class="harmonia__task-icon">${taskIcons[task.type] || 'üìù'}</span>
        <span class="harmonia__task-name">${task.name}</span>
        <span class="harmonia__task-hours">${task.hours}h</span>
    `;
    
    // Add drag event handlers
    div.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('taskId', task.id);
        e.dataTransfer.setData('taskType', task.type);
        e.dataTransfer.setData('taskName', task.name);
    });
    
    return div;
}

// Canvas drag and drop
function setupCanvasDragDrop() {
    const canvas = document.getElementById('workflow-canvas');
    if (!canvas) return;
    
    canvas.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
    });
    
    canvas.addEventListener('drop', (e) => {
        e.preventDefault();
        const taskId = e.dataTransfer.getData('taskId');
        const taskType = e.dataTransfer.getData('taskType');
        const taskName = e.dataTransfer.getData('taskName');
        
        if (taskId) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const node = addWorkflowNode('task', x, y);
            node.dataset.taskId = taskId;
            node.dataset.taskType = taskType;
            node.querySelector('.harmonia__node-title').textContent = taskName;
        }
    });
}

// Toolbar actions
function setupToolbar() {
    const toolButtons = document.querySelectorAll('.harmonia__tool-button[data-tool]');
    toolButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            const tool = button.dataset.tool;
            if (tool) {
                // Add node at center of canvas
                const canvas = document.getElementById('workflow-canvas');
                const rect = canvas.getBoundingClientRect();
                const x = rect.width / 2 - 50;
                const y = rect.height / 2 - 30;
                addWorkflowNode(tool, x, y);
            }
        });
    });
}

// Check for work
function checkForWork() {
    console.log('[HARMONIA] Checking for sprints ready for orchestration');
    fetch(window.harmoniaUrl ? window.harmoniaUrl('/api/v1/workflow') : 'http://localhost:8007/api/v1/workflow', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            purpose: { harmonia: "check_for_sprints" },
            source: "ui_navigation"
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('[HARMONIA] Workflow check response:', data);
        if (data.success && data.count > 0) {
            console.log(`[HARMONIA] Found ${data.count} sprints ready for orchestration`);
            // Load them in the dashboard
            loadSprints('Ready-2:Harmonia');
        }
    })
    .catch(error => {
        console.error('[HARMONIA] Workflow check error:', error);
    });
}

// Initialize on load
window.addEventListener('DOMContentLoaded', function() {
    console.log('[HARMONIA] Component loaded');
    
    // Move modals to body to ensure proper overlay
    const templateModal = document.getElementById('template-modal');
    const workflowModal = document.getElementById('workflow-modal');
    
    if (templateModal && templateModal.parentElement !== document.body) {
        document.body.appendChild(templateModal);
    }
    
    if (workflowModal && workflowModal.parentElement !== document.body) {
        document.body.appendChild(workflowModal);
    }
    
    checkForWork();
    setupCanvasDragDrop();
    setupToolbar();
    
    // Set up event handlers for buttons without onclick
    const createBtn = document.getElementById('workflow-create-btn');
    if (createBtn) {
        createBtn.addEventListener('click', function() {
            harmonia_createWorkflow();
        });
    }
    
    // Template action handlers
    document.querySelectorAll('[data-tekton-action="preview-template"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const card = btn.closest('.harmonia__template-card');
            const templateId = card.dataset.templateId;
            harmonia_previewTemplate(templateId);
        });
    });
    
    document.querySelectorAll('[data-tekton-action="use-template"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const card = btn.closest('.harmonia__template-card');
            const templateId = card.dataset.templateId;
            harmonia_useTemplate(templateId);
        });
    });
    
    // Execution action handlers
    document.querySelectorAll('[data-tekton-action="view-execution"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const item = btn.closest('.harmonia__execution-item');
            const executionId = item.dataset.executionId;
            harmonia_viewExecution(executionId);
        });
    });
    
    document.querySelectorAll('[data-tekton-action="pause-execution"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const item = btn.closest('.harmonia__execution-item');
            const executionId = item.dataset.executionId;
            harmonia_pauseExecution(executionId);
        });
    });
    
    document.querySelectorAll('[data-tekton-action="cancel-execution"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const item = btn.closest('.harmonia__execution-item');
            const executionId = item.dataset.executionId;
            harmonia_cancelExecution(executionId);
        });
    });
    
    // Component routing handlers
    document.querySelectorAll('[data-tekton-action="edit-mapping"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const row = btn.closest('.harmonia__routing-row');
            const taskType = row.querySelector('.harmonia__task-type').textContent;
            harmonia_editMapping(taskType);
        });
    });
    
    const addActionBtn = document.querySelector('[data-tekton-action="add-component-action"]');
    if (addActionBtn) {
        addActionBtn.addEventListener('click', function() {
            harmonia_addComponentAction();
        });
    }
    
    // Export handlers
    const exportBtn = document.querySelector('[data-tekton-action="export-synthesis"]');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            harmonia_exportToSynthesis();
        });
    }
    
    const previewBtn = document.querySelector('[data-tekton-action="preview-export"]');
    if (previewBtn) {
        previewBtn.addEventListener('click', function() {
            harmonia_previewExport();
        });
    }
    
    const saveDraftBtn = document.querySelector('[data-tekton-action="save-draft"]');
    if (saveDraftBtn) {
        saveDraftBtn.addEventListener('click', function() {
            harmonia_saveDraft();
        });
    }
    
    // Template action buttons
    const createTemplateBtn = document.querySelector('[data-tekton-action="create-template"]');
    if (createTemplateBtn) {
        createTemplateBtn.addEventListener('click', function() {
            console.log('[HARMONIA] Creating new template');
            TektonModal.info('Template creator not yet implemented');
        });
    }
    
    const importTemplateBtn = document.querySelector('[data-tekton-action="import-template"]');
    if (importTemplateBtn) {
        importTemplateBtn.addEventListener('click', function() {
            console.log('[HARMONIA] Importing template');
            TektonModal.info('Template import not yet implemented');
        });
    }
});

// Add workflow node styles
const nodeStyles = `
    .harmonia__workflow-node {
        position: absolute;
        width: 100px;
        padding: 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 2px solid var(--border-color, #444444);
        border-radius: 8px;
        text-align: center;
        cursor: move;
        transition: all 0.2s ease;
    }
    
    .harmonia__workflow-node:hover {
        border-color: #7E57C2;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .harmonia__workflow-node.selected {
        border-color: #7E57C2;
        box-shadow: 0 0 0 3px rgba(126, 87, 194, 0.3);
    }
    
    .harmonia__node-icon {
        font-size: 24px;
        margin-bottom: 4px;
    }
    
    .harmonia__node-title {
        font-size: 12px;
        color: var(--text-primary, #f0f0f0);
    }
    
    .harmonia__property-group {
        margin-bottom: 16px;
    }
    
    .harmonia__property-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        font-size: 14px;
    }
    
    .harmonia__property-input,
    .harmonia__property-textarea {
        width: 100%;
        padding: 8px 12px;
        background-color: var(--bg-tertiary, #333345);
        border: 1px solid var(--border-color, #444444);
        border-radius: 4px;
        color: var(--text-primary, #f0f0f0);
        font-size: 14px;
    }
    
    .harmonia__property-textarea {
        resize: vertical;
        min-height: 60px;
    }
`;

// Add node styles to document
const styleSheet = document.createElement('style');
styleSheet.textContent = nodeStyles;
document.head.appendChild(styleSheet);

// Global functions for button handlers with backend API integration
const HARMONIA_API_BASE = window.harmoniaUrl ? window.harmoniaUrl('/api/v1') : 'http://localhost:8007/api/v1';

// Utility function to make API calls
async function harmoniaApiCall(endpoint, method = 'GET', data = null) {
    try {
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            }
        };
        
        if (data && method !== 'GET') {
            options.body = JSON.stringify(data);
        }
        
        const response = await fetch(`${HARMONIA_API_BASE}${endpoint}`, options);
        
        if (!response.ok) {
            throw new Error(`API call failed: ${response.status} ${response.statusText}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('API call error:', error);
        throw error;
    }
}

// Dashboard - Create New Workflow
// Now handled by openWorkflowModal('create') - see workflow modal functions

// Chat - Clear Chat
function clearHarmoniaChat() {
    console.log('Clear harmonia chat');
    const messages = document.getElementById('harmonia-workflow-messages');
    const teamMessages = document.getElementById('harmonia-team-messages');
    if (messages) messages.innerHTML = '<div class="chat-message">Chat cleared.</div>';
    if (teamMessages) teamMessages.innerHTML = '<div class="chat-message">Team chat cleared.</div>';
}

// Templates - Create Template
async function createHarmoniaTemplate() {
    console.log('Create harmonia template');
    
    const templateName = prompt('Enter template name:');
    if (!templateName) return;
    
    const description = prompt('Enter template description:') || '';
    
    try {
        // First create a workflow definition for the template
        const workflowResult = await harmoniaApiCall('/workflows', 'POST', {
            name: `${templateName} Workflow`,
            description: `Workflow definition for ${templateName} template`,
            tasks: {},
            input: {},
            output: {},
            version: "1.0",
            metadata: {
                template: true,
                created_at: new Date().toISOString()
            }
        });
        
        // Note: The backend expects workflow_definition_id, but we don't have the workflow ID from the response
        // This is a limitation of the current API structure - showing the error for now
        TektonModal.info(`Template creation requires workflow definition ID.\nCreated workflow: ${templateName} Workflow\nStatus: ${workflowResult.status}\n\nNote: Template creation needs workflow ID from the response.`);
        
        // Refresh templates view
        loadTemplates();
    } catch (error) {
        TektonModal.error(`Failed to create template: ${error.message}`);
    }
}

// Templates - Import Template
async function importHarmoniaTemplate() {
    console.log('Import harmonia template');
    
    const templateData = prompt('Paste template JSON data (or press OK to see sample format):');
    if (!templateData) {
        // Show sample template format
        const sampleTemplate = {
            "name": "Sample Template",
            "description": "A sample workflow template",
            "workflow_definition": {
                "name": "Sample Workflow",
                "description": "Sample workflow description",
                "tasks": {
                    "task1": {
                        "name": "First Task",
                        "component": "numa",
                        "description": "First task in the workflow"
                    }
                },
                "input": {},
                "output": {},
                "version": "1.0",
                "metadata": {}
            },
            "parameters": {},
            "tags": ["sample"],
            "is_public": true,
            "metadata": {}
        };
        
        TektonModal.info(`Sample Template Format:\n\n${JSON.stringify(sampleTemplate, null, 2)}`);
        return;
    }
    
    try {
        const template = JSON.parse(templateData);
        const result = await harmoniaApiCall('/templates/import', 'POST', template);
        
        TektonModal.success(`Template imported successfully!\nName: ${result.data.name}\nID: ${result.data.template_id}`);
        // Refresh templates view
        loadTemplates();
    } catch (error) {
        if (error.message.includes('JSON') || error.message.includes('Unexpected token')) {
            TektonModal.info('Invalid JSON format. Please check your template data.\n\nUse the sample format shown when you click Import Template without entering data.');
        } else {
            TektonModal.error(`Failed to import template: ${error.message}`);
        }
    }
}

// Templates - Preview Template
async function previewHarmoniaTemplate(templateId) {
    console.log('Preview harmonia template:', templateId);
    
    // For the mock templates in the UI, show predefined previews
    const mockTemplates = {
        'feature-dev': {
            name: 'Feature Development',
            description: 'Standard workflow for new feature implementation with testing and review stages',
            tasks: 4,
            components: ['metis', 'numa', 'athena', 'rhetor'],
            estimatedDuration: '4-6 hours',
            difficulty: 'Medium'
        },
        'bug-fix': {
            name: 'Bug Fix',
            description: 'Quick workflow for bug investigation, fixing, and verification',
            tasks: 3,
            components: ['numa', 'athena'],
            estimatedDuration: '2-3 hours',
            difficulty: 'Easy'
        },
        'refactor': {
            name: 'Code Refactoring',
            description: 'Systematic workflow for code refactoring with safety checks',
            tasks: 5,
            components: ['metis', 'numa', 'athena', 'rhetor'],
            estimatedDuration: '6-8 hours',
            difficulty: 'Hard'
        }
    };
    
    if (mockTemplates[templateId]) {
        const template = mockTemplates[templateId];
        const preview = `Template: ${template.name}

Description: ${template.description}

Tasks: ${template.tasks}
Components: ${template.components.join(', ')}
Estimated Duration: ${template.estimatedDuration}
Difficulty: ${template.difficulty}

This template includes predefined workflow steps optimized for ${template.name.toLowerCase()} scenarios.`;
        
        TektonModal.info(preview);
    } else {
        // Try to load from API for real templates
        try {
            const result = await harmoniaApiCall(`/templates/${templateId}`);
            const template = result.data;
            
            const preview = `Template: ${template.name}
Description: ${template.description || 'No description'}
Tasks: ${Object.keys(template.workflow_definition?.tasks || {}).length}
Created: ${new Date(template.created_at).toLocaleDateString()}
Usage Count: ${template.usage_count || 0}

Tags: ${template.tags?.join(', ') || 'None'}`;
            
            TektonModal.info(preview);
        } catch (error) {
            TektonModal.error(`Failed to load template preview: ${error.message}`);
        }
    }
}

// Templates - Use Template
// Now handled by openWorkflowModal('template') - see workflow modal functions

// Review - Preview Export
async function previewHarmoniaExport() {
    console.log('Preview harmonia export');
    
    // Get current workflow data (mock for now)
    const exportData = {
        workflow_definition: {
            tasks: {},
            dependencies: {},
            component_assignments: {},
            metadata: {
                exported_at: new Date().toISOString(),
                export_format: 'synthesis_v1'
            }
        },
        validation_summary: {
            task_count: 0,
            dependency_count: 0,
            component_count: 0,
            status: 'ready_for_synthesis'
        }
    };
    
    const preview = `Export Preview for Synthesis:

Tasks: ${exportData.validation_summary.task_count}
Dependencies: ${exportData.validation_summary.dependency_count}  
Components: ${exportData.validation_summary.component_count}
Status: ${exportData.validation_summary.status}
Export Time: ${new Date(exportData.workflow_definition.metadata.exported_at).toLocaleString()}

This export will be sent to Synthesis for validation and execution.`;
    
    TektonModal.info(preview);
}

// Review - Save Draft
async function saveHarmoniaDraft() {
    console.log('Save harmonia draft');
    
    try {
        // Check if we have a current workflow ID in the session
        let workflowId = window.currentWorkflowId;
        
        if (!workflowId) {
            // Create a new workflow first
            const workflowName = prompt('Enter name for new workflow:');
            
            // User cancelled the prompt
            if (!workflowName) {
                console.log('User cancelled workflow creation');
                return;
            }
            
            const newWorkflowResult = await harmoniaApiCall('/workflows', 'POST', {
                name: workflowName,
                description: 'Draft workflow created from Harmonia UI',
                tasks: {},
                input: {},
                output: {},
                version: "1.0",
                metadata: { draft: true }
            });
            
            // Extract workflow ID from the response
            if (newWorkflowResult.data && newWorkflowResult.data.workflow_definition) {
                workflowId = newWorkflowResult.data.workflow_definition.id;
                window.currentWorkflowId = workflowId;
            } else {
                throw new Error('Failed to create workflow - no ID returned');
            }
        }
        
        // Save draft data
        const draftData = {
            workflow_state: 'in_progress',
            saved_components: ['numa', 'metis', 'athena'], // Example components
            progress_notes: 'Workflow design in progress',
            saved_at: new Date().toISOString(),
            canvas_state: {
                nodes: nodeCounter,
                connections: connections.length
            }
        };
        
        const result = await harmoniaApiCall(`/workflows/${workflowId}/draft`, 'POST', draftData);
        
        TektonModal.success(`Draft saved successfully!\nWorkflow ID: ${result.data.workflow_id}\nDraft ID: ${result.data.draft_id}\nSaved at: ${new Date(result.data.saved_at).toLocaleString()}`);
        
    } catch (error) {
        console.error('Save draft error:', error);
        // If it's a 404, the workflow doesn't exist
        if (error.message.includes('404')) {
            // Clear the stored workflow ID
            window.currentWorkflowId = null;
            TektonModal.info('The workflow no longer exists. Please create a new workflow first.');
        } else {
            TektonModal.error(`Failed to save draft: ${error.message}`);
        }
    }
}

// Workflow Builder - Auto Layout
function autoLayoutWorkflow() {
    console.log('Auto layout workflow');
    
    // Mock auto-layout functionality
    const canvas = document.getElementById('workflow-canvas');
    if (canvas) {
        // This would trigger actual auto-layout algorithm
        TektonModal.info('Auto Layout Applied\n\nWorkflow nodes have been automatically arranged for optimal visualization.');
    } else {
        TektonModal.info('No workflow canvas found to layout.');
    }
}

// Execution Management Functions
async function pauseExecution(executionId) {
    console.log('Pause execution:', executionId);
    
    // For mock executions, just show a message
    if (executionId.startsWith('exec-')) {
        TektonModal.info(`Pause Execution\n\nThis is a mock execution. In production, this would pause the workflow execution.\n\nExecution ID: ${executionId}`);
        return;
    }
    
    // For real executions, we need to implement the pause endpoint
    TektonModal.info(`Pause Execution\n\nThe pause execution endpoint is not yet implemented in the backend.\n\nExecution ID: ${executionId}\n\nThis feature will be available once the backend API is extended.`);
}

async function resumeExecution(executionId) {
    console.log('Resume execution:', executionId);
    
    // For mock executions, just show a message
    if (executionId.startsWith('exec-')) {
        TektonModal.info(`Resume Execution\n\nThis is a mock execution. In production, this would resume the paused workflow.\n\nExecution ID: ${executionId}`);
        return;
    }
    
    // For real executions, we need to implement the resume endpoint
    TektonModal.info(`Resume Execution\n\nThe resume execution endpoint is not yet implemented in the backend.\n\nExecution ID: ${executionId}\n\nThis feature will be available once the backend API is extended.`);
}

async function cancelExecution(executionId) {
    console.log('Cancel execution:', executionId);
    
    // For mock executions, just show a message
    if (executionId.startsWith('exec-')) {
        if (await TektonModal.confirm('Cancel this mock execution?\n\nIn production, this would stop the workflow and clean up resources.')) {
            TektonModal.info(`Mock execution cancelled.\nExecution ID: ${executionId}`);
            // Hide the execution item
            const execItem = document.querySelector(`[data-execution-id="${executionId}"]`);
            if (execItem) execItem.style.display = 'none';
        }
        return;
    }
    
    // For real executions, we need to implement the cancel endpoint
    if (!await TektonModal.confirm('Are you sure you want to cancel this execution? This action cannot be undone.')) {
        return;
    }
    
    TektonModal.info(`Cancel Execution\n\nThe cancel execution endpoint is not yet implemented in the backend.\n\nExecution ID: ${executionId}\n\nThis feature will be available once the backend API is extended.`);
}

// Component Tasks Management
async function assignComponentTask(taskId, componentName) {
    console.log('Assign component task:', taskId, 'to', componentName);
    
    try {
        const result = await harmoniaApiCall('/component-tasks/assign', 'POST', {
            task_id: taskId,
            component: componentName,
            assignment_time: new Date().toISOString()
        });
        
        TektonModal.success(`Task assigned successfully!\nTask ID: ${taskId}\nComponent: ${componentName}`);
        // Refresh component tasks view
        loadComponentTasks();
    } catch (error) {
        TektonModal.error(`Failed to assign task: ${error.message}`);
    }
}

async function unassignComponentTask(taskId) {
    console.log('Unassign component task:', taskId);
    
    try {
        const result = await harmoniaApiCall(`/component-tasks/${taskId}/unassign`, 'POST');
        TektonModal.success(`Task unassigned successfully.\nTask ID: ${taskId}`);
        // Refresh component tasks view
        loadComponentTasks();
    } catch (error) {
        TektonModal.error(`Failed to unassign task: ${error.message}`);
    }
}

// Data Loading Functions
async function loadDashboardSprints() {
    console.log('Loading dashboard sprints...');
    // This would load Ready-2:Harmonia sprints from the backend
}

async function loadTemplates() {
    console.log('Loading templates...');
    // This would refresh the templates grid
}

async function loadExecutions() {
    console.log('Loading executions...');
    // This would refresh the executions table
}

async function loadComponentTasks() {
    console.log('Loading component tasks...');
    // This would refresh the component tasks view
}

// Additional Functions for Missing Buttons

// Execution Details
async function viewExecutionDetails(executionId) {
    console.log('View execution details:', executionId);
    
    // For mock executions, show mock details
    if (executionId.startsWith('exec-')) {
        const mockDetails = `Execution Details: Feature User Authentication

ID: ${executionId}
Status: Running
Started: ${new Date().toLocaleString()}
Duration: 45 minutes
Tasks Completed: 5 / 11
Current Task: Implementing login endpoint
Component: numa

Progress: 45%

Task Breakdown:
‚úì Design Phase (metis) - 25 min
‚úì Schema Design (metis) - 15 min
‚úì API Design (prometheus) - 20 min
‚úì Setup Project (numa) - 10 min
‚úì Create Models (numa) - 15 min
‚Üí Implement Login (numa) - In Progress
- Implement Registration (numa) - Pending
- Write Tests (athena) - Pending
- Security Review (athena) - Pending
- Documentation (rhetor) - Pending
- Final Review (rhetor) - Pending`;

        TektonModal.info(mockDetails);
        return;
    }
    
    try {
        const result = await harmoniaApiCall(`/executions/${executionId}`);
        const execution = result.data;
        
        const details = `Execution Details: ${execution.workflow_name || 'Unknown'}

ID: ${execution.id}
Status: ${execution.status}
Started: ${new Date(execution.created_at).toLocaleString()}
Duration: ${execution.duration || 'In progress'}
Tasks: ${Object.keys(execution.task_statuses || {}).length}

Current State:
${JSON.stringify(execution.current_state, null, 2)}`;

        TektonModal.info(details);
    } catch (error) {
        TektonModal.error(`Failed to load execution details: ${error.message}\n\nNote: The execution may not exist or the endpoint may not be fully implemented.`);
    }
}

// Component Mapping Management
async function editComponentMapping(taskType, currentComponent) {
    console.log('Edit component mapping:', taskType, 'currently assigned to', currentComponent);
    
    const components = ['numa', 'metis', 'prometheus', 'athena', 'rhetor', 'apollo', 'hermes', 'engram'];
    const newComponent = prompt(`Change ${taskType} tasks assignment from ${currentComponent} to:\n\nAvailable components: ${components.join(', ')}`);
    
    if (!newComponent || !components.includes(newComponent)) {
        if (newComponent) TektonModal.info('Invalid component name. Please choose from the available components.');
        return;
    }
    
    try {
        const result = await harmoniaApiCall('/component-mappings', 'PUT', {
            task_type: taskType,
            component: newComponent,
            previous_component: currentComponent
        });
        
        TektonModal.success(`Mapping updated successfully!\n${taskType} tasks are now assigned to ${newComponent}`);
        
        // Update the UI
        const row = document.querySelector(`[data-task-type="${taskType}"]`);
        if (row) {
            const componentName = row.querySelector('.harmonia__component-name');
            if (componentName) componentName.textContent = newComponent;
        }
        
    } catch (error) {
        TektonModal.error(`Failed to update mapping: ${error.message}`);
    }
}

// Add Component Action
async function addComponentAction() {
    console.log('Add component action');
    
    const componentName = prompt('Enter component name:');
    if (!componentName) return;
    
    const actionName = prompt('Enter action name:');
    if (!actionName) return;
    
    const actionDescription = prompt('Enter action description (optional):') || '';
    
    try {
        const result = await harmoniaApiCall('/component-actions', 'POST', {
            component: componentName,
            action: actionName,
            description: actionDescription,
            parameters: {},
            metadata: {
                created_at: new Date().toISOString()
            }
        });
        
        TektonModal.success(`Component action added successfully!\nComponent: ${componentName}\nAction: ${actionName}`);
        // Refresh component tasks view
        loadComponentTasks();
    } catch (error) {
        TektonModal.error(`Failed to add component action: ${error.message}`);
    }
}

// Dashboard Sprint Functions
async function viewSprint(sprintId) {
    console.log('View sprint:', sprintId);
    
    // Mock sprint data since we don't have sprint API endpoints
    const sprintData = {
        id: sprintId,
        name: 'Example Sprint',
        status: 'Ready-2:Harmonia',
        description: 'This sprint has completed task breakdown in Metis and is ready for workflow orchestration.',
        tasks: 12,
        totalHours: 45,
        completedTasks: 0,
        assignedComponents: ['numa', 'metis', 'athena']
    };
    
    const details = `Sprint Details: ${sprintData.name}

ID: ${sprintData.id}
Status: ${sprintData.status}
Description: ${sprintData.description}

Tasks: ${sprintData.tasks}
Total Hours: ${sprintData.totalHours}
Completed: ${sprintData.completedTasks}/${sprintData.tasks}
Components: ${sprintData.assignedComponents.join(', ')}`;

    TektonModal.info(details);
    
    // Switch to workflows tab to show the sprint
    const workflowsTab = document.querySelector('[data-tab="workflows"]');
    if (workflowsTab) workflowsTab.click();
}

// Now handled by openWorkflowModal('orchestrate') - see workflow modal functions

// Template Modal Functions
function openTemplateModal() {
    const modal = document.getElementById('template-modal');
    if (modal) {
        // Ensure modal is appended to body for proper overlay
        if (modal.parentElement !== document.body) {
            document.body.appendChild(modal);
        }
        modal.style.display = 'flex';
        // Clear form
        document.getElementById('template-name').value = '';
        document.getElementById('template-description').value = '';
        document.getElementById('template-category').value = 'development';
        document.getElementById('template-difficulty').value = 'medium';
        document.getElementById('template-duration').value = '';
        document.getElementById('template-tags').value = '';
        document.getElementById('template-public').checked = true;
        
        // Clear tasks
        const tasksList = document.getElementById('template-tasks-list');
        tasksList.innerHTML = `
            <div class="harmonia__template-task" data-task-index="0">
                <div class="harmonia__template-task-header">
                    <input type="text" class="harmonia__template-input" placeholder="Task Name" data-field="name">
                    <button class="harmonia__button harmonia__button--small harmonia__button--secondary" onclick="removeTemplateTask(0)">Remove</button>
                </div>
                <div class="harmonia__template-task-fields">
                    <select class="harmonia__template-select" data-field="component">
                        <option value="numa">Numa</option>
                        <option value="metis">Metis</option>
                        <option value="prometheus">Prometheus</option>
                        <option value="athena">Athena</option>
                        <option value="rhetor">Rhetor</option>
                        <option value="apollo">Apollo</option>
                        <option value="hermes">Hermes</option>
                        <option value="engram">Engram</option>
                    </select>
                    <input type="text" class="harmonia__template-input" placeholder="Description" data-field="description">
                    <input type="number" class="harmonia__template-input harmonia__template-input--small" placeholder="Timeout (s)" data-field="timeout" value="3600">
                </div>
            </div>
        `;
    }
}

function closeTemplateModal() {
    const modal = document.getElementById('template-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

let templateTaskCounter = 1;

function addTemplateTask() {
    const tasksList = document.getElementById('template-tasks-list');
    const taskIndex = templateTaskCounter++;
    
    const taskDiv = document.createElement('div');
    taskDiv.className = 'harmonia__template-task';
    taskDiv.dataset.taskIndex = taskIndex;
    
    taskDiv.innerHTML = `
        <div class="harmonia__template-task-header">
            <input type="text" class="harmonia__template-input" placeholder="Task Name" data-field="name">
            <button class="harmonia__button harmonia__button--small harmonia__button--secondary" onclick="removeTemplateTask(${taskIndex})">Remove</button>
        </div>
        <div class="harmonia__template-task-fields">
            <select class="harmonia__template-select" data-field="component">
                <option value="numa">Numa</option>
                <option value="metis">Metis</option>
                <option value="prometheus">Prometheus</option>
                <option value="athena">Athena</option>
                <option value="rhetor">Rhetor</option>
                <option value="apollo">Apollo</option>
                <option value="hermes">Hermes</option>
                <option value="engram">Engram</option>
            </select>
            <input type="text" class="harmonia__template-input" placeholder="Description" data-field="description">
            <input type="number" class="harmonia__template-input harmonia__template-input--small" placeholder="Timeout (s)" data-field="timeout" value="3600">
        </div>
    `;
    
    tasksList.appendChild(taskDiv);
}

function removeTemplateTask(index) {
    const task = document.querySelector(`[data-task-index="${index}"]`);
    if (task) {
        task.remove();
    }
}

async function saveTemplate() {
    // Gather form data
    const name = document.getElementById('template-name').value;
    const description = document.getElementById('template-description').value;
    const category = document.getElementById('template-category').value;
    const difficulty = document.getElementById('template-difficulty').value;
    const duration = document.getElementById('template-duration').value;
    const tags = document.getElementById('template-tags').value.split(',').map(t => t.trim()).filter(t => t);
    const isPublic = document.getElementById('template-public').checked;
    
    if (!name) {
        TektonModal.info('Please enter a template name');
        return;
    }
    
    // Gather tasks
    const tasks = {};
    const taskElements = document.querySelectorAll('.harmonia__template-task');
    
    taskElements.forEach((taskEl, index) => {
        const taskName = taskEl.querySelector('[data-field="name"]').value;
        if (taskName) {
            const taskId = `task_${index + 1}`;
            tasks[taskId] = {
                name: taskName,
                description: taskEl.querySelector('[data-field="description"]').value,
                component: taskEl.querySelector('[data-field="component"]').value,
                dependencies: index > 0 ? [`task_${index}`] : [],
                parameters: {},
                timeout: parseInt(taskEl.querySelector('[data-field="timeout"]').value) || 3600
            };
        }
    });
    
    if (Object.keys(tasks).length === 0) {
        TektonModal.info('Please add at least one task');
        return;
    }
    
    // Create template object
    const templateData = {
        name: name,
        description: description,
        workflow_definition: {
            name: `${name} Workflow`,
            description: description,
            tasks: tasks,
            input: {},
            output: {},
            version: "1.0",
            metadata: {
                category: category,
                difficulty: difficulty,
                estimated_duration: duration
            }
        },
        parameters: {},
        tags: tags,
        is_public: isPublic,
        metadata: {
            author: "Harmonia Template System",
            version: "1.0",
            difficulty: difficulty,
            estimated_duration: duration
        },
        usage_count: 0
    };
    
    try {
        const result = await harmoniaApiCall('/templates/import', 'POST', templateData);
        TektonModal.success(`Template created successfully!\nName: ${result.data.name}\nID: ${result.data.template_id}`);
        closeTemplateModal();
        // Refresh templates view
        loadTemplates();
    } catch (error) {
        TektonModal.error(`Failed to create template: ${error.message}`);
    }
}

// Update createHarmoniaTemplate to open modal
window.createHarmoniaTemplate = function() {
    console.log('Opening template creation modal');
    openTemplateModal();
}

// Workflow Editor Modal Functions
function openWorkflowModal(mode = 'create', data = null) {
    const modal = document.getElementById('workflow-modal');
    if (modal) {
        // Ensure modal is appended to body for proper overlay
        if (modal.parentElement !== document.body) {
            document.body.appendChild(modal);
        }
        modal.style.display = 'flex';
        
        // Set mode
        window.workflowEditorMode = mode;
        window.workflowEditorData = data;
        
        // Update modal title based on mode
        const modalTitle = modal.querySelector('.harmonia__modal-title');
        if (mode === 'create') {
            modalTitle.textContent = 'Create New Workflow';
        } else if (mode === 'orchestrate') {
            modalTitle.textContent = 'Orchestrate Sprint Workflow';
        } else if (mode === 'template') {
            modalTitle.textContent = 'Create Workflow from Template';
        }
        
        // Clear or populate form based on mode
        if (mode === 'create') {
            // Clear form for new workflow
            document.getElementById('workflow-name').value = '';
            document.getElementById('workflow-description').value = '';
            document.getElementById('workflow-sprint-id').value = '';
            document.getElementById('workflow-priority').value = 'medium';
            document.getElementById('workflow-auto-start').checked = false;
            clearWorkflowTasks();
        } else if (mode === 'orchestrate' && data) {
            // Populate with sprint data
            document.getElementById('workflow-name').value = `${data.sprintName} Workflow`;
            document.getElementById('workflow-description').value = `Workflow orchestration for ${data.sprintName}`;
            document.getElementById('workflow-sprint-id').value = data.sprintId;
            document.getElementById('workflow-priority').value = 'high';
            document.getElementById('workflow-auto-start').checked = true;
            
            // Load sprint tasks if available
            if (data.tasks) {
                populateWorkflowTasks(data.tasks);
            }
        } else if (mode === 'template' && data) {
            // Populate with template data
            document.getElementById('workflow-name').value = data.name || 'New Workflow from Template';
            document.getElementById('workflow-description').value = data.description || '';
            document.getElementById('workflow-sprint-id').value = '';
            document.getElementById('workflow-priority').value = 'medium';
            document.getElementById('workflow-auto-start').checked = false;
            
            // Load template tasks
            if (data.tasks) {
                populateWorkflowTasks(data.tasks);
            }
        }
    }
}

function closeWorkflowModal() {
    const modal = document.getElementById('workflow-modal');
    if (modal) {
        modal.style.display = 'none';
        window.workflowEditorMode = null;
        window.workflowEditorData = null;
    }
}

function clearWorkflowForm() {
    // Clear all form fields
    document.getElementById('workflow-name').value = '';
    document.getElementById('workflow-description').value = '';
    document.getElementById('workflow-sprint-id').value = '';
    document.getElementById('workflow-priority').value = 'medium';
    document.getElementById('workflow-auto-start').checked = false;
    
    // Clear all tasks and add one empty task
    clearWorkflowTasks();
    
    console.log('Workflow form cleared');
}

let workflowTaskCounter = 0;

function clearWorkflowTasks() {
    const tasksList = document.getElementById('workflow-tasks-list');
    tasksList.innerHTML = '';
    workflowTaskCounter = 0;
    addWorkflowTask(); // Add one empty task
}

function populateWorkflowTasks(tasks) {
    const tasksList = document.getElementById('workflow-tasks-list');
    tasksList.innerHTML = '';
    workflowTaskCounter = 0;
    
    // Convert tasks object or array to list
    const taskArray = Array.isArray(tasks) ? tasks : Object.values(tasks);
    
    taskArray.forEach(task => {
        addWorkflowTask(task);
    });
    
    // Add empty task if none exist
    if (taskArray.length === 0) {
        addWorkflowTask();
    }
}

function addWorkflowTask(taskData = null) {
    const tasksList = document.getElementById('workflow-tasks-list');
    const taskIndex = workflowTaskCounter++;
    
    const taskDiv = document.createElement('div');
    taskDiv.className = 'harmonia__workflow-task';
    taskDiv.dataset.taskIndex = taskIndex;
    
    taskDiv.innerHTML = `
        <div class="harmonia__workflow-task-header">
            <input type="text" class="harmonia__workflow-input" placeholder="Task Name" data-field="name" value="${taskData?.name || ''}">
            <button class="harmonia__button harmonia__button--small harmonia__button--secondary" onclick="removeWorkflowTask(${taskIndex})">Remove</button>
        </div>
        <div class="harmonia__workflow-task-fields">
            <select class="harmonia__workflow-select" data-field="component">
                <option value="">Select Component</option>
                <option value="numa" ${taskData?.component === 'numa' ? 'selected' : ''}>Numa (Implementation)</option>
                <option value="metis" ${taskData?.component === 'metis' ? 'selected' : ''}>Metis (Analysis)</option>
                <option value="prometheus" ${taskData?.component === 'prometheus' ? 'selected' : ''}>Prometheus (Planning)</option>
                <option value="athena" ${taskData?.component === 'athena' ? 'selected' : ''}>Athena (Testing)</option>
                <option value="rhetor" ${taskData?.component === 'rhetor' ? 'selected' : ''}>Rhetor (Documentation)</option>
                <option value="apollo" ${taskData?.component === 'apollo' ? 'selected' : ''}>Apollo (UI/UX)</option>
                <option value="hermes" ${taskData?.component === 'hermes' ? 'selected' : ''}>Hermes (Communication)</option>
                <option value="engram" ${taskData?.component === 'engram' ? 'selected' : ''}>Engram (Memory)</option>
            </select>
            <input type="text" class="harmonia__workflow-input" placeholder="Task Description" data-field="description" value="${taskData?.description || ''}">
            <input type="number" class="harmonia__workflow-input harmonia__workflow-input--small" placeholder="Hours" data-field="hours" value="${taskData?.hours || '8'}">
        </div>
        <div class="harmonia__workflow-task-dependencies">
            <label class="harmonia__workflow-label">Dependencies:</label>
            <input type="text" class="harmonia__workflow-input" placeholder="Comma-separated task names" data-field="dependencies" value="${taskData?.dependencies?.join(', ') || ''}">
        </div>
    `;
    
    tasksList.appendChild(taskDiv);
}

function removeWorkflowTask(index) {
    const task = document.querySelector(`[data-task-index="${index}"]`);
    if (task) {
        task.remove();
    }
}

async function saveWorkflow() {
    // Gather form data
    const name = document.getElementById('workflow-name').value;
    const description = document.getElementById('workflow-description').value;
    const sprintId = document.getElementById('workflow-sprint-id').value;
    const priority = document.getElementById('workflow-priority').value;
    const autoStart = document.getElementById('workflow-auto-start').checked;
    
    if (!name) {
        TektonModal.info('Please enter a workflow name');
        return;
    }
    
    // Gather tasks
    const tasks = {};
    const taskElements = document.querySelectorAll('.harmonia__workflow-task');
    
    taskElements.forEach((taskEl, index) => {
        const taskName = taskEl.querySelector('[data-field="name"]').value;
        if (taskName) {
            const taskId = `task_${index + 1}`;
            const dependencies = taskEl.querySelector('[data-field="dependencies"]').value
                .split(',')
                .map(d => d.trim())
                .filter(d => d);
            
            tasks[taskId] = {
                name: taskName,
                description: taskEl.querySelector('[data-field="description"]').value,
                component: taskEl.querySelector('[data-field="component"]').value || 'numa',
                hours: parseInt(taskEl.querySelector('[data-field="hours"]').value) || 8,
                dependencies: dependencies,
                parameters: {},
                status: 'pending'
            };
        }
    });
    
    if (Object.keys(tasks).length === 0) {
        TektonModal.info('Please add at least one task');
        return;
    }
    
    // Create workflow object
    const workflowData = {
        name: name,
        description: description,
        tasks: tasks,
        input: {
            sprint_id: sprintId || undefined
        },
        output: {
            status: 'string',
            results: 'object'
        },
        version: "1.0",
        metadata: {
            priority: priority,
            auto_start: autoStart,
            created_from: window.workflowEditorMode,
            created_at: new Date().toISOString()
        }
    };
    
    try {
        const result = await harmoniaApiCall('/workflows', 'POST', workflowData);
        
        // Store the workflow ID
        if (result.data && result.data.workflow_definition) {
            window.currentWorkflowId = result.data.workflow_definition.id;
        }
        
        TektonModal.success(`Workflow created successfully!\nName: ${name}\nTasks: ${Object.keys(tasks).length}\nStatus: ${result.status}`);
        
        closeWorkflowModal();
        
        // Switch to workflows tab to see the new workflow
        document.getElementById('harmonia-tab-workflows').checked = true;
        
        // If auto-start is enabled and we're in orchestrate mode, start execution
        if (autoStart && window.workflowEditorMode === 'orchestrate') {
            if (await TektonModal.confirm('Start workflow execution now?')) {
                // Create execution
                const execResult = await harmoniaApiCall('/executions', 'POST', {
                    workflow_id: window.currentWorkflowId,
                    input: workflowData.input,
                    metadata: {
                        started_from: 'workflow_editor',
                        auto_started: true
                    }
                });
                
                if (execResult.success) {
                    TektonModal.info('Workflow execution started!');
                    // Switch to executions tab
                    document.getElementById('harmonia-tab-executions').checked = true;
                }
            }
        }
        
    } catch (error) {
        TektonModal.error(`Failed to create workflow: ${error.message}`);
    }
}

// Update createNewWorkflow to use modal
window.createNewWorkflow = function() {
    console.log('Opening workflow creation modal');
    openWorkflowModal('create');
}

// Update beginOrchestration to use modal
window.beginOrchestration = function(sprintId) {
    console.log('Opening workflow orchestration modal for sprint:', sprintId);
    // In a real implementation, we would load sprint data first
    openWorkflowModal('orchestrate', {
        sprintId: sprintId,
        sprintName: 'Example Sprint',
        tasks: [
            { name: 'Design Phase', component: 'metis', hours: 16 },
            { name: 'Implementation', component: 'numa', hours: 32 },
            { name: 'Testing', component: 'athena', hours: 16 },
            { name: 'Documentation', component: 'rhetor', hours: 8 }
        ]
    });
}

// Update useHarmoniaTemplate to use modal
window.useHarmoniaTemplate = function(templateId) {
    console.log('Opening workflow modal with template:', templateId);
    
    // Mock template data - in real implementation, load from API
    const templates = {
        'feature-dev': {
            name: 'Feature Development',
            description: 'Standard workflow for new feature implementation',
            tasks: [
                { name: 'Design Feature', component: 'metis', hours: 8 },
                { name: 'Implement Feature', component: 'numa', hours: 16 },
                { name: 'Test Feature', component: 'athena', hours: 8 },
                { name: 'Document Feature', component: 'rhetor', hours: 4 }
            ]
        },
        'bug-fix': {
            name: 'Bug Fix',
            description: 'Quick workflow for bug fixes',
            tasks: [
                { name: 'Investigate Bug', component: 'numa', hours: 4 },
                { name: 'Fix Bug', component: 'numa', hours: 8 },
                { name: 'Verify Fix', component: 'athena', hours: 4 }
            ]
        },
        'refactor': {
            name: 'Code Refactoring',
            description: 'Systematic code refactoring workflow',
            tasks: [
                { name: 'Analyze Code', component: 'metis', hours: 8 },
                { name: 'Plan Refactoring', component: 'prometheus', hours: 4 },
                { name: 'Refactor Code', component: 'numa', hours: 16 },
                { name: 'Test Changes', component: 'athena', hours: 8 },
                { name: 'Review Code', component: 'rhetor', hours: 4 }
            ]
        }
    };
    
    const templateData = templates[templateId];
    if (templateData) {
        openWorkflowModal('template', templateData);
    }
}

// Initialize chat when component loads
setTimeout(() => {
    harmonia_initChats();
}, 100);
</script>