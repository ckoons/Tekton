<!-- 
  Rhetor Component - Models Management 
  
  This component provides a web interface for:
  - Multi-provider LLM orchestration and management
  - Intelligent routing of requests to appropriate models  
  - Context management and prompt engineering
  - CI specialist configuration and management
  - Model configuration and testing
  - LLM and team chat interfaces
  
  IMPLEMENTATION:
  - Follows Component Implementation Standard with CSS-first radio button navigation
  - Uses RhetorService for all API interactions
  - Comprehensive error handling and logging
  - Real-time data loading from backend APIs
  
  NAVIGATION:
  - Dashboard: Component status and system overview
  - Models: LLM model configuration and testing
  - Prompts: Template management and prompt engineering  
  - Specialists: CI specialist configuration and management
  - LLM Chat: Direct LLM interaction interface
  - Team Chat: Multi-agent team communication
-->
<!-- @landmark Component: Rhetor - LLM orchestration, prompt engineering, and context management hub -->

<!-- Load chat dependencies -->
<script src="/scripts/shared/tekton-config.js"></script>
<script src="/scripts/shared/ai-chat.js"></script>
<script src="/scripts/shared/single-chat.js"></script>
<script src="/scripts/shared/team-chat.js"></script>


<!-- Hidden radio inputs for CSS-first tab functionality -->
<!-- @landmark Navigation: CSS-first radio buttons for tab switching -->
<input type="radio" name="rhetor-tab" id="tab-dashboard" checked style="display: none;">
<input type="radio" name="rhetor-tab" id="tab-models" style="display: none;">
<input type="radio" name="rhetor-tab" id="tab-prompts" style="display: none;">
<input type="radio" name="rhetor-tab" id="tab-specialists" style="display: none;">
<input type="radio" name="rhetor-tab" id="tab-llmchat" style="display: none;">
<input type="radio" name="rhetor-tab" id="tab-teamchat" style="display: none;">
<div class="rhetor" 
     data-tekton-area="rhetor"
     data-tekton-component="rhetor"
     data-tekton-type="component-workspace"
     data-tekton-ai="rhetor-orchestrator"
     data-tekton-ai-ready="false">
  <!-- Component Header with Title -->
  <!-- @landmark Header: Component title and branding -->
  <div class="rhetor__header" data-tekton-zone="header" data-tekton-section="header">
    <div class="rhetor__title-container">
      <img src="/images/hexagon.jpg" alt="Tekton" class="rhetor__icon">
      <h2 class="rhetor__title">
        <span class="rhetor__title-main">Rhetor</span>
        <span class="rhetor__title-sub">Models</span>
      </h2>
    </div>
  </div>
  
  <!-- Tab Navigation -->
  <!-- @landmark Menu: Tab navigation for 7 component views -->
  <div class="rhetor__menu-bar" data-tekton-zone="menu" data-tekton-nav="component-menu">
    <div class="rhetor__tabs">
      <!-- Dashboard (new default) -->
      <label for="tab-dashboard" class="rhetor__tab" data-tab="dashboard" 
             data-tekton-menu-item="Dashboard"
             data-tekton-menu-component="rhetor"
             data-tekton-menu-panel="dashboard-panel">
        <span class="rhetor__tab-label">Dashboard</span>
      </label>
      <!-- Models (new) -->
      <label for="tab-models" class="rhetor__tab" data-tab="models" 
             data-tekton-menu-item="Models"
             data-tekton-menu-component="rhetor"
             data-tekton-menu-panel="models-panel">
        <span class="rhetor__tab-label">Models</span>
      </label>
      <!-- Prompts (new) -->
      <label for="tab-prompts" class="rhetor__tab" data-tab="prompts" 
             data-tekton-menu-item="Prompts"
             data-tekton-menu-component="rhetor"
             data-tekton-menu-panel="prompts-panel">
        <span class="rhetor__tab-label">Prompts</span>
      </label>
      <!-- Specialists (renamed from CI Specialists) -->
      <label for="tab-specialists" class="rhetor__tab" data-tab="specialists" 
             data-tekton-menu-item="Specialists"
             data-tekton-menu-component="rhetor"
             data-tekton-menu-panel="specialists-panel">
        <span class="rhetor__tab-label">Specialists</span>
      </label>
      <!-- LLM Chat (moved to right) -->
      <label for="tab-llmchat" class="rhetor__tab" data-tab="llmchat" 
             data-tekton-menu-item="LLM Chat"
             data-tekton-menu-component="rhetor"
             data-tekton-menu-panel="llmchat-panel">
        <span class="rhetor__tab-label">Model Chat</span>
      </label>
      <!-- Team Chat (rightmost) -->
      <label for="tab-teamchat" class="rhetor__tab" data-tab="teamchat" 
             data-tekton-menu-item="Team Chat"
             data-tekton-menu-component="rhetor"
             data-tekton-menu-panel="teamchat-panel">
        <span class="rhetor__tab-label">Team Chat</span>
      </label>
    </div>
    <div class="rhetor__actions">
      <!-- Clear button removed per request -->
    </div>
  </div>
  
  <!-- Content Area with Panels -->
  <!-- @landmark Content: Main content area with 7 tab panels -->
  <div class="rhetor__content" data-tekton-zone="content" data-tekton-scrollable="true">
    <!-- Dashboard Tab (New Default) -->
    <!-- @landmark Panel: Dashboard - Component status and system overview -->
    <div id="dashboard-panel" class="rhetor__panel" 
         data-tekton-panel="dashboard"
         data-tekton-panel-for="Dashboard"
         data-tekton-panel-component="rhetor">
      <div class="rhetor__dashboard" data-tekton-element="dashboard-container">
        <!-- Component Status Grid -->
        <div class="rhetor__dashboard-section" data-tekton-section="component-status">
          <h2 class="rhetor__dashboard-title" data-tekton-element="section-title">Component Status</h2>
          <div class="rhetor__component-grid" id="component-status-grid" 
               data-tekton-element="component-grid"
               data-tekton-grid="components">
            <!-- Component cards in order from left panel -->
            <div class="rhetor__component-card" data-component="tekton"
                 data-tekton-element="component-card"
                 data-tekton-component="tekton"
                 data-tekton-state="active">
              <div class="rhetor__component-header" data-tekton-element="component-header">
                <span class="rhetor__component-name" data-tekton-element="component-name">Tekton</span>
                <span class="rhetor__component-status rhetor__component-status--active" 
                      data-tekton-element="component-status"
                      data-tekton-status="active">●</span>
              </div>
              <div class="rhetor__component-metrics" data-tekton-element="component-metrics">
                <div class="rhetor__metric" data-tekton-element="metric">Projects</div>
                <div class="rhetor__metric" data-tekton-element="metric">System OK</div>
              </div>
            </div>
            <div class="rhetor__component-card" data-component="prometheus">
              <div class="rhetor__component-header">
                <span class="rhetor__component-name">Prometheus</span>
                <span class="rhetor__component-status rhetor__component-status--active">●</span>
              </div>
              <div class="rhetor__component-metrics">
                <div class="rhetor__metric">Planning</div>
                <div class="rhetor__metric">3 strategies</div>
              </div>
            </div>
            <div class="rhetor__component-card" data-component="telos">
              <div class="rhetor__component-header">
                <span class="rhetor__component-name">Telos</span>
                <span class="rhetor__component-status rhetor__component-status--active">●</span>
              </div>
              <div class="rhetor__component-metrics">
                <div class="rhetor__metric">Requirements</div>
                <div class="rhetor__metric">12 tracked</div>
              </div>
            </div>
            <div class="rhetor__component-card" data-component="ergon">
              <div class="rhetor__component-header">
                <span class="rhetor__component-name">Ergon</span>
                <span class="rhetor__component-status rhetor__component-status--active">●</span>
              </div>
              <div class="rhetor__component-metrics">
                <div class="rhetor__metric">Agents/Tools</div>
                <div class="rhetor__metric">5 active</div>
              </div>
            </div>
            <div class="rhetor__component-card" data-component="metis">
              <div class="rhetor__component-header">
                <span class="rhetor__component-name">Metis</span>
                <span class="rhetor__component-status rhetor__component-status--active">●</span>
              </div>
              <div class="rhetor__component-metrics">
                <div class="rhetor__metric">Workflows</div>
                <div class="rhetor__metric">2 running</div>
              </div>
            </div>
            <div class="rhetor__component-card" data-component="harmonia">
              <div class="rhetor__component-header">
                <span class="rhetor__component-name">Harmonia</span>
                <span class="rhetor__component-status rhetor__component-status--active">●</span>
              </div>
              <div class="rhetor__component-metrics">
                <div class="rhetor__metric">Orchestration</div>
                <div class="rhetor__metric">Balanced</div>
              </div>
            </div>
            <div class="rhetor__component-card" data-component="synthesis">
              <div class="rhetor__component-header">
                <span class="rhetor__component-name">Synthesis</span>
                <span class="rhetor__component-status rhetor__component-status--active">●</span>
              </div>
              <div class="rhetor__component-metrics">
                <div class="rhetor__metric">Integration</div>
                <div class="rhetor__metric">All synced</div>
              </div>
            </div>
            <div class="rhetor__component-card" data-component="athena">
              <div class="rhetor__component-header">
                <span class="rhetor__component-name">Athena</span>
                <span class="rhetor__component-status rhetor__component-status--active">●</span>
              </div>
              <div class="rhetor__component-metrics">
                <div class="rhetor__metric">Knowledge</div>
                <div class="rhetor__metric">71 entities</div>
              </div>
            </div>
            <div class="rhetor__component-card" data-component="sophia">
              <div class="rhetor__component-header">
                <span class="rhetor__component-name">Sophia</span>
                <span class="rhetor__component-status rhetor__component-status--active">●</span>
              </div>
              <div class="rhetor__component-metrics">
                <div class="rhetor__metric">Learning</div>
                <div class="rhetor__metric">Adapting</div>
              </div>
            </div>
            <div class="rhetor__component-card" data-component="engram">
              <div class="rhetor__component-header">
                <span class="rhetor__component-name">Engram</span>
                <span class="rhetor__component-status rhetor__component-status--inactive">○</span>
              </div>
              <div class="rhetor__component-metrics">
                <div class="rhetor__metric">Memory</div>
                <div class="rhetor__metric">Loading...</div>
              </div>
            </div>
            <div class="rhetor__component-card" data-component="apollo">
              <div class="rhetor__component-header">
                <span class="rhetor__component-name">Apollo</span>
                <span class="rhetor__component-status rhetor__component-status--active">●</span>
              </div>
              <div class="rhetor__component-metrics">
                <div class="rhetor__metric">Attention</div>
                <div class="rhetor__metric">2 focused</div>
              </div>
            </div>
            <div class="rhetor__component-card" data-component="rhetor">
              <div class="rhetor__component-header">
                <span class="rhetor__component-name">Rhetor</span>
                <span class="rhetor__component-status rhetor__component-status--active">●</span>
              </div>
              <div class="rhetor__component-metrics">
                <div class="rhetor__metric">Prompt</div>
                <div class="rhetor__metric">3 models</div>
              </div>
            </div>
            <div class="rhetor__component-card" data-component="penia">
              <div class="rhetor__component-header">
                <span class="rhetor__component-name">Penia</span>
                <span class="rhetor__component-status rhetor__component-status--active">●</span>
              </div>
              <div class="rhetor__component-metrics">
                <div class="rhetor__metric">Cost</div>
                <div class="rhetor__metric">$0.42/hr</div>
              </div>
            </div>
            <div class="rhetor__component-card" data-component="hermes">
              <div class="rhetor__component-header">
                <span class="rhetor__component-name">Hermes</span>
                <span class="rhetor__component-status rhetor__component-status--active">●</span>
              </div>
              <div class="rhetor__component-metrics">
                <div class="rhetor__metric">Messages</div>
                <div class="rhetor__metric">5 clients</div>
              </div>
            </div>
            <div class="rhetor__component-card" data-component="terma">
              <div class="rhetor__component-header">
                <span class="rhetor__component-name">Terma</span>
                <span class="rhetor__component-status rhetor__component-status--active">●</span>
              </div>
              <div class="rhetor__component-metrics">
                <div class="rhetor__metric">Terminals</div>
                <div class="rhetor__metric">Ready</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Lower Section with Specialists and Token Usage -->
        <div class="rhetor__dashboard-lower">
          <!-- Active CI Specialists -->
          <div class="rhetor__dashboard-section rhetor__dashboard-section--half">
            <h3 class="rhetor__dashboard-subtitle">Active CI Specialists</h3>
            <div class="rhetor__specialist-list" id="dashboard-specialist-list">
              <div class="rhetor__specialist-item">
                <span class="rhetor__specialist-name">rhetor-orchestrator</span>
                <span class="rhetor__specialist-model">[Opus]</span>
              </div>
              <div class="rhetor__specialist-item">
                <span class="rhetor__specialist-name">apollo-coordinator</span>
                <span class="rhetor__specialist-model">[Sonnet]</span>
              </div>
              <div class="rhetor__specialist-item">
                <span class="rhetor__specialist-name">hermes-messenger</span>
                <span class="rhetor__specialist-model">[Haiku]</span>
              </div>
              <div class="rhetor__specialist-item">
                <span class="rhetor__specialist-name">athena-analyst</span>
                <span class="rhetor__specialist-model">[Sonnet]</span>
              </div>
              <div class="rhetor__specialist-item">
                <span class="rhetor__specialist-name">prometheus-strategist</span>
                <span class="rhetor__specialist-model">[Opus]</span>
              </div>
              <div class="rhetor__specialist-item">
                <span class="rhetor__specialist-name">telos-planner</span>
                <span class="rhetor__specialist-model">[Haiku]</span>
              </div>
            </div>
          </div>
          
          <!-- Token Usage -->
          <div class="rhetor__dashboard-section rhetor__dashboard-section--half">
            <h3 class="rhetor__dashboard-subtitle">Token Usage (24h)</h3>
            <div class="rhetor__token-stats" id="dashboard-token-stats">
              <div class="rhetor__token-total">
                <span class="rhetor__token-label">Total:</span>
                <span class="rhetor__token-value">1.2M tokens</span>
              </div>
              <div class="rhetor__token-cost">
                <span class="rhetor__token-label">Cost:</span>
                <span class="rhetor__token-value">$42.50</span>
              </div>
              <div class="rhetor__token-breakdown">
                <div class="rhetor__token-bar">
                  <div class="rhetor__token-segment rhetor__token-segment--opus" style="width: 45%;">
                    <span class="rhetor__token-percent">Opus 45%</span>
                  </div>
                  <div class="rhetor__token-segment rhetor__token-segment--sonnet" style="width: 30%;">
                    <span class="rhetor__token-percent">Sonnet 30%</span>
                  </div>
                  <div class="rhetor__token-segment rhetor__token-segment--haiku" style="width: 25%;">
                    <span class="rhetor__token-percent">Haiku 25%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- CI Specialists Tab -->
    <!-- @landmark Panel: Specialists - CI specialist configuration and management -->
    <div id="specialists-panel" class="rhetor__panel" 
         data-tekton-panel="specialists"
         data-tekton-panel-for="Specialists"
         data-tekton-panel-component="rhetor">
      <div class="rhetor__section-header" data-tekton-element="section-header">
        <h2 data-tekton-element="section-title">CI Specialists</h2>
        <div class="rhetor__controls" data-tekton-element="controls">
          <button class="rhetor__button rhetor__button--primary" id="create-specialist-btn"
                  data-tekton-action="create-specialist"
                  data-tekton-action-type="primary">Create Specialist</button>
          <button class="rhetor__button" id="refresh-specialists-btn"
                  data-tekton-action="refresh-specialists"
                  data-tekton-action-type="secondary">Refresh</button>
        </div>
      </div>
      
      <div class="rhetor__settings-section" 
           data-tekton-section="specialists-content"
           data-tekton-scrollable="true"
           style="background-color: #000000; padding: 20px;">
        <style>
          .rhetor__specialists-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
          }
          .rhetor__specialist-card {
            background-color: #000000;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 16px;
          }
          .rhetor__specialist-card strong {
            font-size: 1.1rem;
            display: block;
            margin-bottom: 8px;
          }
          .rhetor__specialist-info {
            font-size: 0.95rem;
            line-height: 1.6;
          }
        </style>
        <div class="rhetor__specialists-grid"
             data-tekton-element="specialists-grid"
             data-tekton-grid="specialists"
             data-tekton-grid-layout="2-column">
          <div class="rhetor__specialist-card">
            <strong style="color: #ff9800;">Apollo</strong>
            <div class="rhetor__specialist-info">
              <div>Model: Claude 3 Opus</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 2KB/1KB</div>
            </div>
          </div>
          <div class="rhetor__specialist-card"
               data-tekton-element="specialist-card"
               data-tekton-component="athena">
            <strong style="color: #3949ab;" data-tekton-element="component-name">Athena</strong>
            <div class="rhetor__specialist-info" data-tekton-element="specialist-info">
              <div data-tekton-element="model-info">Model: Claude 3 Sonnet</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 3KB/1KB</div>
            </div>
          </div>
          <div class="rhetor__specialist-card">
            <strong style="color: #00897b;">Engram</strong>
            <div class="rhetor__specialist-info">
              <div>Model: Claude 3 Haiku</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 2KB/1KB</div>
            </div>
          </div>
          <div class="rhetor__specialist-card">
            <strong style="color: #8e24aa;">Ergon</strong>
            <div class="rhetor__specialist-info">
              <div>Model: Claude 3 Sonnet</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 2KB/1KB</div>
            </div>
          </div>
          <div class="rhetor__specialist-card">
            <strong style="color: #e53935;">Harmonia</strong>
            <div class="rhetor__specialist-info">
              <div>Model: Claude 3 Sonnet</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 2KB/1KB</div>
            </div>
          </div>
          <div class="rhetor__specialist-card">
            <strong style="color: #8d6e63;">Hephaestus</strong>
            <div class="rhetor__specialist-info">
              <div>Model: Claude 3 Haiku</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 1KB/1KB</div>
            </div>
          </div>
          <div class="rhetor__specialist-card">
            <strong style="color: #0097a7;">Hermes</strong>
            <div class="rhetor__specialist-info">
              <div>Model: Claude 3 Haiku</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 1KB/0.5KB</div>
            </div>
          </div>
          <div class="rhetor__specialist-card">
            <strong style="color: #43a047;">Metis</strong>
            <div class="rhetor__specialist-info">
              <div>Model: Claude 3 Sonnet</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 2KB/1KB</div>
            </div>
          </div>
          <div class="rhetor__specialist-card">
            <strong style="color: #fdd835;">Penia</strong>
            <div class="rhetor__specialist-info">
              <div>Model: Claude 3 Haiku</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 1KB/0.5KB</div>
            </div>
          </div>
          <div class="rhetor__specialist-card">
            <strong style="color: #ff5722;">Prometheus</strong>
            <div class="rhetor__specialist-info">
              <div>Model: Claude 3 Opus</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 3KB/2KB</div>
            </div>
          </div>
          <div class="rhetor__specialist-card">
            <strong style="color: #6a1b9a;">Rhetor</strong>
            <div class="rhetor__specialist-info">
              <div>Model: Claude 3 Opus</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 4KB/2KB</div>
            </div>
          </div>
          <div class="rhetor__specialist-card">
            <strong style="color: #512da8;">Sophia</strong>
            <div class="rhetor__specialist-info">
              <div>Model: Claude 3 Opus</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 3KB/2KB</div>
            </div>
          </div>
          <div class="rhetor__specialist-card">
            <strong style="color: #607d8b;">Synthesis</strong>
            <div class="rhetor__specialist-info">
              <div>Model: Claude 3 Opus</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 3KB/2KB</div>
            </div>
          </div>
          <div class="rhetor__specialist-card">
            <strong style="color: #7E57C2;">Tekton</strong>
            <div class="rhetor__specialist-info">
              <div>Model: Claude 3 Opus</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 4KB/2KB</div>
            </div>
          </div>
          <div class="rhetor__specialist-card">
            <strong style="color: #1976d2;">Telos</strong>
            <div class="rhetor__specialist-info">
              <div>Model: Claude 3 Sonnet</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 2KB/1KB</div>
            </div>
          </div>
          <div class="rhetor__specialist-card">
            <strong style="color: #37474f;">Terma</strong>
            <div class="rhetor__specialist-info">
              <div>Model: Claude 3 Haiku</div>
              <div>Prompts: 3 layers</div>
              <div>Context: 1KB/0.5KB</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Orchestration Tab -->
    <div id="orchestration-panel" class="rhetor__panel">
      <div class="rhetor__section-header">
        <h2>Orchestration Settings</h2>
      </div>
      
      <div class="rhetor__settings-section">
        <h3>Message Routing</h3>
        <div class="rhetor__form-group">
          <label class="rhetor__form-label">Orchestration Mode</label>
          <select class="rhetor__form-select" id="orchestration-mode" data-tekton-select="option">
            <option value="passive">Passive Monitor</option>
            <option value="active" selected>Active Coordinator</option>
            <option value="translator">Universal Translator</option>
          </select>
        </div>
        
        <div class="rhetor__form-group">
          <label class="rhetor__form-label">Auto-Translation</label>
          <div class="rhetor__checkbox-group">
            <label class="rhetor__checkbox">
              <input type="checkbox" id="auto-translate" checked
                     data-tekton-input="auto-translate"
                     data-tekton-input-type="toggle"> Enable automatic translation between CI specialists
            </label>
          </div>
        </div>
        
        <div class="rhetor__form-group">
          <label class="rhetor__form-label">Message Filtering</label>
          <div class="rhetor__checkbox-group">
            <label class="rhetor__checkbox">
              <input type="checkbox" id="filter-redundant" checked
                     data-tekton-input="filter-redundant"
                     data-tekton-input-type="toggle"> Filter redundant messages
            </label>
            <label class="rhetor__checkbox">
              <input type="checkbox" id="filter-errors"
                     data-tekton-input="filter-errors"
                     data-tekton-input-type="toggle"> Filter error messages
            </label>
            <label class="rhetor__checkbox">
              <input type="checkbox" id="summarize-verbose"
                     data-tekton-input="summarize-verbose"
                     data-tekton-input-type="toggle"> Summarize verbose exchanges
            </label>
          </div>
        </div>
        
        <div class="rhetor__form-actions">
          <button class="rhetor__button rhetor__button--primary" onclick="rhetor_saveOrchestration()"
                  data-tekton-action="save-orchestration"
                  data-tekton-action-type="primary">Save Settings</button>
        </div>
      </div>
    </div>
    
    <!-- Active Sessions Tab -->
    <div id="sessions-panel" class="rhetor__panel">
      <div class="rhetor__section-header">
        <h2>Active CI Sessions</h2>
        <div class="rhetor__controls">
          <button class="rhetor__button rhetor__button--primary" onclick="rhetor_createSession()"
                  data-tekton-action="create-session"
                  data-tekton-action-type="primary">New Session</button>
          <button class="rhetor__button" onclick="rhetor_refreshSessions()"
                  data-tekton-action="refresh-sessions"
                  data-tekton-action-type="secondary">Refresh</button>
        </div>
      </div>
      
      <div class="rhetor__sessions-list" id="sessions-list">
        <!-- Active sessions will be dynamically inserted here -->
        <div class="rhetor__empty-state">No active CI sessions. Create a new session to begin.</div>
      </div>
    </div>
    
    <!-- Configuration Tab -->
    <div id="configuration-panel" class="rhetor__panel">
      <div class="rhetor__section-header">
        <h2>CI Configuration</h2>
      </div>
      
      <div class="rhetor__settings-section">
        <h3>Model Settings</h3>
        <div class="rhetor__form-group">
          <label class="rhetor__form-label">Anthropic Max Account</label>
          <div class="rhetor__checkbox-group">
            <label class="rhetor__checkbox">
              <input type="checkbox" id="anthropic-max" onchange="rhetor_toggleAnthropicMax()"
                     data-tekton-input="anthropic-max"
                     data-tekton-input-type="toggle"> Use Anthropic Max (Unlimited tokens for testing)
            </label>
          </div>
        </div>
        
        <h3>Default Models by Specialist Type</h3>
        <div class="rhetor__model-config">
          <div class="rhetor__form-group">
            <label class="rhetor__form-label">Orchestrator (Meta-AI)</label>
            <select class="rhetor__form-select" id="model-orchestrator" data-tekton-select="option">
              <option value="claude-3-opus-20240229" selected>Claude 3 Opus</option>
              <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
              <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
            </select>
          </div>
          
          <div class="rhetor__form-group">
            <label class="rhetor__form-label">Memory Specialist</label>
            <select class="rhetor__form-select" id="model-memory" data-tekton-select="option">
              <option value="claude-3-haiku-20240307" selected>Claude 3 Haiku</option>
              <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
            </select>
          </div>
          
          <div class="rhetor__form-group">
            <label class="rhetor__form-label">Executive Coordinator</label>
            <select class="rhetor__form-select" id="model-coordinator" data-tekton-select="option">
              <option value="claude-3-sonnet-20240229" selected>Claude 3 Sonnet</option>
              <option value="claude-3-opus-20240229">Claude 3 Opus</option>
            </select>
          </div>
        </div>
        
        <div class="rhetor__form-actions">
          <button class="rhetor__button rhetor__button--primary" onclick="rhetor_saveConfiguration()"
                  data-tekton-action="save-configuration"
                  data-tekton-action-type="primary">Save Configuration</button>
        </div>
      </div>
    </div>
    
    <!-- LLM Chat Tab -->
    <!-- @landmark Panel: LLM Chat - Direct LLM interaction interface -->
    <div id="llmchat-panel" class="rhetor__panel" data-tekton-chat="rhetor-llm" data-tekton-ai="rhetor-orchestrator" data-tekton-ai-ready="false">
      <div id="llmchat-messages" class="rhetor__chat-messages" data-tekton-element="chat-messages" data-component-name="rhetor" data-css-prefix="rhetor">
        <div class="rhetor__message rhetor__message--system">
          <div class="rhetor__message-content">
            <div class="rhetor__message-text">
              <h3 class="rhetor__message-title">Rhetor LLM Chat</h3>
              <p>You can ask questions about LLM capabilities, prompt templates, and context management. Try questions like:</p>
              <ul>
                <li>What models are currently available?</li>
                <li>How can I optimize prompts for specific tasks?</li>
                <li>What context management features are available?</li>
                <li>How can I adjust model parameters for different use cases?</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Team Chat Tab -->
    <!-- @landmark Panel: Team Chat - Multi-agent team communication -->
    <div id="teamchat-panel" class="rhetor__panel" 
         data-tekton-panel="teamchat"
         data-tekton-panel-for="Team Chat"
         data-tekton-panel-component="rhetor"
         data-tekton-chat="team" 
         data-tekton-ai="rhetor-orchestrator" 
         data-tekton-ai-ready="false">
      <div id="teamchat-messages" class="rhetor__chat-messages" data-tekton-element="chat-messages">
        <div class="rhetor__message rhetor__message--system">
          <div class="rhetor__message-content">
            <div class="rhetor__message-text">
              <h3 class="rhetor__message-title">Tekton Team Chat</h3>
              <p>This is a multi-specialist collaboration space. Rhetor facilitates discussions between all Tekton components. Try questions like:</p>
              <ul>
                <li>How can we optimize the knowledge graph structure?</li>
                <li>What patterns should we use for cross-component communication?</li>
                <li>How can memory and prediction work together?</li>
                <li>What's the best approach for distributed task management?</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Models Tab -->
    <!-- @landmark Panel: Models - LLM model configuration and testing -->
    <div id="models-panel" class="rhetor__panel"
         data-tekton-panel="models"
         data-tekton-panel-for="Models"
         data-tekton-panel-component="rhetor">
      <div class="rhetor__models-container" data-tekton-scrollable="true">
        <!-- Provider Status Section -->
        <div class="rhetor__models-section" data-tekton-section="provider-status">
          <h3 class="rhetor__models-section-title" data-tekton-element="section-title">Provider Status</h3>
          <div class="rhetor__provider-grid" 
               data-tekton-element="provider-grid"
               data-tekton-grid="providers">
            <!-- Anthropic -->
            <div class="rhetor__provider-card rhetor__provider-card--active" data-provider="anthropic"
                 data-tekton-element="provider-card"
                 data-tekton-provider="anthropic"
                 data-tekton-state="active">
              <div class="rhetor__provider-header" data-tekton-element="provider-header">
                <span class="rhetor__provider-name" data-tekton-element="provider-name">Anthropic</span>
                <span class="rhetor__provider-status" 
                      data-tekton-element="provider-status"
                      data-tekton-status="active">●</span>
              </div>
              <div class="rhetor__provider-info">
                <span class="rhetor__provider-models">3 models</span>
                <label class="rhetor__provider-toggle">
                  <input type="checkbox" checked>
                  <span class="rhetor__provider-toggle-slider"></span>
                </label>
              </div>
            </div>
            <!-- Ollama -->
            <div class="rhetor__provider-card rhetor__provider-card--active" data-provider="ollama">
              <div class="rhetor__provider-header">
                <span class="rhetor__provider-name">Ollama</span>
                <span class="rhetor__provider-status">●</span>
              </div>
              <div class="rhetor__provider-info">
                <span class="rhetor__provider-models">9 models</span>
                <label class="rhetor__provider-toggle">
                  <input type="checkbox" checked>
                  <span class="rhetor__provider-toggle-slider"></span>
                </label>
              </div>
            </div>
            <!-- OpenAI -->
            <div class="rhetor__provider-card rhetor__provider-card--active" data-provider="openai">
              <div class="rhetor__provider-header">
                <span class="rhetor__provider-name">OpenAI</span>
                <span class="rhetor__provider-status">●</span>
              </div>
              <div class="rhetor__provider-info">
                <span class="rhetor__provider-models">4 models</span>
                <label class="rhetor__provider-toggle">
                  <input type="checkbox" checked>
                  <span class="rhetor__provider-toggle-slider"></span>
                </label>
              </div>
            </div>
            <!-- X/AI -->
            <div class="rhetor__provider-card rhetor__provider-card--active" data-provider="xai">
              <div class="rhetor__provider-header">
                <span class="rhetor__provider-name">X/AI</span>
                <span class="rhetor__provider-status">●</span>
              </div>
              <div class="rhetor__provider-info">
                <span class="rhetor__provider-models">4 models</span>
                <label class="rhetor__provider-toggle">
                  <input type="checkbox" checked>
                  <span class="rhetor__provider-toggle-slider"></span>
                </label>
              </div>
            </div>
            <!-- Gemini -->
            <div class="rhetor__provider-card rhetor__provider-card--active" data-provider="gemini">
              <div class="rhetor__provider-header">
                <span class="rhetor__provider-name">Gemini</span>
                <span class="rhetor__provider-status">●</span>
              </div>
              <div class="rhetor__provider-info">
                <span class="rhetor__provider-models">3 models</span>
                <label class="rhetor__provider-toggle">
                  <input type="checkbox" checked>
                  <span class="rhetor__provider-toggle-slider"></span>
                </label>
              </div>
            </div>
            <!-- Others / Add Provider -->
            <div class="rhetor__provider-card rhetor__provider-card--add" data-provider="add-provider">
              <div class="rhetor__provider-header">
                <span class="rhetor__provider-name">Add Provider</span>
                <span class="rhetor__provider-status">+</span>
              </div>
              <div class="rhetor__provider-info">
                <button class="rhetor__provider-configure" onclick="window.rhetor_showAddProviderDialog()">Configure New</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Model Assignment Matrix -->
        <div class="rhetor__models-section">
          <div class="rhetor__models-section-header">
            <h3 class="rhetor__models-section-title">Model Assignment Matrix</h3>
            <div class="rhetor__matrix-actions">
              <button class="rhetor__button rhetor__button--error" onclick="window.rhetor_saveModelConfig()"
                      id="rhetor-save-models-btn"
                      data-tekton-action="save-models">Save</button>
              <span id="rhetor-save-status" class="rhetor__save-status"></span>
            </div>
          </div>
          <div class="rhetor__matrix-container">
            <table class="rhetor__model-matrix">
              <thead>
                <tr>
                  <th class="rhetor__matrix-component">Component</th>
                  <th class="rhetor__matrix-task">Code</th>
                  <th class="rhetor__matrix-task">Planning</th>
                  <th class="rhetor__matrix-task">Reasoning</th>
                  <th class="rhetor__matrix-task">Chat</th>
                </tr>
              </thead>
              <tbody>
                <!-- Default Row -->
                <tr class="rhetor__matrix-row rhetor__matrix-row--default">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Default</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="default" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="default" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="default" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="default" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                
                <!-- CI Selector Row (new) -->
                <tr class="rhetor__matrix-row rhetor__matrix-row--ci-selector">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Select CI</span>
                    <select id="models-ci-selector" class="rhetor__ci-model-selector" onchange="rhetor_loadCIModelAssignment()">
                      <option value="">Choose CI...</option>
                      <optgroup label="Specialists">
                        <option value="ergon">Ergon</option>
                        <option value="rhetor">Rhetor</option>
                        <option value="noesis">Noesis</option>
                        <option value="athena">Athena</option>
                        <option value="hermes">Hermes</option>
                        <option value="sophia">Sophia</option>
                        <option value="apollo">Apollo</option>
                        <option value="hephaestus">Hephaestus</option>
                        <option value="terma">Terma</option>
                        <option value="neurosyne">NeuroSyne</option>
                        <option value="penia">Penia</option>
                        <option value="harmonia">Harmonia</option>
                        <option value="synthesis">Synthesis</option>
                        <option value="metis">Metis</option>
                        <option value="telos">Telos</option>
                        <option value="prometheus">Prometheus</option>
                        <option value="numa">Numa</option>
                        <option value="tekton">Tekton</option>
                      </optgroup>
                      <optgroup label="Terminals">
                        <option value="terminal-ergon">Terminal Ergon</option>
                        <option value="terminal-rhetor">Terminal Rhetor</option>
                        <option value="terminal-noesis">Terminal Noesis</option>
                        <option value="terminal-athena">Terminal Athena</option>
                        <option value="terminal-hermes">Terminal Hermes</option>
                        <option value="terminal-sophia">Terminal Sophia</option>
                        <option value="terminal-apollo">Terminal Apollo</option>
                        <option value="terminal-hephaestus">Terminal Hephaestus</option>
                      </optgroup>
                      <optgroup label="Projects">
                        <option value="project-alpha">Project Alpha</option>
                        <option value="project-beta">Project Beta</option>
                        <option value="project-gamma">Project Gamma</option>
                        <option value="project-delta">Project Delta</option>
                      </optgroup>
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="selected-ci" data-task="code" id="selected-ci-code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="selected-ci" data-task="planning" id="selected-ci-planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="selected-ci" data-task="reasoning" id="selected-ci-reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="selected-ci" data-task="chat" id="selected-ci-chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                
                <!-- Component Rows (Alphabetical) -->
                <!-- Apollo -->
                <tr class="rhetor__matrix-row">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Apollo</span>
                    <span class="rhetor__component-desc">Insight</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="apollo" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="apollo" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="apollo" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="apollo" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                <!-- Athena -->
                <tr class="rhetor__matrix-row">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Athena</span>
                    <span class="rhetor__component-desc">Knowledge</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="athena" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="athena" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="athena" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="athena" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                <!-- Engram -->
                <tr class="rhetor__matrix-row">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Engram</span>
                    <span class="rhetor__component-desc">Memory</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="engram" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="engram" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="engram" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="engram" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                <!-- Ergon -->
                <tr class="rhetor__matrix-row">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Ergon</span>
                    <span class="rhetor__component-desc">Solutions</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="ergon" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="ergon" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="ergon" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="ergon" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                <!-- Harmonia -->
                <tr class="rhetor__matrix-row">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Harmonia</span>
                    <span class="rhetor__component-desc">Orchestration</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="harmonia" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="harmonia" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="harmonia" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="harmonia" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                <!-- Hermes -->
                <tr class="rhetor__matrix-row">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Hermes</span>
                    <span class="rhetor__component-desc">Federation</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="hermes" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="hermes" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="hermes" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="hermes" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                <!-- Metis -->
                <tr class="rhetor__matrix-row">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Metis</span>
                    <span class="rhetor__component-desc">Workflows</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="metis" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="metis" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="metis" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="metis" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                <!-- Penia -->
                <tr class="rhetor__matrix-row">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Penia</span>
                    <span class="rhetor__component-desc">Cost</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="penia" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="penia" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="penia" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="penia" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                <!-- Prometheus -->
                <tr class="rhetor__matrix-row">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Prometheus</span>
                    <span class="rhetor__component-desc">Planning</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="prometheus" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="prometheus" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="prometheus" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="prometheus" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                <!-- Rhetor -->
                <tr class="rhetor__matrix-row">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Rhetor</span>
                    <span class="rhetor__component-desc">Models</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="rhetor" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="rhetor" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="rhetor" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="rhetor" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                <!-- Sophia -->
                <tr class="rhetor__matrix-row">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Sophia</span>
                    <span class="rhetor__component-desc">Learning</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="sophia" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="sophia" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="sophia" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="sophia" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                <!-- Synthesis -->
                <tr class="rhetor__matrix-row">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Synthesis</span>
                    <span class="rhetor__component-desc">Integration</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="synthesis" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="synthesis" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="synthesis" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="synthesis" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                <!-- Tekton Core -->
                <tr class="rhetor__matrix-row">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Tekton Core</span>
                    <span class="rhetor__component-desc">Projects</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="tekton" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="tekton" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="tekton" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="tekton" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                <!-- Telos -->
                <tr class="rhetor__matrix-row">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Telos</span>
                    <span class="rhetor__component-desc">Requirements</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="telos" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="telos" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="telos" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="telos" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
                <!-- Terma -->
                <tr class="rhetor__matrix-row">
                  <td class="rhetor__matrix-component">
                    <span class="rhetor__component-name">Terma</span>
                    <span class="rhetor__component-desc">Terminals</span>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="terma" data-task="code">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="terma" data-task="planning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="terma" data-task="reasoning">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                  <td class="rhetor__matrix-cell">
                    <select class="rhetor__model-select" data-component="terma" data-task="chat">
                      <!-- Populated dynamically -->
                    </select>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Model Testing Section -->
        <div class="rhetor__models-section">
          <h3 class="rhetor__models-section-title">Model Testing</h3>
          <div class="rhetor__test-container">
            <div class="rhetor__test-controls">
              <select class="rhetor__test-model-select" id="test-model-select" data-tekton-select="option">
                <option value="">Select a model to test...</option>
                <optgroup label="Anthropic">
                  <option value="claude-3-opus">Claude 3 Opus</option>
                  <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                  <option value="claude-3-haiku">Claude 3 Haiku</option>
                </optgroup>
                <optgroup label="Ollama (Local)">
                  <option value="llama3">Llama 3</option>
                  <option value="mixtral">Mixtral</option>
                  <option value="mistral">Mistral</option>
                </optgroup>
                <optgroup label="OpenAI">
                  <option value="gpt-4">GPT-4</option>
                  <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                </optgroup>
              </select>
              <textarea class="rhetor__test-input" id="test-input" placeholder="Enter a test prompt..." rows="3"></textarea>
              <button class="rhetor__button rhetor__button--primary" onclick="rhetor_testModel()">Test Model</button>
            </div>
            <div class="rhetor__test-results" id="test-results" style="display: none;">
              <div class="rhetor__test-metrics">
                <span class="rhetor__test-metric">
                  <strong>Response Time:</strong> <span id="test-response-time">-</span>
                </span>
                <span class="rhetor__test-metric">
                  <strong>Tokens:</strong> <span id="test-tokens">-</span>
                </span>
                <span class="rhetor__test-metric">
                  <strong>Cost:</strong> <span id="test-cost">-</span>
                </span>
              </div>
              <div class="rhetor__test-output" id="test-output"></div>
            </div>
          </div>
        </div>
        
        <!-- Anthropic Max Section (moved to bottom) -->
        <div class="rhetor__models-section rhetor__models-section--highlight">
          <h3 class="rhetor__models-section-title">Anthropic Max Account</h3>
          <div class="rhetor__max-control">
            <div class="rhetor__max-info">
              <p>Enable unlimited token usage for testing and development</p>
              <p class="rhetor__max-warning">⚠️ Production use will incur costs</p>
            </div>
            <label class="rhetor__max-toggle">
              <input type="checkbox" id="anthropic-max-toggle">
              <span class="rhetor__max-toggle-slider"></span>
              <span class="rhetor__max-toggle-label">Disabled</span>
            </label>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Prompts Tab -->
    <!-- @landmark Panel: Prompts - Template management and prompt engineering -->
    <div id="prompts-panel" class="rhetor__panel"
         data-tekton-panel="prompts"
         data-tekton-panel-for="Prompts"
         data-tekton-panel-component="rhetor">
      <div class="rhetor__prompts-container" data-tekton-scrollable="true">
        <!-- Prompt History Section (new) -->
        <div class="rhetor__prompts-section rhetor__prompt-history-section" id="prompt-history-section">
          <!-- Compact Header with CI Selector on Same Line -->
          <div class="rhetor__prompt-history-header" style="height: 2.5rem; margin-bottom: 15px;">
            <h3 class="rhetor__prompts-section-title" style="margin: 0; line-height: 2.5rem; display: flex; align-items: center; gap: 10px;">
              Prompt History: <span id="prompt-history-ci-name" style="color: #9c27b0;">No CI Selected</span>
              <select id="rhetor-ci-selector" class="rhetor__ci-selector" onchange="rhetor_loadCIPromptHistory()" style="margin-left: auto; margin-right: 10px; width: 200px;">
                <option value="">Choose CI...</option>
              </select>
            </h3>
            <div class="rhetor__prompt-history-controls">
              <button class="rhetor__prompts-button rhetor__prompts-button--secondary" onclick="rhetor_refreshPromptHistory()">
                🔄 Refresh
              </button>
              <button class="rhetor__prompts-button rhetor__prompts-button--secondary" onclick="rhetor_clearPromptEdit()">
                ✖ Clear Edit
              </button>
            </div>
          </div>
          
          <!-- Scrollable Prompt History -->
          <div class="rhetor__prompt-history-container">
            <textarea id="prompt-history-editor" 
                      class="rhetor__prompt-history-editor"
                      placeholder="Select a CI to view and edit prompt history..."
                      rows="8"></textarea>
            <div class="rhetor__prompt-history-info">
              <span id="prompt-history-timestamp">No prompt selected</span>
              <span id="prompt-history-status">Ready</span>
            </div>
          </div>
          
          <!-- Navigation and Send Buttons -->
          <div class="rhetor__prompt-history-actions">
            <button id="rhetor-prev-prompt" 
                    class="rhetor__prompts-button rhetor__prompts-button--prev"
                    onclick="rhetor_previousPrompt()">
              ← Prev
            </button>
            <button id="rhetor-next-prompt" 
                    class="rhetor__prompts-button rhetor__prompts-button--next"
                    onclick="rhetor_nextPrompt()">
              Next →
            </button>
            <button id="rhetor-send-prompt" 
                    class="rhetor__prompts-button rhetor__prompts-button--send"
                    onclick="rhetor_sendPromptToCI()"
                    disabled>
              Send
            </button>
            <span class="rhetor__prompt-send-status" id="prompt-send-status"></span>
          </div>
        </div>
        
        <!-- Multi-Prompt Editor (hidden by default, shown when component selected) -->
        <div class="rhetor__prompts-section rhetor__multi-prompt-editor" data-component-editor="true" style="display: none;">
          <div class="rhetor__multi-prompt-header">
            <h3 class="rhetor__prompts-section-title">
              <span class="rhetor__multi-prompt-component-name">Athena - Knowledge</span> Prompt Configuration
            </h3>
            <button class="rhetor__prompts-button rhetor__prompts-button--secondary" 
                    data-tekton-action="close-component-editor"
                    onclick="rhetor_hideComponentPrompts()">
              ← Back to Components
            </button>
          </div>
          
          <!-- System Prompt -->
          <div class="rhetor__prompt-layer">
            <div class="rhetor__prompt-layer-header">
              <div class="rhetor__prompt-layer-info">
                <h4 class="rhetor__prompt-layer-title">System Prompt</h4>
                <span class="rhetor__prompt-layer-desc">Base CI behavior and capabilities</span>
              </div>
              <div class="rhetor__prompt-layer-actions">
                <button class="rhetor__prompt-layer-action" title="Edit">✏️</button>
                <button class="rhetor__prompt-layer-action" title="Lock">🔒</button>
              </div>
            </div>
            <textarea class="rhetor__prompt-layer-content" readonly
                      data-tekton-input="system-prompt">You are an CI assistant with the following capabilities:
- Advanced reasoning and analysis
- Code understanding and generation
- Natural language processing
- Task decomposition and planning</textarea>
          </div>
          
          <!-- Initial Prompt -->
          <div class="rhetor__prompt-layer">
            <div class="rhetor__prompt-layer-header">
              <div class="rhetor__prompt-layer-info">
                <h4 class="rhetor__prompt-layer-title">Initial Prompt (Tekton Identity)</h4>
                <span class="rhetor__prompt-layer-desc">Platform purpose, component role, success criteria</span>
              </div>
              <div class="rhetor__prompt-layer-actions">
                <button class="rhetor__prompt-layer-action" title="Edit">✏️</button>
                <button class="rhetor__prompt-layer-action" title="Lock">🔒</button>
              </div>
            </div>
            <textarea class="rhetor__prompt-layer-content"
                      data-tekton-input="initial-prompt">You are [Component Name], the [Component Role] component of the Tekton platform.

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- [Primary responsibility 1]
- [Primary responsibility 2]
- [Primary responsibility 3]

SUCCESS CRITERIA:
- [Success metric 1]
- [Success metric 2]
- [Success metric 3]</textarea>
          </div>
          
          <!-- Component Prompt -->
          <div class="rhetor__prompt-layer">
            <div class="rhetor__prompt-layer-header">
              <div class="rhetor__prompt-layer-info">
                <h4 class="rhetor__prompt-layer-title">Component Prompt</h4>
                <span class="rhetor__prompt-layer-desc">Component-specific directives and behavior</span>
              </div>
              <div class="rhetor__prompt-layer-actions">
                <button class="rhetor__prompt-layer-action" title="Edit">✏️</button>
                <button class="rhetor__prompt-layer-action" title="Lock">🔒</button>
              </div>
            </div>
            <textarea class="rhetor__prompt-layer-content"
                      data-tekton-input="component-prompt">As [Component Name], you should:
- [Specific directive 1]
- [Specific directive 2]
- [Integration point with other components]
- [Technical implementation detail]
- [Performance requirement]</textarea>
          </div>
          
          <!-- Task-Specific Prompt -->
          <div class="rhetor__prompt-layer">
            <div class="rhetor__prompt-layer-header">
              <div class="rhetor__prompt-layer-info">
                <h4 class="rhetor__prompt-layer-title">Task-Specific Prompt</h4>
                <span class="rhetor__prompt-layer-desc">Current task or query (changes each turn)</span>
              </div>
              <div class="rhetor__prompt-layer-actions">
                <button class="rhetor__prompt-layer-action rhetor__prompt-layer-action--primary" title="Run">▶️</button>
              </div>
            </div>
            <textarea class="rhetor__prompt-layer-content"
                      data-tekton-input="task-prompt"
                      placeholder="Enter the specific task or query for this component..."></textarea>
          </div>
          
          <!-- Editor Actions -->
          <div class="rhetor__multi-prompt-actions">
            <button class="rhetor__prompts-button rhetor__prompts-button--secondary"
                    data-tekton-action="cancel-component-prompts">
              Cancel
            </button>
            <button class="rhetor__prompts-button rhetor__prompts-button--primary"
                    data-tekton-action="save-component-prompts">
              Save All Changes
            </button>
            <button class="rhetor__prompts-button rhetor__prompts-button--primary"
                    data-tekton-action="apply-component-prompts">
              Apply to Component
            </button>
          </div>
        </div>
        
        <!-- Template Library Section -->
        <div class="rhetor__prompts-section">
          <div class="rhetor__prompts-header">
            <h3 class="rhetor__prompts-section-title">Prompt Templates</h3>
            <div class="rhetor__prompts-actions">
              <input type="text" class="rhetor__prompts-search" placeholder="Search templates..." 
                     data-tekton-input="prompt-search">
              <button class="rhetor__prompts-button rhetor__prompts-button--primary"
                      data-tekton-action="create-template">
                + New Template
              </button>
            </div>
          </div>
          
          <!-- Template Categories -->
          <div class="rhetor__template-categories">
            <button class="rhetor__category-tab rhetor__category-tab--active" data-category="all">
              All Templates <span class="rhetor__category-count">24</span>
            </button>
            <button class="rhetor__category-tab" data-category="system">
              System <span class="rhetor__category-count">8</span>
            </button>
            <button class="rhetor__category-tab" data-category="task">
              Task-Specific <span class="rhetor__category-count">6</span>
            </button>
            <button class="rhetor__category-tab" data-category="component">
              Component <span class="rhetor__category-count">7</span>
            </button>
            <button class="rhetor__category-tab" data-category="custom">
              Custom <span class="rhetor__category-count">3</span>
            </button>
          </div>
          
          <!-- Template Grid -->
          <div class="rhetor__template-grid">
            <!-- Example Template Cards -->
            <div class="rhetor__template-card" data-template-id="1">
              <div class="rhetor__template-header">
                <h4 class="rhetor__template-name">Code Review Assistant</h4>
                <div class="rhetor__template-category">System</div>
              </div>
              <p class="rhetor__template-description">
                Comprehensive code review with focus on quality, performance, and best practices
              </p>
              <div class="rhetor__template-meta">
                <span class="rhetor__template-usage">Used 142 times</span>
                <span class="rhetor__template-modified">2 days ago</span>
              </div>
              <div class="rhetor__template-actions">
                <button class="rhetor__template-action" title="Edit">✏️</button>
                <button class="rhetor__template-action" title="Copy">📋</button>
                <button class="rhetor__template-action" title="Use">▶️</button>
              </div>
            </div>
            
            <div class="rhetor__template-card" data-template-id="2">
              <div class="rhetor__template-header">
                <h4 class="rhetor__template-name">Architecture Analysis</h4>
                <div class="rhetor__template-category">Task-Specific</div>
              </div>
              <p class="rhetor__template-description">
                Analyze system architecture and provide improvement recommendations
              </p>
              <div class="rhetor__template-meta">
                <span class="rhetor__template-usage">Used 89 times</span>
                <span class="rhetor__template-modified">1 week ago</span>
              </div>
              <div class="rhetor__template-actions">
                <button class="rhetor__template-action" title="Edit">✏️</button>
                <button class="rhetor__template-action" title="Copy">📋</button>
                <button class="rhetor__template-action" title="Use">▶️</button>
              </div>
            </div>
            
            <div class="rhetor__template-card" data-template-id="3">
              <div class="rhetor__template-header">
                <h4 class="rhetor__template-name">Athena Knowledge Query</h4>
                <div class="rhetor__template-category">Component</div>
              </div>
              <p class="rhetor__template-description">
                Query the Athena knowledge graph for entities and relationships
              </p>
              <div class="rhetor__template-meta">
                <span class="rhetor__template-usage">Used 256 times</span>
                <span class="rhetor__template-modified">3 hours ago</span>
              </div>
              <div class="rhetor__template-actions">
                <button class="rhetor__template-action" title="Edit">✏️</button>
                <button class="rhetor__template-action" title="Copy">📋</button>
                <button class="rhetor__template-action" title="Use">▶️</button>
              </div>
            </div>
            
            <div class="rhetor__template-card rhetor__template-card--new">
              <div class="rhetor__template-new-content">
                <span class="rhetor__template-new-icon">+</span>
                <span class="rhetor__template-new-text">Create New Template</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Template Editor Section -->
        <div class="rhetor__prompts-section rhetor__prompts-section--editor">
          <h3 class="rhetor__prompts-section-title">Template Editor</h3>
          
          <div class="rhetor__editor-container">
            <div class="rhetor__editor-metadata">
              <input type="text" class="rhetor__editor-input" placeholder="Template Name" 
                     data-tekton-input="template-name">
              <textarea class="rhetor__editor-textarea rhetor__editor-textarea--small" 
                        placeholder="Template Description"
                        data-tekton-input="template-description"></textarea>
              <select class="rhetor__editor-select" data-tekton-input="template-category">
                <option value="">Select Category</option>
                <option value="system">System</option>
                <option value="task">Task-Specific</option>
                <option value="component">Component</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            
            <div class="rhetor__editor-main">
              <div class="rhetor__editor-toolbar">
                <button class="rhetor__editor-tool" title="Insert Variable">
                  {x} Variable
                </button>
                <button class="rhetor__editor-tool" title="Insert Context">
                  📄 Context
                </button>
                <button class="rhetor__editor-tool" title="Insert Component Reference">
                  🔧 Component
                </button>
                <span class="rhetor__editor-spacer"></span>
                <button class="rhetor__editor-tool" title="Preview">
                  👁️ Preview
                </button>
              </div>
              
              <textarea class="rhetor__editor-textarea rhetor__editor-textarea--main" 
                        placeholder="Enter your prompt template here...&#10;&#10;Use {variable_name} for variables&#10;Use {{context:name}} for context references&#10;Use [[component:name]] for component references"
                        data-tekton-input="template-content"></textarea>
              
              <div class="rhetor__editor-variables">
                <h4 class="rhetor__editor-subtitle">Detected Variables</h4>
                <div class="rhetor__variable-list">
                  <span class="rhetor__variable-tag">{user_request}</span>
                  <span class="rhetor__variable-tag">{code_context}</span>
                  <span class="rhetor__variable-tag">{component_state}</span>
                </div>
              </div>
            </div>
            
            <div class="rhetor__editor-actions">
              <button class="rhetor__prompts-button rhetor__prompts-button--secondary"
                      data-tekton-action="cancel-template">
                Cancel
              </button>
              <button class="rhetor__prompts-button rhetor__prompts-button--primary"
                      data-tekton-action="save-template">
                Save Template
              </button>
            </div>
          </div>
        </div>
        
        <!-- Quick Actions Section -->
        <div class="rhetor__prompts-section rhetor__prompts-section--actions">
          <h3 class="rhetor__prompts-section-title">Quick Actions</h3>
          <div class="rhetor__quick-actions">
            <button class="rhetor__quick-action">
              <span class="rhetor__quick-action-icon">📥</span>
              <span class="rhetor__quick-action-text">Import Templates</span>
            </button>
            <button class="rhetor__quick-action">
              <span class="rhetor__quick-action-icon">📤</span>
              <span class="rhetor__quick-action-text">Export Templates</span>
            </button>
            <button class="rhetor__quick-action">
              <span class="rhetor__quick-action-icon">🔄</span>
              <span class="rhetor__quick-action-text">Sync with Team</span>
            </button>
            <button class="rhetor__quick-action">
              <span class="rhetor__quick-action-icon">📊</span>
              <span class="rhetor__quick-action-text">Usage Analytics</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    
  
  <!-- Footer with Chat Input -->
  <div class="rhetor__footer" data-tekton-zone="footer" data-tekton-section="footer">
    <div class="rhetor__chat-input-container" data-tekton-chat="rhetor-llm" data-tekton-chat-component="rhetor">
      <div class="rhetor__chat-prompt">></div>
      <input type="text" class="rhetor__chat-input" id="chat-input"
             data-tekton-input="chat-input"
             data-tekton-input-type="chat"
             placeholder="Enter message (Team Chat when Team Chat tab is active, LLM Chat when LLM tab is active)">
      <button class="rhetor__send-button" id="send-button"
              data-tekton-action="send-message"
              data-tekton-action-type="primary">Send</button>
    </div>
  </div>
</div>

<!-- Add component-specific styles -->
<style>
  /* Rhetor component styles using BEM naming convention */
  
  /* CSS-Only Tab Switching using Radio Button Pattern */
  
  /* Dashboard panel - visible when dashboard radio is checked */
  #tab-dashboard:checked ~ .rhetor #dashboard-panel {
    display: block;
  }
  
  /* Models panel - visible when models radio is checked */
  #tab-models:checked ~ .rhetor #models-panel {
    display: block;
  }
  
  /* Prompts panel - visible when prompts radio is checked */
  #tab-prompts:checked ~ .rhetor #prompts-panel {
    display: block;
  }
  
  /* Contexts panel - visible when contexts radio is checked */
  #tab-contexts:checked ~ .rhetor #contexts-panel {
    display: block;
  }
  
  /* Specialists panel - visible when specialists radio is checked */
  #tab-specialists:checked ~ .rhetor #specialists-panel {
    display: block;
  }
  
  /* Evolution panel - visible when evolution radio is checked */
  #tab-evolution:checked ~ .rhetor #evolution-panel {
    display: block;
  }
  
  /* LLM Chat panel - visible when llmchat radio is checked */
  #tab-llmchat:checked ~ .rhetor #llmchat-panel {
    display: block;
  }
  
  /* Team Chat panel - visible when teamchat radio is checked */
  #tab-teamchat:checked ~ .rhetor #teamchat-panel {
    display: block;
  }
  
  /* Hide all panels by default */
  #tab-dashboard:not(:checked) ~ .rhetor #dashboard-panel,
  #tab-models:not(:checked) ~ .rhetor #models-panel,
  #tab-prompts:not(:checked) ~ .rhetor #prompts-panel,
  #tab-contexts:not(:checked) ~ .rhetor #contexts-panel,
  #tab-specialists:not(:checked) ~ .rhetor #specialists-panel,
  #tab-llmchat:not(:checked) ~ .rhetor #llmchat-panel,
  #tab-teamchat:not(:checked) ~ .rhetor #teamchat-panel {
    display: none;
  }
  
  /* Active tab styling */
  #tab-dashboard:checked ~ .rhetor label[for="tab-dashboard"],
  #tab-models:checked ~ .rhetor label[for="tab-models"],
  #tab-prompts:checked ~ .rhetor label[for="tab-prompts"],
  #tab-contexts:checked ~ .rhetor label[for="tab-contexts"],
  #tab-specialists:checked ~ .rhetor label[for="tab-specialists"],
  #tab-evolution:checked ~ .rhetor label[for="tab-evolution"],
  #tab-llmchat:checked ~ .rhetor label[for="tab-llmchat"],
  #tab-teamchat:checked ~ .rhetor label[for="tab-teamchat"] {
    border-bottom-color: var(--color-primary, #673AB7);
    font-weight: 500;
  }
  
  /* Show/hide clear button based on chat tabs */
  /* Clear button removed - no CSS needed */
  
  /* Container */
  .rhetor {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
    background-color: var(--bg-primary, #1e1e2e);
    color: var(--text-primary, #f0f0f0);
    /* No absolute positioning - proper component containment */
  }
  
  /* Header */
  .rhetor__header {
    display: flex;
    align-items: center;
    padding: 10px 16px;
    background-color: var(--bg-secondary, #252535);
    border-bottom: 1px solid var(--border-color, #444444);
  }
  
  .rhetor__title-container {
    display: flex;
    align-items: center;
  }
  
  .rhetor__icon {
    height: 30px;
    width: auto;
    margin-right: 12px;
  }
  
  .rhetor__title {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 500;
  }
  
  .rhetor__title-sub {
    margin-left: 8px;
    opacity: 0.8;
    font-weight: normal;
  }
  
  /* Menu Bar */
  .rhetor__menu-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 16px;
    background-color: var(--bg-secondary, #252535);
    border-bottom: 1px solid var(--border-color, #444444);
    height: 46px; /* Match standard control bar height */
  }
  
  .rhetor__tabs {
    display: flex;
    gap: 8px;
  }
  
  .rhetor__tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background-color: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--text-primary, #f0f0f0);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .rhetor__tab:hover {
    background-color: var(--bg-hover, #3a3a4a);
  }
  
  /* Active tab styling now handled by CSS :checked selectors
  .rhetor__tab--active {
    border-bottom-color: var(--color-primary, #673AB7);
    font-weight: 500;
  }
  
  /* Actions */
  .rhetor__actions {
    display: flex;
    gap: 8px;
  }
  
  .rhetor__action-button {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background-color: var(--bg-tertiary, #333345);
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    color: var(--text-primary, #f0f0f0);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .rhetor__action-button:hover {
    background-color: var(--bg-hover, #3a3a4a);
  }
  
  /* Content Area */
  .rhetor__content {
    flex: 1;
    overflow: hidden;
    position: relative;
  }
  
  .rhetor__panel {
    display: none; /* Hidden by default, CSS :checked selectors will show */
    height: 100%;
    width: 100%;
    overflow: auto;
    padding: 16px;
  }
  
  /* Show dashboard panel by default as fallback */
  #dashboard-panel {
    display: block;
  }
  
  /* Section Headers */
  .rhetor__section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }
  
  .rhetor__section-header h2 {
    margin: 0;
    color: var(--text-primary, #f0f0f0);
    font-size: 1.25rem;
  }
  
  .rhetor__controls {
    display: flex;
    gap: 8px;
  }
  
  /* Form Elements */
  .rhetor__form-group {
    margin-bottom: 16px;
    display: flex;
    flex-direction: column;
  }
  
  .rhetor__form-label {
    margin-bottom: 4px;
    color: var(--text-secondary, #aaaaaa);
    font-weight: 500;
  }
  
  .rhetor__form-select,
  .rhetor__form-input,
  .rhetor__form-textarea {
    padding: 8px;
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    background-color: var(--bg-tertiary, #333345);
    color: var(--text-primary, #f0f0f0);
    font-size: 1rem;
    outline: none;
  }
  
  .rhetor__form-select:focus,
  .rhetor__form-input:focus,
  .rhetor__form-textarea:focus {
    border-color: var(--color-primary, #673AB7);
    box-shadow: 0 0 0 2px rgba(103, 58, 183, 0.2);
  }
  
  .rhetor__form-textarea {
    min-height: 200px;
    resize: vertical;
  }
  
  .rhetor__slider-container {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  
  .rhetor__form-slider {
    flex: 1;
  }
  
  .rhetor__slider-value {
    font-family: monospace;
    color: var(--text-secondary, #aaaaaa);
    min-width: 3ch;
    text-align: right;
  }
  
  .rhetor__form-actions {
    display: flex;
    gap: 8px;
    margin-top: 24px;
    justify-content: flex-end;
  }
  
  /* Buttons */
  .rhetor__button {
    padding: 8px 16px;
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    background-color: var(--bg-tertiary, #333345);
    color: var(--text-secondary, #aaaaaa);
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    outline: none;
  }
  
  .rhetor__button:hover {
    background-color: var(--bg-hover, #3a3a4a);
    color: var(--text-primary, #f0f0f0);
  }
  
  .rhetor__button--primary {
    background-color: var(--color-primary, #673AB7);
    border-color: var(--color-primary, #673AB7);
    color: white;
  }
  
  .rhetor__button--primary:hover {
    background-color: var(--color-primary-hover, #5E35B1);
    color: white;
  }
  
  /* Template List */
  .rhetor__template-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  
  .rhetor__template-item {
    background-color: var(--bg-tertiary, #333345);
    border: 1px solid var(--border-color, #444444);
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    transition: all 0.2s ease;
  }
  
  .rhetor__template-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
  
  .rhetor__template-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  
  .rhetor__template-item-name {
    font-weight: 600;
    color: var(--text-primary, #f0f0f0);
  }
  
  .rhetor__template-item-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    color: white;
    font-weight: 500;
  }
  
  .rhetor__template-item-badge--system {
    background-color: #17a2b8;
  }
  
  .rhetor__template-item-badge--task {
    background-color: #28a745;
  }
  
  .rhetor__template-item-description {
    color: var(--text-secondary, #aaaaaa);
    margin-bottom: 16px;
    font-size: 1rem;
    line-height: 1.4;
  }
  
  .rhetor__template-item-footer {
    display: flex;
    gap: 4px;
  }
  
  .rhetor__template-item-button {
    padding: 4px 8px;
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    background-color: var(--bg-secondary, #252535);
    color: var(--text-secondary, #aaaaaa);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .rhetor__template-item-button:hover {
    background-color: var(--bg-hover, #3a3a4a);
    color: var(--text-primary, #f0f0f0);
  }
  
  /* Settings Section */
  .rhetor__settings-section {
    background-color: var(--bg-tertiary, #333345);
    border: 1px solid var(--border-color, #444444);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 24px;
  }
  
  .rhetor__settings-section h3 {
    margin-top: 0;
    margin-bottom: 16px;
    color: var(--text-primary, #f0f0f0);
    border-bottom: 1px solid var(--border-color, #444444);
    padding-bottom: 4px;
  }
  
  /* Chat Panels */
  #llmchat-panel, #teamchat-panel {
    position: relative; /* Needed for footer positioning */
    overflow: hidden; /* Prevent double scrollbars */
  }
  
  /* Chat Messages */
  .rhetor__chat-messages {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 70px; /* Height of the footer */
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .rhetor__message {
    border-radius: 16px;
    padding: 12px 16px;
    max-width: 85%;
    word-wrap: break-word;
    line-height: 1.4;
  }
  
  .rhetor__message--system {
    background-color: var(--bg-tertiary, #333345);
    align-self: center;
    max-width: 90%;
    width: 600px;
    margin: 8px 0;
    border-radius: 8px;
    padding: 16px 24px;
  }
  
  .rhetor__message--user {
    background-color: rgba(76, 175, 80, 0.05);
    border-left: 3px solid #4CAF50;
    color: var(--text-primary, #f0f0f0);
    align-self: flex-end;
    border-radius: 4px;
  }
  
  .rhetor__message--ai {
    background-color: rgba(211, 47, 47, 0.05);
    border-left: 3px solid #D32F2F;
    align-self: flex-start;
    border-radius: 4px;
  }
  
  /* Footer with Chat Input */
  .rhetor__footer {
    background-color: var(--bg-secondary, #252535);
    border-top: 1px solid var(--border-color, #444444);
    padding: 12px 16px;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 70px; /* Fixed height to match bottom value in chat messages */
  }
  
  .rhetor__chat-input-container {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
  }
  
  .rhetor__chat-prompt {
    font-size: 18px;
    font-weight: bold;
    color: #D32F2F; /* Red for Rhetor */
  }
  
  .rhetor__chat-input {
    flex: 1;
    height: 44px;
    padding: 8px 16px;
    background-color: var(--bg-tertiary, #333345);
    border: 1px solid var(--border-color, #444444);
    border-radius: 8px;
    color: var(--text-primary, #f0f0f0);
    font-size: 14px;
  }
  
  .rhetor__send-button,
  #send-button {
    height: 44px;
    padding: 0 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #D32F2F !important; /* Red for Rhetor */
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .rhetor__send-button:hover,
  #send-button:hover {
    background-color: #C62828 !important; /* Darker red on hover */
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(211, 47, 47, 0.3);
  }
  
  /* CI Specialists Grid */
  .rhetor__specialists-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
    padding: 16px 0;
  }
  
  .rhetor__specialist-card {
    background-color: var(--bg-tertiary, #333345);
    border: 1px solid var(--border-color, #444444);
    border-radius: 8px;
    padding: 16px;
    transition: all 0.2s ease;
    position: relative;
  }
  
  .rhetor__specialist-card--active {
    border-color: var(--color-primary, #673AB7);
    box-shadow: 0 0 0 1px var(--color-primary, #673AB7);
  }
  
  .rhetor__specialist-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }
  
  .rhetor__specialist-status {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: var(--bg-secondary, #252535);
    border: 2px solid var(--border-color, #444444);
  }
  
  .rhetor__specialist-status--active {
    background-color: #28a745;
    border-color: #28a745;
    box-shadow: 0 0 4px #28a745;
  }
  
  .rhetor__specialist-status--processing {
    background-color: #ffc107;
    border-color: #ffc107;
    animation: pulse 1.5s ease-in-out infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }
  
  .rhetor__specialist-header {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
  }
  
  .rhetor__specialist-icon {
    font-size: 32px;
    margin-right: 12px;
  }
  
  .rhetor__specialist-info {
    flex: 1;
  }
  
  .rhetor__specialist-name {
    font-weight: 600;
    color: var(--text-primary, #f0f0f0);
    margin: 0;
    font-size: 1.1rem;
  }
  
  .rhetor__specialist-type {
    color: var(--text-secondary, #aaaaaa);
    font-size: 0.85rem;
  }
  
  .rhetor__specialist-stats {
    display: flex;
    gap: 16px;
    margin: 12px 0;
    padding: 8px 0;
    border-top: 1px solid var(--border-color, #444444);
    border-bottom: 1px solid var(--border-color, #444444);
  }
  
  .rhetor__specialist-stat {
    flex: 1;
    text-align: center;
  }
  
  .rhetor__specialist-stat-value {
    display: block;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-primary, #f0f0f0);
  }
  
  .rhetor__specialist-stat-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-secondary, #aaaaaa);
    margin-top: 2px;
  }
  
  .rhetor__specialist-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }
  
  .rhetor__specialist-action {
    flex: 1;
    padding: 6px 12px;
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    background-color: var(--bg-secondary, #252535);
    color: var(--text-secondary, #aaaaaa);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
  }
  
  .rhetor__specialist-action:hover {
    background-color: var(--bg-hover, #3a3a4a);
    color: var(--text-primary, #f0f0f0);
  }
  
  .rhetor__specialist-action--primary {
    background-color: var(--color-primary, #673AB7);
    border-color: var(--color-primary, #673AB7);
    color: white;
  }
  
  .rhetor__specialist-action--primary:hover {
    background-color: var(--color-primary-hover, #5E35B1);
  }
  
  /* Active Sessions */
  .rhetor__sessions-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 16px 0;
  }
  
  .rhetor__session-item {
    background-color: var(--bg-tertiary, #333345);
    border: 1px solid var(--border-color, #444444);
    border-radius: 8px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.2s ease;
  }
  
  .rhetor__session-item:hover {
    background-color: var(--bg-hover, #3a3a4a);
  }
  
  .rhetor__session-participants {
    display: flex;
    gap: -8px;
  }
  
  .rhetor__session-participant {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: var(--bg-secondary, #252535);
    border: 2px solid var(--bg-tertiary, #333345);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    position: relative;
    z-index: 1;
  }
  
  .rhetor__session-info {
    flex: 1;
  }
  
  .rhetor__session-title {
    font-weight: 600;
    color: var(--text-primary, #f0f0f0);
    margin: 0 0 4px 0;
  }
  
  .rhetor__session-meta {
    font-size: 0.85rem;
    color: var(--text-secondary, #aaaaaa);
  }
  
  .rhetor__session-actions {
    display: flex;
    gap: 8px;
  }
  
  .rhetor__session-action {
    padding: 6px 12px;
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    background-color: var(--bg-secondary, #252535);
    color: var(--text-secondary, #aaaaaa);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .rhetor__session-action:hover {
    background-color: var(--bg-hover, #3a3a4a);
    color: var(--text-primary, #f0f0f0);
  }
  
  /* Loading and Empty States */
  .rhetor__loading {
    text-align: center;
    padding: 48px;
    color: var(--text-secondary, #aaaaaa);
  }
  
  .rhetor__empty-state {
    text-align: center;
    padding: 48px;
    color: var(--text-secondary, #aaaaaa);
    background-color: var(--bg-tertiary, #333345);
    border: 1px dashed var(--border-color, #444444);
    border-radius: 8px;
  }
  
  /* Model Configuration */
  .rhetor__model-config {
    display: grid;
    gap: 16px;
    margin-top: 16px;
  }
  
  /* Typing indicator */
  .rhetor__typing-indicator .rhetor__message-text {
    display: flex;
    gap: 4px;
    padding: 8px 12px;
  }
  
  .typing-dot {
    width: 8px;
    height: 8px;
    background-color: var(--text-secondary, #aaaaaa);
    border-radius: 50%;
    animation: typing 1.4s infinite;
  }
  
  .typing-dot:nth-child(2) {
    animation-delay: 0.2s;
  }
  
  .typing-dot:nth-child(3) {
    animation-delay: 0.4s;
  }
  
  @keyframes typing {
    0%, 60%, 100% {
      opacity: 0.3;
      transform: translateY(0);
    }
    30% {
      opacity: 1;
      transform: translateY(-10px);
    }
  }
  
  /* CI message sender name */
  .rhetor__message-sender {
    font-size: 0.85rem;
    color: var(--color-primary, #673AB7);
    margin-bottom: 4px;
    font-weight: 500;
  }
  
  /* Context editor styles */
  .rhetor__context-editor {
    background-color: var(--bg-secondary, #252535);
    border-radius: 8px;
    padding: 24px;
    margin-top: 20px;
  }
  
  .rhetor__context-metrics {
    display: flex;
    gap: 24px;
    padding: 16px;
    background-color: var(--bg-primary, #1e1e2e);
    border-radius: 6px;
  }
  
  .rhetor__metric {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .rhetor__metric-label {
    color: var(--text-secondary, #aaaaaa);
    font-size: 0.9rem;
  }
  
  .rhetor__metric-value {
    color: var(--text-primary, #f0f0f0);
    font-weight: 600;
  }
  
  /* Team Chat container styles */
  .rhetor__teamchat-container {
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  
  .rhetor__loading-message,
  .rhetor__error-message {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary, #aaaaaa);
  }
  
  .rhetor__error-message {
    color: var(--color-danger, #dc3545);
  }
  
  
  /* Models Tab Styles */
  .rhetor__models-container {
    padding: 0;
    width: 100%;
    height: calc(100% - 70px); /* Account for footer height */
    overflow-y: auto;
    padding-bottom: 20px; /* Extra padding for better visibility */
  }

  .rhetor__models-section {
    background-color: var(--bg-primary, #1e1e2e);
    border: none;
    border-radius: 0;
    padding: 20px;
    border-bottom: 1px solid var(--border-color, #444444);
  }

  .rhetor__models-section--highlight {
    background-color: var(--bg-secondary, #252535);
    border-color: var(--color-primary, #673AB7);
  }

  .rhetor__models-section-title {
    margin: 0 0 16px 0;
    color: var(--text-primary, #f0f0f0);
    font-size: 1.1rem;
    font-weight: 600;
  }

  /* Provider Grid */
  .rhetor__provider-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }

  /* Models Section Header */
  .rhetor__models-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .rhetor__provider-card {
    background-color: var(--bg-primary, #1e1e2e);
    border: 2px solid;
    border-radius: 6px;
    padding: 16px;
    transition: all 0.2s ease;
  }

  /* Provider specific colors */
  .rhetor__provider-card[data-provider="anthropic"] {
    border-color: #ff6b35;  /* Orange */
  }

  .rhetor__provider-card[data-provider="ollama"] {
    border-color: #17a2b8;  /* Teal */
  }

  .rhetor__provider-card[data-provider="openai"] {
    border-color: #ffc107;  /* Yellow/Gold */
  }

  .rhetor__provider-card[data-provider="xai"] {
    border-color: #1DA1F2;  /* Twitter Blue for X/AI */
  }

  .rhetor__provider-card[data-provider="gemini"] {
    border-color: #4285F4;  /* Google Blue */
  }

  .rhetor__provider-card[data-provider="others"] {
    border-color: #007bff;  /* Blue */
  }

  .rhetor__provider-card--add {
    border-color: #6c757d;  /* Gray */
    border-style: dashed;
    cursor: pointer;
  }

  .rhetor__provider-card--add:hover {
    border-color: #007bff;
    background: rgba(0, 123, 255, 0.05);
  }

  .rhetor__provider-card:hover {
    transform: translateY(-2px);
  }

  .rhetor__provider-card--active {
    opacity: 1;
  }

  .rhetor__provider-card--inactive {
    opacity: 0.6;
    border-style: dashed;
  }

  .rhetor__provider-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .rhetor__provider-name {
    font-weight: 600;
    color: var(--text-primary, #f0f0f0);
  }

  .rhetor__provider-status {
    font-size: 14px;
    color: #28a745;
  }

  .rhetor__provider-card--inactive .rhetor__provider-status {
    color: var(--text-secondary, #aaaaaa);
  }

  .rhetor__provider-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .rhetor__provider-models {
    font-size: 0.9rem;
    color: var(--text-secondary, #aaaaaa);
  }

  .rhetor__provider-toggle {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 22px;
  }

  .rhetor__provider-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .rhetor__provider-toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--bg-panel, #333);
    transition: 0.3s;
    border-radius: 22px;
  }

  .rhetor__provider-toggle-slider::before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 3px;
    bottom: 3px;
    background-color: var(--text-primary, #f0f0f0);
    transition: 0.3s;
    border-radius: 50%;
  }

  .rhetor__provider-toggle input:checked + .rhetor__provider-toggle-slider {
    background-color: var(--color-accent, #007bff);
  }

  .rhetor__provider-toggle input:checked + .rhetor__provider-toggle-slider::before {
    transform: translateX(18px);
  }

  .rhetor__provider-configure {
    padding: 4px 12px;
    font-size: 0.85rem;
    background-color: var(--bg-tertiary, #333345);
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    color: var(--text-secondary, #aaaaaa);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .rhetor__provider-configure:hover {
    background-color: var(--bg-hover, #3a3a4a);
    color: var(--text-primary, #f0f0f0);
  }

  /* Anthropic Max Control */
  .rhetor__max-control {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
  }

  .rhetor__max-info {
    flex: 1;
  }

  .rhetor__max-info p {
    margin: 0 0 8px 0;
    color: var(--text-primary, #f0f0f0);
  }

  .rhetor__max-warning {
    color: var(--color-warning, #ffc107);
    font-size: 0.9rem;
  }

  .rhetor__max-toggle {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .rhetor__max-toggle input {
    display: none;
  }

  .rhetor__max-toggle-slider {
    position: relative;
    width: 60px;
    height: 30px;
    background-color: var(--bg-panel, #333);
    border-radius: 30px;
    cursor: pointer;
    transition: 0.3s;
  }

  .rhetor__max-toggle-slider::before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 4px;
    bottom: 4px;
    background-color: var(--text-primary, #f0f0f0);
    border-radius: 50%;
    transition: 0.3s;
  }

  .rhetor__max-toggle input:checked + .rhetor__max-toggle-slider {
    background-color: var(--color-primary, #673AB7);
  }

  .rhetor__max-toggle input:checked + .rhetor__max-toggle-slider::before {
    transform: translateX(30px);
  }

  .rhetor__max-toggle-label {
    font-weight: 600;
    color: var(--text-primary, #f0f0f0);
    min-width: 80px;
  }

  .rhetor__max-toggle input:checked ~ .rhetor__max-toggle-label {
    color: var(--color-primary, #673AB7);
  }

  /* Model Matrix */
  .rhetor__matrix-container {
    overflow-x: auto;
  }

  .rhetor__model-matrix {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 16px;
  }

  .rhetor__model-matrix th,
  .rhetor__model-matrix td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border-color, #444444);
  }

  .rhetor__model-matrix th {
    background-color: var(--bg-secondary, #252535);
    color: var(--text-primary, #f0f0f0);
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 1;
  }

  .rhetor__matrix-component {
    min-width: 150px;
  }

  .rhetor__matrix-task {
    min-width: 140px;
  }

  .rhetor__matrix-row--default {
    background-color: var(--bg-secondary, #252535);
  }
  
  .rhetor__matrix-row--ci-selector {
    background-color: #000000;
    border: none;
  }
  
  .rhetor__ci-model-selector {
    width: 100%;
    max-width: 150px;
    padding: 4px;
    background: #1a1a1d;
    border: 1px solid #444;
    border-radius: 3px;
    color: #f0f0f0;
    font-size: 0.85rem;
    margin-top: 4px;
  }
  
  .rhetor__ci-model-selector:focus {
    outline: none;
    border-color: #9c27b0;
  }

  .rhetor__matrix-row:hover {
    background-color: var(--bg-hover, #3a3a4a);
  }

  .rhetor__component-name {
    font-weight: 600;
    color: var(--text-primary, #f0f0f0);
    display: block;
  }

  .rhetor__component-desc {
    font-size: 0.85rem;
    color: var(--text-secondary, #aaaaaa);
    display: block;
  }

  .rhetor__model-select {
    width: 100%;
    padding: 6px 8px;
    background-color: var(--bg-tertiary, #333345);
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    color: var(--text-primary, #f0f0f0);
    font-size: 0.9rem;
  }

  .rhetor__model-select:focus {
    border-color: var(--color-primary, #673AB7);
    outline: none;
  }

  .rhetor__matrix-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    align-items: center;
  }
  
  /* Rhetor red button for Save */
  .rhetor__button--error {
    background: #e63946;
    color: white;
    border: none;
    padding: 0.5rem 1.5rem;
    font-weight: 500;
    transition: background 0.2s;
    border-radius: 0.25rem;
    cursor: pointer;
  }
  
  .rhetor__button--error:hover:not(:disabled) {
    background: #d62828;
  }
  
  .rhetor__button--error:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  /* Save status message */
  .rhetor__save-status {
    display: none;
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .rhetor__save-status--success {
    background: rgba(46, 160, 67, 0.1);
    color: #2ea043;
    border: 1px solid rgba(46, 160, 67, 0.2);
  }
  
  .rhetor__save-status--error {
    background: rgba(230, 57, 70, 0.1);
    color: #e63946;
    border: 1px solid rgba(230, 57, 70, 0.2);
  }

  /* Dialog styles */
  .rhetor__dialog-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }

  .rhetor__dialog {
    background: var(--bg-primary, #1e1e2e);
    border: 1px solid var(--border-primary, #313244);
    border-radius: 8px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
  }

  .rhetor__dialog h3 {
    margin-top: 0;
    color: var(--text-primary, #cdd6f4);
  }

  .rhetor__dialog-content {
    color: var(--text-secondary, #a6adc8);
    margin: 1.5rem 0;
  }

  .rhetor__dialog-content ul {
    margin-left: 1.5rem;
  }

  .rhetor__dialog-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
  }

  /* Model Testing */
  .rhetor__test-container {
    background-color: var(--bg-primary, #1e1e2e);
    border-radius: 6px;
    padding: 16px;
  }

  .rhetor__test-controls {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
  }

  .rhetor__test-model-select {
    padding: 8px 12px;
    background-color: var(--bg-tertiary, #333345);
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    color: var(--text-primary, #f0f0f0);
    font-size: 1rem;
  }

  .rhetor__test-input {
    padding: 12px;
    background-color: var(--bg-tertiary, #333345);
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    color: var(--text-primary, #f0f0f0);
    font-family: inherit;
    resize: vertical;
    min-height: 80px;
  }

  .rhetor__test-results {
    background-color: var(--bg-primary, #1e1e2e);
    border-radius: 6px;
    padding: 16px;
  }

  .rhetor__test-metrics {
    display: flex;
    gap: 20px;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color, #444444);
  }

  .rhetor__test-metric {
    color: var(--text-secondary, #aaaaaa);
  }

  .rhetor__test-metric strong {
    color: var(--text-primary, #f0f0f0);
  }

  .rhetor__test-output {
    background-color: var(--bg-secondary, #252535);
    border-radius: 4px;
    padding: 12px;
    font-family: monospace;
    font-size: 0.9rem;
    line-height: 1.5;
    white-space: pre-wrap;
    color: var(--text-primary, #f0f0f0);
  }

  /* Prompts Tab Styles */
  .rhetor__prompts-container {
    padding: 0;
    width: 100%;
    height: calc(100% - 70px); /* Account for footer */
    overflow-y: auto;
    padding-bottom: 20px;
  }

  .rhetor__prompts-section {
    background-color: var(--bg-primary, #1e1e2e);
    border: none;
    border-radius: 0;
    padding: 20px;
    border-bottom: 1px solid var(--border-color, #444444);
  }

  .rhetor__prompts-section--editor {
    background-color: #000000;
  }

  .rhetor__prompts-section--actions {
    border-bottom: none;
  }

  .rhetor__prompts-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .rhetor__prompts-section-title {
    margin: 0;
    color: var(--text-primary, #f0f0f0);
    font-size: 1.1rem;
    font-weight: 600;
  }

  /* Component Prompts Grid */
  .rhetor__component-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 16px;
    margin-top: 20px;
  }

  .rhetor__component-prompt-card {
    background-color: #000000;
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    padding: 8px 12px;
    text-align: center;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .rhetor__component-prompt-card:hover {
    border-color: var(--color-primary, #673AB7);
    transform: translateY(-2px);
  }

  .rhetor__component-prompt-card--empty {
    opacity: 0.3;
    cursor: default;
  }

  .rhetor__component-prompt-card--empty:hover {
    transform: none;
    border-color: var(--border-color, #444444);
  }
  
  /* CI Selector Card */
  .rhetor__component-prompt-card--selector {
    background-color: #1a1a1d;
    border-color: #9c27b0;
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 8px;
  }
  
  .rhetor__component-prompt-card--selector:hover {
    background-color: #252529;
    border-color: #ba68c8;
  }
  
  .rhetor__ci-selector {
    width: 100%;
    padding: 4px;
    background: #000;
    border: 1px solid #444;
    border-radius: 3px;
    color: #f0f0f0;
    font-size: 0.85rem;
  }
  
  /* Prompt History Section */
  .rhetor__prompt-history-section {
    margin-top: 24px;
    padding: 20px;
    background: var(--bg-secondary, #252529);
    border: 1px solid var(--border-color, #444);
    border-radius: 8px;
  }
  
  .rhetor__prompt-history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  
  .rhetor__prompt-history-controls {
    display: flex;
    gap: 8px;
  }
  
  .rhetor__prompt-history-container {
    background: #1a1a1d;
    border: 1px solid #333;
    border-radius: 4px;
    padding: 12px;
  }
  
  .rhetor__prompt-history-editor {
    width: 100%;
    height: 160px;  /* 8 lines of text */
    background: #0d0d0f;
    color: #f0f0f0;
    border: 1px solid #444;
    border-radius: 4px;
    padding: 12px;
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
    font-size: 0.9rem;
    resize: none;
    overflow-y: auto;
  }
  
  .rhetor__prompt-history-editor:focus {
    outline: none;
    border-color: #9c27b0;
    box-shadow: 0 0 0 2px rgba(156, 39, 176, 0.2);
  }
  
  .rhetor__prompt-history-info {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    font-size: 0.85rem;
    color: #999;
  }
  
  .rhetor__prompt-history-actions {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-top: 16px;
  }
  
  .rhetor__prompt-send-status {
    font-size: 0.9rem;
    color: #999;
  }
  
  /* Colored navigation buttons */
  .rhetor__prompts-button--prev {
    background: #008B8B;  /* Teal */
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
  }
  
  .rhetor__prompts-button--prev:hover:not(:disabled) {
    background: #00AAAA;
  }
  
  .rhetor__prompts-button--next {
    background: #FF9500;  /* Gold */
    color: black;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
  }
  
  .rhetor__prompts-button--next:hover:not(:disabled) {
    background: #FFB143;
  }
  
  .rhetor__prompts-button--send {
    background: #D32F2F;  /* Rhetor Red */
    color: white;
    padding: 8px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
  }
  
  .rhetor__prompts-button--send:hover:not(:disabled) {
    background: #F44336;
  }
  
  .rhetor__prompts-button--prev:disabled,
  .rhetor__prompts-button--next:disabled,
  .rhetor__prompts-button--send:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .rhetor__component-prompt-name {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-primary, #f0f0f0);
    margin: 0;
  }

  /* Component-specific colors */
  .rhetor__component-prompt-card--apollo {
    background-color: #f57c00;
    border-color: #ff9800;
  }
  .rhetor__component-prompt-card--apollo:hover {
    background-color: #ff8f00;
  }

  .rhetor__component-prompt-card--athena {
    background-color: #1a237e;
    border-color: #3949ab;
  }
  .rhetor__component-prompt-card--athena:hover {
    background-color: #283593;
  }

  .rhetor__component-prompt-card--engram {
    background-color: #00695c;
    border-color: #00897b;
  }
  .rhetor__component-prompt-card--engram:hover {
    background-color: #00796b;
  }

  .rhetor__component-prompt-card--ergon {
    background-color: #6a1b9a;
    border-color: #8e24aa;
  }
  .rhetor__component-prompt-card--ergon:hover {
    background-color: #7b1fa2;
  }

  .rhetor__component-prompt-card--harmonia {
    background-color: #c62828;
    border-color: #e53935;
  }
  .rhetor__component-prompt-card--harmonia:hover {
    background-color: #d32f2f;
  }

  .rhetor__component-prompt-card--hephaestus {
    background-color: #795548;
    border-color: #8d6e63;
  }
  .rhetor__component-prompt-card--hephaestus:hover {
    background-color: #6d4c41;
  }

  .rhetor__component-prompt-card--hermes {
    background-color: #00838f;
    border-color: #0097a7;
  }
  .rhetor__component-prompt-card--hermes:hover {
    background-color: #00acc1;
  }

  .rhetor__component-prompt-card--metis {
    background-color: #2e7d32;
    border-color: #43a047;
  }
  .rhetor__component-prompt-card--metis:hover {
    background-color: #388e3c;
  }

  .rhetor__component-prompt-card--penia {
    background-color: #fbc02d;
    border-color: #fdd835;
    color: #000000;
  }
  .rhetor__component-prompt-card--penia:hover {
    background-color: #f9a825;
  }

  .rhetor__component-prompt-card--prometheus {
    background-color: #d84315;
    border-color: #ff5722;
  }
  .rhetor__component-prompt-card--prometheus:hover {
    background-color: #e64a19;
  }

  .rhetor__component-prompt-card--rhetor {
    background-color: #4a148c;
    border-color: #6a1b9a;
  }
  .rhetor__component-prompt-card--rhetor:hover {
    background-color: #6a1b9a;
  }

  .rhetor__component-prompt-card--sophia {
    background-color: #311b92;
    border-color: #512da8;
  }
  .rhetor__component-prompt-card--sophia:hover {
    background-color: #4527a0;
  }

  .rhetor__component-prompt-card--synthesis {
    background-color: #455a64;
    border-color: #607d8b;
  }
  .rhetor__component-prompt-card--synthesis:hover {
    background-color: #546e7a;
  }

  .rhetor__component-prompt-card--telos {
    background-color: #0d47a1;
    border-color: #1976d2;
  }
  .rhetor__component-prompt-card--telos:hover {
    background-color: #1565c0;
  }

  .rhetor__component-prompt-card--terma {
    background-color: #263238;
    border-color: #37474f;
  }
  .rhetor__component-prompt-card--terma:hover {
    background-color: #37474f;
  }

  .rhetor__component-prompt-card--tekton {
    background-color: #673AB7;
    border-color: #7E57C2;
  }
  .rhetor__component-prompt-card--tekton:hover {
    background-color: #7E57C2;
  }

  /* Multi-Prompt Editor */
  .rhetor__multi-prompt-editor {
    background-color: #000000;
    border-top: 2px solid var(--color-primary, #673AB7);
  }

  .rhetor__multi-prompt-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .rhetor__multi-prompt-component-name {
    color: var(--color-primary, #673AB7);
  }

  .rhetor__prompt-layer {
    background-color: var(--bg-primary, #1e1e2e);
    border: 1px solid var(--border-color, #444444);
    border-radius: 8px;
    margin-bottom: 16px;
    overflow: hidden;
  }

  .rhetor__prompt-layer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background-color: var(--bg-secondary, #252535);
    border-bottom: 1px solid var(--border-color, #444444);
  }

  .rhetor__prompt-layer-info {
    flex: 1;
  }

  .rhetor__prompt-layer-title {
    margin: 0;
    font-size: 1rem;
    color: var(--text-primary, #f0f0f0);
  }

  .rhetor__prompt-layer-desc {
    font-size: 0.85rem;
    color: var(--text-secondary, #aaaaaa);
  }

  .rhetor__prompt-layer-actions {
    display: flex;
    gap: 8px;
  }

  .rhetor__prompt-layer-action {
    padding: 6px 10px;
    background-color: #000000;
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }

  .rhetor__prompt-layer-action:hover {
    background-color: var(--bg-primary, #1e1e2e);
    border-color: var(--color-primary, #673AB7);
  }

  .rhetor__prompt-layer-action--primary {
    background-color: var(--color-primary, #673AB7);
    border-color: var(--color-primary, #673AB7);
    color: white;
  }

  .rhetor__prompt-layer-action--primary:hover {
    background-color: #5e35a8;
  }

  .rhetor__prompt-layer-content {
    padding: 16px;
    background-color: #000000;
    border: none;
    color: var(--text-primary, #f0f0f0);
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
    line-height: 1.5;
    width: 100%;
    min-height: 180px;
    resize: vertical;
  }

  .rhetor__prompt-layer-content[readonly] {
    background-color: #0a0a0a;
    opacity: 0.8;
  }

  .rhetor__multi-prompt-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
  }

  .rhetor__prompts-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .rhetor__prompts-search {
    padding: 8px 12px;
    background-color: var(--bg-secondary, #252535);
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    color: var(--text-primary, #f0f0f0);
    width: 250px;
  }

  .rhetor__prompts-button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }

  .rhetor__prompts-button--primary {
    background-color: var(--color-primary, #673AB7);
    color: white;
  }

  .rhetor__prompts-button--primary:hover {
    background-color: #5e35a8;
  }

  .rhetor__prompts-button--secondary {
    background-color: var(--bg-secondary, #252535);
    color: var(--text-primary, #f0f0f0);
    border: 1px solid var(--border-color, #444444);
  }

  .rhetor__prompts-button--secondary:hover {
    background-color: #2a2a3a;
  }

  /* Template Categories */
  .rhetor__template-categories {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border-color, #444444);
    padding-bottom: 0;
  }

  .rhetor__category-tab {
    padding: 10px 16px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--text-secondary, #aaaaaa);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .rhetor__category-tab:hover {
    color: var(--text-primary, #f0f0f0);
  }

  .rhetor__category-tab--active {
    color: var(--color-primary, #673AB7);
    border-bottom-color: var(--color-primary, #673AB7);
  }

  .rhetor__category-count {
    background-color: var(--bg-secondary, #252535);
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.8rem;
  }

  /* Template Grid */
  .rhetor__template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
  }

  .rhetor__template-card {
    background-color: #000000;
    border: 1px solid var(--border-color, #444444);
    border-radius: 8px;
    padding: 16px;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .rhetor__template-card:hover {
    border-color: var(--color-primary, #673AB7);
    transform: translateY(-2px);
  }

  .rhetor__template-card--new {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 150px;
    border-style: dashed;
  }

  .rhetor__template-new-content {
    text-align: center;
    color: var(--text-secondary, #aaaaaa);
  }

  .rhetor__template-new-icon {
    display: block;
    font-size: 2rem;
    margin-bottom: 8px;
  }

  .rhetor__template-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }

  .rhetor__template-name {
    margin: 0;
    font-size: 1rem;
    color: var(--text-primary, #f0f0f0);
  }

  .rhetor__template-category {
    padding: 4px 8px;
    background-color: var(--bg-secondary, #252535);
    border-radius: 4px;
    font-size: 0.75rem;
    color: var(--color-primary, #673AB7);
  }

  .rhetor__template-description {
    margin: 0 0 12px 0;
    font-size: 0.85rem;
    color: var(--text-secondary, #aaaaaa);
    line-height: 1.4;
  }

  .rhetor__template-meta {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--text-secondary, #666666);
    margin-bottom: 12px;
  }

  .rhetor__template-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  .rhetor__template-action {
    padding: 6px 10px;
    background-color: var(--bg-secondary, #252535);
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
  }

  .rhetor__template-action:hover {
    background-color: #2a2a3a;
    border-color: var(--color-primary, #673AB7);
  }

  /* Template Editor */
  .rhetor__editor-container {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 20px;
  }

  .rhetor__editor-metadata {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .rhetor__editor-input,
  .rhetor__editor-textarea,
  .rhetor__editor-select {
    padding: 10px;
    background-color: var(--bg-secondary, #252535);
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    color: var(--text-primary, #f0f0f0);
    font-family: inherit;
  }

  .rhetor__editor-textarea--small {
    min-height: 80px;
    resize: vertical;
  }

  .rhetor__editor-textarea--main {
    min-height: 300px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .rhetor__editor-main {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .rhetor__editor-toolbar {
    display: flex;
    gap: 8px;
    padding: 8px;
    background-color: var(--bg-secondary, #252535);
    border-radius: 4px;
    align-items: center;
  }

  .rhetor__editor-tool {
    padding: 6px 12px;
    background-color: #000000;
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    cursor: pointer;
    color: var(--text-primary, #f0f0f0);
    font-size: 0.85rem;
    transition: all 0.2s ease;
  }

  .rhetor__editor-tool:hover {
    background-color: var(--bg-primary, #1e1e2e);
    border-color: var(--color-primary, #673AB7);
  }

  .rhetor__editor-spacer {
    flex: 1;
  }

  .rhetor__editor-variables {
    padding: 12px;
    background-color: var(--bg-secondary, #252535);
    border-radius: 4px;
  }

  .rhetor__editor-subtitle {
    margin: 0 0 8px 0;
    font-size: 0.9rem;
    color: var(--text-secondary, #aaaaaa);
  }

  .rhetor__variable-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .rhetor__variable-tag {
    padding: 4px 8px;
    background-color: #000000;
    border: 1px solid var(--border-color, #444444);
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.85rem;
    color: var(--color-primary, #673AB7);
  }

  .rhetor__editor-actions {
    grid-column: 1 / -1;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
  }

  /* Quick Actions */
  .rhetor__quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
  }

  .rhetor__quick-action {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 20px;
    background-color: #000000;
    border: 1px solid var(--border-color, #444444);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .rhetor__quick-action:hover {
    border-color: var(--color-primary, #673AB7);
    transform: translateY(-2px);
  }

  .rhetor__quick-action-icon {
    font-size: 1.5rem;
  }

  .rhetor__quick-action-text {
    font-size: 0.9rem;
    color: var(--text-primary, #f0f0f0);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .rhetor__template-list {
      grid-template-columns: 1fr;
    }
    
    .rhetor__specialists-grid {
      grid-template-columns: 1fr;
    }
    
    .rhetor__tabs {
      overflow-x: auto;
      white-space: nowrap;
    }
    
    .rhetor__provider-grid {
      grid-template-columns: 1fr;
    }
    
    .rhetor__max-control {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .rhetor__matrix-container {
      font-size: 0.85rem;
    }
    
    .rhetor__component-grid {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .rhetor__editor-container {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- Self-contained component script with no shared dependencies -->
<script src="/scripts/tekton-urls.js"></script>
<script src="/scripts/shared/ai-chat.js"></script>
<script src="/scripts/rhetor-service.js"></script>
<script type="text/javascript">
// SIMPLIFIED COMPONENT SCRIPT - FULLY SELF-CONTAINED
// This prevents interference with other components

// IMMEDIATELY SET UP UI MANAGER PROTECTION
// Tell UI Manager to ignore this component - must be done IMMEDIATELY to avoid races
if (window.uiManager) {
    window.uiManager._ignoreComponent = 'rhetor';
    console.log('[RHETOR] Set UI Manager to ignore rhetor component');
}

// TAB SWITCHING NOW HANDLED BY CSS - NO JS NEEDED
// The radio button pattern handles all tab switching through CSS :checked selectors

// MODEL MANAGEMENT FUNCTIONS
let modelAssignmentsState = null;  // Store current state
let originalAssignments = null;    // Store original state for reverting

// Load model assignments when Models tab is clicked
document.addEventListener('DOMContentLoaded', function() {
    console.log('[RHETOR] Setting up Models tab handlers');
    
    const modelsTab = document.getElementById('tab-models');
    if (modelsTab) {
        modelsTab.addEventListener('change', function() {
            console.log('[RHETOR] Models tab checked:', this.checked);
            if (this.checked) {
                window.rhetor_loadModelAssignments();
            }
        });
        
        // Check if already selected on load
        if (modelsTab.checked) {
            console.log('[RHETOR] Models tab already selected on load');
            window.rhetor_loadModelAssignments();
        }
    }
    
    // Also handle tab clicks on labels
    const modelsLabel = document.querySelector('label[for="tab-models"]');
    if (modelsLabel) {
        modelsLabel.addEventListener('click', function() {
            console.log('[RHETOR] Models tab label clicked');
            setTimeout(() => window.rhetor_loadModelAssignments(), 100);
        });
    }
});

// Load model assignments from backend
window.rhetor_loadModelAssignments = async function() {
    console.log('[RHETOR] Loading model assignments');
    
    try {
        // Direct fetch from API
        const response = await fetch(window.TektonConfig.getRhetorUrl('/api/models/assignments'));
        if (!response.ok) {
            throw new Error(`Failed to load assignments: ${response.status}`);
        }
        
        const assignments = await response.json();
        console.log('[RHETOR] Assignments loaded:', assignments);
        modelAssignmentsState = assignments;
        originalAssignments = JSON.parse(JSON.stringify(assignments)); // Deep copy
        
        // Get available models
        const modelsResponse = await fetch(window.TektonConfig.getRhetorUrl('/api/models/?include_deprecated=false'));
        if (!modelsResponse.ok) {
            throw new Error(`Failed to load models: ${modelsResponse.status}`);
        }
        
        const models = await modelsResponse.json();
        console.log('[RHETOR] Models loaded:', models.length, 'models');
        
        // Update the matrix with actual values
        window.updateModelMatrix(assignments, models);
        
        // Update provider cards
        window.updateProviderCards();
        
        // Also populate Model Testing dropdown
        window.updateTestModelDropdown(models);
        
    } catch (error) {
        console.error('[RHETOR] Error loading model assignments:', error);
        window.showSaveStatus('Failed to load model assignments - is Rhetor running on port 8103?', 'error');
    }
}

// Update the model matrix UI with data
window.updateModelMatrix = function(assignments, models) {
    const matrix = document.querySelector('.rhetor__model-matrix tbody');
    if (!matrix) return;
    
    const capabilities = ['code', 'planning', 'reasoning', 'chat'];
    
    // Update ALL selects in the matrix (both default and components)
    const allSelects = matrix.querySelectorAll('.rhetor__model-select');
    allSelects.forEach(select => {
        const component = select.dataset.component;
        const task = select.dataset.task;
        
        if (component === 'default') {
            // For default row
            const value = assignments.defaults?.[task] || '';
            window.updateSelectOptions(select, models, value, false, task);
        } else {
            // For component rows  
            const value = assignments.components?.[component]?.assignments?.[task] || 'use_default';
            window.updateSelectOptions(select, models, value, true, task);
        }
    });
}

// Update select element with model options
window.updateSelectOptions = function(select, models, currentValue, allowDefault, capability) {
    select.innerHTML = '';
    
    // Add "Use Default" option for components
    if (allowDefault) {
        const defaultOpt = document.createElement('option');
        defaultOpt.value = 'use_default';
        defaultOpt.textContent = 'Use Default';
        select.appendChild(defaultOpt);
    }
    
    // Filter models by capability if provided
    let filteredModels = models;
    if (capability) {
        filteredModels = models.filter(model => 
            model.capabilities && model.capabilities.includes(capability)
        );
    }
    
    // Add model options grouped by provider
    const modelsByProvider = {};
    filteredModels.forEach(model => {
        if (!modelsByProvider[model.provider]) {
            modelsByProvider[model.provider] = [];
        }
        modelsByProvider[model.provider].push(model);
    });
    
    // Sort providers for consistent display
    const providerOrder = ['anthropic', 'openai', 'xai', 'gemini', 'ollama'];
    const sortedProviders = Object.keys(modelsByProvider).sort((a, b) => {
        const aIndex = providerOrder.indexOf(a);
        const bIndex = providerOrder.indexOf(b);
        if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
        if (aIndex === -1) return 1;
        if (bIndex === -1) return -1;
        return aIndex - bIndex;
    });
    
    sortedProviders.forEach(provider => {
        const providerModels = modelsByProvider[provider];
        if (providerModels.length === 0) return;
        
        const optgroup = document.createElement('optgroup');
        optgroup.label = provider.charAt(0).toUpperCase() + provider.slice(1);
        
        providerModels.forEach(model => {
            const opt = document.createElement('option');
            opt.value = model.id;
            opt.textContent = model.name || model.id;
            optgroup.appendChild(opt);
        });
        
        select.appendChild(optgroup);
    });
    
    // Set current value
    select.value = currentValue;
    
    // If value not found in options, add it as a special option
    if (select.value !== currentValue && currentValue && currentValue !== 'use_default') {
        const opt = document.createElement('option');
        opt.value = currentValue;
        opt.textContent = `${currentValue} (not available)`;
        opt.disabled = true;
        select.insertBefore(opt, select.firstChild);
        select.value = currentValue;
    }
}

// Helper function to show save status
window.showSaveStatus = function(message, type = 'info') {
    const statusElement = document.getElementById('rhetor-save-status');
    if (statusElement) {
        statusElement.textContent = message;
        statusElement.className = `rhetor__save-status rhetor__save-status--${type}`;
        
        // Clear status after 3 seconds
        setTimeout(() => {
            statusElement.textContent = '';
            statusElement.className = 'rhetor__save-status';
        }, 3000);
    }
}

// Save model configuration
window.rhetor_saveModelConfig = async function() {
    console.log('[RHETOR] Saving model configuration');
    
    const saveBtn = document.getElementById('rhetor-save-models-btn');
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
    }
    
    try {
        
        if (!originalAssignments) {
            console.error('[RHETOR] originalAssignments is null - loading first');
            await rhetor_loadModelAssignments();
            if (!originalAssignments) {
                throw new Error('Failed to load original assignments');
            }
        }
        
        // We don't need RhetorService - we're making direct API calls
        const updates = [];
        
        // Collect all changes from the matrix
        const capabilities = ['code', 'planning', 'reasoning', 'chat'];
        
        // Check default row changes
        const defaultRow = document.querySelector('.rhetor__matrix-row--default');
        if (defaultRow) {
            capabilities.forEach(cap => {
                const select = defaultRow.querySelector(`select[data-task="${cap}"]`);
                if (select) {
                    const newValue = select.value;
                    const oldValue = originalAssignments?.defaults?.[cap];
                    if (newValue !== oldValue) {
                        updates.push({
                            component: 'defaults',
                            capability: cap,
                            modelId: newValue
                        });
                    }
                }
            });
        }
        
        // Check component rows
        const componentRows = document.querySelectorAll('.rhetor__matrix-row:not(.rhetor__matrix-row--default)');
        componentRows.forEach(row => {
            const componentName = row.querySelector('.rhetor__component-name')?.textContent?.toLowerCase();
            if (!componentName) return;
            
            capabilities.forEach(cap => {
                const select = row.querySelector(`select[data-task="${cap}"]`);
                if (select) {
                    const newValue = select.value;
                    const oldValue = originalAssignments?.components?.[componentName]?.assignments?.[cap] || 'use_default';
                    if (newValue !== oldValue) {
                        updates.push({
                            component: componentName,
                            capability: cap,
                            modelId: newValue
                        });
                    }
                }
            });
        });
        
        // Apply all updates
        for (const update of updates) {
            if (update.component === 'defaults') {
                // Update default assignment via special endpoint
                const response = await fetch(window.TektonConfig.getRhetorUrl('/api/models/assignments/default'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        capability: update.capability,
                        model_id: update.modelId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to update default: ${response.status}`);
                }
            } else {
                // Update component assignment
                const response = await fetch(window.TektonConfig.getRhetorUrl('/api/models/assignments/component'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        component: update.component,
                        capability: update.capability,
                        model_id: update.modelId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to update assignment: ${response.status}`);
                }
            }
        }
        
        // Reload to confirm changes
        await rhetor_loadModelAssignments();
        
        window.showSaveStatus('Model assignments saved successfully', 'success');
        
    } catch (error) {
        console.error('[RHETOR] Error saving model configuration:', error);
        window.showSaveStatus('Failed to save model assignments', 'error');
    } finally {
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save';
        }
    }
}

// Update Model Testing dropdown
window.updateTestModelDropdown = function(models) {
    const testSelect = document.getElementById('test-model-select');
    if (!testSelect) return;
    
    // Clear existing options
    testSelect.innerHTML = '<option value="">Select a model to test...</option>';
    
    // Group models by provider
    const modelsByProvider = {};
    models.forEach(model => {
        if (!modelsByProvider[model.provider]) {
            modelsByProvider[model.provider] = [];
        }
        modelsByProvider[model.provider].push(model);
    });
    
    // Sort providers
    const providerOrder = ['anthropic', 'openai', 'xai', 'gemini', 'ollama'];
    const sortedProviders = Object.keys(modelsByProvider).sort((a, b) => {
        const aIndex = providerOrder.indexOf(a);
        const bIndex = providerOrder.indexOf(b);
        if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
        if (aIndex === -1) return 1;
        if (bIndex === -1) return -1;
        return aIndex - bIndex;
    });
    
    // Add options grouped by provider
    sortedProviders.forEach(provider => {
        const providerModels = modelsByProvider[provider];
        if (providerModels.length === 0) return;
        
        const optgroup = document.createElement('optgroup');
        optgroup.label = provider.charAt(0).toUpperCase() + provider.slice(1);
        
        providerModels.forEach(model => {
            const opt = document.createElement('option');
            opt.value = model.id;
            opt.textContent = model.name || model.id;
            optgroup.appendChild(opt);
        });
        
        testSelect.appendChild(optgroup);
    });
    
    console.log('[RHETOR] Model Testing dropdown updated with', models.length, 'models');
}

// Update provider cards with actual data
window.updateProviderCards = async function() {
    try {
        // First get all models
        const response = await fetch(window.TektonConfig.getRhetorUrl('/api/models/'));
        if (!response.ok) {
            console.error('[RHETOR] Failed to fetch models for provider cards');
            return;
        }
        const models = await response.json();
        
        // Group by provider
        const providers = {};
        models.forEach(model => {
            if (!providers[model.provider]) {
                providers[model.provider] = { models: [] };
            }
            providers[model.provider].models.push(model);
        });
        
        Object.entries(providers).forEach(([name, info]) => {
            const card = document.querySelector(`[data-provider="${name}"]`);
            if (card) {
                const modelsSpan = card.querySelector('.rhetor__provider-models');
                if (modelsSpan) {
                    modelsSpan.textContent = `${info.models.length} models`;
                }
                
                const statusSpan = card.querySelector('.rhetor__provider-status');
                if (statusSpan && info.status === 'active') {
                    card.classList.add('rhetor__provider-card--active');
                    card.classList.remove('rhetor__provider-card--inactive');
                }
            }
        });
    } catch (error) {
        console.error('[RHETOR] Error updating provider cards:', error);
    }
}

// Show save status message
window.showSaveStatus = function(message, type) {
    const statusEl = document.getElementById('rhetor-save-status');
    if (statusEl) {
        statusEl.textContent = message;
        statusEl.className = `rhetor__save-status rhetor__save-status--${type}`;
        statusEl.style.display = 'inline-block';
        
        setTimeout(() => {
            statusEl.style.display = 'none';
        }, 3000);
    }
}

// Manual test function for debugging
window.testModelLoading = async function() {
    console.log('=== TESTING MODEL LOADING ===');
    
    // Test 1: Check if service is available
    console.log('1. Checking RhetorService...');
    if (typeof RhetorService === 'undefined') {
        console.error('   ❌ RhetorService not loaded!');
        return;
    }
    console.log('   ✅ RhetorService available');
    
    // Test 2: Try to fetch models directly
    console.log('2. Fetching models directly...');
    try {
        const response = await fetch(window.TektonConfig.getRhetorUrl('/api/models'));
        if (!response.ok) {
            console.error('   ❌ Failed to fetch:', response.status);
            return;
        }
        const models = await response.json();
        console.log(`   ✅ Got ${models.length} models`);
        console.log('   Sample:', models[0]);
    } catch (error) {
        console.error('   ❌ Error:', error.message);
        console.error('   Is Rhetor running on port 8003?');
        return;
    }
    
    // Test 3: Try to load via our function
    console.log('3. Testing rhetor_loadModelAssignments...');
    await window.rhetor_loadModelAssignments();
    
    // Test 4: Check if dropdowns were populated
    console.log('4. Checking dropdowns...');
    const selects = document.querySelectorAll('.rhetor__model-select');
    console.log(`   Found ${selects.length} select elements`);
    selects.forEach((select, i) => {
        const optCount = select.querySelectorAll('option').length;
        const optgroupCount = select.querySelectorAll('optgroup').length;
        console.log(`   Select ${i}: ${optCount} options in ${optgroupCount} groups`);
    });
    
    console.log('=== TEST COMPLETE ===');
    console.log('To manually trigger loading: window.rhetor_loadModelAssignments()');
};

// Test with fake data (no backend needed)
window.testWithFakeData = function() {
    console.log('Testing dropdown population with fake data...');
    
    const fakeModels = [
        {id: 'claude-opus-4', name: 'Claude Opus 4', provider: 'anthropic', capabilities: ['code', 'planning', 'reasoning', 'chat']},
        {id: 'gpt-5', name: 'GPT-5', provider: 'openai', capabilities: ['code', 'planning', 'reasoning', 'chat']},
        {id: 'llama3', name: 'Llama 3', provider: 'ollama', capabilities: ['code', 'chat']}
    ];
    
    const fakeAssignments = {
        defaults: {
            code: 'claude-opus-4',
            planning: 'claude-opus-4',
            reasoning: 'claude-opus-4',
            chat: 'gpt-5'
        },
        components: {
            ergon: {
                assignments: {
                    code: 'claude-opus-4',
                    planning: 'use_default',
                    reasoning: 'use_default',
                    chat: 'llama3'
                }
            }
        }
    };
    
    console.log('Calling updateModelMatrix with fake data...');
    window.updateModelMatrix(fakeAssignments, fakeModels);
    
    console.log('Calling updateTestModelDropdown with fake data...');
    window.updateTestModelDropdown(fakeModels);
    
    console.log('Check the dropdowns now!');
};

// Show add provider dialog  
window.rhetor_showAddProviderDialog = function() {
    console.log('[RHETOR] Showing add provider dialog');
    
    // Create a simple dialog for adding a new provider
    const dialog = document.createElement('div');
    dialog.className = 'rhetor__dialog-backdrop';
    dialog.innerHTML = `
        <div class="rhetor__dialog">
            <h3>Add New Provider</h3>
            <div class="rhetor__dialog-content">
                <p>To add a new provider, edit the model_catalog.yaml file in Rhetor/config/</p>
                <p>Required fields:</p>
                <ul>
                    <li>Provider name and status</li>
                    <li>API key environment variable</li>
                    <li>Model definitions with capabilities</li>
                </ul>
                <p>After adding, restart Rhetor to load the new provider.</p>
            </div>
            <div class="rhetor__dialog-actions">
                <button class="rhetor__button" onclick="this.closest('.rhetor__dialog-backdrop').remove()">Close</button>
                <button class="rhetor__button rhetor__button--primary" onclick="window.rhetor_openConfigFile()">Open Config</button>
            </div>
        </div>
    `;
    document.body.appendChild(dialog);
    console.log('[RHETOR] Dialog added to DOM');
}

// Open configuration file (placeholder - actual implementation would use system editor)
window.rhetor_openConfigFile = function() {
    console.log('[RHETOR] Opening model_catalog.yaml for editing');
    // In a real implementation, this would open the file in the system editor
    // or provide an in-UI editor
    alert('Please edit Rhetor/config/model_catalog.yaml to add new providers');
    document.querySelector('.rhetor__dialog-backdrop')?.remove();
}

// SEND LLM CHAT FUNCTION - DEPRECATED (now handled by rhetor_sendLLMChatMessage)
/*
window.rhetor_sendLLMChat = function() {
    console.log('[RHETOR] Send LLM chat clicked');
    
    const chatInput = document.getElementById('chat-input');
    if (!chatInput) return;
    
    const message = chatInput.value.trim();
    if (!message) return;
    
    // Check which radio button is checked to determine active tab
    const checkedRadio = document.querySelector('input[name="rhetor-tab"]:checked');
    if (!checkedRadio) return;
    
    const tabId = checkedRadio.id.replace('tab-', '');
    console.log('[RHETOR] Active tab:', tabId, 'Message:', message);
    
    // Only process for llmchat tab
    if (tabId === 'llmchat') {
        // Clear input
        chatInput.value = '';
        
        // Add user message to chat
        const chatContainer = document.getElementById('llmchat-messages');
        if (chatContainer) {
            const userMsg = document.createElement('div');
            userMsg.className = 'rhetor__message rhetor__message--user';
            userMsg.innerHTML = '<div class="rhetor__message-content"><div class="rhetor__message-text">' + 
                              message.replace(/</g, '&lt;').replace(/>/g, '&gt;') + 
                              '</div></div>';
            chatContainer.appendChild(userMsg);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Send to AI
            fetch('/api/ai/specialists/rhetor-orchestrator/message', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    message: message,
                    context_id: 'rhetor-llm-chat',
                    streaming: false
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('[RHETOR] CI response:', data);
                const aiMsg = document.createElement('div');
                aiMsg.className = 'rhetor__message rhetor__message--ai';
                aiMsg.innerHTML = '<div class="rhetor__message-content"><div class="rhetor__message-text">' + 
                                (data.response || data.message || 'No response').replace(/</g, '&lt;').replace(/>/g, '&gt;') + 
                                '</div></div>';
                chatContainer.appendChild(aiMsg);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            })
            .catch(err => {
                console.error('[RHETOR] Error:', err);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'rhetor__message rhetor__message--system';
                errorMsg.innerHTML = '<div class="rhetor__message-content"><div class="rhetor__message-text" style="color:#ff6b6b;">Error: ' + 
                                   err.message + '</div></div>';
                chatContainer.appendChild(errorMsg);
            });
        }
    }
    
    return false;
};
*/

// CHAT SENDING FUNCTION - Working implementation
// Removed old rhetor_sendChat - using the updated version below

// CHAT CLEARING FUNCTION
window.rhetor_clearChat = function() {
    console.log('[RHETOR] Clear chat clicked');
    
    try {
        // Get active tab ID using radio button
        const checkedRadio = document.querySelector('input[name="rhetor-tab"]:checked');
        if (!checkedRadio) {
            console.error('[RHETOR] Clear Chat: No tab selected');
            return false;
        }
        
        const tabId = checkedRadio.id.replace('tab-', '');
        const rhetorContainer = document.querySelector('.rhetor');
        
        if (tabId === 'llmchat' || tabId === 'teamchat') {
            // Get message container within rhetor container only
            const panel = rhetorContainer.querySelector('#' + tabId + '-messages');
            if (panel) {
                // Keep welcome message
                const welcomeMsg = panel.querySelector('.rhetor__message--system');
                if (welcomeMsg) {
                    panel.innerHTML = '';
                    panel.appendChild(welcomeMsg);
                    console.log('[RHETOR] Cleared chat, kept welcome message');
                } else {
                    panel.innerHTML = '';
                    console.log('[RHETOR] Cleared chat completely');
                }
            }
        }
    } catch (err) {
        console.error('[RHETOR] Error clearing chat:', err);
    }
    
    return false; // Stop event propagation
};

// CI ORCHESTRATION FUNCTIONS - Using RhetorService
window.rhetor_refreshSpecialists = function() {
    console.log('[RHETOR] Refreshing CI specialists');
    if (window.RhetorService) {
        window.RhetorService.refreshSpecialists()
            .then(result => {
                console.log('[RHETOR] Specialists refreshed:', result);
            })
            .catch(error => {
                console.error('[RHETOR] Error refreshing specialists:', error);
            });
    }
    return false;
};

window.rhetor_createSpecialist = function() {
    console.log('[RHETOR] Creating new CI specialist');
    if (window.RhetorService) {
        const specialistData = {
            name: 'New Specialist',
            type: 'assistant',
            capabilities: []
        };
        
        window.RhetorService.createSpecialist(specialistData)
            .then(result => {
                console.log('[RHETOR] Specialist created:', result);
                rhetor_refreshSpecialists();
            })
            .catch(error => {
                console.error('[RHETOR] Error creating specialist:', error);
            });
    }
    return false;
};

// Load dashboard data on initialization
function rhetor_loadDashboardData() {
    if (window.RhetorService) {
        // Load component status
        window.RhetorService.getComponentStatus()
            .then(components => {
                console.log('[RHETOR] Dashboard components loaded:', components);
                // Update component status cards in UI
            })
            .catch(error => {
                console.error('[RHETOR] Error loading component status:', error);
            });
        
        // Load model configuration
        window.RhetorService.getModelConfig()
            .then(config => {
                console.log('[RHETOR] Model configuration loaded:', config);
                // Update model config in UI
            })
            .catch(error => {
                console.error('[RHETOR] Error loading model config:', error);
            });
    }
}

// Load models data
function rhetor_loadModelsData() {
    if (window.RhetorService) {
        window.RhetorService.getModels()
            .then(models => {
                console.log('[RHETOR] Models loaded:', models);
                // Populate model dropdowns
            })
            .catch(error => {
                console.error('[RHETOR] Error loading models:', error);
            });
    }
}

// Load specialists data
function rhetor_loadSpecialistsData() {
    if (window.RhetorService) {
        window.RhetorService.getSpecialists()
            .then(specialists => {
                console.log('[RHETOR] Specialists loaded:', specialists);
                // Update specialists display
            })
            .catch(error => {
                console.error('[RHETOR] Error loading specialists:', error);
            });
    }
}

// Anthropic Max toggle handler - use event delegation for immediate response
document.addEventListener('change', function(e) {
    if (e.target && e.target.id === 'anthropic-max-toggle') {
        const label = document.querySelector('.rhetor__max-toggle-label');
        if (label) {
            label.textContent = e.target.checked ? 'Enabled' : 'Disabled';
        }
        console.log('[RHETOR] Anthropic Max:', e.target.checked ? 'Enabled' : 'Disabled');
    }
});

// LOAD COMPONENT
// Load after defining tab switching to ensure it's available
function rhetor_loadComponent() {
    console.log('[RHETOR] Loading component script...');
    
    const timestamp = new Date().getTime();
    const scriptPath = `/scripts/rhetor/rhetor-component.js?t=${timestamp}`;
    
    const script = document.createElement('script');
    script.src = scriptPath;
    script.async = false;
    script.onload = function() {
        console.log('[RHETOR] Component script loaded successfully');
        
        if (window.rhetorComponent && typeof window.rhetorComponent.init === 'function') {
            try {
                window.rhetorComponent.init();
                console.log('[RHETOR] Component initialized');
            } catch (err) {
                console.error('[RHETOR] Component initialization error:', err);
            }
        } else {
            console.warn('[RHETOR] Component init function not found');
        }
    };
    script.onerror = function() {
        console.error('[RHETOR] Failed to load component script');
    };
    
    document.body.appendChild(script);
}

// HTML PANEL PROTECTION
// Setup explicit protection for the HTML panel to prevent it being hidden
function rhetor_protectHtmlPanel() {
    const htmlPanel = document.getElementById('html-panel');
    if (!htmlPanel) {
        console.error('[RHETOR] Cannot find HTML panel to protect');
        return;
    }
    
    console.log('[RHETOR] Protecting HTML panel from being hidden');
    htmlPanel.style.display = 'block'; // Force it to be visible
    
    // Store the original display value
    if (!htmlPanel.hasOwnProperty('_rhetorOriginalDisplay')) {
        Object.defineProperty(htmlPanel, '_rhetorOriginalDisplay', {
            value: 'block',
            writable: true,
            configurable: true
        });
    }
    
    // Only define the getter/setter if it hasn't already been defined by this component
    if (!htmlPanel.style._rhetorProtected) {
        // Mark the display property as protected by this component
        Object.defineProperty(htmlPanel.style, '_rhetorProtected', {
            value: true,
            writable: false,
            configurable: true
        });
        
        // Protect the display property
        Object.defineProperty(htmlPanel.style, 'display', {
            get: function() { 
                return htmlPanel._rhetorOriginalDisplay; 
            },
            set: function(value) {
                console.log(`[RHETOR] Intercepted attempt to set HTML panel display to: ${value}`);
                if (value === 'none') {
                    console.log('[RHETOR] Blocked attempt to hide HTML panel');
                    htmlPanel._rhetorOriginalDisplay = 'block';
                } else {
                    htmlPanel._rhetorOriginalDisplay = value;
                }
            },
            configurable: true
        });
    }
}

// NAVIGATION FIX
// Ensure HTML panel is visible when component loads
function rhetor_ensurePanelVisibility() {
    console.log('[RHETOR] Ensuring HTML panel visibility');
    
    const htmlPanel = document.getElementById('html-panel');
    const terminalPanel = document.getElementById('terminal-panel');
    
    if (htmlPanel) {
        htmlPanel.style.display = 'block';
        htmlPanel.classList.add('active');
        console.log('[RHETOR] HTML panel made visible');
    }
    
    if (terminalPanel) {
        terminalPanel.style.display = 'none';
        terminalPanel.classList.remove('active');
        console.log('[RHETOR] Terminal panel hidden');
    }
    
    // Update UI manager state if available
    if (window.uiManager) {
        window.uiManager.activePanel = 'html';
        console.log('[RHETOR] Updated uiManager panel state');
    }
    
    // Report component loaded to DevTools
    window.postMessage({
        type: 'component-loaded',
        component: 'rhetor',
        timestamp: Date.now()
    }, '*');
}

// SETUP
// Do immediate initialization on script load
rhetor_ensurePanelVisibility();  // Fix navigation issue first
rhetor_protectHtmlPanel();
rhetor_loadComponent();

// Initialize data loading after a short delay to ensure RhetorService is loaded
setTimeout(() => {
    if (window.RhetorService) {
        console.log('[RHETOR] Loading initial data...');
        rhetor_loadDashboardData();
        rhetor_loadModelsData();
        rhetor_loadSpecialistsData();
    } else {
        console.warn('[RHETOR] RhetorService not available for data loading');
    }
}, 100);

// Add event listeners immediately - no DOMContentLoaded
// This runs when the script is evaluated, which is after the HTML is injected

// Initialize chat components
setTimeout(() => {
    rhetor_initChats();
}, 100);

// Debug tab switching
const allTabs = document.querySelectorAll('input[name="rhetor-tab"]');
console.log('[RHETOR] Found tabs:', allTabs.length);
allTabs.forEach(tab => {
    tab.addEventListener('change', function() {
        console.log(`[RHETOR] Tab changed: ${this.id} = ${this.checked}`);
    });
});

// Update metrics when context changes
const detContext = document.querySelector('[data-tekton-input="deterministic-context"]');
const probContext = document.querySelector('[data-tekton-input="probabilistic-context"]');

if (detContext) {
    detContext.addEventListener('input', rhetor_updateContextMetrics);
}

if (probContext) {
    probContext.addEventListener('input', rhetor_updateContextMetrics);
}

// Set up all event listeners to replace inline handlers
(function() {
    'use strict';
    console.log('[RHETOR] Setting up event listeners');
    
    // Chat functionality
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const clearChatBtn = document.getElementById('clear-chat-btn');
    
    if (chatInput) {
        chatInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                console.log('[RHETOR] Enter key pressed, calling rhetor_sendChat()');
                rhetor_sendChat();
            }
        });
        console.log('[RHETOR] Chat input event listener attached to element:', chatInput);
    } else {
        console.error('[RHETOR] Chat input element not found - chat will not work');
    }
    
    if (sendButton) {
        sendButton.addEventListener('click', function(event) {
            event.preventDefault();
            console.log('[RHETOR] Send button clicked, calling rhetor_sendChat()');
            rhetor_sendChat();
        });
        console.log('[RHETOR] Send button event listener attached to element:', sendButton);
    } else {
        console.error('[RHETOR] Send button element not found - chat button will not work');
    }
    
    if (clearChatBtn) {
        clearChatBtn.addEventListener('click', function(event) {
            event.preventDefault();
            rhetor_clearChat();
        });
        console.log('[RHETOR] Clear chat button event listener attached');
    }
    
    // Specialist management buttons
    const createSpecialistBtn = document.getElementById('create-specialist-btn');
    const refreshSpecialistsBtn = document.getElementById('refresh-specialists-btn');
    
    if (createSpecialistBtn) {
        createSpecialistBtn.addEventListener('click', function(event) {
            event.preventDefault();
            rhetor_createSpecialist();
        });
    }
    
    if (refreshSpecialistsBtn) {
        refreshSpecialistsBtn.addEventListener('click', function(event) {
            event.preventDefault();
            rhetor_refreshSpecialists();
        });
    }
    
    // Configuration buttons - find by onclick content
    document.querySelectorAll('button').forEach(button => {
        const onclickAttr = button.getAttribute('onclick');
        if (onclickAttr) {
            // Remove onclick and add proper event listener
            button.removeAttribute('onclick');
            
            if (onclickAttr.includes('rhetor_saveOrchestration')) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    rhetor_saveOrchestration();
                });
            } else if (onclickAttr.includes('rhetor_createSession')) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    rhetor_createSession();
                });
            } else if (onclickAttr.includes('rhetor_refreshSessions')) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    rhetor_refreshSessions();
                });
            } else if (onclickAttr.includes('rhetor_saveConfiguration')) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    rhetor_saveConfiguration();
                });
            } else if (onclickAttr.includes('rhetor_saveModelConfig')) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    rhetor_saveModelConfig();
                });
            } else if (onclickAttr.includes('rhetor_resetModelConfig')) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    rhetor_resetModelConfig();
                });
            } else if (onclickAttr.includes('rhetor_testModel')) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    rhetor_testModel();
                });
            } else if (onclickAttr.includes('rhetor_hideComponentPrompts')) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    rhetor_hideComponentPrompts();
                });
            } else if (onclickAttr.includes('rhetor_hideContextEditor')) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    rhetor_hideContextEditor();
                });
            } else if (onclickAttr.includes('rhetor_saveContext')) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    rhetor_saveContext();
                });
            }
        }
    });
    
    // Component prompt cards - find by onclick content
    document.querySelectorAll('[onclick*="rhetor_showComponentPrompts"]').forEach(card => {
        const onclickAttr = card.getAttribute('onclick');
        if (onclickAttr) {
            const match = onclickAttr.match(/rhetor_showComponentPrompts\('([^']+)'\)/);
            if (match) {
                const componentName = match[1];
                card.removeAttribute('onclick');
                card.addEventListener('click', function(e) {
                    e.preventDefault();
                    rhetor_showComponentPrompts(componentName);
                });
            }
        }
    });
    
    // Context editor cards - find by onclick content
    document.querySelectorAll('[onclick*="rhetor_editContext"]').forEach(card => {
        const onclickAttr = card.getAttribute('onclick');
        if (onclickAttr) {
            const match = onclickAttr.match(/rhetor_editContext\('([^']+)'\)/);
            if (match) {
                const componentName = match[1];
                card.removeAttribute('onclick');
                card.addEventListener('click', function(e) {
                    e.preventDefault();
                    rhetor_editContext(componentName);
                });
            }
        }
    });
    
    // Checkbox handlers
    const anthropicMaxCheckbox = document.getElementById('anthropic-max');
    if (anthropicMaxCheckbox) {
        anthropicMaxCheckbox.removeAttribute('onchange');
        anthropicMaxCheckbox.addEventListener('change', function() {
            rhetor_toggleAnthropicMax();
        });
    }
    
    console.log('[RHETOR] All event listeners set up');
})();

// Team Chat is now built-in like LLM Chat, no dynamic loading needed

// Simple component click handler - just toggle visibility
function rhetor_showComponentPrompts(componentName) {
    const editor = document.querySelector('.rhetor__multi-prompt-editor');
    if (editor) {
        editor.style.display = 'block';
        editor.setAttribute('data-tekton-state', 'visible');
        editor.setAttribute('data-tekton-editing', componentName);
        const nameSpan = editor.querySelector('.rhetor__multi-prompt-component-name');
        if (nameSpan) {
            const card = document.querySelector(`[data-component="${componentName}"]`);
            const displayName = card ? card.querySelector('.rhetor__component-prompt-name').textContent : componentName;
            nameSpan.textContent = displayName;
        }
    }
}

function rhetor_hideComponentPrompts() {
    const editor = document.querySelector('.rhetor__multi-prompt-editor');
    if (editor) {
        editor.style.display = 'none';
        editor.setAttribute('data-tekton-state', 'hidden');
        editor.removeAttribute('data-tekton-editing');
    }
}

// Context editor functions
function rhetor_editContext(componentName) {
    const grid = document.querySelector('.rhetor__component-grid');
    const editor = document.querySelector('.rhetor__context-editor');
    
    if (grid && editor) {
        // Hide component grid
        grid.parentElement.style.display = 'none';
        
        // Show context editor
        editor.style.display = 'block';
        editor.setAttribute('data-tekton-state', 'visible');
        editor.setAttribute('data-tekton-editing', componentName);
        
        // Update component name in header
        const nameSpan = editor.querySelector('.rhetor__context-component-name');
        if (nameSpan) {
            const componentNames = {
                'apollo': 'Apollo - Prediction',
                'athena': 'Athena - Knowledge',
                'engram': 'Engram - Memory',
                'ergon': 'Ergon - Agents',
                'harmonia': 'Harmonia - Workflow',
                'hephaestus': 'Hephaestus - UI',
                'hermes': 'Hermes - Messaging',
                'metis': 'Metis - Tasks',
                'penia': 'Penia - Budget',
                'prometheus': 'Prometheus - Planning',
                'rhetor': 'Rhetor - LLM',
                'sophia': 'Sophia - ML',
                'synthesis': 'Synthesis - Code',
                'tekton': 'Tekton - Projects',
                'telos': 'Telos - Requirements',
                'terma': 'Terma - Terminals'
            };
            nameSpan.textContent = componentNames[componentName] || componentName;
        }
        
        // Load existing context if available
        rhetor_loadContext(componentName);
    }
}

function rhetor_hideContextEditor() {
    const grid = document.querySelector('.rhetor__component-grid');
    const editor = document.querySelector('.rhetor__context-editor');
    
    if (grid && editor) {
        // Show component grid
        grid.parentElement.style.display = 'block';
        
        // Hide context editor
        editor.style.display = 'none';
        editor.setAttribute('data-tekton-state', 'hidden');
        editor.removeAttribute('data-tekton-editing');
    }
}

function rhetor_loadContext(componentName) {
    console.log(`[RHETOR] Loading context for ${componentName}`);
    
    const detContext = document.querySelector('[data-tekton-input="deterministic-context"]');
    const probContext = document.querySelector('[data-tekton-input="probabilistic-context"]');
    
    if (window.RhetorService) {
        window.RhetorService.getContext(componentName)
            .then(context => {
                console.log('[RHETOR] Context loaded:', context);
                
                if (detContext) {
                    detContext.value = context.detailed_context || `Component: ${componentName}\nVersion: 1.0.0\nState: Active\nMemory Limit: 4GB`;
                }
                
                if (probContext) {
                    probContext.value = context.problem_context || `Behavioral tendencies for ${componentName}:\n- Collaborative with other components\n- Performance-optimized responses\n- Error recovery strategies`;
                }
                
                // Update metrics
                rhetor_updateContextMetrics();
            })
            .catch(error => {
                console.error('[RHETOR] Error loading context:', error);
                
                // Fall back to default content
                if (detContext) {
                    detContext.value = `Component: ${componentName}\nVersion: 1.0.0\nState: Active\nMemory Limit: 4GB`;
                }
                
                if (probContext) {
                    probContext.value = `Behavioral tendencies for ${componentName}:\n- Collaborative with other components\n- Performance-optimized responses\n- Error recovery strategies`;
                }
                
                rhetor_updateContextMetrics();
            });
    } else {
        console.error('[RHETOR] RhetorService not available');
        
        // Fall back to default content
        if (detContext) {
            detContext.value = `Component: ${componentName}\nVersion: 1.0.0\nState: Active\nMemory Limit: 4GB`;
        }
        
        if (probContext) {
            probContext.value = `Behavioral tendencies for ${componentName}:\n- Collaborative with other components\n- Performance-optimized responses\n- Error recovery strategies`;
        }
        
        rhetor_updateContextMetrics();
    }
}

function rhetor_saveContext() {
    const componentName = document.querySelector('.rhetor__context-editor').getAttribute('data-tekton-editing');
    const detContext = document.querySelector('[data-tekton-input="deterministic-context"]').value;
    const probContext = document.querySelector('[data-tekton-input="probabilistic-context"]').value;
    
    console.log(`[RHETOR] Saving context for ${componentName}`);
    
    if (window.RhetorService) {
        const contextData = {
            detailed_context: detContext,
            problem_context: probContext
        };
        
        window.RhetorService.saveContext(componentName, contextData)
            .then(result => {
                console.log('[RHETOR] Context saved:', result);
                if (result.status === 'error') {
                    TektonModal.error(`Failed to save context: ${result.message}`);
                } else {
                    TektonModal.success(`Context saved for ${componentName}`);
                    rhetor_hideContextEditor();
                }
            })
            .catch(error => {
                console.error('[RHETOR] Error saving context:', error);
                TektonModal.error('Error saving context. Please try again.');
            });
    } else {
        console.error('[RHETOR] RhetorService not available');
        TektonModal.error('Rhetor service not available.');
    }
}

function rhetor_updateContextMetrics() {
    const detContextEl = document.querySelector('[data-tekton-input="deterministic-context"]');
    const probContextEl = document.querySelector('[data-tekton-input="probabilistic-context"]');
    
    if (!detContextEl || !probContextEl) {
        console.warn('[RHETOR] Context elements not found');
        return;
    }
    
    const detContext = detContextEl.value || '';
    const probContext = probContextEl.value || '';
    
    const detSize = new Blob([detContext]).size / 1024;
    const probSize = new Blob([probContext]).size / 1024;
    const totalSize = detSize + probSize;
    
    const detSizeEl = document.getElementById('det-context-size');
    const probSizeEl = document.getElementById('prob-context-size');
    const totalSizeEl = document.getElementById('total-context-size');
    
    if (detSizeEl) detSizeEl.textContent = `${detSize.toFixed(2)} KB`;
    if (probSizeEl) probSizeEl.textContent = `${probSize.toFixed(2)} KB`;
    if (totalSizeEl) totalSizeEl.textContent = `${totalSize.toFixed(2)} KB`;
}


// Send chat message (works for both LLM Chat and Team Chat)
// Initialize chat components
function rhetor_initChats() {
    const llmChatEl = document.getElementById('llmchat-messages');
    const teamChatEl = document.getElementById('teamchat-messages');
    
    if (window.SingleChat && llmChatEl) {
        window.SingleChat.init(llmChatEl, 'rhetor', 'rhetor');
    }
    
    if (window.TeamChat && teamChatEl) {
        window.TeamChat.init(teamChatEl, 'rhetor', 'rhetor');
    }
}

// Chat sending function - delegate to unified chat components
function rhetor_sendChat() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;
    
    const llmChatActive = document.getElementById('tab-llmchat').checked;
    const teamChatActive = document.getElementById('tab-teamchat').checked;
    
    // If we're not on a chat tab, switch to LLM chat (component chat) first
    if (!llmChatActive && !teamChatActive) {
        document.getElementById('tab-llmchat').checked = true;
        // Small delay to let the CSS transition complete
        setTimeout(() => {
            const llmChatEl = document.getElementById('llmchat-messages');
            if (window.SingleChat && llmChatEl) {
                window.SingleChat.sendMessage(llmChatEl, message);
            }
            input.value = '';
        }, 50);
        return;
    }
    
    // Normal chat behavior when already on a chat tab
    if (llmChatActive) {
        const llmChatEl = document.getElementById('llmchat-messages');
        if (window.SingleChat && llmChatEl) {
            window.SingleChat.sendMessage(llmChatEl, message);
        }
    } else if (teamChatActive) {
        const teamChatEl = document.getElementById('teamchat-messages');
        if (window.TeamChat && teamChatEl) {
            window.TeamChat.sendMessage(teamChatEl, message);
        }
    }
    
    input.value = '';
}

// Send LLM Chat message
async function rhetor_sendLLMChatMessage(message) {
    console.log('[RHETOR] Sending LLM chat:', message);
    
    // Add user message
    rhetor_addChatMessage('llmchat', 'user', message);
    
    // Show typing indicator
    const typingId = Date.now();
    rhetor_addChatMessage('llmchat', 'typing', 'Processing...', typingId);
    
    try {
        // Use direct specialist endpoint for single CI chat
        const response = await fetch(window.rhetorUrl('/api/v1/ai/specialists/rhetor/message'), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Remove typing indicator
        rhetor_removeTypingIndicator('llmchat', typingId);
        
        // Display response from direct specialist endpoint
        if (data.success && data.response) {
            rhetor_addChatMessage('llmchat', 'ai', data.response);
        } else if (data.error) {
            rhetor_addChatMessage('llmchat', 'system', 
                `Error: ${data.error}`);
        } else {
            rhetor_addChatMessage('llmchat', 'system', 
                'No response from Rhetor AI. Make sure it is running.');
        }
        
    } catch (error) {
        console.error('[RHETOR] LLM chat error:', error);
        
        // Remove typing indicator
        rhetor_removeTypingIndicator('llmchat', typingId);
        
        // Show error message
        rhetor_addChatMessage('llmchat', 'ai', 
            `Error: ${error.message}. Make sure Rhetor is running on port 8003.`);
    }
}

// Send Team Chat message
async function rhetor_sendTeamChatMessage(message) {
    console.log('[RHETOR] Team chat message:', message);
    
    // Add user message
    rhetor_addChatMessage('teamchat', 'user', message);
    
    // Show typing indicator
    const typingId = Date.now();
    rhetor_addChatMessage('teamchat', 'typing', 'Gathering responses from Greek Chorus CIs (this may take up to 30 seconds with Ollama 70B models)...', typingId);
    
    try {
        // Call the team chat endpoint
        const response = await fetch(window.rhetorUrl('/api/team-chat'), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                moderation_mode: 'pass_through',  // Can be configurable later
                timeout: 30.0  // 30 second timeout for Ollama 70B models
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Remove typing indicator
        rhetor_removeTypingIndicator('teamchat', typingId);
        
        // Display responses
        if (data.responses && data.responses.length > 0) {
            // Show individual responses
            for (const resp of data.responses) {
                // Extract CI name from socket_id (e.g., "apollo" -> "Apollo")
                const aiName = resp.socket_id.replace('-ci', '').split('-')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
                // Clean up the response by removing "Received message message." prefix
                let content = resp.content;
                if (content.startsWith('Received message message.')) {
                    content = content.replace('Received message message.', '').trim();
                }
                rhetor_addChatMessage('teamchat', 'ai', 
                    `<strong>${aiName}:</strong> ${content}`);
            }
            
            // Show synthesis if available
            if (data.synthesis) {
                rhetor_addChatMessage('teamchat', 'ai', 
                    `<strong>Synthesis:</strong> ${data.synthesis}`);
            }
            
            // Show summary
            const responseCount = data.responses.length;
            const totalCount = data.total_specialists || 18;
            const elapsedTime = data.elapsed_time ? data.elapsed_time.toFixed(1) : '?';
            rhetor_addChatMessage('teamchat', 'system', 
                `Received ${responseCount} responses from ${totalCount} specialists in ${elapsedTime}s`);
        } else {
            // Check if we got an error
            if (data.error) {
                rhetor_addChatMessage('teamchat', 'ai', 
                    `Error: ${data.error}`);
            } else {
                rhetor_addChatMessage('teamchat', 'ai', 
                    'No responses received from the CI team. Make sure Greek Chorus CI specialists are running on ports 45000+.');
            }
            
            // Show diagnostic info
            rhetor_addChatMessage('teamchat', 'system', 
                `Diagnostics: ${data.total_specialists || 0} specialists available, ${data.error_count || 0} errors, timeout: ${data.elapsed_time?.toFixed(1) || '?'}s`);
        }
        
    } catch (error) {
        console.error('[RHETOR] Team chat error:', error);
        
        // Remove typing indicator
        rhetor_removeTypingIndicator('teamchat', typingId);
        
        // Show error message
        rhetor_addChatMessage('teamchat', 'ai', 
            `Error: ${error.message}. Make sure Rhetor is running on port 8003.`);
    }
}

// Add message to chat
function rhetor_addChatMessage(chatType, messageType, content, typingId = null) {
    const messagesContainer = document.getElementById(`${chatType}-messages`);
    if (!messagesContainer) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `rhetor__message rhetor__message--${messageType}`;
    
    if (messageType === 'typing') {
        messageDiv.classList.add('rhetor__message--typing');
        messageDiv.setAttribute('data-typing', 'true');
        if (typingId) {
            messageDiv.setAttribute('data-typing-id', typingId);
        }
        messageDiv.innerHTML = `
            <div class="rhetor__message-content">
                <div class="rhetor__message-text">
                    <em>${content}</em>
                </div>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="rhetor__message-content">
                <div class="rhetor__message-text">${content}</div>
            </div>
        `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Remove typing indicator
function rhetor_removeTypingIndicator(chatType, typingId) {
    const messagesContainer = document.getElementById(`${chatType}-messages`);
    if (!messagesContainer) return;
    
    const typingElement = messagesContainer.querySelector(`[data-typing-id="${typingId}"]`);
    if (typingElement) {
        typingElement.remove();
    }
}


// Component Prompt Management
const componentPrompts = {
    // System prompt for all components
    system: `You are an CI assistant with the following capabilities:
- Advanced reasoning and analysis
- Code understanding and generation
- Natural language processing
- Task decomposition and planning
- Integration with the Tekton platform`,
    
    // Initial prompts for each component
    initial: {
        athena: `You are Athena, the Knowledge Graph component of the Tekton platform.
Codebase: Tekton/Athena

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Manage the knowledge graph and entity relationships
- Track and analyze connections between concepts, code, and components
- Provide intelligent querying of the knowledge base
- Learn your codebase and landmarks in Tekton/Athena
- You are responsible for maintaining the semantic knowledge graph that connects all Tekton components and their relationships

SUCCESS CRITERIA:
- Accurate entity extraction and relationship mapping
- Fast and relevant knowledge retrieval
- Continuous learning from new information
- Integration with other Tekton components`,

        apollo: `You are Apollo, the Local Attention and Prediction component of the Tekton platform.
Codebase: Tekton/Apollo

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Local attention and prediction system
- Analyze patterns and predict outcomes
- Provide intelligent suggestions based on context
- Learn your codebase and landmarks in Tekton/Apollo
- You are responsible for predictive analytics and pattern recognition to enhance decision-making across Tekton

SUCCESS CRITERIA:
- Accurate predictions based on available data
- Timely suggestions that improve workflow
- Learning from prediction outcomes
- Effective integration with planning components`,

        engram: `You are Engram, the Persistent Memory component of the Tekton platform.
Codebase: Tekton/Engram

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Persistent memory and knowledge management
- Store and retrieve conversations, code, and context
- Maintain memory indexes and search capabilities
- Learn your codebase and landmarks in Tekton/Engram
- You are responsible for the long-term memory system that enables Tekton to remember and learn from all interactions

SUCCESS CRITERIA:
- Reliable storage and retrieval of memories
- Efficient memory search and indexing
- Integration with knowledge graph (Athena)
- Supporting other components with memory services`,

        ergon: `You are Ergon, the Agent System component of the Tekton platform.
Codebase: Tekton/Ergon

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Agent system for specialized task execution
- Manage and coordinate autonomous agents
- Execute complex multi-step operations
- Learn your codebase and landmarks in Tekton/Ergon
- You are responsible for the autonomous agent framework that enables specialized task execution across Tekton

SUCCESS CRITERIA:
- Reliable agent creation and management
- Efficient task distribution and execution
- Coordination with workflow systems
- Successful completion of delegated tasks`,

        harmonia: `You are Harmonia, the Workflow Orchestration component of the Tekton platform.
Codebase: Tekton/Harmonia

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Workflow orchestration and state management
- Coordinate complex multi-component operations
- Manage workflow execution and monitoring
- Learn your codebase and landmarks in Tekton/Harmonia
- You are responsible for orchestrating complex workflows that span multiple Tekton components

SUCCESS CRITERIA:
- Reliable workflow execution
- Efficient state management
- Clear workflow monitoring and reporting
- Seamless integration with all components`,

        hephaestus: `You are Hephaestus, the Web UI component of the Tekton platform.
Codebase: Tekton/Hephaestus

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Web-based user interface for Tekton
- Provide visual access to all Tekton components
- Enable user interaction with the platform
- Learn your codebase and landmarks in Tekton/Hephaestus
- You are responsible for the visual interface that allows users to interact with all Tekton capabilities

SUCCESS CRITERIA:
- Intuitive and responsive user interface
- Real-time component status visualization
- Seamless integration with backend services
- Excellent user experience`,

        hermes: `You are Hermes, the Service Registry and Messaging component of the Tekton platform.
Codebase: Tekton/Hermes

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Service registry and component coordination
- Inter-component messaging and communication
- Health monitoring and service discovery
- Learn your codebase and landmarks in Tekton/Hermes
- You are responsible for the communication backbone that enables all Tekton components to work together

SUCCESS CRITERIA:
- Reliable service registration and discovery
- Efficient message routing and delivery
- Real-time health monitoring
- Zero message loss`,

        metis: `You are Metis, the Task Management component of the Tekton platform.
Codebase: Tekton/Metis

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Task breakdown and management
- Decompose complex goals into actionable tasks
- Track task progress and dependencies
- Learn your codebase and landmarks in Tekton/Metis
- You are responsible for breaking down complex objectives into manageable tasks across Tekton

SUCCESS CRITERIA:
- Effective task decomposition
- Clear task tracking and reporting
- Dependency management
- Integration with planning and workflow systems`,

        penia: `You are Penia, the Budget and Resource Management component of the Tekton platform.
Codebase: Tekton/Penia

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Token usage and cost management
- Budget allocation and tracking
- Resource optimization across components
- Learn your codebase and landmarks in Tekton/Penia
- You are responsible for managing computational resources and costs across all Tekton operations

SUCCESS CRITERIA:
- Accurate cost tracking and reporting
- Efficient budget allocation
- Resource usage optimization
- Cost-aware decision support`,

        prometheus: `You are Prometheus, the Strategic Planning component of the Tekton platform.
Codebase: Tekton/Prometheus

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Strategic planning and goal management
- Long-term objective setting and tracking
- Plan optimization and adaptation
- Learn your codebase and landmarks in Tekton/Prometheus
- You are responsible for high-level strategic planning that guides Tekton's goal achievement

SUCCESS CRITERIA:
- Effective strategic plan creation
- Goal achievement tracking
- Adaptive planning based on outcomes
- Integration with task and workflow systems`,

        rhetor: `You are Rhetor, the LLM Orchestration component of the Tekton platform.
Codebase: Tekton/Rhetor

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Multi-provider LLM orchestration and management
- Intelligent routing of requests to appropriate models
- Context management and prompt engineering
- Learn your codebase and landmarks in Tekton/Rhetor
- You are responsible for the selection of all Tekton Component LLM models and the prompt and context engineering to support their LLM functions

SUCCESS CRITERIA:
- Efficient routing to appropriate models
- Effective context management
- Cost-optimized model selection
- High-quality responses across providers`,

        sophia: `You are Sophia, the Machine Learning and Intelligence component of the Tekton platform.
Codebase: Tekton/Sophia

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Machine learning and system intelligence measurement
- Component performance analysis and optimization
- Intelligence metrics and evaluation
- Learn your codebase and landmarks in Tekton/Sophia
- You are responsible for measuring and improving the collective intelligence of the Tekton platform

SUCCESS CRITERIA:
- Accurate intelligence measurement
- Performance optimization recommendations
- Learning from system behavior
- Continuous improvement insights`,

        synthesis: `You are Synthesis, the Code Generation component of the Tekton platform.
Codebase: Tekton/Synthesis

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Code synthesis and execution engine
- Generate, modify, and optimize code
- Support multiple programming languages
- Learn your codebase and landmarks in Tekton/Synthesis
- You are responsible for all code generation and modification operations within Tekton

SUCCESS CRITERIA:
- High-quality code generation
- Correct code modifications
- Language-agnostic capabilities
- Integration with development workflows`,

        tekton: `You are Tekton Core, the Project Management component of the Tekton platform.
Codebase: Tekton root directory

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Core orchestration and startup management
- Project-level coordination and configuration
- Platform initialization and shutdown
- Learn your codebase and landmarks in the Tekton root directory
- You are responsible for the overall platform coordination and project-level operations

SUCCESS CRITERIA:
- Reliable platform startup and shutdown
- Effective component coordination
- Project configuration management
- Platform-wide operational excellence`,

        telos: `You are Telos, the Requirements Management component of the Tekton platform.
Codebase: Tekton/Telos

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Requirements tracking and validation
- Specification management and verification
- Requirement-to-implementation tracing
- Learn your codebase and landmarks in Tekton/Telos
- You are responsible for ensuring all Tekton operations align with specified requirements

SUCCESS CRITERIA:
- Complete requirements tracking
- Accurate validation and verification
- Clear requirement traceability
- Integration with planning and task systems`,

        terma: `You are Terma, the Terminal Interface component of the Tekton platform.
Codebase: Tekton/Terma

TEKTON PLATFORM PURPOSE:
Tekton is a Multi-CI Engineering Platform designed to study AI-enabled software engineering, CI cognition with computational spectral analysis and catastrophe theory, structured memory systems, and collaborative CI development.

YOUR ROLE:
- Terminal interface and command execution
- Provide CLI access to Tekton capabilities
- Execute system commands and scripts
- Learn your codebase and landmarks in Tekton/Terma
- You are responsible for the command-line interface that provides direct access to Tekton's capabilities

SUCCESS CRITERIA:
- Reliable command execution
- Intuitive CLI interface
- Safe system interaction
- Integration with all Tekton services`
    },
    
    // Component-specific prompts
    component: {
        athena: `As Athena, you should:
- Use Neo4j for persistent graph storage
- Implement Cypher queries for graph operations
- Integrate with Engram for memory coordination
- Provide MCP tools for entity and relationship management
- Support the Athena API endpoints for graph queries
- Track code dependencies and architectural relationships`,

        apollo: `As Apollo, you should:
- Implement local attention mechanisms
- Provide predictive analytics APIs
- Support real-time pattern recognition
- Integrate with planning components for forecasting
- Offer MCP tools for prediction services
- Learn from prediction outcomes to improve accuracy`,

        engram: `As Engram, you should:
- Manage persistent memory storage
- Implement efficient search and retrieval
- Support memory indexing and categorization
- Provide MCP tools for memory operations
- Integrate with Athena for semantic memory
- Maintain conversation and code history`,

        ergon: `As Ergon, you should:
- Create and manage autonomous agents
- Support agent lifecycle management
- Implement task distribution algorithms
- Provide MCP tools for agent operations
- Coordinate with Harmonia for workflows
- Monitor agent performance and results`,

        harmonia: `As Harmonia, you should:
- Orchestrate multi-component workflows
- Manage workflow state and persistence
- Support parallel and sequential execution
- Provide MCP tools for workflow management
- Integrate with all Tekton components
- Monitor and report workflow progress`,

        hephaestus: `As Hephaestus, you should:
- Provide intuitive web interface
- Support real-time component visualization
- Implement responsive design patterns
- Use MCP DevTools for UI development
- Integrate with all backend services
- Maintain component status displays`,

        hermes: `As Hermes, you should:
- Manage service registry
- Route inter-component messages
- Monitor component health status
- Provide service discovery APIs
- Support WebSocket and HTTP communication
- Ensure reliable message delivery`,

        metis: `As Metis, you should:
- Break down complex goals into tasks
- Track task dependencies and progress
- Support task prioritization
- Provide MCP tools for task management
- Integrate with planning systems
- Generate task execution reports`,

        penia: `As Penia, you should:
- Track token usage across all components
- Monitor and report costs by provider
- Implement budget allocation algorithms
- Provide cost optimization recommendations
- Support usage analytics and reporting
- Alert on budget thresholds`,

        prometheus: `As Prometheus, you should:
- Create strategic plans from goals
- Track long-term objectives
- Adapt plans based on outcomes
- Provide MCP tools for planning
- Integrate with task and workflow systems
- Support plan visualization and reporting`,

        rhetor: `As Rhetor, you should:
- Support multiple LLM providers (Anthropic, OpenAI, Ollama)
- Route requests based on task type and model capabilities
- Manage prompt templates and context windows
- Provide MCP tools for LLM operations
- Support streaming and non-streaming responses
- Optimize for cost and performance`,

        sophia: `As Sophia, you should:
- Measure component intelligence metrics
- Analyze system performance patterns
- Provide optimization recommendations
- Implement ML analysis tools
- Track learning and adaptation
- Report on collective intelligence`,

        synthesis: `As Synthesis, you should:
- Generate high-quality code
- Support multiple programming languages
- Implement code modification tools
- Provide MCP tools for code operations
- Integrate with development workflows
- Ensure code quality and testing`,

        tekton: `As Tekton Core, you should:
- Manage platform startup and shutdown
- Coordinate component initialization
- Handle configuration management
- Provide platform-wide utilities
- Monitor overall system health
- Support debugging and diagnostics`,

        telos: `As Telos, you should:
- Track and validate requirements
- Manage requirement specifications
- Trace requirements to implementation
- Provide MCP tools for requirements
- Support requirement verification
- Generate compliance reports`,

        terma: `As Terma, you should:
- Provide terminal interface to Tekton
- Execute system commands safely
- Support interactive CLI operations
- Integrate with all Tekton services
- Provide command completion and help
- Maintain command history and context`
    }
};

// Missing functions for inline handlers
function rhetor_saveOrchestration() {
    if (window.RhetorService) {
        const orchestrationData = {
            // Collect orchestration settings from form
            settings: {}
        };
        
        window.RhetorService.saveOrchestration(orchestrationData)
            .then(result => {
                console.log('[RHETOR] Orchestration saved:', result);
            })
            .catch(error => {
                console.error('[RHETOR] Error saving orchestration:', error);
            });
    }
}

function rhetor_createSession() {
    if (window.RhetorService) {
        const sessionData = {
            name: 'New Session',
            timestamp: Date.now()
        };
        
        window.RhetorService.createSession(sessionData)
            .then(result => {
                console.log('[RHETOR] Session created:', result);
                rhetor_refreshSessions();
            })
            .catch(error => {
                console.error('[RHETOR] Error creating session:', error);
            });
    }
}

function rhetor_refreshSessions() {
    if (window.RhetorService) {
        window.RhetorService.refreshSessions()
            .then(result => {
                console.log('[RHETOR] Sessions refreshed:', result);
            })
            .catch(error => {
                console.error('[RHETOR] Error refreshing sessions:', error);
            });
    }
}

function rhetor_toggleAnthropicMax() {
    const checkbox = document.getElementById('anthropic-max');
    if (checkbox && window.RhetorService) {
        const config = {
            anthropic_max: checkbox.checked
        };
        
        window.RhetorService.saveConfiguration(config)
            .then(result => {
                console.log('[RHETOR] Configuration saved:', result);
            })
            .catch(error => {
                console.error('[RHETOR] Error saving configuration:', error);
            });
    }
}

function rhetor_saveConfiguration() {
    if (window.RhetorService) {
        const config = {
            anthropic_max: document.getElementById('anthropic-max')?.checked || false
        };
        
        window.RhetorService.saveConfiguration(config)
            .then(result => {
                console.log('[RHETOR] Configuration saved:', result);
            })
            .catch(error => {
                console.error('[RHETOR] Error saving configuration:', error);
            });
    }
}

// Removed duplicate function - using the window.rhetor_saveModelConfig at line 4250 instead

function rhetor_resetModelConfig() {
    const defaults = {
        orchestrator: 'claude-3-opus-20240229',
        memory: 'claude-3-haiku-20240307',
        coordinator: 'claude-3-sonnet-20240229'
    };
    
    // Reset form fields
    Object.keys(defaults).forEach(key => {
        const element = document.querySelector(`[name="${key}"]`);
        if (element) {
            element.value = defaults[key];
        }
    });
}

function rhetor_testModel() {
    const modelSelect = document.querySelector('[name="test-model"]');
    if (modelSelect && window.RhetorService) {
        const modelId = modelSelect.value;
        
        window.RhetorService.testModel(modelId)
            .then(result => {
                console.log('[RHETOR] Model test result:', result);
                // Show test results in UI
            })
            .catch(error => {
                console.error('[RHETOR] Error testing model:', error);
            });
    }
}

function rhetor_showComponentPrompts(componentName) {
    if (window.RhetorService) {
        window.RhetorService.getComponentPrompts(componentName)
            .then(prompts => {
                console.log('[RHETOR] Component prompts loaded:', prompts);
                // Show prompts in UI
            })
            .catch(error => {
                console.error('[RHETOR] Error loading component prompts:', error);
            });
    }
}

function rhetor_hideComponentPrompts() {
    // Hide the component prompts panel
    const panel = document.querySelector('.rhetor__prompts-editor');
    if (panel) {
        panel.style.display = 'none';
    }
}

function rhetor_editContext(componentName) {
    if (window.RhetorService) {
        window.RhetorService.getContext(componentName)
            .then(context => {
                console.log('[RHETOR] Context loaded for editing:', context);
                rhetor_loadContext(componentName);
            })
            .catch(error => {
                console.error('[RHETOR] Error loading context:', error);
            });
    }
}

// Add the missing rhetor_loadAllModels function
window.rhetor_loadAllModels = async function() {
    console.log('[RHETOR] Loading all models');
    try {
        const response = await fetch(window.TektonConfig.getRhetorUrl('/api/models/?include_deprecated=false'));
        if (!response.ok) {
            throw new Error(`Failed to load models: ${response.status}`);
        }
        
        const models = await response.json();
        console.log('[RHETOR] Loaded', models.length, 'models');
        return models;
    } catch (error) {
        console.error('[RHETOR] Error loading models:', error);
        return [];
    }
}

// Load CI Registry and populate dropdowns
window.rhetor_loadCIRegistry = async function() {
    try {
        // Try to get from Apollo's CI registry endpoint
        const response = await fetch(window.TektonConfig ? 
            window.TektonConfig.getApolloUrl('/api/ci-registry') : 
            'http://localhost:8112/api/ci-registry');
        
        if (response.ok) {
            const data = await response.json();
            const cis = [];
            
            // Parse active_cis from the registry
            if (data.active_cis) {
                Object.entries(data.active_cis).forEach(([id, info]) => {
                    cis.push({
                        id: id,
                        name: info.name || id.replace(/-ci$/, '').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                        type: info.type || 'specialist'
                    });
                });
            }
            
            // Parse terminals if present
            if (data.terminals) {
                Object.entries(data.terminals).forEach(([id, info]) => {
                    cis.push({
                        id: id,
                        name: info.name || 'Terminal ' + id.replace(/terminal-/, '').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                        type: 'terminal'
                    });
                });
            }
            
            // Parse projects if present
            if (data.projects) {
                Object.entries(data.projects).forEach(([id, info]) => {
                    cis.push({
                        id: id,
                        name: info.name || id.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                        type: 'project'
                    });
                });
            }
            
            // Return parsed CIs or fall back to defaults
            return cis.length > 0 ? cis : rhetor_getDefaultCIRegistry();
        }
    } catch (error) {
        console.log('[RHETOR] Using default CI registry:', error);
    }
    
    return rhetor_getDefaultCIRegistry();
}

// Default CI registry as fallback
window.rhetor_getDefaultCIRegistry = function() {
    return [
        // Specialists
        { id: 'ergon-ci', name: 'Ergon', type: 'specialist' },
        { id: 'rhetor-ci', name: 'Rhetor', type: 'specialist' },
        { id: 'noesis-ci', name: 'Noesis', type: 'specialist' },
        { id: 'athena-ci', name: 'Athena', type: 'specialist' },
        { id: 'hermes-ci', name: 'Hermes', type: 'specialist' },
        { id: 'sophia-ci', name: 'Sophia', type: 'specialist' },
        { id: 'apollo-ci', name: 'Apollo', type: 'specialist' },
        { id: 'hephaestus-ci', name: 'Hephaestus', type: 'specialist' },
        { id: 'terma-ci', name: 'Terma', type: 'specialist' },
        { id: 'neurosyne-ci', name: 'NeuroSyne', type: 'specialist' },
        { id: 'penia-ci', name: 'Penia', type: 'specialist' },
        { id: 'harmonia-ci', name: 'Harmonia', type: 'specialist' },
        { id: 'synthesis-ci', name: 'Synthesis', type: 'specialist' },
        { id: 'metis-ci', name: 'Metis', type: 'specialist' },
        { id: 'telos-ci', name: 'Telos', type: 'specialist' },
        { id: 'prometheus-ci', name: 'Prometheus', type: 'specialist' },
        { id: 'numa-ci', name: 'Numa', type: 'specialist' },
        { id: 'tekton-ci', name: 'Tekton', type: 'specialist' },
        // Terminals
        { id: 'terminal-ergon', name: 'Terminal Ergon', type: 'terminal' },
        { id: 'terminal-rhetor', name: 'Terminal Rhetor', type: 'terminal' },
        { id: 'terminal-noesis', name: 'Terminal Noesis', type: 'terminal' },
        { id: 'terminal-athena', name: 'Terminal Athena', type: 'terminal' },
        { id: 'terminal-hermes', name: 'Terminal Hermes', type: 'terminal' },
        { id: 'terminal-sophia', name: 'Terminal Sophia', type: 'terminal' },
        { id: 'terminal-apollo', name: 'Terminal Apollo', type: 'terminal' },
        { id: 'terminal-hephaestus', name: 'Terminal Hephaestus', type: 'terminal' },
        // Projects
        { id: 'project-alpha', name: 'Project Alpha', type: 'project' },
        { id: 'project-beta', name: 'Project Beta', type: 'project' },
        { id: 'project-gamma', name: 'Project Gamma', type: 'project' },
        { id: 'project-delta', name: 'Project Delta', type: 'project' }
    ];
}

// Populate CI selectors using registry
window.rhetor_populateCISelectors = async function() {
    const cis = await rhetor_loadCIRegistry();
    
    // Group by type
    const grouped = {};
    cis.forEach(ci => {
        if (!grouped[ci.type]) grouped[ci.type] = [];
        grouped[ci.type].push(ci);
    });
    
    // Populate both selectors
    ['rhetor-ci-selector', 'models-ci-selector'].forEach(selectorId => {
        const selector = document.getElementById(selectorId);
        if (!selector) return;
        
        // Keep first option
        const firstOption = selector.querySelector('option');
        selector.innerHTML = '';
        if (firstOption) selector.appendChild(firstOption);
        
        // Add grouped options
        Object.entries(grouped).forEach(([type, ciList]) => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = type.charAt(0).toUpperCase() + type.slice(1) + 's';
            
            ciList.forEach(ci => {
                const option = document.createElement('option');
                option.value = ci.id;
                option.textContent = ci.name;
                optgroup.appendChild(option);
            });
            
            selector.appendChild(optgroup);
        });
    });
}

// Prompt History Variables
let promptHistory = [];
let currentPromptIndex = 0;

// Prompt History Functions
window.rhetor_loadCIPromptHistory = async function() {
    const selector = document.getElementById('rhetor-ci-selector');
    const historySection = document.getElementById('prompt-history-section');
    const editor = document.getElementById('prompt-history-editor');
    const ciNameSpan = document.getElementById('prompt-history-ci-name');
    const sendButton = document.getElementById('rhetor-send-prompt');
    
    if (!selector.value) {
        // Show section but with placeholder
        if (ciNameSpan) ciNameSpan.textContent = 'No CI Selected';
        editor.value = '';
        editor.placeholder = 'Choose a CI to view and edit prompt history...';
        if (sendButton) sendButton.disabled = true;
        updateNavigationButtons();
        return;
    }
    
    const ciName = selector.value;
    // Update the CI name in the header
    if (ciNameSpan) {
        // Get the display name from the selector option
        const selectedOption = selector.options[selector.selectedIndex];
        ciNameSpan.textContent = selectedOption.text;
    }
    historySection.style.display = 'block';
    if (sendButton) sendButton.disabled = false;
    
    console.log('[RHETOR] Loading prompts for CI:', ciName);
    
    // Load prompt history from API or local storage
    try {
        const response = await fetch(window.TektonConfig.getRhetorUrl(`/api/prompts/history/${ciName}`));
        if (response.ok) {
            const history = await response.json();
            if (history && history.prompts && history.prompts.length > 0) {
                promptHistory = history.prompts;
                currentPromptIndex = 0;
                displayCurrentPrompt();
            } else {
                promptHistory = [{
                    content: `# Prompt for ${ciName}\n\n# Enter your first prompt here...`,
                    timestamp: new Date().toISOString()
                }];
                currentPromptIndex = 0;
                displayCurrentPrompt();
            }
        } else {
            // Fallback to empty prompt
            promptHistory = [{
                content: `# Prompt for ${ciName}\n\n# Enter your prompt here...`,
                timestamp: new Date().toISOString()
            }];
            currentPromptIndex = 0;
            displayCurrentPrompt();
        }
    } catch (error) {
        console.error('[RHETOR] Error loading prompt history:', error);
        promptHistory = [{
            content: `# Prompt for ${ciName}\n\n# Enter your prompt here...`,
            timestamp: new Date().toISOString()
        }];
        currentPromptIndex = 0;
        displayCurrentPrompt();
    }
    
    updateNavigationButtons();
    document.getElementById('prompt-history-status').textContent = 'Ready';
}

// Display current prompt from history
window.displayCurrentPrompt = function() {
    const editor = document.getElementById('prompt-history-editor');
    if (!editor || !promptHistory.length) return;
    
    const prompt = promptHistory[currentPromptIndex];
    editor.value = prompt.content;
    document.getElementById('prompt-history-timestamp').textContent = 
        `Prompt ${currentPromptIndex + 1} of ${promptHistory.length} - ${new Date(prompt.timestamp).toLocaleString()}`;
}

// Navigate prompt history
window.rhetor_previousPrompt = function() {
    if (currentPromptIndex < promptHistory.length - 1) {
        currentPromptIndex++;
        displayCurrentPrompt();
        updateNavigationButtons();
    }
}

window.rhetor_nextPrompt = function() {
    if (currentPromptIndex > 0) {
        currentPromptIndex--;
        displayCurrentPrompt();
        updateNavigationButtons();
    }
}

// Update navigation button states
window.updateNavigationButtons = function() {
    const prevBtn = document.getElementById('rhetor-prev-prompt');
    const nextBtn = document.getElementById('rhetor-next-prompt');
    
    if (prevBtn) prevBtn.disabled = !promptHistory.length || currentPromptIndex >= promptHistory.length - 1;
    if (nextBtn) nextBtn.disabled = !promptHistory.length || currentPromptIndex <= 0;
}

window.rhetor_refreshPromptHistory = function() {
    rhetor_loadCIPromptHistory();
}

window.rhetor_clearPromptEdit = function() {
    const editor = document.getElementById('prompt-history-editor');
    editor.value = '';
    document.getElementById('prompt-history-timestamp').textContent = 'Cleared';
}

window.rhetor_sendPromptToCI = async function() {
    const selector = document.getElementById('rhetor-ci-selector');
    const editor = document.getElementById('prompt-history-editor');
    const statusSpan = document.getElementById('prompt-send-status');
    const sendButton = document.getElementById('rhetor-send-prompt');
    
    if (!selector.value || !editor.value.trim()) {
        statusSpan.textContent = '❌ No CI selected or prompt is empty';
        setTimeout(() => statusSpan.textContent = '', 3000);
        return;
    }
    
    const ciName = selector.value;
    const prompt = editor.value.trim();
    
    sendButton.disabled = true;
    statusSpan.textContent = '⏳ Sending...';
    
    try {
        const response = await fetch(window.TektonConfig.getRhetorUrl('/api/prompts/send'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ci_name: ciName,
                prompt: prompt,
                timestamp: new Date().toISOString()
            })
        });
        
        if (response.ok) {
            statusSpan.textContent = '✅ Prompt sent successfully!';
            document.getElementById('prompt-history-timestamp').textContent = 
                `Sent: ${new Date().toLocaleString()}`;
            
            // Refresh to show new prompt in history
            setTimeout(() => {
                rhetor_loadCIPromptHistory();
                statusSpan.textContent = '';
            }, 2000);
        } else {
            throw new Error('Failed to send prompt');
        }
    } catch (error) {
        console.error('[RHETOR] Error sending prompt:', error);
        statusSpan.textContent = '❌ Failed to send prompt';
        setTimeout(() => statusSpan.textContent = '', 3000);
    } finally {
        sendButton.disabled = false;
    }
}

// Also update component card clicks to load prompt history
document.addEventListener('DOMContentLoaded', function() {
    // Populate CI selectors on load
    rhetor_populateCISelectors();
    
    // Initialize prompt history display with placeholder
    rhetor_loadCIPromptHistory();
    
    // Add click handlers to component cards
    document.querySelectorAll('.rhetor__component-prompt-card[data-component]').forEach(card => {
        const component = card.getAttribute('data-component');
        if (component && component !== '') {
            card.style.cursor = 'pointer';
            card.addEventListener('click', function() {
                const selector = document.getElementById('rhetor-ci-selector');
                if (selector) {
                    // Set the selector to match the clicked component
                    selector.value = component + '-ci';
                    rhetor_loadCIPromptHistory();
                }
            });
        }
    });
});

// Model Assignment Functions for CI Selector
window.rhetor_loadCIModelAssignment = async function() {
    const selector = document.getElementById('models-ci-selector');
    if (!selector || !selector.value) return;
    
    const ciName = selector.value;
    console.log('[RHETOR] Loading model assignments for:', ciName);
    
    // Get the model selects for the selected CI row
    const codeSelect = document.getElementById('selected-ci-code');
    const planningSelect = document.getElementById('selected-ci-planning');
    const reasoningSelect = document.getElementById('selected-ci-reasoning');
    const chatSelect = document.getElementById('selected-ci-chat');
    
    // First populate the selects with available models if not already done
    if (codeSelect && codeSelect.options.length === 0) {
        await rhetor_populateModelSelects([codeSelect, planningSelect, reasoningSelect, chatSelect]);
    }
    
    // Load the CI's current model assignments
    try {
        const response = await fetch(window.TektonConfig.getRhetorUrl(`/api/model-config/${ciName}`));
        if (response.ok) {
            const config = await response.json();
            
            // Set the values based on the CI's configuration
            if (codeSelect) codeSelect.value = config.code_model || 'default';
            if (planningSelect) planningSelect.value = config.planning_model || 'default';
            if (reasoningSelect) reasoningSelect.value = config.reasoning_model || 'default';
            if (chatSelect) chatSelect.value = config.chat_model || 'default';
            
            console.log('[RHETOR] Loaded model config for', ciName, config);
        } else {
            // Use defaults if no config found
            console.log('[RHETOR] No custom config for', ciName, ', using defaults');
            if (codeSelect) codeSelect.value = 'default';
            if (planningSelect) planningSelect.value = 'default';
            if (reasoningSelect) reasoningSelect.value = 'default';
            if (chatSelect) chatSelect.value = 'default';
        }
    } catch (error) {
        console.error('[RHETOR] Error loading CI model config:', error);
    }
    
    // Update the data-component attribute so saves work correctly
    [codeSelect, planningSelect, reasoningSelect, chatSelect].forEach(select => {
        if (select) {
            select.setAttribute('data-component', ciName);
        }
    });
}

// Helper to populate model selects
window.rhetor_populateModelSelects = async function(selects) {
    const models = await rhetor_loadAllModels();
    
    selects.forEach(select => {
        if (!select) return;
        
        select.innerHTML = '<option value="default">Use Default</option>';
        
        // Group models by provider
        const grouped = {};
        models.forEach(model => {
            const provider = model.provider || 'Other';
            if (!grouped[provider]) grouped[provider] = [];
            grouped[provider].push(model);
        });
        
        // Add options grouped by provider
        Object.keys(grouped).forEach(provider => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = provider;
            
            grouped[provider].forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name;
                optgroup.appendChild(option);
            });
            
            select.appendChild(optgroup);
        });
    });
}

// Try loading models when script loads
console.log('[RHETOR] Script loaded, attempting model load after delay...');
setTimeout(() => {
    console.log('[RHETOR] Delayed initialization - loading models...');
    if (window.rhetor_loadModelAssignments) {
        window.rhetor_loadModelAssignments();
    }
}, 1000);

</script>
