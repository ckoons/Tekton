<!-- 
  Settings Component - Pure HTML/CSS Solution
  NO SCRIPTS - Uses forms, radio buttons, and CSS for all functionality
-->

<!-- Hidden form controls for CSS-only functionality -->
<input type="radio" name="settings-tab" id="tab-theme" checked style="display: none;">
<input type="radio" name="settings-tab" id="tab-interface" style="display: none;">

<input type="radio" name="theme-mode" id="theme-light" value="light" style="display: none;">
<input type="radio" name="theme-mode" id="theme-dark" value="dark" style="display: none;">
<input type="radio" name="theme-mode" id="theme-pure-black" value="pure-black" checked style="display: none;">

<input type="radio" name="accent-color" id="accent-blue" value="blue" checked style="display: none;">
<input type="radio" name="accent-color" id="accent-green" value="green" style="display: none;">
<input type="radio" name="accent-color" id="accent-purple" value="purple" style="display: none;">
<input type="radio" name="accent-color" id="accent-orange" value="orange" style="display: none;">

<input type="checkbox" name="greek-names" id="greek-names-setting" style="display: none;">

<div class="settings" 
     data-tekton-area="settings"
     data-tekton-component="settings"
     data-tekton-type="component-workspace">
  
  <!-- Component Header -->
  <div class="settings__header" 
       data-tekton-zone="header"
       data-tekton-section="header"
       data-tekton-element="settings-header">
    <div class="settings__title-container"
         data-tekton-element="title-container">
      <img src="/images/hexagon.jpg" alt="Tekton" class="settings__icon"
           data-tekton-element="icon"
           data-tekton-type="image">
      <h2 class="settings__title"
          data-tekton-element="title"
          data-tekton-type="heading">
        <span class="settings__title-main"
              data-tekton-element="title-main"
              data-tekton-text="Settings">Settings</span>
        <span class="settings__title-sub"
              data-tekton-element="title-sub"
              data-tekton-text="System Configuration">System Configuration</span>
      </h2>
    </div>
  </div>
  
  <!-- Tab Navigation - CSS ONLY -->
  <div class="settings__menu-bar" 
       data-tekton-zone="menu"
       data-tekton-nav="component-menu"
       data-tekton-element="menu-bar">
    <div class="settings__tabs"
         data-tekton-nav="tabs"
         data-tekton-element="tab-container">
      <!-- Theme Tab -->
      <label for="tab-theme" class="settings__tab"
             data-tekton-nav-item="theme"
             data-tekton-nav-target="theme-panel"
             data-tekton-element="tab"
             data-tekton-state="active">
        <span class="settings__tab-label"
              data-tekton-element="tab-label"
              data-tekton-text="Theme">Theme</span>
      </label>
      <!-- Interface Tab -->
      <label for="tab-interface" class="settings__tab"
             data-tekton-nav-item="interface"
             data-tekton-nav-target="interface-panel"
             data-tekton-element="tab"
             data-tekton-state="inactive">
        <span class="settings__tab-label"
              data-tekton-element="tab-label"
              data-tekton-text="Interface">Interface</span>
      </label>
    </div>
    <div class="settings__actions"
         data-tekton-element="actions">
      <span class="settings__status"
            data-tekton-element="status"
            data-tekton-type="message"
            data-tekton-text="Changes applied instantly">Changes applied instantly</span>
    </div>
  </div>
  
  <!-- Content Area -->
  <div class="settings__content" 
       data-tekton-zone="content"
       data-tekton-scrollable="true"
       data-tekton-element="content-area">
    
    <!-- Theme Panel -->
    <div class="settings__panel settings__panel--theme"
         data-tekton-panel="theme"
         data-tekton-element="panel"
         data-tekton-state="active">
      <div class="settings__form"
           data-tekton-element="form"
           data-tekton-type="settings-form">
        
        <!-- UI Mode -->
        <div class="settings__field"
             data-tekton-field="theme-mode"
             data-tekton-element="field">
          <div class="settings__field-label"
               data-tekton-element="field-label"
               data-tekton-text="UI Mode">UI Mode</div>
          <div class="settings__field-control"
               data-tekton-element="field-control">
            <div class="settings__theme-mode"
                 data-tekton-control="theme-selector"
                 data-tekton-element="theme-mode-container">
              <label for="theme-light" class="settings__theme-mode-button"
                     data-tekton-option="light"
                     data-tekton-element="theme-option"
                     data-tekton-state="inactive">
                <span class="settings__theme-mode-icon"
                      data-tekton-element="theme-icon">‚òÄÔ∏è</span>
                <span class="settings__theme-mode-label"
                      data-tekton-element="theme-label"
                      data-tekton-text="Light">Light</span>
              </label>
              <label for="theme-dark" class="settings__theme-mode-button"
                     data-tekton-option="dark"
                     data-tekton-element="theme-option"
                     data-tekton-state="inactive">
                <span class="settings__theme-mode-icon"
                      data-tekton-element="theme-icon">üåô</span>
                <span class="settings__theme-mode-label"
                      data-tekton-element="theme-label"
                      data-tekton-text="Dark">Dark</span>
              </label>
              <label for="theme-pure-black" class="settings__theme-mode-button"
                     data-tekton-option="pure-black"
                     data-tekton-element="theme-option"
                     data-tekton-state="active">
                <span class="settings__theme-mode-icon"
                      data-tekton-element="theme-icon">‚ö´</span>
                <span class="settings__theme-mode-label"
                      data-tekton-element="theme-label"
                      data-tekton-text="Pure Black">Pure Black</span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Accent Color -->
        <div class="settings__field"
             data-tekton-field="accent-color"
             data-tekton-element="field">
          <div class="settings__field-label"
               data-tekton-element="field-label"
               data-tekton-text="Accent Color">Accent Color</div>
          <div class="settings__field-control"
               data-tekton-element="field-control">
            <div class="settings__theme-color"
                 data-tekton-control="accent-selector"
                 data-tekton-element="accent-color-container">
              <label for="accent-blue" class="settings__theme-color-button" 
                     data-color="blue"
                     data-tekton-option="blue"
                     data-tekton-element="accent-option"
                     data-tekton-state="active">
                <span class="settings__theme-color-dot" 
                      style="background-color: #007bff;"
                      data-tekton-element="color-dot"
                      data-tekton-color="#007bff"></span>
                <span class="settings__theme-color-label"
                      data-tekton-element="color-label"
                      data-tekton-text="Blue">Blue</span>
              </label>
              <label for="accent-green" class="settings__theme-color-button" 
                     data-color="green"
                     data-tekton-option="green"
                     data-tekton-element="accent-option"
                     data-tekton-state="inactive">
                <span class="settings__theme-color-dot" 
                      style="background-color: #28a745;"
                      data-tekton-element="color-dot"
                      data-tekton-color="#28a745"></span>
                <span class="settings__theme-color-label"
                      data-tekton-element="color-label"
                      data-tekton-text="Green">Green</span>
              </label>
              <label for="accent-purple" class="settings__theme-color-button" 
                     data-color="purple"
                     data-tekton-option="purple"
                     data-tekton-element="accent-option"
                     data-tekton-state="inactive">
                <span class="settings__theme-color-dot" 
                      style="background-color: #6f42c1;"
                      data-tekton-element="color-dot"
                      data-tekton-color="#6f42c1"></span>
                <span class="settings__theme-color-label"
                      data-tekton-element="color-label"
                      data-tekton-text="Purple">Purple</span>
              </label>
              <label for="accent-orange" class="settings__theme-color-button" 
                     data-color="orange"
                     data-tekton-option="orange"
                     data-tekton-element="accent-option"
                     data-tekton-state="inactive">
                <span class="settings__theme-color-dot" 
                      style="background-color: #fd7e14;"
                      data-tekton-element="color-dot"
                      data-tekton-color="#fd7e14"></span>
                <span class="settings__theme-color-label"
                      data-tekton-element="color-label"
                      data-tekton-text="Orange">Orange</span>
              </label>
            </div>
          </div>
        </div>
        
      </div>
    </div>
    
    <!-- Interface Panel -->
    <div class="settings__panel settings__panel--interface"
         data-tekton-panel="interface"
         data-tekton-element="panel"
         data-tekton-state="inactive">
      <div class="settings__form"
           data-tekton-element="form"
           data-tekton-type="settings-form">
        
        <!-- Greek Names Toggle -->
        <div class="settings__field"
             data-tekton-field="greek-names"
             data-tekton-element="field">
          <div class="settings__field-label"
               data-tekton-element="field-label"
               data-tekton-text="Show Greek Names">Show Greek Names</div>
          <div class="settings__field-control"
               data-tekton-element="field-control">
            <label for="greek-names-setting" class="settings__toggle"
                   data-tekton-control="toggle"
                   data-tekton-element="toggle-control"
                   data-tekton-state="unchecked">
              <span class="settings__toggle-slider"
                    data-tekton-element="toggle-slider"></span>
            </label>
            <div class="settings__field-description"
                 data-tekton-element="field-description"
                 data-tekton-type="help-text">
              Display components with their Greek names (e.g., "Ergon - Agents/Tools/MCP")
            </div>
          </div>
        </div>
        
        <!-- Terminal Font Size -->
        <div class="settings__field"
             data-tekton-field="terminal-font-size"
             data-tekton-element="field">
          <div class="settings__field-label"
               data-tekton-element="field-label"
               data-tekton-text="Terminal Font Size">Terminal Font Size</div>
          <div class="settings__field-control"
               data-tekton-element="field-control">
            <select id="terminal-font-setting" class="settings__select"
                    data-tekton-control="select"
                    data-tekton-element="select-control"
                    data-tekton-value="medium" data-tekton-select="config">
              <option value="small"
                      data-tekton-option="small"
                      data-tekton-text="Small">Small</option>
              <option value="medium" selected
                      data-tekton-option="medium"
                      data-tekton-text="Medium">Medium</option>
              <option value="large"
                      data-tekton-option="large"
                      data-tekton-text="Large">Large</option>
            </select>
          </div>
        </div>
        
      </div>
    </div>
    
  </div>
</div>

<script>
// Save settings to backend
async function saveSettingsToBackend() {
  try {
    // Gather all settings
    const settingsData = {
      showGreekNames: document.getElementById('greek-names-setting')?.checked || false,
      themeBase: document.querySelector('input[name="theme-mode"]:checked')?.value || 'pure-black',
      accentColor: '#007bff', // We'll calculate this from the preset
      accentPreset: document.querySelector('input[name="accent-color"]:checked')?.value || 'blue',
      terminalFontSize: document.getElementById('terminal-font-setting')?.value || 'medium',
      terminalFontSizePx: 14,
      terminalFontFamily: "'Courier New', monospace",
      terminalTheme: "default",
      terminalCursorStyle: "block",
      terminalCursorBlink: true,
      terminalScrollback: true,
      terminalScrollbackLines: 1000,
      chatHistoryEnabled: true,
      maxChatHistoryEntries: 50
    };
    
    // Set accent color based on preset
    const accentColors = {
      'blue': '#007bff',
      'green': '#28a745',
      'purple': '#6f42c1',
      'orange': '#fd7e14'
    };
    settingsData.accentColor = accentColors[settingsData.accentPreset] || '#007bff';
    
    // Save to backend
    const response = await fetch('/api/settings', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(settingsData)
    });
    
    if (response.ok) {
      console.log('[SETTINGS] Settings saved to backend successfully');
    } else {
      console.error('[SETTINGS] Failed to save settings:', response.status);
    }
  } catch (error) {
    console.error('[SETTINGS] Error saving settings:', error);
  }
}

// Direct theme application - brute force approach
function applyTheme() {
  const checkedTheme = document.querySelector('input[name="theme-mode"]:checked');
  const checkedAccent = document.querySelector('input[name="accent-color"]:checked');
  const greekNamesCheckbox = document.getElementById('greek-names-setting');
  const greekNames = greekNamesCheckbox ? greekNamesCheckbox.checked : false;
  
  console.log('=== APPLYING THEME ===');
  console.log('Theme:', checkedTheme?.value);
  console.log('Accent:', checkedAccent?.value);
  console.log('Greek names:', greekNames);
  
  // Update semantic tags for state tracking
  updateSemanticStates(checkedTheme, checkedAccent, greekNames);
  
  // Apply theme using existing theme system
  if (checkedTheme) {
    document.documentElement.setAttribute('data-theme-base', checkedTheme.value);
    document.body.setAttribute('data-theme-base', checkedTheme.value);
    console.log('Set data-theme-base to:', checkedTheme.value);
    
    // Update the theme stylesheet link if needed
    const themeStylesheet = document.getElementById('theme-stylesheet');
    if (themeStylesheet) {
      themeStylesheet.href = `styles/themes/theme-${checkedTheme.value}.css`;
      console.log('Updated theme stylesheet to:', themeStylesheet.href);
    }
  }
  
  // Apply accent color
  if (checkedAccent) {
    document.documentElement.setAttribute('data-theme-color', checkedAccent.value);
    document.body.setAttribute('data-theme-color', checkedAccent.value);
    
    const accentColors = {
      'blue': '#007bff',
      'green': '#28a745',
      'purple': '#6f42c1',
      'orange': '#fd7e14'
    };
    
    const accentColor = accentColors[checkedAccent.value];
    if (accentColor) {
      document.documentElement.style.setProperty('--color-accent', accentColor);
      console.log('Set accent color to:', accentColor);
    }
  }
  
  // Handle Greek names
  if (greekNames !== null) {
    document.documentElement.setAttribute('data-show-greek-names', greekNames ? 'true' : 'false');
    
    // Update settings manager and apply names
    if (window.settingsManager) {
      window.settingsManager.settings.showGreekNames = greekNames;
      window.settingsManager.save();
      window.settingsManager.applyNames();
      console.log('Applied Greek names setting:', greekNames);
    }
  }
  
  // Save settings to backend
  saveSettingsToBackend();
  
  console.log('=== THEME APPLICATION COMPLETE ===');
}

// Update semantic state tags for UI DevTools
function updateSemanticStates(theme, accent, greekNames) {
  // Update theme option states
  document.querySelectorAll('[data-tekton-element="theme-option"]').forEach(opt => {
    const isActive = opt.getAttribute('data-tekton-option') === theme?.value;
    opt.setAttribute('data-tekton-state', isActive ? 'active' : 'inactive');
  });
  
  // Update accent option states
  document.querySelectorAll('[data-tekton-element="accent-option"]').forEach(opt => {
    const isActive = opt.getAttribute('data-tekton-option') === accent?.value;
    opt.setAttribute('data-tekton-state', isActive ? 'active' : 'inactive');
  });
  
  // Update tab states
  const activeTab = document.querySelector('input[name="settings-tab"]:checked');
  document.querySelectorAll('[data-tekton-element="tab"]').forEach(tab => {
    const tabName = tab.getAttribute('data-tekton-nav-item');
    const isActive = activeTab?.id === `tab-${tabName}`;
    tab.setAttribute('data-tekton-state', isActive ? 'active' : 'inactive');
  });
  
  // Update panel states
  document.querySelectorAll('[data-tekton-element="panel"]').forEach(panel => {
    const panelName = panel.getAttribute('data-tekton-panel');
    const isActive = activeTab?.id === `tab-${panelName}`;
    panel.setAttribute('data-tekton-state', isActive ? 'active' : 'inactive');
  });
  
  // Update toggle state
  const toggle = document.querySelector('[data-tekton-control="toggle"]');
  if (toggle) {
    toggle.setAttribute('data-tekton-state', greekNames ? 'checked' : 'unchecked');
  }
  
  // Update select value
  const select = document.querySelector('[data-tekton-control="select"]');
  if (select) {
    select.setAttribute('data-tekton-value', select.value);
  }
}

// Listen for clicks on labels (most reliable)
document.addEventListener('click', function(e) {
  const label = e.target.closest('label');
  if (label) {
    const inputId = label.getAttribute('for');
    console.log('Label clicked for input:', inputId);
    
    // Small delay to let the radio button/checkbox update
    setTimeout(() => {
      applyTheme();
    }, 50);
  }
});

// Backup: Listen for input changes
document.addEventListener('change', function(e) {
  if (e.target.type === 'radio' || e.target.type === 'checkbox') {
    console.log('Input changed:', e.target.name || e.target.id, e.target.value || e.target.checked);
    applyTheme();
  }
  
  // Special handling for Greek names checkbox
  if (e.target.id === 'greek-names-setting') {
    console.log('Greek names toggled to:', e.target.checked);
    applyTheme();
  }
});

// Apply theme on load
setTimeout(() => {
  console.log('Initial theme application...');
  
  // Set initial Greek names checkbox state from settings
  if (window.settingsManager) {
    const greekCheckbox = document.getElementById('greek-names-setting');
    if (greekCheckbox) {
      greekCheckbox.checked = window.settingsManager.settings.showGreekNames;
      console.log('Set Greek names checkbox to:', window.settingsManager.settings.showGreekNames);
    }
  }
  
  applyTheme();
}, 200);
</script>

<style>
/* CSS-Only Settings Functionality */

/* Tab switching */
#tab-theme:checked ~ .settings .settings__panel--theme {
  display: block;
}

#tab-interface:checked ~ .settings .settings__panel--interface {
  display: block;
}

#tab-theme:checked ~ .settings .settings__panel--interface {
  display: none;
}

#tab-interface:checked ~ .settings .settings__panel--theme {
  display: none;
}

/* Tab visual states */
#tab-theme:checked ~ .settings .settings__tab:first-child {
  background-color: var(--color-bg-card, #333);
  color: var(--color-accent, #007bff);
  border-bottom: 2px solid var(--color-accent, #007bff);
}

#tab-interface:checked ~ .settings .settings__tab:last-child {
  background-color: var(--color-bg-card, #333);
  color: var(--color-accent, #007bff);
  border-bottom: 2px solid var(--color-accent, #007bff);
}

/* Theme mode button states */
#theme-light:checked ~ .settings label[for="theme-light"] {
  background-color: var(--color-accent, #007bff);
  color: white;
}

#theme-dark:checked ~ .settings label[for="theme-dark"] {
  background-color: var(--color-accent, #007bff);
  color: white;
}

#theme-pure-black:checked ~ .settings label[for="theme-pure-black"] {
  background-color: var(--color-accent, #007bff);
  color: white;
}

/* Accent color button states */
#accent-blue:checked ~ .settings label[for="accent-blue"] {
  border: 2px solid #007bff;
  background-color: rgba(0, 123, 255, 0.1);
}

#accent-green:checked ~ .settings label[for="accent-green"] {
  border: 2px solid #28a745;
  background-color: rgba(40, 167, 69, 0.1);
}

#accent-purple:checked ~ .settings label[for="accent-purple"] {
  border: 2px solid #6f42c1;
  background-color: rgba(111, 66, 193, 0.1);
}

#accent-orange:checked ~ .settings label[for="accent-orange"] {
  border: 2px solid #fd7e14;
  background-color: rgba(253, 126, 20, 0.1);
}

/* Greek names toggle */
#greek-names-setting:checked ~ .settings .settings__toggle .settings__toggle-slider {
  background-color: var(--color-accent, #007bff);
}

#greek-names-setting:checked ~ .settings .settings__toggle .settings__toggle-slider::before {
  transform: translateX(20px);
}

/* Fix toggle positioning */
.settings__toggle input[type="checkbox"] {
  opacity: 0;
  width: 0;
  height: 0;
}


/* Debug theme switching - immediate background changes */
#theme-light:checked ~ .settings {
  background-color: #ffffff !important;
  color: #000000 !important;
}

#theme-dark:checked ~ .settings {
  background-color: #1a1a1a !important;
  color: #ffffff !important;
}

#theme-pure-black:checked ~ .settings {
  background-color: #000000 !important;
  color: #ffffff !important;
}

/* Base Settings styling */
.settings {
  background-color: var(--color-bg-base, #000000);
  color: var(--color-text-primary, #ffffff);
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.settings__header {
  padding: 20px;
  border-bottom: 1px solid var(--color-border, #333);
}

.settings__title-container {
  display: flex;
  align-items: center;
  gap: 12px;
}

.settings__icon {
  width: 32px;
  height: 32px;
  border-radius: 4px;
}

.settings__title-main {
  font-size: 24px;
  font-weight: 600;
  display: block;
}

.settings__title-sub {
  font-size: 14px;
  color: var(--color-text-secondary, #ccc);
  display: block;
}

.settings__menu-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 20px;
  border-bottom: 1px solid var(--color-border, #333);
}

.settings__tabs {
  display: flex;
  gap: 0;
}

.settings__tab {
  padding: 12px 20px;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s ease;
  background: none;
  border: none;
  color: var(--color-text-secondary, #ccc);
}

.settings__tab:hover {
  color: var(--color-text-primary, #fff);
  background-color: var(--color-bg-card, #141414);
}

.settings__actions {
  display: flex;
  gap: 10px;
}

.settings__button {
  padding: 8px 16px;
  border: 1px solid var(--color-border, #333);
  background-color: var(--color-bg-card, #141414);
  color: var(--color-text-primary, #fff);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.settings__button:hover {
  background-color: var(--color-bg-panel, #0a0a0a);
}

.settings__button--primary {
  background-color: var(--color-accent, #007bff);
  border-color: var(--color-accent, #007bff);
}

.settings__content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.settings__panel {
  display: none;
}

.settings__panel--theme {
  display: block; /* Default active */
}

.settings__field {
  margin-bottom: 24px;
}

.settings__field-label {
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--color-text-primary, #fff);
}

.settings__field-control {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.settings__theme-mode {
  display: flex;
  gap: 12px;
}

.settings__theme-mode-button {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 16px;
  border: 1px solid var(--color-border, #333);
  background-color: var(--color-bg-card, #141414);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  color: var(--color-text-primary, #fff);
  min-width: 80px;
}

.settings__theme-mode-button:hover {
  border-color: var(--color-accent, #007bff);
}

.settings__theme-mode-icon {
  font-size: 24px;
}

.settings__theme-mode-label {
  font-size: 12px;
  font-weight: 500;
}

.settings__theme-color {
  display: flex;
  gap: 12px;
}

.settings__theme-color-button {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  border: 1px solid var(--color-border, #333);
  background-color: var(--color-bg-card, #141414);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  color: var(--color-text-primary, #fff);
}

.settings__theme-color-button:hover {
  border-color: var(--color-accent, #007bff);
}

.settings__theme-color-dot {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: 1px solid var(--color-border, #333);
}

.settings__toggle {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}

.settings__toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--color-bg-panel, #333);
  transition: 0.3s;
  border-radius: 24px;
}

.settings__toggle-slider::before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}

.settings__select {
  padding: 8px 12px;
  border: 1px solid var(--color-border, #333);
  background-color: var(--color-bg-card, #141414);
  color: var(--color-text-primary, #fff);
  border-radius: 4px;
  max-width: 200px;
}

.settings__field-description {
  font-size: 12px;
  color: var(--color-text-secondary, #ccc);
  margin-top: 4px;
}

.settings__status {
  font-size: 12px;
  color: var(--color-text-secondary, #ccc);
  font-style: italic;
}
</style>